<!DOCTYPE html>
<!-- Language attribute set by JS -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title set by JS -->
    <title data-translate="page_title">Module 0: Lesson Simulation - Controlled Timed IDE (Extra Pacing)</title>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --bg-base: #181a1f;         /* Very dark blue/grey base */
            --bg-panel: #21252b;        /* Slightly lighter panels */
            --bg-editor: #282c34;       /* Editor background (Atom One Dark-like) */
            --bg-console: #1f2328;      /* Darker console */
            --text-primary: #abb2bf;    /* Primary light grey text */
            --text-secondary: #5c6370;  /* Dimmer grey for secondary info */
            --text-highlight: #e5c07b;  /* Accent yellow/gold */
            --border-color: #3a3f4b;    /* Subtle borders */
            --cursor-color: #528bff;    /* Accent blue cursor */
            --scrollbar-thumb: #4b5263;
            --scrollbar-track: var(--bg-panel);

            /* Syntax Highlighting Palette (Atom One Dark inspired) */
            --hl-keyword: #c678dd;  /* Purple */
            --hl-string: #98c379;   /* Green */
            --hl-comment: var(--text-secondary); /* Dim grey, italic */
            --hl-function: #61afef;  /* Blue */
            --hl-paren: var(--text-primary); /* Match default text */
            --hl-number: #d19a66;   /* Orange/Brown */
            --hl-output: #a0e8ff;   /* Light cyan for output */
            --hl-error: #e06c75;    /* Red for errors (if needed later) */

            /* UI Elements */
            --sidebar-bg: var(--bg-base);
            --statusbar-bg: #1b1d23;
            --statusbar-text: var(--text-secondary);
            --titlebar-bg: var(--bg-base);
            --titlebar-text: var(--text-secondary);

            --font-code: 'Fira Code', 'Courier New', Courier, monospace;
            --font-ui: 'Roboto', sans-serif;
            --transition-speed: 0.3s;
            --typing-cursor-height: 1.4em;
            --line-height-editor: 1.7;
            --overlay-bg: rgba(0, 0, 0, 0.7); /* Overlay background */
            --border-radius: 8px;
            /* Colors matching news.html for consistency in switcher potentially */
            --nav-success: #4cc9f0;
            --nav-dark: #1a1a2e;
        }

        /* --- Reset & Base --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg-base); font-family: var(--font-ui); color: var(--text-primary); }

        /* --- IDE Layout --- */
        .ide-container { display: flex; flex-direction: column; width: 100vw; height: 100vh; background-color: var(--bg-base); position: relative; /* For overlay & button */ }

        /* --- Title Bar --- */
        .title-bar { background-color: var(--titlebar-bg); padding: 8px 15px; color: var(--titlebar-text); font-size: 0.9em; text-align: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: relative; }
        .title-bar .file-name { font-weight: 500; color: var(--text-primary); }
        /* Icons removed as they weren't functional */

        /* --- Main Content Area --- */
        .main-content { display: flex; flex-grow: 1; overflow: hidden; }

        /* --- Sidebar Placeholder --- */
        .sidebar-placeholder { width: 50px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 25px; }
        .sidebar-placeholder i { font-size: 1.4em; color: var(--text-secondary); opacity: 0.6; }
        .sidebar-placeholder i.active { color: var(--text-primary); opacity: 1; }

        /* --- Editor & Console Split --- */
        .editor-console-split { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }

        /* --- Editor Pane --- */
        .editor-pane { flex-grow: 1; background-color: var(--bg-editor); display: flex; overflow: hidden; position: relative; min-height: 150px; }
        .line-numbers { font-family: var(--font-code); font-size: 1em; line-height: var(--line-height-editor); color: var(--text-secondary); text-align: right; padding: 15px 15px 15px 10px; user-select: none; background-color: var(--bg-editor); border-right: 1px solid var(--border-color); white-space: pre; overflow: hidden; flex-shrink: 0; }
        .code-area-wrapper { flex-grow: 1; overflow-y: auto; padding: 15px; position: relative; }
        .code-area { font-family: var(--font-code); font-size: 1em; line-height: var(--line-height-editor); color: var(--text-primary); white-space: pre; outline: none; min-height: 100%; position: relative; }

        /* --- Minimap --- */
        .minimap-placeholder { position: absolute; top: 0; right: 0; bottom: 0; width: 80px; background-color: rgba(0, 0, 0, 0.1); border-left: 1px solid var(--border-color); flex-shrink: 0; overflow: hidden; opacity: 0.5; pointer-events: none; }
        .minimap-placeholder::before { content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; background: linear-gradient( rgba(255,255,255,0.08) 1px, transparent 1px ); background-size: 100% 4px; }

        /* --- Cursor --- */
        .code-area::after { /* Style remains same */ }
        .code-area.typing::after { /* Style remains same */ }
        .code-area.idle::after { /* Style remains same */ }
        .code-area.no-cursor::after { /* Style remains same */ }
        @keyframes blink { 50% { opacity: 0; } }

        /* --- Console Pane --- */
        .console-pane { height: 30%; max-height: 350px; min-height: 120px; background-color: var(--bg-console); border-top: 1px solid var(--border-color); color: var(--text-primary); font-family: var(--font-code); font-size: 0.95em; line-height: 1.6; padding: 10px 15px; overflow-y: auto; flex-shrink: 0; white-space: pre-wrap; word-wrap: break-word; }
        .console-pane .output-line { color: var(--hl-output); }
        .console-pane .error-line { color: var(--hl-error); font-weight: bold;}
        .console-pane .placeholder { color: var(--text-secondary); font-style: italic; }
        .console-pane .info-line { color: var(--text-secondary); font-style: italic;}
        .console-prompt { color: var(--text-secondary); margin-right: 8px; user-select: none;}

        /* --- Status Bar --- */
        .status-bar { background-color: var(--statusbar-bg); color: var(--statusbar-text); padding: 5px 15px; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); flex-shrink: 0; white-space: nowrap; }
        .status-bar-left, .status-bar-right { display: flex; gap: 15px; align-items: center; }
        .status-bar i { margin-right: 5px; font-size: 1.1em; vertical-align: middle;}
        .status-bar .git-branch i { color: #e8ae59; }
        .status-bar .language i { color: #61afef; }

        /* --- Syntax Highlighting --- */
        .hl-keyword { color: var(--hl-keyword); font-weight: 500; }
        .hl-string { color: var(--hl-string); }
        .hl-comment { color: var(--hl-comment); font-style: italic; }
        .hl-function { color: var(--hl-function); }
        .hl-paren { color: var(--hl-paren); }
        .hl-number { color: var(--hl-number); }

        /* --- Scrollbar Styling --- */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #5a6375; }
        ::-webkit-scrollbar-corner { background: var(--scrollbar-track); }

        /* --- Pause/Play/Restart Button --- */
        #control-button {
            position: absolute;
            top: 55px;
            right: 20px;
            z-index: 100;
            background-color: rgba(40, 44, 52, 0.7);
            color: var(--text-secondary);
            border: 1px solid rgba(58, 63, 75, 0.5);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: none;
            transition: background-color var(--transition-speed), color var(--transition-speed), opacity var(--transition-speed);
            opacity: 0.6;
        }
        #control-button:hover {
            opacity: 1;
            background-color: rgba(40, 44, 52, 0.9);
            color: var(--text-primary);
        }
        #control-button.hidden { display: none; }

        /* --- Navigation Overlay & Menu --- */
        #nav-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--overlay-bg); z-index: 90; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity var(--transition-speed) ease-in-out; }
        #nav-overlay.visible { opacity: 1; pointer-events: auto; }
        .nav-menu { background-color: var(--bg-panel); padding: 25px 35px; border-radius: var(--border-radius); text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.5); max-width: 90%; width: 400px; /* Limit width */ }
        .nav-menu h3 { color: var(--text-highlight); margin-bottom: 20px; font-size: 1.4em; }
        .nav-menu .button-group { display: flex; flex-direction: column; gap: 15px; margin-top: 0; margin-bottom: 25px; /* Add space before lang switcher */ }
        .nav-menu .action-button { display: block; text-decoration: none; padding: 10px 20px; font-size: 1em; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color var(--transition-speed), transform 0.1s ease; text-align: center; }
        .nav-menu .action-button i { margin-right: 8px; }
        .nav-menu .action-button.primary { background-color: var(--hl-output); color: var(--bg-base); }
        .nav-menu .action-button.primary:hover { background-color: #b3f0ff; }
        .nav-menu .action-button.secondary { background-color: var(--text-secondary); }
        .nav-menu .action-button.secondary:hover { background-color: #7a828e; }
        .nav-menu .action-button.tertiary { background-color: var(--border-color); font-size: 0.9em; padding: 8px 15px; }
        .nav-menu .action-button.tertiary:hover { background-color: #4b5263; }
        .nav-menu .action-button:active { transform: scale(0.98); }

        /* --- Language Switcher in Menu --- */
        .nav-menu .language-switcher-container {
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            margin-top: 5px; /* Adjust spacing */
        }
        .nav-menu #languageSelect {
            width: 100%;
            background: rgba(255,255,255,0.08); /* Slightly lighter than news */
            color: white;
            border: 1px solid var(--nav-success);
            border-radius: 5px;
            padding: 8px 30px 8px 12px; /* Adjusted padding */
            cursor: pointer;
            font-size: 0.95em; /* Match button font size */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234CC9F0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 12px center; /* Adjusted position */
            background-size: 10px auto;
            transition: background-color 0.3s ease;
        }
        .nav-menu #languageSelect:hover {
             background-color: rgba(255,255,255,0.15);
        }
        .nav-menu #languageSelect option {
             background: var(--nav-dark);
             color: var(--text-light);
        }

    </style>
</head>
<body>

    <div class="ide-container" id="ide-container">
        <!-- Title Bar -->
        <div class="title-bar"> <span class="file-name">module_0_review.py</span> </div>
        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar Placeholder -->
            <div class="sidebar-placeholder"> <i class="fas fa-copy active"></i> <i class="fas fa-search"></i> <i class="fas fa-code-branch"></i> <i class="fas fa-bug"></i> <i class="fas fa-puzzle-piece"></i> </div>
            <!-- Editor & Console -->
            <div class="editor-console-split">
                <div class="editor-pane">
                    <div class="line-numbers" id="line-numbers">1</div>
                    <div class="code-area-wrapper" id="code-area-wrapper"> <div class="code-area" id="code-area"></div> </div>
                    <div class="minimap-placeholder"></div>
                     <!-- Pause/Play/Restart Button -->
                     <button id="control-button" class="hidden" data-translate-title="tooltip_play_pause" title="Play/Pause">
                         <i class="fas fa-pause" id="control-icon"></i>
                     </button>
                </div>
                <div class="console-pane" id="console-pane"> <span class="placeholder" data-translate="console_placeholder_initial">Python Console Ready... [Click to Start Lesson]</span> </div>
            </div>
        </div>
        <!-- Status Bar -->
        <div class="status-bar" id="status-bar">
             <div class="status-bar-left"> <span class="git-branch"><i class="fas fa-code-branch"></i> main</span> </div>
             <div class="status-bar-right">
                 <span id="cursor-pos" data-translate-pattern="status_cursor_pos" data-translate-pattern-ln="1" data-translate-pattern-col="1">Ln 1, Col 1</span>
                 <span data-translate="status_spaces">Spaces: 4</span>
                 <span data-translate="status_encoding">UTF-8</span>
                 <span class="language"><i class="fab fa-python"></i> <span data-translate="status_language">Python 3.1x.x</span></span>
             </div>
        </div>

         <!-- Navigation Overlay (Initially Hidden) -->
         <div id="nav-overlay">
             <div class="nav-menu">
                 <h3 id="nav-menu-title" data-translate="pause_menu_title_paused">Lesson Paused</h3>
                 <div class="button-group">
                     <a href="ctp-knowledge-check-0.html" class="action-button primary"><i class="fas fa-question-circle"></i> <span data-translate="button_knowledge_check">Knowledge Check</span></a>
                     <a href="ctp-theory-0.html" class="action-button secondary"><i class="fas fa-book-open"></i> <span data-translate="button_review_theory">Review Theory</span></a>
                     <a href="ctp-practice-0.html" class="action-button secondary"><i class="fas fa-undo-alt"></i> <span data-translate="button_revisit_basic">Revisit Basic Practice</span></a>
                     <a href="ctp-advanced-0.html" class="action-button secondary"><i class="fas fa-redo-alt"></i> <span data-translate="button_revisit_advanced">Revisit Advanced Practice</span></a>
                     <a href="ctp.html" class="action-button tertiary"><i class="fas fa-list"></i> <span data-translate="button_course_menu">Course Menu</span></a>
                 </div>
                 <!-- Language Switcher -->
                 <div class="language-switcher-container">
                     <select id="languageSelect" aria-label="Select Language">
                         <option value="en" data-translate="lang_en">ðŸ‡¬ðŸ‡§ English</option>
                         <option value="pt" data-translate="lang_pt">ðŸ‡§ðŸ‡· PortuguÃªs</option>
                         <option value="zh" data-translate="lang_zh">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
                     </select>
                 </div>
             </div>
         </div>

    </div>

     <!-- Hidden Audio Elements (Ensure src paths are correct!) -->
     <div style="display: none;">
        <!-- English -->
        <audio id="audio-ctp-0-a1-eng" src="audio/ctp-0-a1-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a2-eng" src="audio/ctp-0-a2-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a3-eng" src="audio/ctp-0-a3-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a4-eng" src="audio/ctp-0-a4-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a5-eng" src="audio/ctp-0-a5-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a6-eng" src="audio/ctp-0-a6-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a7-eng" src="audio/ctp-0-a7-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a8-eng" src="audio/ctp-0-a8-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a9-eng" src="audio/ctp-0-a9-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a10-eng" src="audio/ctp-0-a10-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a11-eng" src="audio/ctp-0-a11-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a12-eng" src="audio/ctp-0-a12-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a13-eng" src="audio/ctp-0-a13-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a14-eng" src="audio/ctp-0-a14-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a15-eng" src="audio/ctp-0-a15-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a16-eng" src="audio/ctp-0-a16-eng.mp3" preload="auto"></audio>
        <!-- Portuguese -->
        <audio id="audio-ctp-0-a1-ptbr" src="audio/ctp-0-a1-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a2-ptbr" src="audio/ctp-0-a2-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a3-ptbr" src="audio/ctp-0-a3-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a4-ptbr" src="audio/ctp-0-a4-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a5-ptbr" src="audio/ctp-0-a5-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a6-ptbr" src="audio/ctp-0-a6-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a7-ptbr" src="audio/ctp-0-a7-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a8-ptbr" src="audio/ctp-0-a8-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a9-ptbr" src="audio/ctp-0-a9-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a10-ptbr" src="audio/ctp-0-a10-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a11-ptbr" src="audio/ctp-0-a11-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a12-ptbr" src="audio/ctp-0-a12-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a13-ptbr" src="audio/ctp-0-a13-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a14-ptbr" src="audio/ctp-0-a14-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a15-ptbr" src="audio/ctp-0-a15-ptbr.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a16-ptbr" src="audio/ctp-0-a16-ptbr.mp3" preload="auto"></audio>
        <!-- Chinese -->
        <audio id="audio-ctp-0-a1-cn" src="audio/ctp-0-a1-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a2-cn" src="audio/ctp-0-a2-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a3-cn" src="audio/ctp-0-a3-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a4-cn" src="audio/ctp-0-a4-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a5-cn" src="audio/ctp-0-a5-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a6-cn" src="audio/ctp-0-a6-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a7-cn" src="audio/ctp-0-a7-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a8-cn" src="audio/ctp-0-a8-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a9-cn" src="audio/ctp-0-a9-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a10-cn" src="audio/ctp-0-a10-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a11-cn" src="audio/ctp-0-a11-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a12-cn" src="audio/ctp-0-a12-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a13-cn" src="audio/ctp-0-a13-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a14-cn" src="audio/ctp-0-a14-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a15-cn" src="audio/ctp-0-a15-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a16-cn" src="audio/ctp-0-a16-cn.mp3" preload="auto"></audio>
     </div>

    <script>
    // --- Translations Object ---
    const translations = {
        en: {
            "page_title": "Module 0: Lesson Simulation - Controlled Timed IDE (Extra Pacing)",
            "tooltip_play_pause": "Play/Pause",
            "console_placeholder_initial": "Python Console Ready... [Click to Start Lesson]",
            "console_placeholder_cleared": "Console cleared.",
            "console_placeholder_playing": "Lesson playing...",
            "console_placeholder_starting": "Starting lesson...",
            "console_output_no_comments": "(No output from comments)",
            "console_output_great_job": "Great job!",
            "console_output_next_steps": "Next: Knowledge Check",
            "console_output_error": "An error occurred: {error}",
            "status_cursor_pos": "Ln {ln}, Col {col}",
            "status_spaces": "Spaces: 4",
            "status_encoding": "UTF-8",
            "status_language": "Python 3.1x.x",
            "pause_menu_title_paused": "Lesson Paused",
            "pause_menu_title_finished": "Lesson Finished",
            "pause_menu_title_error": "Error Occurred",
            "button_knowledge_check": "Knowledge Check",
            "button_review_theory": "Review Theory",
            "button_revisit_basic": "Revisit Basic Practice",
            "button_revisit_advanced": "Revisit Advanced Practice",
            "button_course_menu": "Course Menu",
            "button_title_resume": "Resume",
            "button_title_pause": "Pause",
            "button_title_restart": "Restart Lesson",
            "lang_en": "ðŸ‡¬ðŸ‡§ English",
            "lang_pt": "ðŸ‡§ðŸ‡· PortuguÃªs",
            "lang_zh": "ðŸ‡¨ðŸ‡³ ä¸­æ–‡"
        },
        pt: {
            "page_title": "MÃ³dulo 0: SimulaÃ§Ã£o de LiÃ§Ã£o - IDE Controlado por Tempo (Ritmo Extra)",
            "tooltip_play_pause": "Reproduzir/Pausar",
            "console_placeholder_initial": "Console Python Pronto... [Clique para Iniciar a LiÃ§Ã£o]",
            "console_placeholder_cleared": "Console limpo.",
            "console_placeholder_playing": "LiÃ§Ã£o em andamento...",
            "console_placeholder_starting": "Iniciando liÃ§Ã£o...",
            "console_output_no_comments": "(Nenhuma saÃ­da de comentÃ¡rios)",
            "console_output_great_job": "Ã“timo trabalho!",
            "console_output_next_steps": "PrÃ³ximo: VerificaÃ§Ã£o de Conhecimento",
            "console_output_error": "Ocorreu um erro: {error}",
            "status_cursor_pos": "Ln {ln}, Col {col}", // Format remains Ln/Col
            "status_spaces": "EspaÃ§os: 4",
            "status_encoding": "UTF-8",
            "status_language": "Python 3.1x.x", // Keep version number
            "pause_menu_title_paused": "LiÃ§Ã£o Pausada",
            "pause_menu_title_finished": "LiÃ§Ã£o ConcluÃ­da",
            "pause_menu_title_error": "Ocorreu um Erro",
            "button_knowledge_check": "VerificaÃ§Ã£o de Conhecimento",
            "button_review_theory": "Revisar Teoria",
            "button_revisit_basic": "Revisitar PrÃ¡tica BÃ¡sica",
            "button_revisit_advanced": "Revisitar PrÃ¡tica AvanÃ§ada",
            "button_course_menu": "Menu do Curso",
            "button_title_resume": "Continuar",
            "button_title_pause": "Pausar",
            "button_title_restart": "Reiniciar LiÃ§Ã£o",
            "lang_en": "ðŸ‡¬ðŸ‡§ English",
            "lang_pt": "ðŸ‡§ðŸ‡· PortuguÃªs",
            "lang_zh": "ðŸ‡¨ðŸ‡³ ä¸­æ–‡"
        },
        zh: {
            "page_title": "æ¨¡å— 0ï¼šè¯¾ç¨‹æ¨¡æ‹Ÿ - å—æŽ§è®¡æ—¶ IDEï¼ˆé¢å¤–èŠ‚å¥ï¼‰",
            "tooltip_play_pause": "æ’­æ”¾/æš‚åœ",
            "console_placeholder_initial": "Python æŽ§åˆ¶å°å‡†å¤‡å°±ç»ª... [ç‚¹å‡»å¼€å§‹è¯¾ç¨‹]",
            "console_placeholder_cleared": "æŽ§åˆ¶å°å·²æ¸…é™¤ã€‚",
            "console_placeholder_playing": "è¯¾ç¨‹æ’­æ”¾ä¸­...",
            "console_placeholder_starting": "æ­£åœ¨å¼€å§‹è¯¾ç¨‹...",
            "console_output_no_comments": "ï¼ˆæ³¨é‡Šæ— è¾“å‡ºï¼‰",
            "console_output_great_job": "åšå¾—å¥½ï¼",
            "console_output_next_steps": "ä¸‹ä¸€æ­¥ï¼šçŸ¥è¯†æ£€æµ‹",
            "console_output_error": "å‘ç”Ÿé”™è¯¯ï¼š{error}",
            "status_cursor_pos": "è¡Œ {ln}, åˆ— {col}", // Translated Ln/Col
            "status_spaces": "ç©ºæ ¼: 4",
            "status_encoding": "UTF-8",
            "status_language": "Python 3.1x.x", // Keep version number
            "pause_menu_title_paused": "è¯¾ç¨‹å·²æš‚åœ",
            "pause_menu_title_finished": "è¯¾ç¨‹å·²å®Œæˆ",
            "pause_menu_title_error": "å‘ç”Ÿé”™è¯¯",
            "button_knowledge_check": "çŸ¥è¯†æ£€æµ‹",
            "button_review_theory": "å¤ä¹ ç†è®º",
            "button_revisit_basic": "é‡æ¸©åŸºç¡€ç»ƒä¹ ",
            "button_revisit_advanced": "é‡æ¸©é«˜çº§ç»ƒä¹ ",
            "button_course_menu": "è¯¾ç¨‹èœå•",
            "button_title_resume": "ç»§ç»­",
            "button_title_pause": "æš‚åœ",
            "button_title_restart": "é‡æ–°å¼€å§‹è¯¾ç¨‹",
            "lang_en": "ðŸ‡¬ðŸ‡§ English",
            "lang_pt": "ðŸ‡§ðŸ‡· PortuguÃªs",
            "lang_zh": "ðŸ‡¨ðŸ‡³ ä¸­æ–‡"
        }
    };

    document.addEventListener('DOMContentLoaded', () => {

        // --- Element References ---
        const ideContainer = document.getElementById('ide-container');
        const codeArea = document.getElementById('code-area');
        const consolePane = document.getElementById('console-pane');
        const lineNumbersEl = document.getElementById('line-numbers');
        const statusBar = document.getElementById('status-bar');
        const cursorPosEl = document.getElementById('cursor-pos');
        const codeAreaWrapper = document.getElementById('code-area-wrapper');
        const controlButton = document.getElementById('control-button');
        const controlIcon = document.getElementById('control-icon');
        const navOverlay = document.getElementById('nav-overlay');
        const navMenuTitle = document.getElementById('nav-menu-title');
        const languageSelect = document.getElementById('languageSelect');

        // --- State Variables ---
        let currentLineNumber = 1;
        let currentCol = 1;
        let currentContentHTML = '';
        let charWidthEstimate = 9; // Recalculated later
        let lineHeightEstimate = 27; // Recalculated later
        let simulationStarted = false;
        let isPaused = false;
        let isFinished = false;
        let currentStepIndex = 0;
        let currentAudioElement = null;
        let currentTimeoutId = null;
        let stopExecution = false;
        let currentLanguage = 'en'; // Set during initialization

        // --- Audio Setup ---
        const audioElements = {}; // Object to hold references to audio elements
        document.querySelectorAll('audio[id^="audio-ctp-0-a"]').forEach(el => {
            audioElements[el.id] = el;
             el.onerror = () => console.error(`Error loading audio: ${el.src}`);
             // Optional: Add event listener for when audio can play through
             el.oncanplaythrough = () => { /* console.log(`${el.id} can play through`); */ };
             el.load(); // Explicitly load metadata
        });

        // --- Language Management Functions ---
        function getStoredLanguage() {
            const storedLang = localStorage.getItem('userVideoLanguage'); // Use a different key for video page
            if (storedLang && translations[storedLang]) return storedLang;
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith('pt')) return 'pt';
            if (browserLang.startsWith('zh')) return 'zh';
            return 'en'; // Default to English
        }

        function setLanguage(lang) {
            if (!translations[lang]) lang = 'en'; // Fallback
            if (lang === currentLanguage && document.documentElement.lang === lang) return; // No change needed

            console.log(`Setting language to: ${lang}`);
            currentLanguage = lang; // Update global state
            localStorage.setItem('userVideoLanguage', lang);
            document.documentElement.lang = lang;
            translatePage(lang);

            // Update language selector dropdown
            if (languageSelect) {
                languageSelect.value = lang;
            }

            // If simulation is paused or finished, update the menu title immediately
            if (isPaused) {
                showNavMenu(true, getTranslation('pause_menu_title_paused', currentLanguage));
            } else if (isFinished) {
                 // Find the current title key (this is a bit hacky, better to store state)
                 const currentTitleKey = navMenuTitle.dataset.translate || 'pause_menu_title_finished'; // Default if no key set
                 showNavMenu(true, getTranslation(currentTitleKey, currentLanguage));
            }

            // Stop current audio and reset state if language changes mid-playback
            if (simulationStarted && !isPaused && !isFinished) {
                console.warn("Language changed mid-simulation. Restarting required.");
                // Option 1: Force pause and show menu (less disruptive)
                // togglePause(); // Will show pause menu with new lang title
                // Option 2: Force restart (cleaner state)
                 restartSimulation(); // This might be better for audio sync
            }
        }

        function getTranslation(key, lang, replacements = {}) {
            let text = translations[lang]?.[key] ?? translations['en']?.[key] ?? `[${key}]`;
            for (const placeholder in replacements) {
                const regex = new RegExp(`\\{${placeholder}\\}`, 'g');
                text = text.replace(regex, replacements[placeholder]);
            }
            return text;
        }

        function translatePage(lang) {
            if (!translations[lang]) lang = 'en';

            // Translate elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                const translation = getTranslation(key, lang);
                 if (el.tagName === 'TITLE') {
                     document.title = translation;
                 } else if (el.tagName === 'OPTION') {
                     el.textContent = translation; // For language names in dropdown
                 } else {
                    // Check for pattern translation
                    const patternKey = el.getAttribute('data-translate-pattern');
                    if (patternKey) {
                        const replacements = {};
                        for (const attr of el.attributes) {
                            if (attr.name.startsWith('data-translate-pattern-')) {
                                replacements[attr.name.substring(23)] = attr.value; // Get key like 'ln' or 'col'
                            }
                        }
                        el.textContent = getTranslation(patternKey, lang, replacements);
                    } else if (translation.includes('<') && translation.includes('>')) {
                         el.innerHTML = translation; // Use innerHTML for tags
                     } else {
                         el.textContent = translation; // Use textContent otherwise
                     }
                 }
            });

            // Translate placeholders
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                el.setAttribute('placeholder', getTranslation(key, lang));
            });

            // Translate titles (tooltips)
            document.querySelectorAll('[data-translate-title]').forEach(el => {
                const key = el.getAttribute('data-translate-title');
                el.setAttribute('title', getTranslation(key, lang));
            });

            // Update initial console placeholder text if simulation hasn't started
            if (!simulationStarted) {
                const placeholder = consolePane.querySelector('.placeholder');
                if (placeholder) {
                     placeholder.textContent = getTranslation('console_placeholder_initial', lang);
                }
            }
        }


         // --- Helper Functions ---
         function getTextWidth(text, font) {
              const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
              const context = canvas.getContext("2d");
              context.font = font || getComputedStyle(codeArea).font;
              // Replace non-breaking spaces potentially added by innerHTML with regular spaces for measurement
              const cleanText = text.replace(/\u00A0/g, ' ');
              return context.measureText(cleanText).width;
          }
        function updateStatusBarAndCursor() {
            const lines = codeArea.innerText.split('\n');
            currentLineNumber = lines.length;
            const lastLineText = lines[currentLineNumber - 1] || '';
            currentCol = lastLineText.length + 1; // +1 for cursor position after last char

            // Update status bar text using translation pattern
            cursorPosEl.setAttribute('data-translate-pattern-ln', currentLineNumber);
            cursorPosEl.setAttribute('data-translate-pattern-col', currentCol);
            cursorPosEl.textContent = getTranslation('status_cursor_pos', currentLanguage, { ln: currentLineNumber, col: currentCol });

            // Update cursor position visually
            const cursorTop = (currentLineNumber - 1) * lineHeightEstimate;
            // Use the helper function to get width accurately
            const cursorLeft = getTextWidth(lastLineText, getComputedStyle(codeArea).font);

            const cursorPseudoStyle = `
                 .code-area.idle::after, .code-area.typing::after {
                     top: ${cursorTop}px; left: ${cursorLeft}px;
                     height: ${getComputedStyle(codeArea).lineHeight}; }`;
            let styleSheet = document.getElementById('cursor-style');
            if (!styleSheet) { styleSheet = document.createElement('style'); styleSheet.id = 'cursor-style'; document.head.appendChild(styleSheet); }
            styleSheet.textContent = cursorPseudoStyle;

            // Auto-scroll logic
            const wrapperRect = codeAreaWrapper.getBoundingClientRect();
            const cursorAbsoluteTop = codeArea.offsetTop + cursorTop;
            const scrollTop = codeAreaWrapper.scrollTop;
            const scrollBottom = scrollTop + wrapperRect.height;
            const currentLineHeight = parseFloat(getComputedStyle(codeArea).lineHeight);

            // Scroll down if cursor is below visible area
            if (cursorAbsoluteTop + currentLineHeight > scrollBottom) {
                codeAreaWrapper.scrollTop = cursorAbsoluteTop + currentLineHeight - wrapperRect.height + 10; // +10 buffer
            }
            // Scroll up if cursor is above visible area
            else if (cursorAbsoluteTop < scrollTop) {
                codeAreaWrapper.scrollTop = Math.max(0, cursorAbsoluteTop - 10); // -10 buffer
            }
        }
        function updateLineNumbers() {
             const lines = codeArea.innerText.split('\n').length;
             const maxLines = Math.max(lines, 1);
             let numbersHTML = '';
             for (let i = 1; i <= maxLines; i++) { numbersHTML += i + '\n'; }
             lineNumbersEl.textContent = numbersHTML.trimEnd(); // Use textContent for performance
         }
        function showOutput(outputLines, isInfo = false, isError = false, errorKey = 'console_output_error') {
             return new Promise((resolve) => {
                 consolePane.innerHTML = ''; // Clear previous console content
                 outputLines.forEach(line => {
                     const lineEl = document.createElement('div');
                     if (isError) {
                         lineEl.className = 'error-line';
                         // Use translation for the error prefix
                         const errorText = getTranslation(errorKey, currentLanguage, { error: line });
                         lineEl.textContent = `âŒ ${errorText}`;
                     } else if (isInfo) {
                         lineEl.className = 'info-line';
                         // Allow info lines to be translation keys directly
                         const infoText = getTranslation(line, currentLanguage); // Use line as key
                         lineEl.textContent = `â„¹ï¸ ${infoText}`;
                     } else {
                         lineEl.className = 'output-line';
                         const promptSpan = document.createElement('span');
                         promptSpan.className = 'console-prompt';
                         promptSpan.textContent = '>>>'; // Keep prompt standard
                         lineEl.appendChild(promptSpan);
                         lineEl.appendChild(document.createTextNode(` ${line}`)); // Actual output
                     }
                     consolePane.appendChild(lineEl);
                 });
                 consolePane.scrollTop = consolePane.scrollHeight;
                 resolve();
             });
        }
        function clearConsole(placeholderKey = 'console_placeholder_cleared') {
             return new Promise((resolve) => {
                 const placeholderText = getTranslation(placeholderKey, currentLanguage);
                 consolePane.innerHTML = `<span class="placeholder">${placeholderText}</span>`;
                 resolve();
             });
        }
        function clearEditor() {
             return new Promise((resolve) => {
                 currentContentHTML = '';
                 codeArea.innerHTML = ''; // Clear visual content
                 currentLineNumber = 1;
                 currentCol = 1;
                 updateLineNumbers();
                 updateStatusBarAndCursor();
                 codeArea.classList.add('idle');
                 codeArea.classList.remove('typing', 'no-cursor');
                 resolve();
             });
        }
        function simulateTyping(textToTypeHTML, typingSpeed) {
             // This function remains largely the same as it deals with HTML structure
             // No direct translation needed within its core logic
             return new Promise((resolve, reject) => {
                 clearTimeout(currentTimeoutId); currentTimeoutId = null;
                 if (isPaused) { codeArea.classList.add('idle'); codeArea.classList.remove('typing', 'no-cursor'); updateStatusBarAndCursor(); resolve(); return; }
                 if (stopExecution) { reject("stopped"); return; }

                 codeArea.classList.add('typing'); codeArea.classList.remove('idle', 'no-cursor');
                 let charIndex = 0; let currentHTML = currentContentHTML;

                 function typeStep() {
                     if (stopExecution) { console.log("Typing interrupted by stop signal."); codeArea.classList.remove('typing'); codeArea.classList.add('idle'); clearTimeout(currentTimeoutId); currentTimeoutId = null; reject("stopped"); return; }
                     if (isPaused) {
                         console.log("Typing paused..."); codeArea.classList.remove('typing'); codeArea.classList.add('idle'); updateStatusBarAndCursor();
                         const pauseCheckInterval = setInterval(() => {
                             if (stopExecution) { clearInterval(pauseCheckInterval); console.log("Typing stop signal received while paused."); reject("stopped"); }
                             else if (!isPaused) { clearInterval(pauseCheckInterval); console.log("Typing resumed..."); codeArea.classList.add('typing'); codeArea.classList.remove('idle'); currentTimeoutId = setTimeout(typeStep, typingSpeed); }
                         }, 100);
                         return;
                     }

                     if (charIndex >= textToTypeHTML.length) { currentContentHTML = currentHTML; codeArea.classList.remove('typing'); codeArea.classList.add('idle'); updateLineNumbers(); updateStatusBarAndCursor(); currentTimeoutId = null; resolve(); return; }
                     let nextChar = textToTypeHTML[charIndex]; let stepSize = 1;
                     if (nextChar === '<') { const tagEndIndex = textToTypeHTML.indexOf('>', charIndex); if (tagEndIndex !== -1) { stepSize = tagEndIndex - charIndex + 1; nextChar = textToTypeHTML.substring(charIndex, tagEndIndex + 1); } }
                     else if (nextChar === '&') { // Handle HTML entities
                         const entityEndIndex = textToTypeHTML.indexOf(';', charIndex);
                         if (entityEndIndex !== -1) {
                             stepSize = entityEndIndex - charIndex + 1;
                             nextChar = textToTypeHTML.substring(charIndex, entityEndIndex + 1);
                         }
                     }
                     currentHTML += nextChar;
                     codeArea.innerHTML = currentHTML; // Update DOM
                     updateLineNumbers();
                     updateStatusBarAndCursor();
                     charIndex += stepSize;
                     currentTimeoutId = setTimeout(typeStep, typingSpeed);
                 }
                 typeStep();
             });
        }
        async function playAudio(baseAudioId) {
            // Construct the language-specific ID
            let langSuffix = 'eng';
            if (currentLanguage === 'pt') langSuffix = 'ptbr';
            else if (currentLanguage === 'zh') langSuffix = 'cn';

            const fullAudioId = `${baseAudioId}-${langSuffix}`;
            console.log(`Attempting to play: ${fullAudioId}`);

            // Stop any currently playing audio first
            if (currentAudioElement && !currentAudioElement.paused) {
                console.log(`Stopping previous audio: ${currentAudioElement.id}`);
                currentAudioElement.pause();
                currentAudioElement.currentTime = 0;
            }

            currentAudioElement = audioElements[fullAudioId]; // Get reference from preloaded elements

            if (!currentAudioElement) {
                console.warn(`Audio element ${fullAudioId} not found in preloaded list.`);
                // Optional: Fallback to English?
                // currentAudioElement = audioElements[`${baseAudioId}-eng`];
                // if (!currentAudioElement) {
                //     console.error(`Fallback English audio ${baseAudioId}-eng also not found.`);
                //     return; // Exit if even fallback fails
                // }
                 return; // Exit if specific language audio not found
            }

            try {
                currentAudioElement.currentTime = 0; // Ensure playback starts from beginning
                 // Use a promise to handle potential play() interruptions or errors
                 await currentAudioElement.play();
                console.log(`Started audio playback: ${fullAudioId}`);
            } catch (error) {
                console.error(`Error attempting to play ${fullAudioId}:`, error);
                // Handle common errors like user interaction needed
                if (error.name === 'NotAllowedError') {
                    console.warn("Playback prevented. User interaction likely needed.");
                     // Optionally, prompt user to click again?
                     // Or just log the warning.
                 }
                 currentAudioElement = null; // Reset current element if playback failed
            }
        }
        async function pause(duration) {
             // This function remains the same, pausing execution flow
             return new Promise((resolve, reject) => {
                 clearTimeout(currentTimeoutId); currentTimeoutId = null;
                 if (isPaused) { codeArea.classList.add('idle'); codeArea.classList.remove('typing', 'no-cursor'); updateStatusBarAndCursor(); resolve(); return; }
                 if (stopExecution) { reject("stopped"); return; }

                codeArea.classList.add('idle'); codeArea.classList.remove('typing', 'no-cursor'); updateStatusBarAndCursor();
                let intervalCheckId = null;
                const cleanUp = () => { clearTimeout(currentTimeoutId); clearInterval(intervalCheckId); currentTimeoutId = null; intervalCheckId = null; };

                currentTimeoutId = setTimeout(() => { cleanUp(); resolve(); }, duration);
                intervalCheckId = setInterval(() => {
                    if (stopExecution) { console.log("Pause interrupted by stop signal."); cleanUp(); reject("stopped"); }
                    else if (isPaused) { console.log("Pause interrupted by user pause."); cleanUp(); resolve(); } // Resolve immediately if paused
                }, 50);
            });
         }

        // --- THE LESSON SCRIPT (Uses base Audio IDs) ---
        const audioDurations = { // Durations remain the same regardless of language
            'a1': 13000, 'a2': 13000, 'a3': 14000, 'a4': 30000, 'a5': 6000,
            'a6': 9000, 'a7': 8000, 'a8': 5000, 'a9': 11000, 'a10': 16000,
            'a11': 2000, 'a12': 18000, 'a13': 8000, 'a14': 8000, 'a15': 15000,
            'a16': 32000
        };

        const lessonScript = [
             // Segments use base IDs like 'audio-ctp-0-a1'. The playAudio func adds the suffix.
             { type: 'audio', audioId: 'audio-ctp-0-a1', note: "Start a1" }, { type: 'pause', duration: 1500 }, { type: 'typeCode', content: `<span class="hl-comment"># Module 0 Review: print() and comments</span>\n\n`, speed: 70 }, { type: 'pause', duration: Math.max(0, audioDurations['a1'] - 1500 - 2000 + 900), note: "Wait remainder of a1 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a2', note: "Start a2" }, { type: 'pause', duration: audioDurations['a2'] + 900, note: "Wait for a2 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a3', note: "Start a3" }, { type: 'pause', duration: 11000 }, { type: 'typeCode', content: `<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"..."</span><span class="hl-paren">)</span>`, speed: 90 }, { type: 'pause', duration: Math.max(0, audioDurations['a3'] - 11000 - 1000 + 900), note: "Wait remainder of a3 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a4', note: "Start a4" }, { type: 'pause', duration: 5000 }, { type: 'clearEditor' }, { type: 'pause', duration: 100}, { type: 'typeCode', content: `<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"Hello, World!"</span><span class="hl-paren">)</span>`, speed: 80 }, { type: 'pause', duration: Math.max(0, audioDurations['a4'] - 5000 - 100 - 2500 + 900), note: "Wait remainder of a4 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a5', note: "Start a5" }, { type: 'runCode', output: ["Hello, World!"] }, { type: 'pause', duration: 2000 }, { type: 'typeCode', content: `\n<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"Python is powerful."</span><span class="hl-paren">)</span>`, speed: 70 }, { type: 'pause', duration: Math.max(0, audioDurations['a5'] - 2000 - 2000 + 900), note: "Wait remainder of a5 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a6', note: "Start a6" }, { type: 'typeCode', content: `\n<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"Practice makes perfect!"</span><span class="hl-paren">)</span>`, speed: 70 }, { type: 'pause', duration: 3000 }, { type: 'typeCode', content: `\n\n<span class="hl-comment"># Adding a blank line</span>\n`, speed: 60 }, { type: 'typeCode', content: `<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-paren">)</span>`, speed: 95 }, { type: 'pause', duration: Math.max(0, audioDurations['a6'] - 3000 - 2500 + 900), note: "Wait remainder of a6 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a7', note: "Start a7" }, { type: 'runCode', output: ["Hello, World!", "Python is powerful.", "Practice makes perfect!", ""] }, { type: 'pause', duration: 3000 }, { type: 'typeCode', content: `\n<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"This appears after the space."</span><span class="hl-paren">)</span>`, speed: 70 }, { type: 'pause', duration: Math.max(0, audioDurations['a7'] - 3000 - 3000 + 900), note: "Wait remainder of a7 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a8', note: "Start a8" }, { type: 'runCode', output: ["Hello, World!", "Python is powerful.", "Practice makes perfect!", "", "This appears after the space."]}, { type: 'pause', duration: audioDurations['a8'] + 900, note: "Wait for a8 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a9', note: "Start a9" }, { type: 'clearEditor' }, { type: 'clearConsole' }, { type: 'pause', duration: 500 }, { type: 'typeCode', content: `<span class="hl-comment"># This is a full-line comment.</span>\n`, speed: 60 }, { type: 'pause', duration: Math.max(0, audioDurations['a9'] - 500 - 3000 + 900), note: "Wait remainder of a9 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a10', note: "Start a10" }, { type: 'runCode', output: ["console_output_no_comments"], isInfo: true }, { type: 'pause', duration: 5000 }, { type: 'typeCode', content: `<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"Processing data..."</span><span class="hl-paren">)</span> `, speed: 70 }, { type: 'typeCode', content: `<span class="hl-comment"># End-of-line comment</span>`, speed: 55 }, { type: 'pause', duration: Math.max(0, audioDurations['a10'] - 5000 - 4000 + 900), note: "Wait remainder of a10 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a11', note: "Start a11" }, { type: 'runCode', output: ["Processing data..."] }, { type: 'pause', duration: audioDurations['a11'] + 900, note: "Wait for a11 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a12', note: "Start a12" }, { type: 'pause', duration: 10000 }, { type: 'typeCode', content: `\n<span class="hl-comment"># print("Old debug message") # Temporarily disabled</span>`, speed: 55 }, { type: 'pause', duration: Math.max(0, audioDurations['a12'] - 10000 - 4000 + 900), note: "Wait remainder of a12 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a13', note: "Start a13" }, { type: 'clearEditor' }, { type: 'clearConsole' }, { type: 'pause', duration: 500 }, { type: 'typeCode', content: `<span class="hl-comment"># Finally: Syntax is important!</span>\n`, speed: 65 }, { type: 'pause', duration: Math.max(0, audioDurations['a13'] - 500 - 2500 + 900), note: "Wait remainder of a13 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a14', note: "Start a14" }, { type: 'typeCode', content: `<span class="hl-comment"># - print (lowercase)</span>\n<span class="hl-comment"># - () Parentheses</span>\n<span class="hl-comment"># - "" or '' Quotes for text</span>`, speed: 65 }, { type: 'pause', duration: Math.max(0, audioDurations['a14'] - 5000 + 900), note: "Wait remainder of a14 (+0.9s)" },
             { type: 'audio', audioId: 'audio-ctp-0-a15', note: "Start a15" }, { type: 'clearEditor' }, { type: 'pause', duration: 300 }, { type: 'typeCode', content: `<span class="hl-comment"># You've mastered the basics!</span>\n`, speed: 60 }, { type: 'pause', duration: 500 }, { type: 'typeCode', content: `<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"Module 0 Complete!"</span><span class="hl-paren">)</span>`, speed: 70 }, { type: 'pause', duration: 1000 }, { type: 'runCode', output: ["Module 0 Complete!"] }, { type: 'pause', duration: Math.max(0, audioDurations['a15'] - 300 - 500 - 1000 - 1000 - 2000 + 900), note: "Wait remainder of a15 (+0.9s)" },

             // --- Segment 16: Final conclusion/next steps (a16) ---
             { type: 'audio', audioId: 'audio-ctp-0-a16', note: "Start a16" },
             { type: 'clearConsole'},
             { type: 'pause', duration: 500, note: "Pause after clear console" },
             // Use translation keys for info output
             { type: 'runCode', output: ["console_output_great_job", "console_output_next_steps"], isInfo: true},
             { type: 'pause', duration: Math.max(0, audioDurations['a16'] - 500), note: "Wait for a16 main duration" },
             { type: 'pause', duration: 1200, note: "Final buffer (+1.2s)" },

             { type: 'end', note: "End of Simulation" }
        ];

        // --- AUTOPLAY EXECUTION & CONTROL LOGIC ---
        async function executeScript() {
             if (!simulationStarted) return;
             console.log("Starting script execution...");
             clearConsole('console_placeholder_playing'); // Use key for playing message
             controlButton.classList.remove('hidden');
             setControlButtonState('pause');
             isFinished = false;
             stopExecution = false; // Ensure stop flag is reset

             while (currentStepIndex < lessonScript.length && !stopExecution) {
                 // Pause check loop
                  while (isPaused && !stopExecution) {
                      console.log("Execution paused. Waiting...");
                      // Show menu if paused
                      showNavMenu(true, getTranslation('pause_menu_title_paused', currentLanguage));
                      await new Promise(resolve => setTimeout(resolve, 200)); // Check pause state every 200ms
                  }
                  if (isPaused) showNavMenu(true, getTranslation('pause_menu_title_paused', currentLanguage)); // Ensure menu stays visible if paused

                  if (stopExecution) { console.log("Stop signal received while paused or between steps."); break; }

                 const step = lessonScript[currentStepIndex];
                 console.log(`Executing Step ${currentStepIndex}: ${step.type} - ${step.note || ''}`);
                 codeArea.classList.remove('idle', 'typing', 'no-cursor'); // Ensure cursor state is active

                 try {
                     switch (step.type) {
                         case 'audio': if (step.audioId) { await playAudio(step.audioId); } await pause(10); break; // Use base ID
                         case 'typeCode': await simulateTyping(step.content, step.speed || 75); break;
                         case 'runCode': await pause(100); await showOutput(step.output, step.isInfo || false, step.isError || false); break;
                         case 'clearConsole': await clearConsole(); break;
                         case 'clearEditor': await clearEditor(); break;
                         case 'pause': await pause(step.duration || 1000); break;
                         case 'end': isFinished = true; showEndState(); stopExecution = true; console.log("Script finished normally."); break; // Use default title first
                         default: console.warn(`Unknown step type: ${step.type}`); await pause(100);
                     }
                 } catch (error) {
                      if (error === "stopped") { console.log(`Step ${currentStepIndex} (${step.type}) interrupted.`); }
                      else {
                          console.error(`Error during step ${currentStepIndex} (${step.type}):`, error);
                           // Show translated error message
                           showOutput([error.message || 'Unknown error'], false, true, 'console_output_error');
                          stopExecution = true;
                          isFinished = true;
                          showEndState("pause_menu_title_error"); // Use translation key for title
                      }
                 }

                 // Move to next step only if execution wasn't stopped and it wasn't the end step
                 if (!stopExecution && step.type !== 'end') {
                    codeArea.classList.add('idle'); // Set cursor to idle after step completion
                    codeArea.classList.remove('typing', 'no-cursor');
                    updateStatusBarAndCursor();
                    currentStepIndex++;
                 } else if (stopExecution) {
                     console.log("Execution loop terminating due to stop signal.");
                     break; // Exit loop explicitly
                 }
             } // End while loop

             // Handle external stop signal if loop finished because of it
             if (!isFinished && stopExecution) {
                console.log("Script execution stopped externally.");
                if(isPaused) {
                    // Already paused, ensure menu is shown with correct state
                    setControlButtonState('play');
                    showNavMenu(true, getTranslation('pause_menu_title_paused', currentLanguage));
                    codeArea.classList.add('idle');
                    updateStatusBarAndCursor();
                } else if (!isFinished) {
                     // Stopped but not paused and not finished -> show restart
                     setControlButtonState('restart');
                     showNavMenu(true, getTranslation('pause_menu_title_paused', currentLanguage)); // Show menu as paused
                     codeArea.classList.add('idle');
                     updateStatusBarAndCursor();
                 }
             } else if (currentStepIndex >= lessonScript.length && !isFinished) {
                 // Reached end of script steps naturally
                 isFinished = true;
                 showEndState(); // Use default finished title key
                 console.log("Script loop completed (final check).");
             }
        }

        // --- Control/UI Functions ---
        function setControlButtonState(state) { // state: 'play', 'pause', 'restart'
            let iconClass = 'fa-pause';
            let titleKey = 'button_title_pause';
            if (state === 'play') {
                iconClass = 'fa-play';
                titleKey = 'button_title_resume';
            } else if (state === 'restart') {
                iconClass = 'fa-redo-alt';
                titleKey = 'button_title_restart';
            }
            controlIcon.className = `fas ${iconClass}`;
            controlButton.setAttribute('data-translate-title', titleKey); // Set key
            controlButton.title = getTranslation(titleKey, currentLanguage); // Set initial title
        }
        function showNavMenu(show = true, titleKey = "pause_menu_title_paused") {
            navMenuTitle.dataset.translate = titleKey; // Store the key
            navMenuTitle.textContent = getTranslation(titleKey, currentLanguage); // Translate title
            if (show) {
                navOverlay.classList.add('visible');
            } else {
                navOverlay.classList.remove('visible');
            }
        }
        function showEndState(titleKey = "pause_menu_title_finished") {
            console.log("Showing end state");
            isFinished = true;
            stopExecution = true; // Ensure execution loop stops
            setControlButtonState('restart');
            codeArea.classList.add('no-cursor'); // Hide cursor
            codeArea.classList.remove('idle', 'typing');
            showNavMenu(true, titleKey); // Show menu with appropriate title key

            // Stop any potentially lingering audio
            if (currentAudioElement) {
                currentAudioElement.pause();
                currentAudioElement.currentTime = 0;
            }
            currentAudioElement = null;
            // Clear any pending timeouts
            clearTimeout(currentTimeoutId);
            currentTimeoutId = null;
        }
        function togglePause() {
            if (isFinished) return; // Don't pause if finished
            isPaused = !isPaused;
            console.log(isPaused ? "Pausing..." : "Resuming...");

            if (isPaused) {
                setControlButtonState('play'); // Set button to 'play' icon
                showNavMenu(true, getTranslation('pause_menu_title_paused', currentLanguage)); // Show pause menu
                if (currentAudioElement) {
                    currentAudioElement.pause(); // Pause audio
                }
                codeArea.classList.remove('typing'); // Ensure not 'typing' style
                codeArea.classList.add('idle'); // Show idle cursor
                updateStatusBarAndCursor();
                 clearTimeout(currentTimeoutId); // Clear any typing timeout
                 currentTimeoutId = null;
            } else {
                showNavMenu(false); // Hide pause menu
                setControlButtonState('pause'); // Set button back to 'pause' icon
                if (currentAudioElement && currentAudioElement.paused && currentAudioElement.currentTime > 0) {
                    // Resume audio only if it was paused and has progress
                    currentAudioElement.play().catch(e => console.error("Resume play error", e));
                }
                // If typing was interrupted, it will resume via the check in simulateTyping
                // If execution was between steps, the main loop will continue
                if (!stopExecution && currentStepIndex < lessonScript.length) {
                    // Re-trigger execution check if resuming between steps
                     // The main executeScript loop's pause check will handle resuming
                     console.log("Resuming execution loop check.");
                }
            }
        }
        function restartSimulation() {
            console.log("Restarting simulation...");
            stopExecution = true; // Signal stop to any ongoing process
            clearTimeout(currentTimeoutId); // Clear any pending timeouts
            currentTimeoutId = null;

            // Stop and reset current audio
            if (currentAudioElement) {
                currentAudioElement.pause();
                currentAudioElement.currentTime = 0;
            }
            currentAudioElement = null;

            // Reset state variables
            currentStepIndex = 0;
            isPaused = false;
            isFinished = false;
            currentContentHTML = '';

            // Reset UI
            clearEditor();
            clearConsole('console_placeholder_initial'); // Reset console to initial state
            showNavMenu(false); // Hide menu
            codeArea.classList.remove('typing', 'no-cursor');
            codeArea.classList.add('idle'); // Show idle cursor initially
            updateStatusBarAndCursor();
            setControlButtonState('pause'); // Set button to pause for the new run

            // Use a small delay before restarting to ensure cleanup completes
            setTimeout(() => {
                stopExecution = false; // Allow new execution
                simulationStarted = true; // Ensure it's marked as started
                console.log("Executing script after restart delay.");
                executeScript(); // Start the script from the beginning
            }, 150); // Slightly longer delay
        }


        // --- Event Listeners ---
        controlButton.addEventListener('click', () => {
            if (!simulationStarted) return; // Don't do anything if not started
            if (isFinished) {
                restartSimulation();
            } else {
                togglePause();
            }
        });

        // Language select listener
        if (languageSelect) {
            languageSelect.addEventListener('change', (e) => {
                setLanguage(e.target.value);
            });
        }

        // --- User Interaction Start ---
        function startSimulation() {
             if (simulationStarted) return;
             simulationStarted = true;
            // Remove listeners to prevent multiple starts
            document.body.removeEventListener('click', startSimulation);
            document.body.removeEventListener('keydown', startSimulation);

            console.log("User interaction detected, starting simulation...");
            clearConsole('console_placeholder_starting'); // Use key

             // Attempt to unlock audio context
             try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                if (context.state === 'suspended') { context.resume(); }
                // Optional: "Prime" audio elements after user interaction
                // Object.values(audioElements)[0]?.play().then(() => Object.values(audioElements)[0].pause()).catch(()=>{});
             } catch(e) { console.warn("AudioContext interaction failed:", e); }

            controlButton.classList.remove('hidden');
            // Set initial state correctly before starting
            setControlButtonState('pause');
            // Start execution after a short delay
            setTimeout(executeScript, 300);
        }
        // Add listeners for the first user interaction
        document.body.addEventListener('click', startSimulation, { once: true });
        document.body.addEventListener('keydown', startSimulation, { once: true });

        // --- Initial Setup ---
        function calculateMetrics() {
            // Calculate estimates based on current styles
            const style = getComputedStyle(codeArea);
            lineHeightEstimate = parseFloat(style.lineHeight) || 27;
            charWidthEstimate = getTextWidth('M', style.font) || 9; // Measure a typical wide character
            // Update cursor height based on calculated line height
             document.documentElement.style.setProperty('--typing-cursor-height', style.lineHeight);
        }

        // Set initial language and translate
        const startingLang = getStoredLanguage();
        setLanguage(startingLang); // This now calls translatePage

        // Initial UI state
        calculateMetrics(); // Calculate after styles are applied
        updateLineNumbers();
        updateStatusBarAndCursor();
        codeArea.classList.add('idle'); // Show blinking cursor initially

        // Recalculate metrics on resize
        window.addEventListener('resize', calculateMetrics);


    }); // End DOMContentLoaded
    </script>

</body>
</html>
