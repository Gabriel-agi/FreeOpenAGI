<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 0: Lesson Simulation - Interactive Control</title>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Base Styles & Variables --- */
        :root {
            /* ... (Same color variables as previous version) ... */
            --bg-base: #181a1f; --bg-panel: #21252b; --bg-editor: #282c34; --bg-console: #1f2328;
            --text-primary: #abb2bf; --text-secondary: #5c6370; --text-highlight: #e5c07b;
            --border-color: #3a3f4b; --cursor-color: #528bff; --scrollbar-thumb: #4b5263;
            --scrollbar-track: var(--bg-panel);
            --hl-keyword: #c678dd; --hl-string: #98c379; --hl-comment: var(--text-secondary);
            --hl-function: #61afef; --hl-paren: var(--text-primary); --hl-number: #d19a66;
            --hl-output: #a0e8ff; --hl-error: #e06c75;
            --sidebar-bg: var(--bg-base); --statusbar-bg: #1b1d23; --statusbar-text: var(--text-secondary);
            --titlebar-bg: var(--bg-base); --titlebar-text: var(--text-secondary);
            --font-code: 'Fira Code', 'Courier New', Courier, monospace;
            --font-ui: 'Roboto', sans-serif;
            --transition-speed: 0.3s;
            --typing-cursor-height: 1.4em;
            --line-height-editor: 1.7;
            --overlay-bg: rgba(0, 0, 0, 0.75); /* Slightly darker overlay */
        }

        /* --- Reset & Base --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg-base); font-family: var(--font-ui); color: var(--text-primary); }

        /* --- IDE Layout --- */
        .ide-container { display: flex; flex-direction: column; width: 100vw; height: 100vh; background-color: var(--bg-base); position: relative; }

        /* --- Title Bar --- */
        .title-bar { background-color: var(--titlebar-bg); padding: 8px 15px; color: var(--titlebar-text); font-size: 0.9em; text-align: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: relative; }
        .title-bar .file-name { font-weight: 500; color: var(--text-primary); }
        .title-bar-icons { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px; }
        .title-bar-icons i { font-size: 0.8em; color: #555; }

        /* --- Main Content Area --- */
        .main-content { display: flex; flex-grow: 1; overflow: hidden; position: relative; /* For interaction listener */}

        /* --- Sidebar Placeholder --- */
        .sidebar-placeholder { width: 50px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 25px; }
        .sidebar-placeholder i { font-size: 1.4em; color: var(--text-secondary); opacity: 0.6; }
        .sidebar-placeholder i.active { color: var(--text-primary); opacity: 1; }

        /* --- Editor & Console Split --- */
        .editor-console-split { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }

        /* --- Editor Pane --- */
        .editor-pane { flex-grow: 1; background-color: var(--bg-editor); display: flex; overflow: hidden; position: relative; min-height: 150px; }
        .line-numbers { font-family: var(--font-code); font-size: 1em; line-height: var(--line-height-editor); color: var(--text-secondary); text-align: right; padding: 15px 15px 15px 10px; user-select: none; background-color: var(--bg-editor); border-right: 1px solid var(--border-color); white-space: pre; overflow: hidden; flex-shrink: 0; }
        .code-area-wrapper { flex-grow: 1; overflow-y: auto; padding: 15px; position: relative; }
        .code-area { font-family: var(--font-code); font-size: 1em; line-height: var(--line-height-editor); color: var(--text-primary); white-space: pre; outline: none; min-height: 100%; position: relative; }

        /* --- Minimap --- */
        .minimap-placeholder { position: absolute; top: 0; right: 0; bottom: 0; width: 80px; background-color: rgba(0, 0, 0, 0.1); border-left: 1px solid var(--border-color); flex-shrink: 0; overflow: hidden; opacity: 0.5; pointer-events: none; }
        .minimap-placeholder::before { content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; background: linear-gradient( rgba(255,255,255,0.08) 1px, transparent 1px ); background-size: 100% 4px; }

        /* --- Cursor --- */
        .code-area::after { content: ''; display: block; width: 2px; height: var(--typing-cursor-height); background-color: var(--cursor-color); position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 0.1s ease-out, top 0.05s linear, left 0.05s linear; border-radius: 1px; box-shadow: 0 0 5px var(--cursor-color); }
        .code-area.typing::after { opacity: 1; animation: none; }
        .code-area.idle::after { opacity: 1; animation: blink 1.1s steps(1) infinite; }
        .code-area.no-cursor::after { opacity: 0; animation: none; }
        @keyframes blink { 50% { opacity: 0; } }

        /* --- Console Pane --- */
        .console-pane { height: 30%; max-height: 350px; min-height: 120px; background-color: var(--bg-console); border-top: 1px solid var(--border-color); color: var(--text-primary); font-family: var(--font-code); font-size: 0.95em; line-height: 1.6; padding: 10px 15px; overflow-y: auto; flex-shrink: 0; white-space: pre-wrap; word-wrap: break-word; }
        .console-pane .output-line { color: var(--hl-output); }
        .console-pane .error-line { color: var(--hl-error); font-weight: bold;}
        .console-pane .placeholder { color: var(--text-secondary); font-style: italic; }
        .console-pane .info-line { color: var(--text-secondary); font-style: italic;}
        .console-prompt { color: var(--text-secondary); margin-right: 8px; user-select: none;}

        /* --- Status Bar --- */
        .status-bar { background-color: var(--statusbar-bg); color: var(--statusbar-text); padding: 5px 15px; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); flex-shrink: 0; white-space: nowrap; }
        .status-bar-left, .status-bar-right { display: flex; gap: 15px; align-items: center; }
        .status-bar i { margin-right: 5px; font-size: 1.1em; vertical-align: middle;}
        .status-bar .git-branch i { color: #e8ae59; }
        .status-bar .language i { color: #61afef; }

        /* --- Syntax Highlighting --- */
        .hl-keyword { color: var(--hl-keyword); font-weight: 500; }
        .hl-string { color: var(--hl-string); }
        .hl-comment { color: var(--hl-comment); font-style: italic; }
        .hl-function { color: var(--hl-function); }
        .hl-paren { color: var(--hl-paren); }
        .hl-number { color: var(--hl-number); }

        /* --- Scrollbar Styling --- */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #5a6375; }
        ::-webkit-scrollbar-corner { background: var(--scrollbar-track); }

        /* --- Center Control Button --- */
        #control-button {
            position: absolute;
            /* Center positioning */
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 100; /* Above overlay */
            background-color: rgba(82, 139, 255, 0.8); /* Semi-transparent */
            color: white; border: none; border-radius: 50%;
            width: 70px; height: 70px; /* Larger */
            font-size: 2em; /* Larger icon */
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transition: background-color var(--transition-speed), opacity var(--transition-speed), transform 0.2s ease;
            opacity: 0.9;
        }
        #control-button:hover { background-color: var(--cursor-color); opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
        #control-button.hidden { opacity: 0; pointer-events: none; transform: translate(-50%, -50%) scale(0.8); } /* Hide smoothly */

        /* --- Navigation Overlay & Menu --- */
        #nav-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--overlay-bg); z-index: 90;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
            transition: opacity var(--transition-speed) ease-in-out;
        }
        #nav-overlay.visible { opacity: 1; pointer-events: auto; }

        .nav-menu { background-color: var(--bg-panel); padding: 25px 35px; border-radius: var(--border-radius); text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .nav-menu h3 { color: var(--text-highlight); margin-bottom: 20px; font-family: var(--font-title); font-size: 1.4em; }
        .nav-menu .button-group { display: flex; flex-direction: column; gap: 15px; margin-top: 0; }
        .nav-menu .action-button { display: block; text-decoration: none; padding: 10px 20px; font-size: 1em; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color var(--transition-speed), transform 0.1s ease; text-align: center; }
        .nav-menu .action-button i { margin-right: 8px; }
        .nav-menu .action-button.primary { background-color: var(--hl-output); color: var(--bg-base); } /* Knowledge check */
        .nav-menu .action-button.primary:hover { background-color: #b3f0ff; }
        .nav-menu .action-button.secondary { background-color: var(--text-secondary); }
        .nav-menu .action-button.secondary:hover { background-color: #7a828e; }
        .nav-menu .action-button.tertiary { background-color: var(--border-color); font-size: 0.9em; padding: 8px 15px; } /* Course Menu */
        .nav-menu .action-button.tertiary:hover { background-color: #4b5263; }
        .nav-menu .action-button:active { transform: scale(0.98); }

        /* --- Initial Tutorial Hint --- */
        #tutorial-hint {
            position: absolute;
            top: 60px; /* Below title bar */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.6);
            color: #eee;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 110; /* Above everything initially */
            pointer-events: none; /* Don't block clicks */
            opacity: 1;
            transition: opacity 0.5s ease-out 1s; /* Fade out after a delay */
        }
        #tutorial-hint.hidden { opacity: 0; }


    </style>
</head>
<body>

    <div class="ide-container" id="ide-container">
        <!-- Title Bar -->
        <div class="title-bar"> <span class="file-name">module_0_review.py</span> </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content-area"> <!-- Added ID for click listener -->
            <!-- Sidebar Placeholder -->
            <div class="sidebar-placeholder"> <i class="fas fa-copy active"></i> <i class="fas fa-search"></i> <i class="fas fa-code-branch"></i> <i class="fas fa-bug"></i> <i class="fas fa-puzzle-piece"></i> </div>
            <!-- Editor & Console -->
            <div class="editor-console-split">
                <div class="editor-pane">
                    <div class="line-numbers" id="line-numbers">1</div>
                    <div class="code-area-wrapper" id="code-area-wrapper"> <div class="code-area" id="code-area"></div> </div>
                    <div class="minimap-placeholder"></div>
                </div>
                <div class="console-pane" id="console-pane"> <span class="placeholder"></span> </div> <!-- Initial message set by JS -->
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar" id="status-bar">
             <div class="status-bar-left"> <span class="git-branch"><i class="fas fa-code-branch"></i> main</span> </div>
             <div class="status-bar-right"> <span id="cursor-pos">Ln 1, Col 1</span> <span>Spaces: 4</span> <span>UTF-8</span> <span class="language"><i class="fab fa-python"></i> Python 3.1x.x</span> </div>
        </div>

         <!-- Center Control Button -->
         <button id="control-button" title="Play"> <!-- Initially Play -->
             <i class="fas fa-play" id="control-icon"></i>
         </button>

         <!-- Navigation Overlay -->
         <div id="nav-overlay">
             <div class="nav-menu">
                 <h3 id="nav-menu-title">Lesson Paused</h3>
                 <div class="button-group">
                     <a href="ctp-knowledge-check-0.html" class="action-button primary"><i class="fas fa-question-circle"></i> Knowledge Check</a>
                     <a href="ctp-theory-0.html" class="action-button secondary"><i class="fas fa-book-open"></i> Review Theory</a>
                     <a href="ctp-practice-0.html" class="action-button secondary"><i class="fas fa-undo-alt"></i> Revisit Basic Practice</a>
                     <a href="ctp-advanced-0.html" class="action-button secondary"><i class="fas fa-redo-alt"></i> Revisit Advanced Practice</a>
                     <a href="ctp.html" class="action-button tertiary"><i class="fas fa-list"></i> Course Menu</a>
                 </div>
             </div>
         </div>

         <!-- Tutorial Hint -->
         <div id="tutorial-hint">Click Play or Screen to Start | Click Screen to Pause/Resume</div>

    </div>

     <!-- Hidden Audio Elements -->
     <div style="display: none;">
        <audio id="audio-ctp-0-a1-eng" src="audio/ctp-0-a1-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a2-eng" src="audio/ctp-0-a2-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a3-eng" src="audio/ctp-0-a3-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a4-eng" src="audio/ctp-0-a4-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a5-eng" src="audio/ctp-0-a5-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a6-eng" src="audio/ctp-0-a6-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a7-eng" src="audio/ctp-0-a7-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a8-eng" src="audio/ctp-0-a8-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a9-eng" src="audio/ctp-0-a9-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a10-eng" src="audio/ctp-0-a10-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a11-eng" src="audio/ctp-0-a11-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a12-eng" src="audio/ctp-0-a12-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a13-eng" src="audio/ctp-0-a13-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a14-eng" src="audio/ctp-0-a14-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a15-eng" src="audio/ctp-0-a15-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a16-eng" src="audio/ctp-0-a16-eng.mp3" preload="auto"></audio>
     </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- Element References ---
        const ideContainer = document.getElementById('ide-container');
        const codeArea = document.getElementById('code-area');
        const consolePane = document.getElementById('console-pane');
        const lineNumbersEl = document.getElementById('line-numbers');
        const statusBar = document.getElementById('status-bar');
        const cursorPosEl = document.getElementById('cursor-pos');
        const codeAreaWrapper = document.getElementById('code-area-wrapper');
        const controlButton = document.getElementById('control-button');
        const controlIcon = document.getElementById('control-icon');
        const navOverlay = document.getElementById('nav-overlay');
        const navMenuTitle = document.getElementById('nav-menu-title');
        const mainContentArea = document.getElementById('main-content-area');
        const tutorialHint = document.getElementById('tutorial-hint');

        // --- State Variables ---
        let currentLineNumber = 1;
        let currentCol = 1;
        let currentContentHTML = '';
        let charWidthEstimate = 9;
        let lineHeightEstimate = 27;
        let simulationStarted = false;
        let isPaused = false;
        let isFinished = false;
        let currentStepIndex = 0;
        let currentAudioElement = null;
        let audioPromiseResolve = null;
        let currentTimeoutId = null; // To clear pauses

        // --- Audio Setup ---
        const audioElements = {};
        document.querySelectorAll('audio[id^="audio-ctp-0-a"]').forEach(el => {
            audioElements[el.id] = el;
             el.onerror = () => console.error(`Error loading audio: ${el.src}`);
             el.addEventListener('ended', handleAudioEnd);
        });

        // --- Helper Functions ---

        function getTextWidth(text, font) { /* ... as before ... */ }
        function updateStatusBarAndCursor() { /* ... as before ... */ }
        function updateLineNumbers() { /* ... as before ... */ }
        function simulateTyping(textToTypeHTML, typingSpeed) {
             // Modified to store and clear interval ID for pausing
             return new Promise((resolve, reject) => {
                 if (isPaused) { resolve(); return; } // Don't start typing if paused

                 codeArea.classList.add('typing');
                 codeArea.classList.remove('idle', 'no-cursor');
                 let charIndex = 0;
                 let currentHTML = currentContentHTML;
                 let intervalId = null; // Store interval ID

                 function typeStep() {
                     if (isPaused) { // Check pause flag within the loop
                         clearInterval(intervalId); // Stop the interval
                          codeArea.classList.remove('typing');
                          codeArea.classList.add('idle'); // Show blinking cursor
                          // Don't resolve yet, wait for resume
                         return;
                     }
                     if (charIndex >= textToTypeHTML.length) {
                         currentContentHTML = currentHTML;
                         codeArea.classList.remove('typing');
                         codeArea.classList.add('idle');
                         updateLineNumbers();
                         updateStatusBarAndCursor();
                         resolve(); // Typing complete
                         return;
                     }
                     // ... (rest of typing logic) ...
                     let nextChar = textToTypeHTML[charIndex];
                     let stepSize = 1;
                     if (nextChar === '<') {
                         const tagEndIndex = textToTypeHTML.indexOf('>', charIndex);
                         if (tagEndIndex !== -1) {
                             stepSize = tagEndIndex - charIndex + 1;
                             nextChar = textToTypeHTML.substring(charIndex, tagEndIndex + 1);
                         }
                     }
                     currentHTML += nextChar;
                     codeArea.innerHTML = currentHTML;
                     updateLineNumbers();
                     updateStatusBarAndCursor();
                     charIndex += stepSize;
                     // Store interval ID before scheduling next step
                     intervalId = setTimeout(typeStep, typingSpeed);
                 }
                 // Start the first step
                 intervalId = setTimeout(typeStep, typingSpeed);
             });
        }
        function showOutput(outputLines, isInfo = false, isError = false) { /* ... as before ... */ }
        function clearConsole() { /* ... as before ... */ }
        function clearEditor() { /* ... as before ... */ }

        async function playAudio(audioId) {
            // Modified to handle pausing/resuming
            return new Promise(async (resolve, reject) => {
                if (isPaused) { resolve(); return; } // Don't play if paused

                currentAudioElement = audioElements[audioId];
                audioPromiseResolve = resolve;

                if (!currentAudioElement) {
                    console.warn(`Audio ${audioId} not found.`);
                    resolve(); return;
                }
                try {
                    // If resuming, don't reset time
                    if(currentAudioElement.paused && currentAudioElement.currentTime > 0) {
                         await currentAudioElement.play();
                         console.log(`Resuming audio: ${audioId}`);
                    } else {
                        currentAudioElement.currentTime = 0;
                        await currentAudioElement.play();
                        console.log(`Playing audio: ${audioId}`);
                    }
                    // Resolve is handled by 'handleAudioEnd'
                } catch (error) {
                    console.error(`Error playing ${audioId}:`, error);
                    currentAudioElement = null;
                    audioPromiseResolve = null;
                    reject(error);
                }
            });
        }

        function handleAudioEnd(event) {
             console.log(`Audio ended: ${event.target.id}`);
             if (audioPromiseResolve) {
                 audioPromiseResolve();
                 audioPromiseResolve = null;
             }
             // Only clear if this specific audio finished
             if (currentAudioElement === event.target) {
                currentAudioElement = null;
             }
         }

        async function pause(duration) {
            // Modified pause to be cancellable and respect isPaused
             return new Promise((resolve) => {
                 codeArea.classList.add('idle');
                 codeArea.classList.remove('typing', 'no-cursor');
                 updateStatusBarAndCursor();

                 let elapsed = 0;
                 const interval = 50; // Check more frequently for responsiveness

                 // Clear any existing pause timeout
                 if (currentTimeoutId) { clearTimeout(currentTimeoutId); }

                 function checkPause() {
                     if (isPaused) {
                         // If paused, reschedule the check without incrementing time
                         currentTimeoutId = setTimeout(checkPause, interval);
                         return;
                     }
                     elapsed += interval;
                     if (elapsed >= duration) {
                         resolve();
                     } else {
                         currentTimeoutId = setTimeout(checkPause, interval); // Schedule next check
                     }
                 }
                 currentTimeoutId = setTimeout(checkPause, interval); // Start the checks
             });
         }

        // --- THE LESSON SCRIPT (Sequential Order a1-a16) ---
        const audioDurations = { /* ... same durations map ... */ };
        const lessonScript = [ /* ... same script structure as previous version ... */
            // --- Segment 1: Intro (a1) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a1-eng' },
            { type: 'pause', duration: 1500, note: "Short pause before typing" },
            { type: 'typeCode', content: `<span class="hl-comment"># Module 0 Review: print() and comments</span>\n\n`, speed: 70 },
            // Wait handled by await playAudio

            // --- Segment 2: Review Concepts (a2) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a2-eng' },
            // Wait handled by await playAudio

            // --- Segment 3: Introduce print(), basic structure (a3) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a3-eng' },
            { type: 'pause', duration: 11000, note: "Pause until 'looks like this:'" },
            { type: 'typeCode', content: `<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"..."</span><span class="hl-paren">)</span>`, speed: 90 },
            // Wait handled by await playAudio

             // --- Segment 4: Break down print() (a4 - Long) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a4-eng' },
            { type: 'pause', duration: 5000, note: "Pause while explaining 'print'" },
             { type: 'clearEditor' }, { type: 'pause', duration: 100},
             { type: 'typeCode', content: `<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"Hello, World!"</span><span class="hl-paren">)</span>`, speed: 80 },
            // Wait handled by await playAudio

            // --- Segment 5: Run code, print different things (a5) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a5-eng' },
            { type: 'runCode', output: ["Hello, World!"] },
            { type: 'pause', duration: 2000, note: "Pause after run"},
            { type: 'typeCode', content: `\n<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"Python is powerful."</span><span class="hl-paren">)</span>`, speed: 70 },
             // Wait handled by await playAudio

            // --- Segment 6: Blank line explanation (a6) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a6-eng' },
            { type: 'typeCode', content: `\n<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"Practice is essential."</span><span class="hl-paren">)</span>`, speed: 70 },
            { type: 'pause', duration: 3000, note: "Pause after typing examples"},
            { type: 'typeCode', content: `\n\n<span class="hl-comment"># Adding a blank line</span>\n`, speed: 60 },
            { type: 'typeCode', content: `<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-paren">)</span>`, speed: 95 },
             // Wait handled by await playAudio

            // --- Segment 7: Multi-line explanation (a7) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a7-eng' },
             { type: 'runCode', output: ["Hello, World!", "Python is powerful.", "Practice is essential!", ""] },
             { type: 'pause', duration: 3000, note: "Show blank line output"},
             { type: 'typeCode', content: `\n<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"This appears after the space."</span><span class="hl-paren">)</span>`, speed: 70 },
             // Wait handled by await playAudio

            // --- Segment 8: Default behavior (new line) (a8) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a8-eng' },
            { type: 'runCode', output: ["Hello, World!", "Python is powerful.", "Practice is essential!", "", "This appears after the space."]},
            // Wait handled by await playAudio

            // --- Segment 9: Introduce comments (a9) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a9-eng' },
            { type: 'clearEditor' }, { type: 'clearConsole' }, { type: 'pause', duration: 1000 },
            { type: 'typeCode', content: `<span class="hl-comment"># This is a full-line comment.</span>\n`, speed: 60 },
             // Wait handled by await playAudio

            // --- Segment 10: Run comment (no output), explain usefulness, end-of-line (a10) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a10-eng' },
            { type: 'runCode', output: ["(No output from comments)"], isInfo: true },
            { type: 'pause', duration: 5000, note: "Pause after running comment" },
            { type: 'typeCode', content: `<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"Processing data..."</span><span class="hl-paren">)</span> `, speed: 70 },
            { type: 'typeCode', content: `<span class="hl-comment"># End-of-line comment</span>`, speed: 55 },
             // Wait handled by await playAudio

            // --- Segment 11: Run code with end-of-line comment (a11) ---
             { type: 'playAudio', audioId: 'audio-ctp-0-a11-eng' },
             { type: 'runCode', output: ["Processing data..."] },
             // Wait handled by await playAudio

            // --- Segment 12: Explain end-of-line result, commented-out code (a12) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a12-eng' },
             { type: 'pause', duration: 10000, note: "Pause during explanation"},
             { type: 'typeCode', content: `\n<span class="hl-comment"># print("Old debug message") # Temporarily disabled</span>`, speed: 55 },
             // Wait handled by await playAudio

            // --- Segment 13: Syntax errors intro + ADDED 1s pause (a13) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a13-eng' },
            { type: 'clearEditor' }, { type: 'clearConsole' }, { type: 'pause', duration: 500 },
            { type: 'typeCode', content: `<span class="hl-comment"># Finally: Syntax is important!</span>\n`, speed: 65 },
             { type: 'pause', duration: 1000, note: "ADDED 1s pause after 'Finally'" },
             // Wait handled by await playAudio

            // --- Segment 14: Syntax recap (a14) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a14-eng' },
            { type: 'typeCode', content: `<span class="hl-comment"># - print (lowercase)</span>\n<span class="hl-comment"># - () Parentheses</span>\n<span class="hl-comment"># - "" or '' Quotes for text</span>`, speed: 65 },
             // Wait handled by await playAudio

            // --- Segment 15: Review wrap-up (a15) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a15-eng' },
            { type: 'clearEditor' }, { type: 'pause', duration: 300 },
            { type: 'typeCode', content: `<span class="hl-comment"># You've mastered the basics!</span>\n`, speed: 60 },
            { type: 'pause', duration: 500 },
            { type: 'typeCode', content: `<span class="hl-keyword">print</span><span class="hl-paren">(</span><span class="hl-string">"Module 0 Complete!"</span><span class="hl-paren">)</span>`, speed: 70 },
            { type: 'pause', duration: 1000 },
            { type: 'runCode', output: ["Module 0 Complete!"] },
            // Wait handled by await playAudio

            // --- Segment 16: Final conclusion/next steps (a16) ---
            { type: 'playAudio', audioId: 'audio-ctp-0-a16-eng' },
            { type: 'clearConsole'}, { type: 'pause', duration: 500 },
            { type: 'showOutput', output: ["Great job!", "Next: Knowledge Check & Module 1!"], isInfo: true},
            // Wait handled by await playAudio

            { type: 'end', note: "End of Simulation" }
        ];

        // --- AUTOPLAY EXECUTION & CONTROL LOGIC ---
        let stopExecution = false;

        async function executeScript() {
             if (!simulationStarted) return; // Should not happen if start logic is correct
             // console.log("Execute Script - Current Index:", currentStepIndex);
             // console.log("Is Paused:", isPaused, "Is Finished:", isFinished);

             if (isPaused || isFinished) { // Don't proceed if paused or finished
                 console.log("Execution halted (paused or finished).");
                 return;
             }

             showNavMenu(false); // Ensure menu is hidden when playing
             controlButton.classList.add('hidden'); // Hide button during playback

             // --- Main Execution Loop ---
             while (currentStepIndex < lessonScript.length && !stopExecution) {
                 // --- Pause Check ---
                 if (isPaused) {
                      console.log("Execution paused at step:", currentStepIndex);
                      // Ensure audio is paused if it was playing
                      if (currentAudioElement && !currentAudioElement.paused) {
                           currentAudioElement.pause();
                           console.log("Audio paused due to script pause.");
                      }
                      return; // Stop this execution path, wait for resume
                 }

                 const step = lessonScript[currentStepIndex];
                 // console.log(`Executing Step ${currentStepIndex}: ${step.type} - ${step.note || ''}`);
                 codeArea.classList.remove('idle', 'typing', 'no-cursor');

                 try {
                     switch (step.type) {
                         case 'playAudio':
                             await playAudio(step.audioId); // This now waits for audio to END
                             break;
                         case 'typeCode':
                             await simulateTyping(step.content, step.speed || 75);
                             break;
                         case 'runCode':
                             await pause(200); // Brief visual pause before output
                             await showOutput(step.output, step.isInfo || false, step.isError || false);
                             break;
                         case 'clearConsole': await clearConsole(); break;
                         case 'clearEditor': await clearEditor(); break;
                         case 'pause': await pause(step.duration || 1000); break;
                         case 'end':
                             isFinished = true;
                             showEndState();
                             stopExecution = true;
                             console.log("Script finished normally.");
                             break; // Exit switch
                         default:
                             console.warn(`Unknown step type: ${step.type}`); await pause(100);
                     }
                 } catch (error) {
                      console.error("Error during script execution:", error);
                      showOutput(["An error occurred during playback."], false, true);
                      stopExecution = true; // Stop on error
                      isFinished = true; // Treat error as finish state
                      showEndState(); // Show menu on error
                 }

                 if (step.type !== 'end' && !stopExecution) {
                      codeArea.classList.add('idle');
                      codeArea.classList.remove('typing', 'no-cursor');
                       updateStatusBarAndCursor();
                  }

                 if (!stopExecution) {
                    currentStepIndex++;
                 }
             } // End while loop

             // This part might be redundant now if 'end' handles it
             if (!isFinished && !stopExecution) {
                  isFinished = true;
                  showEndState();
                  console.log("Script loop completed.");
              }
        }

        function setControlButtonState(state) { // 'play', 'pause', 'restart'
            switch (state) {
                case 'play':
                    controlIcon.className = 'fas fa-play'; controlButton.title = 'Resume'; break;
                case 'pause':
                    controlIcon.className = 'fas fa-pause'; controlButton.title = 'Pause'; break;
                 case 'restart':
                    controlIcon.className = 'fas fa-redo-alt'; controlButton.title = 'Restart Lesson'; break;
            }
        }

        function showNavMenu(show = true, title = "Lesson Paused") {
             navMenuTitle.textContent = title;
             navOverlay.classList.toggle('visible', show);
         }

        function showEndState() {
             console.log("Showing end state");
             setControlButtonState('restart');
             controlButton.classList.remove('hidden'); // Show restart button
             codeArea.classList.add('no-cursor');
             codeArea.classList.remove('idle', 'typing');
             showNavMenu(true, "Lesson Finished");
             if (currentAudioElement) { currentAudioElement.pause(); currentAudioElement.currentTime = 0; }
             currentAudioElement = null;
             if (currentTimeoutId) { clearTimeout(currentTimeoutId); currentTimeoutId = null;} // Clear any pending pause
        }

        function togglePause(event) {
             if (!simulationStarted || isFinished) return;
             // Prevent pause if click is on the navigation menu itself
             if (event && navOverlay.contains(event.target)) return;

            isPaused = !isPaused;
            console.log(isPaused ? "Pausing..." : "Resuming...");

            if (isPaused) {
                if (currentAudioElement) { currentAudioElement.pause(); }
                if (currentTimeoutId) { clearTimeout(currentTimeoutId); currentTimeoutId = null;} // Clear pending pause
                setControlButtonState('play');
                controlButton.classList.remove('hidden'); // Show play button
                 showNavMenu(true, "Lesson Paused");
            } else {
                 showNavMenu(false); // Hide menu
                 controlButton.classList.add('hidden'); // Hide button while playing
                if (currentAudioElement) {
                    currentAudioElement.play().catch(e => console.error("Resume play error", e));
                }
                 setControlButtonState('pause'); // Set state for next pause
                 // Resume execution loop (needs slight adjustment if paused mid-step)
                 // For simplicity, we restart the executeScript loop from the current index
                 // This might cause slight visual jump if paused mid-typing, but easier than complex state saving
                 console.log("Resuming script from step:", currentStepIndex);
                 executeScript(); // Re-enter the loop
            }
        }

        function restartSimulation() {
             console.log("Restarting simulation...");
             stopExecution = true; // Signal current loop to stop
             if (currentAudioElement) { currentAudioElement.pause(); currentAudioElement.onended = null; currentAudioElement.currentTime = 0; }
             if (audioPromiseResolve) { audioPromiseResolve(); audioPromiseResolve = null; }
             currentAudioElement = null;
             if (currentTimeoutId) { clearTimeout(currentTimeoutId); currentTimeoutId = null;}

            // Reset state
            currentStepIndex = 0;
            isPaused = false;
            isFinished = false;
            currentContentHTML = '';

             setTimeout(async () => { // Use async for await inside
                 await clearEditor();
                 await clearConsole();
                 showNavMenu(false);
                 codeArea.classList.add('idle');
                 controlButton.classList.add('hidden'); // Hide button initially for restart

                 stopExecution = false;
                 simulationStarted = true; // It has started
                 executeScript(); // Start from beginning
             }, 150); // Delay to ensure cleanup
        }

        // --- Event Listeners ---
        controlButton.addEventListener('click', () => {
            if (!simulationStarted) {
                 startSimulation();
            } else if (isFinished) {
                restartSimulation();
            } else {
                togglePause();
            }
        });

         // Click on main content area to toggle pause/play (but not overlay)
         mainContentArea.addEventListener('click', (event) => {
             if (simulationStarted && !isFinished && !navOverlay.contains(event.target) && !controlButton.contains(event.target)) {
                 togglePause(event);
             }
         });


        // --- Initial State & Start Trigger ---
        function initializeLesson() {
             console.log("Initializing lesson state.");
             simulationStarted = false; // Not started yet
             isPaused = false;
             isFinished = false;
             currentStepIndex = 0;
             currentContentHTML = ''; // Clear content state
             if (currentTimeoutId) clearTimeout(currentTimeoutId); // Clear any leftover timer
              // Reset UI elements
              codeArea.innerHTML = '';
              consolePane.innerHTML = '<span class="placeholder">Click the Play button or screen to start...</span>';
              updateLineNumbers();
              updateStatusBarAndCursor();
              codeArea.classList.add('idle'); codeArea.classList.remove('no-cursor', 'typing');
              controlButton.classList.remove('hidden'); // Show initial Play button
              setControlButtonState('play');
              showNavMenu(false); // Ensure menu is hidden
              tutorialHint.classList.remove('hidden'); // Show hint
               // Reset all audio elements
               Object.values(audioElements).forEach(audio => {
                 if (audio) {
                     audio.pause();
                     audio.currentTime = 0;
                     audio.onended = handleAudioEnd; // Re-attach listener if needed
                 }
             });
             currentAudioElement = null;
             audioPromiseResolve = null;
        }


        function startSimulation() {
            if (simulationStarted) return;
            simulationStarted = true;

             // Remove interaction listeners if needed (already done by calling function)
             // document.body.removeEventListener('click', startSimulation);
             // document.body.removeEventListener('keydown', startSimulation);

            console.log("User interaction detected, starting simulation...");
            consolePane.innerHTML = '<span class="placeholder">Starting lesson...</span>';
            tutorialHint.classList.add('hidden'); // Hide hint
            controlButton.classList.add('hidden'); // Hide central button during playback
            setControlButtonState('pause'); // Set icon for when pause occurs

             // Unlock audio context
             const context = new (window.AudioContext || window.webkitAudioContext)();
             if (context.state === 'suspended') { context.resume(); }
             Object.values(audioElements).forEach(audio => {
                 audio.load();
                 const promise = audio.play();
                 if (promise !== undefined) { promise.then(_ => { audio.pause(); }).catch(() => {}); }
             });

            executeScript(); // Start the main execution loop
        }

        // Initial prompt for user interaction
        initializeLesson(); // Set initial state
         // No need for body listeners now, the button handles the start
         // document.body.addEventListener('click', startSimulation, { once: true });
         // document.body.addEventListener('keydown', startSimulation, { once: true });

    }); // End DOMContentLoaded
    </script>

</body>
</html>
