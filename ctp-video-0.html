<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 0: Lesson Simulation - Controlled Timed IDE (Extra Pacing)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --bg-base: #181a1f;
            --bg-panel: #21252b;
            --bg-editor: #282c34;
            --bg-console: #1f2328;
            --text-primary: #abb2bf;
            --text-secondary: #5c6370;
            --text-highlight: #e5c07b;
            --border-color: #3a3f4b;
            --cursor-color: #528bff;
            --scrollbar-thumb: #4b5263;
            --scrollbar-track: var(--bg-panel);
            --hl-keyword: #c678dd;
            --hl-string: #98c379;
            --hl-comment: var(--text-secondary);
            --hl-function: #61afef; /* Function highlighting not implemented in this simple version */
            --hl-paren: var(--text-primary);
            --hl-number: #d19a66; /* Number highlighting not implemented */
            --hl-output: #a0e8ff;
            --hl-error: #e06c75;
            --sidebar-bg: var(--bg-base);
            --statusbar-bg: #1b1d23;
            --statusbar-text: var(--text-secondary);
            --titlebar-bg: var(--bg-base);
            --titlebar-text: var(--text-secondary);
            --font-code: 'Fira Code', 'Courier New', Courier, monospace;
            --font-ui: 'Roboto', sans-serif;
            --transition-speed: 0.3s;
            --typing-cursor-height: 1.4em;
            --line-height-editor: 1.7;
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --border-radius: 8px;
        }

        /* --- Reset & Base --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg-base); font-family: var(--font-ui); color: var(--text-primary); }

        /* --- IDE Layout --- */
        .ide-container { display: flex; flex-direction: column; width: 100vw; height: 100vh; background-color: var(--bg-base); position: relative; }

        /* --- Title Bar --- */
        .title-bar { background-color: var(--titlebar-bg); padding: 8px 15px; color: var(--titlebar-text); font-size: 0.9em; text-align: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: relative; }
        .title-bar .file-name { font-weight: 500; color: var(--text-primary); }

        /* --- Main Content Area --- */
        .main-content { display: flex; flex-grow: 1; overflow: hidden; }

        /* --- Sidebar Placeholder --- */
        .sidebar-placeholder { width: 50px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 25px; }
        .sidebar-placeholder i { font-size: 1.4em; color: var(--text-secondary); opacity: 0.6; }
        .sidebar-placeholder i.active { color: var(--text-primary); opacity: 1; }

        /* --- Editor & Console Split --- */
        .editor-console-split { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }

        /* --- Editor Pane --- */
        .editor-pane { flex-grow: 1; background-color: var(--bg-editor); display: flex; overflow: hidden; position: relative; min-height: 150px; }
        .line-numbers { font-family: var(--font-code); font-size: 1em; line-height: var(--line-height-editor); color: var(--text-secondary); text-align: right; padding: 15px 15px 15px 10px; user-select: none; background-color: var(--bg-editor); border-right: 1px solid var(--border-color); white-space: pre; overflow: hidden; flex-shrink: 0; }
        .code-area-wrapper { flex-grow: 1; overflow-y: auto; padding: 15px; position: relative; }
        .code-area { font-family: var(--font-code); font-size: 1em; line-height: var(--line-height-editor); color: var(--text-primary); white-space: pre; outline: none; min-height: 100%; position: relative; }

        /* --- Minimap --- */
        .minimap-placeholder { position: absolute; top: 0; right: 0; bottom: 0; width: 80px; background-color: rgba(0, 0, 0, 0.1); border-left: 1px solid var(--border-color); flex-shrink: 0; overflow: hidden; opacity: 0.5; pointer-events: none; }
        .minimap-placeholder::before { content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; background: linear-gradient( rgba(255,255,255,0.08) 1px, transparent 1px ); background-size: 100% 4px; }

        /* --- Cursor --- */
        .code-area::after { content: ''; display: block; width: 2px; background-color: var(--cursor-color); position: absolute; opacity: 0; transition: opacity 0.1s ease-out, top 0.05s linear, left 0.05s linear; border-radius: 1px; box-shadow: 0 0 5px var(--cursor-color); }
        .code-area.typing::after { opacity: 1; animation: none; top: var(--cursor-top, 0px); left: var(--cursor-left, 0px); height: var(--cursor-height, 1.4em); }
        .code-area.idle::after { opacity: 1; animation: blink 1.1s steps(1) infinite; top: var(--cursor-top, 0px); left: var(--cursor-left, 0px); height: var(--cursor-height, 1.4em); }
        .code-area.no-cursor::after { opacity: 0; animation: none; }
        @keyframes blink { 50% { opacity: 0; } }

        /* --- Console Pane --- */
        .console-pane { height: 30%; max-height: 350px; min-height: 120px; background-color: var(--bg-console); border-top: 1px solid var(--border-color); color: var(--text-primary); font-family: var(--font-code); font-size: 0.95em; line-height: 1.6; padding: 10px 15px; overflow-y: auto; flex-shrink: 0; white-space: pre-wrap; word-wrap: break-word; }
        .console-pane .output-line { color: var(--hl-output); }
        .console-pane .error-line { color: var(--hl-error); font-weight: bold;}
        .console-pane .placeholder { color: var(--text-secondary); font-style: italic; }
        .console-pane .info-line { color: var(--text-secondary); font-style: italic;}
        .console-prompt { color: var(--text-secondary); margin-right: 8px; user-select: none;}

        /* --- Status Bar --- */
        .status-bar { background-color: var(--statusbar-bg); color: var(--statusbar-text); padding: 5px 15px; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); flex-shrink: 0; white-space: nowrap; }
        .status-bar-left, .status-bar-right { display: flex; gap: 15px; align-items: center; }
        .status-bar i { margin-right: 5px; font-size: 1.1em; vertical-align: middle;}
        .status-bar .git-branch i { color: #e8ae59; }
        .status-bar .language i { color: #61afef; }

        /* --- Syntax Highlighting --- */
        .hl-keyword { color: var(--hl-keyword); font-weight: 500; }
        .hl-string { color: var(--hl-string); }
        .hl-comment { color: var(--hl-comment); font-style: italic; }
        .hl-paren { color: var(--hl-paren); }
        /* Add other .hl-* styles if needed */


        /* --- Scrollbar Styling --- */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #5a6375; }
        ::-webkit-scrollbar-corner { background: var(--scrollbar-track); }

        /* --- Pause/Play/Restart Button --- */
        #control-button { position: absolute; top: 55px; right: 20px; z-index: 100; background-color: rgba(40, 44, 52, 0.7); color: var(--text-secondary); border: 1px solid rgba(58, 63, 75, 0.5); border-radius: 50%; width: 36px; height: 36px; font-size: 1em; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: none; transition: background-color var(--transition-speed), color var(--transition-speed), opacity var(--transition-speed); opacity: 0.6; }
        #control-button:hover { opacity: 1; background-color: rgba(40, 44, 52, 0.9); color: var(--text-primary); }
        #control-button.hidden { display: none; }

        /* --- Navigation Overlay & Menu --- */
        #nav-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--overlay-bg); z-index: 90; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity var(--transition-speed) ease-in-out; }
        #nav-overlay.visible { opacity: 1; pointer-events: auto; }
        .nav-menu { background-color: var(--bg-panel); padding: 25px 35px; border-radius: var(--border-radius); text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .nav-menu h3 { color: var(--text-highlight); margin-bottom: 20px; font-size: 1.4em; }
        .nav-menu .button-group { display: flex; flex-direction: column; gap: 15px; margin-top: 0; }
        .nav-menu .action-button { display: block; text-decoration: none; padding: 10px 20px; font-size: 1em; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color var(--transition-speed), transform 0.1s ease; text-align: center; }
        .nav-menu .action-button i { margin-right: 8px; }
        .nav-menu .action-button .btn-text { vertical-align: middle; }
        .nav-menu .action-button.primary { background-color: var(--hl-output); color: var(--bg-base); }
        .nav-menu .action-button.primary:hover { background-color: #b3f0ff; }
        .nav-menu .action-button.secondary { background-color: var(--text-secondary); }
        .nav-menu .action-button.secondary:hover { background-color: #7a828e; }
        .nav-menu .action-button.tertiary { background-color: var(--border-color); font-size: 0.9em; padding: 8px 15px; }
        .nav-menu .action-button.tertiary:hover { background-color: #4b5263; }
        .nav-menu .action-button:active { transform: scale(0.98); }

        /* --- Language Selector (Links) --- */
        .language-selector { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: center; gap: 10px; }
        a.language-button { display: inline-block; text-decoration: none; background-color: var(--border-color); color: var(--text-primary); border: 1px solid var(--text-secondary); padding: 5px 12px; font-size: 0.85em; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s, box-shadow 0.2s; opacity: 0.7; }
        a.language-button:hover { background-color: #4b5263; border-color: var(--text-primary); opacity: 1; box-shadow: 0 0 5px rgba(97, 175, 239, 0.3); /* hl-function blue hint */ }
        a.language-button.active { background-color: var(--hl-function); color: var(--bg-base); border-color: var(--hl-function); opacity: 1; font-weight: 500; cursor: default; }

    </style>
</head>
<body>

    <div class="ide-container" id="ide-container">
        <!-- Title Bar -->
        <div class="title-bar"> <span class="file-name">module_0_review.py</span> </div>
        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar Placeholder -->
            <div class="sidebar-placeholder"> <i class="fas fa-copy active"></i> <i class="fas fa-search"></i> <i class="fas fa-code-branch"></i> <i class="fas fa-bug"></i> <i class="fas fa-puzzle-piece"></i> </div>
            <!-- Editor & Console -->
            <div class="editor-console-split">
                <div class="editor-pane">
                    <div class="line-numbers" id="line-numbers">1</div>
                    <div class="code-area-wrapper" id="code-area-wrapper"> <div class="code-area" id="code-area"></div> </div>
                    <div class="minimap-placeholder"></div>
                     <!-- Pause/Play/Restart Button -->
                     <button id="control-button" class="hidden" title="Play/Pause">
                         <i class="fas fa-pause" id="control-icon"></i>
                     </button>
                </div>
                <div class="console-pane" id="console-pane"> <span id="console-placeholder" class="placeholder">Loading...</span> </div>
            </div>
        </div>
        <!-- Status Bar -->
        <div class="status-bar" id="status-bar">
             <div class="status-bar-left"> <span class="git-branch"><i class="fas fa-code-branch"></i> main</span> </div>
             <div class="status-bar-right"> <span id="cursor-pos">Ln 1, Col 1</span> <span>Spaces: 4</span> <span>UTF-8</span> <span class="language"><i class="fab fa-python"></i> Python 3.1x.x</span> </div>
        </div>

         <!-- Navigation Overlay -->
         <div id="nav-overlay">
             <div class="nav-menu">
                 <h3 id="nav-menu-title">Lesson Paused</h3>
                 <div class="button-group">
                     <a id="knowledge-check-btn" href="ctp-knowledge-check-0.html" class="action-button primary"><i class="fas fa-question-circle"></i> <span class="btn-text">Knowledge Check</span></a>
                     <a id="review-theory-btn" href="ctp-theory-0.html" class="action-button secondary"><i class="fas fa-book-open"></i> <span class="btn-text">Review Theory</span></a>
                     <a id="revisit-basic-btn" href="ctp-practice-0.html" class="action-button secondary"><i class="fas fa-undo-alt"></i> <span class="btn-text">Revisit Basic Practice</span></a>
                     <a id="revisit-advanced-btn" href="ctp-advanced-0.html" class="action-button secondary"><i class="fas fa-redo-alt"></i> <span class="btn-text">Revisit Advanced Practice</span></a>
                     <a id="course-menu-btn" href="ctp.html" class="action-button tertiary"><i class="fas fa-list"></i> <span class="btn-text">Course Menu</span></a>
                 </div>
                 <!-- Language Selector (Links) -->
                 <div class="language-selector">
                     <a href="#" id="lang-eng-link" class="language-button" data-lang="eng">English</a>
                     <a href="#" id="lang-pt-link" class="language-button" data-lang="pt">Português</a>
                     <a href="#" id="lang-cn-link" class="language-button" data-lang="cn">中文</a>
                 </div>
             </div>
         </div>

    </div>

     <!-- Hidden Audio Elements (Unchanged) -->
     <div style="display: none;">
        <audio id="audio-ctp-0-a1-eng" src="audio/ctp-0-a1-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a1-pt" src="audio/ctp-0-a1-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a1-cn" src="audio/ctp-0-a1-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a2-eng" src="audio/ctp-0-a2-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a2-pt" src="audio/ctp-0-a2-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a2-cn" src="audio/ctp-0-a2-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a3-eng" src="audio/ctp-0-a3-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a3-pt" src="audio/ctp-0-a3-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a3-cn" src="audio/ctp-0-a3-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a4-eng" src="audio/ctp-0-a4-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a4-pt" src="audio/ctp-0-a4-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a4-cn" src="audio/ctp-0-a4-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a5-eng" src="audio/ctp-0-a5-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a5-pt" src="audio/ctp-0-a5-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a5-cn" src="audio/ctp-0-a5-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a6-eng" src="audio/ctp-0-a6-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a6-pt" src="audio/ctp-0-a6-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a6-cn" src="audio/ctp-0-a6-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a7-eng" src="audio/ctp-0-a7-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a7-pt" src="audio/ctp-0-a7-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a7-cn" src="audio/ctp-0-a7-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a8-eng" src="audio/ctp-0-a8-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a8-pt" src="audio/ctp-0-a8-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a8-cn" src="audio/ctp-0-a8-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a9-eng" src="audio/ctp-0-a9-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a9-pt" src="audio/ctp-0-a9-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a9-cn" src="audio/ctp-0-a9-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a10-eng" src="audio/ctp-0-a10-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a10-pt" src="audio/ctp-0-a10-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a10-cn" src="audio/ctp-0-a10-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a11-eng" src="audio/ctp-0-a11-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a11-pt" src="audio/ctp-0-a11-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a11-cn" src="audio/ctp-0-a11-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a12-eng" src="audio/ctp-0-a12-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a12-pt" src="audio/ctp-0-a12-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a12-cn" src="audio/ctp-0-a12-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a13-eng" src="audio/ctp-0-a13-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a13-pt" src="audio/ctp-0-a13-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a13-cn" src="audio/ctp-0-a13-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a14-eng" src="audio/ctp-0-a14-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a14-pt" src="audio/ctp-0-a14-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a14-cn" src="audio/ctp-0-a14-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a15-eng" src="audio/ctp-0-a15-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a15-pt" src="audio/ctp-0-a15-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a15-cn" src="audio/ctp-0-a15-cn.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a16-eng" src="audio/ctp-0-a16-eng.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a16-pt" src="audio/ctp-0-a16-pt.mp3" preload="auto"></audio>
        <audio id="audio-ctp-0-a16-cn" src="audio/ctp-0-a16-cn.mp3" preload="auto"></audio>
     </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- Element References (Unchanged) ---
        const codeArea = document.getElementById('code-area');
        const consolePane = document.getElementById('console-pane');
        const lineNumbersEl = document.getElementById('line-numbers');
        const cursorPosEl = document.getElementById('cursor-pos');
        const codeAreaWrapper = document.getElementById('code-area-wrapper');
        const controlButton = document.getElementById('control-button');
        const controlIcon = document.getElementById('control-icon');
        const navOverlay = document.getElementById('nav-overlay');
        const navMenuTitle = document.getElementById('nav-menu-title');
        const knowledgeCheckBtnText = document.querySelector('#knowledge-check-btn .btn-text');
        const reviewTheoryBtnText = document.querySelector('#review-theory-btn .btn-text');
        const revisitBasicBtnText = document.querySelector('#revisit-basic-btn .btn-text');
        const revisitAdvancedBtnText = document.querySelector('#revisit-advanced-btn .btn-text');
        const courseMenuBtnText = document.querySelector('#course-menu-btn .btn-text');
        const consolePlaceholderEl = document.getElementById('console-placeholder');
        const langEngLink = document.getElementById('lang-eng-link');
        const langPtLink = document.getElementById('lang-pt-link');
        const langCnLink = document.getElementById('lang-cn-link');
        const languageLinks = [langEngLink, langPtLink, langCnLink];


        // --- State Variables (Unchanged) ---
        let currentLineNumber = 1;
        let currentCol = 1;
        let currentContentHTML = '';
        let lineHeightEstimate = 0;
        let simulationStarted = false;
        let isPaused = false;
        let isFinished = false;
        let currentStepIndex = 0;
        let currentAudioElement = null;
        let currentTimeoutId = null;
        let stopExecution = false;
        let currentLanguage = localStorage.getItem('lessonLanguage') || 'eng';

        // --- Language Content Store (Unchanged) ---
        const lessonContent = {
            eng: { /* ... content ... */
                menuTitlePaused: "Lesson Paused", menuTitleFinished: "Lesson Finished", menuTitleError: "Error Occurred", menuTitleInterrupted: "Lesson Interrupted",
                knowledgeCheckBtn: "Knowledge Check", reviewTheoryBtn: "Review Theory", revisitBasicBtn: "Revisit Basic Practice", revisitAdvancedBtn: "Revisit Advanced Practice", courseMenuBtn: "Course Menu",
                langEngBtn: "English", langPtBtn: "Português", langCnBtn: "中文",
                consolePlaceholderReady: "Python Console Ready... [Click to Start Lesson]", consolePlaceholderStarting: "Starting lesson...", consolePlaceholderPlaying: "Lesson playing...", consolePlaceholderCleared: "Console cleared.", consolePlaceholderRestarting: "Restarting lesson...",
                codeCommentIntro: `# Module 0 Review: print() and comments\n\n`, codePrintEllipsis: `print("...")`, codeHelloWorld: `print("Hello, World!")`,
                consoleHelloWorld: ["Hello, World!"], codePythonPowerful: `print("Python is powerful.")`, codePracticePerfect: `print("Practice makes perfect!")`,
                codeBlankLineComment: `# Adding a blank line\n`, codeBlankPrint: `print()`, consoleMultiLineOutput: ["Hello, World!", "Python is powerful.", "Practice makes perfect!", ""],
                codeAfterSpace: `print("This appears after the space.")`, consoleAfterSpaceOutput: ["Hello, World!", "Python is powerful.", "Practice makes perfect!", "", "This appears after the space."],
                codeFullLineComment: `# This is a full-line comment.\n`, consoleNoOutput: ["(No output from comments)"], codeProcessingData: `print("Processing data...")`,
                codeEndOfLineComment: ` # End-of-line comment`, consoleProcessingOutput: ["Processing data..."], codeCommentedOutPrint: `# print("Old debug message") # Temporarily disabled`,
                codeSyntaxImportant: `# Finally: Syntax is important!\n`, codeSyntaxRules: `# - print (lowercase)\n# - () Parentheses\n# - "" or '' Quotes for text`,
                codeMasteredBasics: `# You've mastered the basics!\n`, codeModuleComplete: `print("Module 0 Complete!")`, consoleModuleComplete: ["Module 0 Complete!"],
                consoleGreatJob: ["Great job!", "Next: Knowledge Check"], errorGeneric: "An error occurred: ",
            },
            pt: { /* ... content ... */
                 menuTitlePaused: "Lição Pausada", menuTitleFinished: "Lição Concluída", menuTitleError: "Ocorreu um Erro", menuTitleInterrupted: "Lição Interrompida",
                knowledgeCheckBtn: "Verificação de Conhecimento", reviewTheoryBtn: "Revisar Teoria", revisitBasicBtn: "Revisitar Prática Básica", revisitAdvancedBtn: "Revisitar Prática Avançada", courseMenuBtn: "Menu do Curso",
                langEngBtn: "English", langPtBtn: "Português", langCnBtn: "中文",
                consolePlaceholderReady: "Console Python Pronto... [Clique para Iniciar a Lição]", consolePlaceholderStarting: "Iniciando lição...", consolePlaceholderPlaying: "Lição em andamento...", consolePlaceholderCleared: "Console limpo.", consolePlaceholderRestarting: "Reiniciando lição...",
                codeCommentIntro: `# Revisão Módulo 0: print() e comentários\n\n`, codePrintEllipsis: `print("...")`, codeHelloWorld: `print("Olá, Mundo!")`,
                consoleHelloWorld: ["Olá, Mundo!"], codePythonPowerful: `print("Python é poderoso.")`, codePracticePerfect: `print("A prática leva à perfeição!")`,
                codeBlankLineComment: `# Adicionando uma linha em branco\n`, codeBlankPrint: `print()`, consoleMultiLineOutput: ["Olá, Mundo!", "Python é poderoso.", "A prática leva à perfeição!", ""],
                codeAfterSpace: `print("Isso aparece após o espaço.")`, consoleAfterSpaceOutput: ["Olá, Mundo!", "Python é poderoso.", "A prática leva à perfeição!", "", "Isso aparece após o espaço."],
                codeFullLineComment: `# Este é um comentário de linha inteira.\n`, consoleNoOutput: ["(Nenhuma saída de comentários)"], codeProcessingData: `print("Processando dados...")`,
                codeEndOfLineComment: ` # Comentário de fim de linha`, consoleProcessingOutput: ["Processando dados..."], codeCommentedOutPrint: `# print("Mensagem de debug antiga") # Temporariamente desabilitado`,
                codeSyntaxImportant: `# Finalmente: A sintaxe é importante!\n`, codeSyntaxRules: `# - print (minúsculas)\n# - () Parênteses\n# - "" ou '' Aspas para texto`,
                codeMasteredBasics: `# Você dominou o básico!\n`, codeModuleComplete: `print("Módulo 0 Completo!")`, consoleModuleComplete: ["Módulo 0 Completo!"],
                consoleGreatJob: ["Ótimo trabalho!", "Próximo: Verificação de Conhecimento"], errorGeneric: "Ocorreu um erro: ",
            },
            cn: { /* ... content ... */
                menuTitlePaused: "课程已暂停", menuTitleFinished: "课程已完成", menuTitleError: "发生错误", menuTitleInterrupted: "课程已中断",
                knowledgeCheckBtn: "知识测验", reviewTheoryBtn: "复习理论", revisitBasicBtn: "重温基础练习", revisitAdvancedBtn: "重温高级练习", courseMenuBtn: "课程菜单",
                langEngBtn: "English", langPtBtn: "Português", langCnBtn: "中文",
                consolePlaceholderReady: "Python 控制台准备就绪... [点击开始课程]", consolePlaceholderStarting: "正在开始课程...", consolePlaceholderPlaying: "课程播放中...", consolePlaceholderCleared: "控制台已清除。", consolePlaceholderRestarting: "正在重新开始课程...",
                codeCommentIntro: `# 模块 0 复习: print() 与注释\n\n`, codePrintEllipsis: `print("...")`, codeHelloWorld: `print("你好，世界！")`,
                consoleHelloWorld: ["你好，世界！"], codePythonPowerful: `print("Python 很强大。")`, codePracticePerfect: `print("熟能生巧！")`,
                codeBlankLineComment: `# 添加一个空行\n`, codeBlankPrint: `print()`, consoleMultiLineOutput: ["你好，世界！", "Python 很强大。", "熟能生巧！", ""],
                codeAfterSpace: `print("这会出现在空格之后。")`, consoleAfterSpaceOutput: ["你好，世界！", "Python 很强大。", "熟能生巧！", "", "这会出现在空格之后。"],
                codeFullLineComment: `# 这是一个整行注释。\n`, consoleNoOutput: ["（注释无输出）"], codeProcessingData: `print("处理数据中...")`,
                codeEndOfLineComment: ` # 行尾注释`, consoleProcessingOutput: ["处理数据中..."], codeCommentedOutPrint: `# print("旧的调试信息") # 暂时禁用`,
                codeSyntaxImportant: `# 最后：语法很重要！\n`, codeSyntaxRules: `# - print (小写)\n# - () 圆括号\n# - "" 或 '' 用于文本的引号`,
                codeMasteredBasics: `# 你已经掌握了基础！\n`, codeModuleComplete: `print("模块 0 完成！")`, consoleModuleComplete: ["模块 0 完成！"],
                consoleGreatJob: ["做得好！", "下一步：知识测验"], errorGeneric: "发生错误：",
            }
        };

        // --- REFINED Syntax Highlighting Function (Placeholder Method) ---
        function addSyntaxHighlighting(langContent) {
            const span = (className, text) => `<span class="${className}">${text}</span>`;
            // Placeholder format: __P<index>__ (less likely to collide with code)
            const placeholderRegex = /__P(\d+)__/g;
            const commentRegex = /(#[^\n]*)/g; // Capture full comments
            const stringRegex = /("[^"]*?"|'[^']*?')/g; // Capture strings '' or ""
            const keywordRegex = /\b(print)\b/g; // Capture keyword 'print'
            const parenRegex = /(\(|\))/g; // Capture parentheses

            for (const lang in langContent) {
                for (const key in langContent[lang]) {
                    if (key.startsWith('code')) {
                        let originalContent = langContent[lang][key];
                        let placeholderIndex = 0;
                        const placeholders = {};

                        // 1. Replace Comments with Placeholders
                        let tempContent = originalContent.replace(commentRegex, (match) => {
                            const phKey = `__P${placeholderIndex}__`;
                            placeholders[phKey] = span('hl-comment', match);
                            placeholderIndex++;
                            return phKey;
                        });

                        // 2. Replace Strings with Placeholders
                        tempContent = tempContent.replace(stringRegex, (match) => {
                            // Avoid replacing inside already existing placeholders (though unlikely with this order)
                            if (match.startsWith('__P')) return match;
                            const phKey = `__P${placeholderIndex}__`;
                            placeholders[phKey] = span('hl-string', match);
                            placeholderIndex++;
                            return phKey;
                        });

                        // 3. Highlight Keywords in remaining text
                        tempContent = tempContent.replace(keywordRegex, (match) => {
                            return span('hl-keyword', match);
                        });

                        // 4. Highlight Parentheses in remaining text
                        tempContent = tempContent.replace(parenRegex, (match) => {
                            return span('hl-paren', match);
                        });

                        // 5. Restore Placeholders
                        let finalContent = tempContent.replace(placeholderRegex, (match, index) => {
                            return placeholders[match] || match; // Restore or keep if somehow invalid
                        });

                        // Assign the processed content back
                        langContent[lang][key] = finalContent;
                    }
                }
            }
        }
        addSyntaxHighlighting(lessonContent); // Prepare content with highlighting

        // --- Audio Setup (Unchanged) ---
        const audioElements = {};
        document.querySelectorAll('audio[id^="audio-ctp-0-a"]').forEach(el => {
            audioElements[el.id] = el;
             el.onerror = () => console.error(`Error loading audio: ${el.src}`);
             el.volume = 0;
        });

        // --- Helper Functions (Unchanged) ---
         function getTextWidth(text, font) {
              const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
              const context = canvas.getContext("2d");
              context.font = font || getComputedStyle(codeArea).font;
              return context.measureText(text).width;
          }
        function updateStatusBarAndCursor() {
            const lines = codeArea.innerText.split('\n');
            currentLineNumber = lines.length;
            const lastLineText = lines[currentLineNumber - 1] || '';
            currentCol = lastLineText.length + 1;
            cursorPosEl.textContent = `Ln ${currentLineNumber}, Col ${currentCol}`;
             if (lineHeightEstimate === 0 && codeArea.offsetHeight > 0) { lineHeightEstimate = parseFloat(getComputedStyle(codeArea).lineHeight) || 27; }
            const cursorTop = (currentLineNumber - 1) * lineHeightEstimate;
            const cursorLeft = getTextWidth(lastLineText, getComputedStyle(codeArea).font);
            codeArea.style.setProperty('--cursor-top', `${cursorTop}px`);
            codeArea.style.setProperty('--cursor-left', `${cursorLeft}px`);
            codeArea.style.setProperty('--cursor-height', `${lineHeightEstimate}px`);
             const wrapperRect = codeAreaWrapper.getBoundingClientRect();
             const cursorVisualTop = codeArea.offsetTop + cursorTop;
             const scrollTop = codeAreaWrapper.scrollTop;
             const scrollBottom = scrollTop + wrapperRect.height;
             if (cursorVisualTop + lineHeightEstimate > scrollBottom - 10) { codeAreaWrapper.scrollTop = cursorVisualTop + lineHeightEstimate - wrapperRect.height + 10; }
             else if (cursorVisualTop < scrollTop + 10) { codeAreaWrapper.scrollTop = Math.max(0, cursorVisualTop - 10); }
        }
        function updateLineNumbers() {
             const lines = codeArea.innerText.split('\n').length; const maxLines = Math.max(lines, 1);
             let numbersHTML = ''; for (let i = 1; i <= maxLines; i++) { numbersHTML += i + '\n'; }
             lineNumbersEl.textContent = numbersHTML.trimEnd();
         }
        function showOutput(outputKey, isInfo = false, isError = false) {
             return new Promise((resolve) => {
                 consolePane.innerHTML = '';
                 const outputLines = lessonContent[currentLanguage][outputKey] || ["Error: Output key not found"];
                 outputLines.forEach(line => {
                     const lineEl = document.createElement('div');
                     if (isError) { lineEl.className = 'error-line'; lineEl.textContent = `❌ ${lessonContent[currentLanguage].errorGeneric || 'Error: '}${line}`; }
                     else if (isInfo) { lineEl.className = 'info-line'; lineEl.textContent = `ℹ️ ${line}`; }
                     else {
                         lineEl.className = 'output-line';
                         const promptSpan = document.createElement('span'); promptSpan.className = 'console-prompt'; promptSpan.textContent = '>>>';
                         lineEl.appendChild(promptSpan); lineEl.appendChild(document.createTextNode(` ${line}`));
                     }
                     consolePane.appendChild(lineEl);
                 });
                 consolePane.scrollTop = consolePane.scrollHeight;
                 resolve();
             });
        }
         function setConsolePlaceholder(placeholderKey) {
            const placeholderText = lessonContent[currentLanguage][placeholderKey] || "Console ready.";
            consolePane.innerHTML = `<span id="console-placeholder" class="placeholder">${placeholderText}</span>`;
        }
        function clearConsole() {
             return new Promise((resolve) => {
                 setConsolePlaceholder('consolePlaceholderCleared');
                 resolve();
             });
        }
        function clearEditor() {
             return new Promise((resolve) => {
                 currentContentHTML = ''; codeArea.innerHTML = ''; currentLineNumber = 1; currentCol = 1;
                 updateLineNumbers(); updateStatusBarAndCursor();
                 codeArea.classList.add('idle'); codeArea.classList.remove('typing', 'no-cursor');
                 resolve();
             });
        }
        function simulateTyping(contentInput, typingSpeed) {
             return new Promise((resolve, reject) => {
                 clearTimeout(currentTimeoutId); currentTimeoutId = null;
                 if (isPaused) { codeArea.classList.add('idle'); codeArea.classList.remove('typing', 'no-cursor'); updateStatusBarAndCursor(); resolve(); return; }
                 if (stopExecution) { reject("stopped"); return; }
                 let textToTypeHTML = contentInput;
                 if (lessonContent[currentLanguage] && lessonContent[currentLanguage][contentInput]) { textToTypeHTML = lessonContent[currentLanguage][contentInput]; }
                 else if (typeof contentInput !== 'string') { textToTypeHTML = ""; }
                 if (!textToTypeHTML || textToTypeHTML.trim() === '') { resolve(); return; }
                 codeArea.classList.add('typing'); codeArea.classList.remove('idle', 'no-cursor');
                 let charIndex = 0; let currentHTML = currentContentHTML;
                 function typeStep() {
                     if (stopExecution) { console.log("Typing stopped."); codeArea.classList.remove('typing'); codeArea.classList.add('idle'); clearTimeout(currentTimeoutId); currentTimeoutId = null; reject("stopped"); return; }
                     if (isPaused) {
                         console.log("Typing paused."); codeArea.classList.remove('typing'); codeArea.classList.add('idle'); updateStatusBarAndCursor();
                         const pauseCheckInterval = setInterval(() => { if (stopExecution) { clearInterval(pauseCheckInterval); reject("stopped"); } else if (!isPaused) { clearInterval(pauseCheckInterval); console.log("Typing resumed."); codeArea.classList.add('typing'); codeArea.classList.remove('idle'); currentTimeoutId = setTimeout(typeStep, typingSpeed); } }, 100); return;
                     }
                     if (charIndex >= textToTypeHTML.length) { currentContentHTML = currentHTML; codeArea.classList.remove('typing'); codeArea.classList.add('idle'); updateLineNumbers(); updateStatusBarAndCursor(); currentTimeoutId = null; resolve(); return; }
                     let nextChar = textToTypeHTML[charIndex]; let stepSize = 1;
                     if (nextChar === '<') { const tagEndIndex = textToTypeHTML.indexOf('>', charIndex); if (tagEndIndex !== -1) { const potentialTag = textToTypeHTML.substring(charIndex, tagEndIndex + 1); if (potentialTag.match(/^<(\/?)([a-zA-Z]+)[^>]*>$/)) { stepSize = potentialTag.length; nextChar = potentialTag; } } }
                     else if (nextChar === '&') { const entityEndIndex = textToTypeHTML.indexOf(';', charIndex); if (entityEndIndex !== -1) { const potentialEntity = textToTypeHTML.substring(charIndex, entityEndIndex + 1); if (potentialEntity.match(/^&\w+;$/)) { stepSize = potentialEntity.length; nextChar = potentialEntity; } } }
                     currentHTML += nextChar; codeArea.innerHTML = currentHTML; updateLineNumbers(); updateStatusBarAndCursor(); charIndex += stepSize;
                     currentTimeoutId = setTimeout(typeStep, typingSpeed);
                 }
                 typeStep();
             });
        }
        async function playAudio(baseAudioId) { /* Unchanged */
            const fullAudioId = `${baseAudioId}-${currentLanguage}`; if (currentAudioElement && !currentAudioElement.paused) { currentAudioElement.pause(); currentAudioElement.currentTime = 0; } currentAudioElement = audioElements[fullAudioId]; if (!currentAudioElement) { console.warn(`Audio ${fullAudioId} missing. Fallback: English.`); const fallbackAudioId = `${baseAudioId}-eng`; currentAudioElement = audioElements[fallbackAudioId]; if (!currentAudioElement) { console.error(`Fallback audio ${fallbackAudioId} missing.`); return; } } try { currentAudioElement.currentTime = 0; currentAudioElement.volume = 1; if (!stopExecution) { await currentAudioElement.play().catch(error => { if (!stopExecution && !isPaused) { console.error(`Play error ${currentAudioElement.id}:`, error); } }); console.log(`Audio start: ${currentAudioElement.id}`); } else { console.log(`Audio skip (stopped): ${currentAudioElement.id}`); } } catch (error) { console.error(`Audio error ${currentAudioElement.id}:`, error); }
        }
        async function pause(duration) { /* Unchanged */
            return new Promise((resolve, reject) => { clearTimeout(currentTimeoutId); currentTimeoutId = null; if (isPaused) { codeArea.classList.add('idle'); codeArea.classList.remove('typing', 'no-cursor'); updateStatusBarAndCursor(); resolve(); return; } if (stopExecution) { reject("stopped"); return; } codeArea.classList.add('idle'); codeArea.classList.remove('typing', 'no-cursor'); updateStatusBarAndCursor(); let intervalCheckId = null; const cleanUp = () => { clearTimeout(currentTimeoutId); clearInterval(intervalCheckId); currentTimeoutId = null; intervalCheckId = null; }; currentTimeoutId = setTimeout(() => { cleanUp(); resolve(); }, duration); intervalCheckId = setInterval(() => { if (stopExecution) { cleanUp(); reject("stopped"); } else if (isPaused) { cleanUp(); resolve(); } }, 50); });
         }

        // --- THE LESSON SCRIPT (Unchanged) ---
        const audioDurations = { 'a1': 13000, 'a2': 13000, 'a3': 14000, 'a4': 30000, 'a5': 6000, 'a6': 9000, 'a7': 8000, 'a8': 5000, 'a9': 11000, 'a10': 16000, 'a11': 2000, 'a12': 18000, 'a13': 8000, 'a14': 8000, 'a15': 15000, 'a16': 32000 };
        const lessonScript = [ /* ... script steps ... */
            { type: 'audio', audioId: 'audio-ctp-0-a1', note: "Start a1" }, { type: 'pause', duration: 1500 }, { type: 'typeCode', contentKey: 'codeCommentIntro', speed: 70 }, { type: 'pause', duration: Math.max(0, audioDurations['a1'] - 1500 - 2000 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a2', note: "Start a2" }, { type: 'pause', duration: audioDurations['a2'] + 900 },
            { type: 'audio', audioId: 'audio-ctp-0-a3', note: "Start a3" }, { type: 'pause', duration: 11000 }, { type: 'typeCode', contentKey: 'codePrintEllipsis', speed: 90 }, { type: 'pause', duration: Math.max(0, audioDurations['a3'] - 11000 - 1000 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a4', note: "Start a4" }, { type: 'pause', duration: 5000 }, { type: 'clearEditor' }, { type: 'pause', duration: 100 }, { type: 'typeCode', contentKey: 'codeHelloWorld', speed: 80 }, { type: 'pause', duration: Math.max(0, audioDurations['a4'] - 5000 - 100 - 2500 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a5', note: "Start a5" }, { type: 'runCode', outputKey: 'consoleHelloWorld' }, { type: 'pause', duration: 2000 }, { type: 'typeCode', contentInput: '\n', speed: 70 }, { type: 'typeCode', contentKey: 'codePythonPowerful', speed: 70 }, { type: 'pause', duration: Math.max(0, audioDurations['a5'] - 2000 - 2000 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a6', note: "Start a6" }, { type: 'typeCode', contentInput: '\n', speed: 70 }, { type: 'typeCode', contentKey: 'codePracticePerfect', speed: 70 }, { type: 'pause', duration: 3000 }, { type: 'typeCode', contentInput: '\n\n', speed: 60 }, { type: 'typeCode', contentKey: 'codeBlankLineComment', speed: 60 }, { type: 'typeCode', contentKey: 'codeBlankPrint', speed: 95 }, { type: 'pause', duration: Math.max(0, audioDurations['a6'] - 3000 - 2500 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a7', note: "Start a7" }, { type: 'runCode', outputKey: 'consoleMultiLineOutput' }, { type: 'pause', duration: 3000 }, { type: 'typeCode', contentInput: '\n', speed: 70 }, { type: 'typeCode', contentKey: 'codeAfterSpace', speed: 70 }, { type: 'pause', duration: Math.max(0, audioDurations['a7'] - 3000 - 3000 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a8', note: "Start a8" }, { type: 'runCode', outputKey: 'consoleAfterSpaceOutput' }, { type: 'pause', duration: audioDurations['a8'] + 900 },
            { type: 'audio', audioId: 'audio-ctp-0-a9', note: "Start a9" }, { type: 'clearEditor' }, { type: 'clearConsole' }, { type: 'pause', duration: 500 }, { type: 'typeCode', contentKey: 'codeFullLineComment', speed: 60 }, { type: 'pause', duration: Math.max(0, audioDurations['a9'] - 500 - 3000 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a10', note: "Start a10" }, { type: 'runCode', outputKey: 'consoleNoOutput', isInfo: true }, { type: 'pause', duration: 5000 }, { type: 'typeCode', contentKey: 'codeProcessingData', speed: 70 }, { type: 'typeCode', contentInput: ' ', speed: 55 }, { type: 'typeCode', contentKey: 'codeEndOfLineComment', speed: 55 }, { type: 'pause', duration: Math.max(0, audioDurations['a10'] - 5000 - 4000 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a11', note: "Start a11" }, { type: 'runCode', outputKey: 'consoleProcessingOutput' }, { type: 'pause', duration: audioDurations['a11'] + 900 },
            { type: 'audio', audioId: 'audio-ctp-0-a12', note: "Start a12" }, { type: 'pause', duration: 10000 }, { type: 'typeCode', contentInput: '\n', speed: 55 }, { type: 'typeCode', contentKey: 'codeCommentedOutPrint', speed: 55 }, { type: 'pause', duration: Math.max(0, audioDurations['a12'] - 10000 - 4000 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a13', note: "Start a13" }, { type: 'clearEditor' }, { type: 'clearConsole' }, { type: 'pause', duration: 500 }, { type: 'typeCode', contentKey: 'codeSyntaxImportant', speed: 65 }, { type: 'pause', duration: Math.max(0, audioDurations['a13'] - 500 - 2500 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a14', note: "Start a14" }, { type: 'typeCode', contentKey: 'codeSyntaxRules', speed: 65 }, { type: 'pause', duration: Math.max(0, audioDurations['a14'] - 5000 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a15', note: "Start a15" }, { type: 'clearEditor' }, { type: 'pause', duration: 300 }, { type: 'typeCode', contentKey: 'codeMasteredBasics', speed: 60 }, { type: 'pause', duration: 500 }, { type: 'typeCode', contentKey: 'codeModuleComplete', speed: 70 }, { type: 'pause', duration: 1000 }, { type: 'runCode', outputKey: 'consoleModuleComplete' }, { type: 'pause', duration: Math.max(0, audioDurations['a15'] - 300 - 500 - 1000 - 1000 - 2000 + 900) },
            { type: 'audio', audioId: 'audio-ctp-0-a16', note: "Start a16" }, { type: 'clearConsole' }, { type: 'pause', duration: 500 }, { type: 'showOutput', outputKey: 'consoleGreatJob', isInfo: true }, { type: 'pause', duration: Math.max(0, audioDurations['a16'] - 500) }, { type: 'pause', duration: 1200 },
            { type: 'end', note: "End of Simulation" }
        ];

        // --- AUTOPLAY EXECUTION & CONTROL LOGIC (Unchanged) ---
        async function executeScript() { /* Unchanged */
            if (!simulationStarted) return; console.log("Starting script execution..."); setConsolePlaceholder('consolePlaceholderPlaying'); controlButton.classList.remove('hidden'); setControlButtonState('pause'); isFinished = false; stopExecution = false;
            while (currentStepIndex < lessonScript.length && !stopExecution) { while (isPaused && !stopExecution) { await new Promise(resolve => setTimeout(resolve, 200)); } if (stopExecution) { console.log("Stop signal before step."); break; } const step = lessonScript[currentStepIndex]; console.log(`Step ${currentStepIndex}: ${step.type} - ${step.note || step.contentKey || step.outputKey || ''}`); codeArea.classList.remove('idle', 'typing', 'no-cursor'); try { switch (step.type) { case 'audio': if (step.audioId) { await playAudio(step.audioId); } await pause(10); break; case 'typeCode': await simulateTyping(step.contentKey || step.contentInput || '', step.speed || 75); break; case 'runCode': await pause(100); await showOutput(step.outputKey || 'errorGeneric', step.isInfo || false, step.isError || false); break; case 'clearConsole': await clearConsole(); break; case 'clearEditor': await clearEditor(); break; case 'pause': await pause(step.duration || 1000); break; case 'end': isFinished = true; stopExecution = true; showEndState('menuTitleFinished'); console.log("Script finished."); break; default: console.warn(`Unknown step type: ${step.type}`); await pause(100); } } catch (error) { if (error === "stopped") { console.log(`Step ${currentStepIndex} (${step.type}) stopped.`); } else { console.error(`Error step ${currentStepIndex} (${step.type}):`, error); showOutput('errorGeneric', false, true); stopExecution = true; isFinished = true; showEndState("menuTitleError"); } } if (!stopExecution && step.type !== 'end') { codeArea.classList.add('idle'); codeArea.classList.remove('typing', 'no-cursor'); updateStatusBarAndCursor(); currentStepIndex++; } else if (stopExecution) { console.log("Loop terminating (stop/end)."); break; } } /* End while */ if (!isFinished && stopExecution) { console.log("Script execution stopped."); if (isPaused) { setControlButtonState('play'); showNavMenu(true, "menuTitlePaused"); codeArea.classList.add('idle'); updateStatusBarAndCursor(); } else { setControlButtonState('restart'); if (!navOverlay.classList.contains('visible')) { showNavMenu(true, "menuTitleInterrupted"); } } } else if (currentStepIndex >= lessonScript.length && !isFinished) { isFinished = true; showEndState('menuTitleFinished'); console.log("Script loop completed (fallback check)."); }
        }

        // --- UI Update Function (Runs Once on Load) (Unchanged) ---
        function updateUIText() { /* Unchanged */
            const content = lessonContent[currentLanguage]; knowledgeCheckBtnText.textContent = content.knowledgeCheckBtn; reviewTheoryBtnText.textContent = content.reviewTheoryBtn; revisitBasicBtnText.textContent = content.revisitBasicBtn; revisitAdvancedBtnText.textContent = content.revisitAdvancedBtn; courseMenuBtnText.textContent = content.courseMenuBtn; langEngLink.textContent = content.langEngBtn; langPtLink.textContent = content.langPtBtn; langCnLink.textContent = content.langCnBtn; if (consolePlaceholderEl && !simulationStarted) { consolePlaceholderEl.textContent = content.consolePlaceholderReady; } if (navOverlay.classList.contains('visible')) { const currentTitleKey = navMenuTitle.dataset.titleKey || 'menuTitlePaused'; navMenuTitle.textContent = content[currentTitleKey]; } languageLinks.forEach(link => { if (link.dataset.lang === currentLanguage) { link.classList.add('active'); } else { link.classList.remove('active'); } });
        }

        // --- Control/UI Functions (Unchanged) ---
        function setControlButtonState(state) { /* Unchanged */
            switch(state){case 'play': controlIcon.className = 'fas fa-play'; controlButton.title = 'Resume'; break; case 'pause': controlIcon.className = 'fas fa-pause'; controlButton.title = 'Pause'; break; case 'restart': controlIcon.className = 'fas fa-redo-alt'; controlButton.title = 'Restart Lesson'; break;}
        }
        function showNavMenu(show = true, titleKey = "menuTitlePaused") { /* Unchanged */
            navMenuTitle.textContent = lessonContent[currentLanguage][titleKey] || "Menu"; navMenuTitle.dataset.titleKey = titleKey; if (show) { navOverlay.classList.add('visible'); } else { navOverlay.classList.remove('visible'); }
        }
        function showEndState(titleKey = "menuTitleFinished") { /* Unchanged */
            console.log("Showing end state"); isFinished = true; stopExecution = true; setControlButtonState('restart'); codeArea.classList.add('no-cursor'); codeArea.classList.remove('idle', 'typing'); showNavMenu(true, titleKey); if (currentAudioElement) { currentAudioElement.pause(); currentAudioElement.currentTime = 0; } currentAudioElement = null; clearTimeout(currentTimeoutId); currentTimeoutId = null;
        }
        function togglePause() { /* Unchanged */
            if (isFinished) return; isPaused = !isPaused; console.log(isPaused ? "Pausing..." : "Resuming..."); if (isPaused) { stopExecution = true; if (currentAudioElement) { currentAudioElement.pause(); } clearTimeout(currentTimeoutId); currentTimeoutId = null; setControlButtonState('play'); showNavMenu(true, "menuTitlePaused"); codeArea.classList.remove('typing'); codeArea.classList.add('idle'); updateStatusBarAndCursor(); } else { stopExecution = false; showNavMenu(false); setControlButtonState('pause'); if (currentAudioElement && currentAudioElement.paused && currentAudioElement.currentTime > 0) { currentAudioElement.play().catch(e => console.error("Resume play error", e)); } codeArea.classList.remove('idle'); }
        }
        function restartSimulation() { /* Unchanged */
            console.log("Restarting simulation..."); stopExecution = true; isPaused = false; clearTimeout(currentTimeoutId); currentTimeoutId = null; if (currentAudioElement) { currentAudioElement.pause(); currentAudioElement.currentTime = 0; } currentAudioElement = null; currentStepIndex = 0; isFinished = false; currentContentHTML = ''; clearEditor(); setConsolePlaceholder('consolePlaceholderRestarting'); showNavMenu(false); codeArea.classList.remove('typing', 'no-cursor'); codeArea.classList.add('idle'); updateStatusBarAndCursor(); setTimeout(() => { stopExecution = false; simulationStarted = true; executeScript(); }, 150);
        }

        // --- Language Link Click Handler (Unchanged) ---
        languageLinks.forEach(link => { /* Unchanged */
            link.addEventListener('click', (e) => { e.preventDefault(); const selectedLang = e.target.dataset.lang; if (selectedLang && selectedLang !== currentLanguage) { console.log(`Setting language to ${selectedLang} and reloading.`); localStorage.setItem('lessonLanguage', selectedLang); stopExecution = true; isPaused = false; if (currentAudioElement) { currentAudioElement.pause(); currentAudioElement.volume = 0; } clearTimeout(currentTimeoutId); setTimeout(() => { window.location.reload(); }, 50); } else { console.log("Language already selected or invalid."); } });
        });

        // --- Event Listeners (Control Button) (Unchanged) ---
        controlButton.addEventListener('click', () => { /* Unchanged */
            if (!simulationStarted) return; if (isFinished) { restartSimulation(); } else { togglePause(); }
        });

        // --- User Interaction Start (Unchanged) ---
        function startSimulation() { /* Unchanged */
             if (simulationStarted) return; simulationStarted = true; document.body.removeEventListener('click', startSimulation); document.body.removeEventListener('keydown', startSimulation); console.log("User interaction detected, starting simulation..."); setConsolePlaceholder('consolePlaceholderStarting'); try { const context = new (window.AudioContext || window.webkitAudioContext)(); if (context.state === 'suspended') { context.resume(); } Object.values(audioElements).forEach(audio => { audio.volume = 0; const promise = audio.play(); if (promise !== undefined) { promise.then(_ => { audio.pause(); audio.currentTime = 0; audio.volume = 1; }).catch(error => { audio.volume = 1; }); } else { audio.volume = 1; } }); } catch(e) { console.warn("AudioContext/preload trick failed:", e); } controlButton.classList.remove('hidden'); setTimeout(executeScript, 500);
        }
        document.body.addEventListener('click', startSimulation, { once: true });
        document.body.addEventListener('keydown', startSimulation, { once: true });

        // --- Initial Setup (Unchanged) ---
        updateUIText(); updateLineNumbers(); updateStatusBarAndCursor(); codeArea.classList.add('idle'); console.log(`Page loaded with language: ${currentLanguage}`);

    }); // End DOMContentLoaded
    </script>

</body>
</html>
