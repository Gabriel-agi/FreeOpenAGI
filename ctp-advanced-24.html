<!DOCTYPE html>
<!-- Language set by JS -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title set by JS -->
    <title data-translate="page_title">Module 24: Advanced Python Practice - Files</title>
    <!-- Fonts & Icons (Same as basic practice) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Base Styles & Variables (Identical to basic practice) --- */
        :root {
            --primary-color: #007bff; /* Blue */
            --secondary-color: #6c757d; /* Grey */
            --background-light: #f8f9fa;
            --background-medium: #e9ecef;
            --background-dark: #343a40;
            --text-light: #f8f9fa;
            --text-dark: #212529;
            --accent-color: #ffc107; /* Yellow */
            --success-color: #28a745; /* Green */
            --error-color: #dc3545;   /* Red */
            --info-color: #17a2b8;    /* Teal */
            --file-color: #fd7e14; /* Orange - for file elements */
            --border-radius: 8px;
            --transition-speed: 0.3s;
            --font-body: 'Roboto', sans-serif;
            --font-title: 'Orbitron', sans-serif;
            --selection-highlight-bg: rgba(0, 123, 255, 0.1);
            --selection-highlight-border: rgba(0, 123, 255, 0.4);
            --nav-primary: #6e48aa;
            --nav-success: #4cc9f0;
            --nav-dark: #1a1a2e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-body); line-height: 1.7;
            background-color: var(--background-light); color: var(--text-dark);
            overflow-x: hidden;
        }

        /* --- Utility Classes (Identical) --- */
        .container { max-width: 960px; margin: 0 auto; padding: 0 15px; }
        .text-center { text-align: center; }
        .highlight { color: var(--primary-color); font-weight: bold; }
        .code-font { font-family: 'Courier New', Courier, monospace; }
        .hidden { display: none !important; }
        .button-group { margin-top: 2rem; display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; }

        /* --- Advanced Animations (Identical) --- */
        .fade-in { opacity: 0; transform: translateY(20px); animation: fadeInAnimation 0.8s ease-out forwards; }
        .fade-in.delay-1 { animation-delay: 0.2s; }
        .fade-in.delay-2 { animation-delay: 0.4s; }
        .fade-in.delay-3 { animation-delay: 0.6s; }
        .fade-in.delay-4 { animation-delay: 0.8s; }
        @keyframes fadeInAnimation { to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseHeaderIcon { 0% { transform: scale(1); opacity: 0.1; filter: brightness(1); } 50% { transform: scale(1.05); opacity: 0.25; filter: brightness(1.2); } 100% { transform: scale(1); opacity: 0.1; filter: brightness(1); } }
        @keyframes successGlow { 0% { box-shadow: 0 0 3px rgba(40, 167, 69, 0.3); transform: scale(1); } 50% { box-shadow: 0 0 12px 5px rgba(40, 167, 69, 0.5); transform: scale(1.01); } 100% { box-shadow: 0 0 3px rgba(40, 167, 69, 0.3); transform: scale(1); } }
        .success-glow-anim { animation: successGlow 0.9s ease-out; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(3px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-5px, 0, 0); } 40%, 60% { transform: translate3d(5px, 0, 0); } }
        .shake-anim { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes iconAppearCorrect { 0% { transform: scale(0.5) rotate(-15deg); opacity: 0; } 60% { transform: scale(1.2) rotate(5deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes iconAppearIncorrect { 0% { transform: scale(0.5) rotate(-15deg); opacity: 0; } 50% { transform: scale(1.2) rotate(10deg); opacity: 1; } 70% { transform: scale(0.9) rotate(-5deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        .action-button:active:not(:disabled) { transform: translateY(1px) scale(0.98); filter: brightness(0.95); }

        /* --- Minimal Retractable Nav (Identical Structure, Links Updated) --- */
        .minimal-nav-button { position: fixed; top: 15px; right: 15px; z-index: 1001; background-color: rgba(52, 58, 64, 0.75); color: var(--text-light); border: none; border-radius: var(--border-radius); padding: 8px 12px; cursor: pointer; transition: background-color var(--transition-speed), opacity var(--transition-speed), transform var(--transition-speed); font-size: 1.1rem; opacity: 0.6; box-shadow: 0 2px 5px rgba(0,0,0,0.2); line-height: 1; }
        .minimal-nav-button:hover { background-color: rgba(52, 58, 64, 0.95); opacity: 1; transform: scale(1.05); }
        .minimal-nav { position: fixed; top: 60px; right: 15px; z-index: 1000; background-color: var(--background-dark); border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3); padding: 0.8rem; opacity: 0; transform: translateY(-15px) scale(0.95); transform-origin: top right; pointer-events: none; transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease; min-width: 200px; }
        body.nav-active .minimal-nav { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .minimal-nav ul { list-style: none; margin: 0; padding: 0; }
        .minimal-nav ul li { margin-bottom: 5px; }
        .minimal-nav ul li:last-child { margin-bottom: 0; }
        .minimal-nav ul li a { display: flex; align-items: center; color: var(--text-light); text-decoration: none; padding: 0.6rem 1rem; border-radius: 4px; transition: background-color var(--transition-speed), color var(--transition-speed); white-space: nowrap; font-weight: 400; font-size: 0.95rem; }
        .minimal-nav ul li a i.fas { margin-right: 10px; width: 1.2em; text-align: center; opacity: 0.8; transition: opacity var(--transition-speed); }
        .minimal-nav ul li a:hover { background-color: var(--primary-color); color: var(--text-light); }
        .minimal-nav ul li a:hover i.fas { opacity: 1; }
        /* Language Switcher Styles (Identical) */
        .minimal-nav .language-switcher-item { padding: 0.5rem 1rem; border-top: 1px solid var(--secondary-color); margin-top: 8px; padding-top: 13px; }
        #languageSelect { width: 100%; background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--nav-success); border-radius: 5px; padding: 6px 30px 6px 12px; cursor: pointer; font-size: 0.9rem; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234CC9F0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px center; background-size: 10px auto; transition: background-color 0.3s ease; }
        #languageSelect:hover { background-color: rgba(255,255,255,0.15); }
        #languageSelect option { background: var(--nav-dark); color: var(--text-light); }
        /* --- End Minimal Retractable Nav --- */

        /* --- Practice Header (Adapted for Advanced) --- */
        .practice-header { background: linear-gradient(135deg, var(--nav-primary), #4a2f7c); color: var(--text-light); padding: 3rem 0 4rem; text-align: center; position: relative; overflow: hidden; border-bottom: 5px solid var(--accent-color); } /* Changed color */
        .practice-header h1 { font-family: var(--font-title); font-size: 2.8rem; margin-bottom: 0.5rem; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); animation: fadeInAnimation 1s ease-out; }
        .practice-header p { font-size: 1.1rem; font-weight: 300; opacity: 0.9; animation: fadeInAnimation 1s ease-out 0.3s forwards; opacity: 0; }
        .header-icon { position: absolute; font-size: 4rem; color: var(--text-light); animation: pulseHeaderIcon 6s infinite ease-in-out alternate; }
        .icon1 { top: 20%; left: 15%; animation-duration: 7s; } /* Changed icon */
        .icon2 { bottom: 15%; right: 20%; animation-duration: 5s; } /* Changed icon */

        /* --- Practice Section Styling (Identical) --- */
        .practice-section { padding: 3rem 0; background-color: var(--background-medium); border-bottom: 1px solid #d6d8db; }
        .practice-section:nth-child(odd) { background-color: var(--background-light); }
        .practice-section:last-of-type { border-bottom: none; }
        .practice-section h2 { font-family: var(--font-title); font-size: 1.8rem; color: var(--primary-color); margin-bottom: 1rem; text-align: center; }
        .practice-section .section-description { text-align: center; margin-bottom: 2.5rem; color: var(--secondary-color); font-size: 1.05rem; max-width: 700px; margin-left: auto; margin-right: auto; }
        .practice-section .cs-concept { display: inline-block; background-color: var(--background-medium); color: var(--secondary-color); font-size: 0.85rem; padding: 0.2rem 0.6rem; border-radius: 10px; margin-left: 5px; border: 1px solid #ccc; font-family: var(--font-body); font-weight: 400; }

        /* --- General Interactive Elements (Identical) --- */
        .interactive-area { background-color: #fff; padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-top: 1.5rem; position: relative; transition: box-shadow 0.5s ease-out; }
        .feedback-message { padding: 0.8rem 1rem; margin-top: 1rem; border-radius: var(--border-radius); font-weight: bold; text-align: center; opacity: 0; max-height: 0; overflow: hidden; transition: opacity var(--transition-speed) ease, max-height var(--transition-speed) ease, margin-top var(--transition-speed) ease; }
        .feedback-message.visible { opacity: 1; max-height: 100px; margin-top: 1.5rem; }
        .feedback-message.correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .feedback-message.incorrect { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .feedback-message.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .feedback-message .fas { margin: 0 3px; }
        .action-button { display: inline-block; padding: 0.8rem 1.5rem; font-size: 1rem; font-weight: bold; color: var(--text-light); background-color: var(--primary-color); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color var(--transition-speed), transform var(--transition-speed), filter var(--transition-speed), box-shadow var(--transition-speed); margin-top: 1rem; vertical-align: middle; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-decoration: none; }
        .action-button:hover:not(:disabled) { background-color: #0056b3; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .action-button:disabled { background-color: var(--secondary-color); cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        .action-button.success { background-color: var(--success-color); }
        .action-button.success:hover:not(:disabled) { background-color: #218838; }
        .action-button.secondary { background-color: var(--secondary-color); }
        .action-button.secondary:hover:not(:disabled) { background-color: #5a6268; }
        /* Code styling (Identical) */
        .code-block { background-color: var(--background-dark); color: var(--text-light); padding: 1.5rem; border-radius: var(--border-radius); font-family: var(--code-font); font-size: 1rem; position: relative; overflow-x: auto; margin: 1rem 0; }
        .code-keyword { color: #569cd6; } .code-string { color: #ce9178; } .code-comment { color: #6a9955; } .code-function { color: #dcdcaa; } .code-paren { color: #ffd700; } .code-variable { color: #9cdcfe; } .code-method { color: #dcdcaa; } .code-operator { color: #d4d4d4; } .code-mode { color: var(--file-color); font-weight: bold; } .code-number { color: #b5cea8; } /* Style for numbers */

        /* --- Activity 1: Build-a-Multi-Write (Adapted) --- */
        #build-multi-write .draggable-pieces { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; padding: 1rem; background-color: var(--background-light); border: 1px dashed var(--secondary-color); border-radius: var(--border-radius); justify-content: center; user-select: none; -webkit-user-select: none; -ms-user-select: none; }
        /* Piece styles are inherited */
        #build-multi-write #build-drop-zone { min-height: 80px; background-color: var(--background-dark); border: 3px dashed var(--secondary-color); border-radius: var(--border-radius); padding: 15px; display: flex; align-items: flex-start; /* Align to top */ gap: 5px; flex-wrap: wrap; transition: border-color var(--transition-speed), background-color var(--transition-speed), box-shadow var(--transition-speed); }
        #build-multi-write #build-drop-zone.over { border-color: var(--accent-color); background-color: #495057; box-shadow: inset 0 0 10px rgba(255,193,7,0.2); }
        #build-multi-write #build-drop-zone .piece { cursor: default; margin: 0; touch-action: auto; box-shadow: none; }
        #build-multi-write #build-drop-zone-placeholder { color: var(--secondary-color); font-style: italic; width: 100%; text-align: center;}
        /* Style for line break visual cue (optional) */
        #build-multi-write .line-break-visual { width: 100%; height: 5px; display: block; /* Represents where a newline would be visually */ }


        /* --- Activity 2: Data Type Challenge (New Activity) --- */
        #data-type-challenge .sim-editor { width: 100%; min-height: 100px; background-color: var(--background-dark); color: var(--text-light); border: 1px solid var(--secondary-color); border-radius: var(--border-radius); padding: 1rem; font-family: var(--code-font); font-size: 1rem; line-height: 1.5; resize: vertical; }
        #data-type-challenge .sim-output-area { margin-top: 1rem; min-height: 60px; background-color: #1a1a1a; border: 1px solid #444; border-radius: var(--border-radius); padding: 1rem; color: var(--text-light); font-family: var(--font-body); font-size: 1rem; white-space: pre-wrap; word-wrap: break-word; }
        #data-type-challenge .sim-output-area .placeholder { color: var(--secondary-color); font-style: italic; font-size: 0.9rem; }
        #data-type-challenge .sim-output-area .filename-header { font-weight: bold; color: var(--file-color); margin-bottom: 5px; display: block; font-family: var(--code-font); font-size: 0.9rem;}
        #data-type-challenge .sim-output-area .output-line { display: block; }


         /* --- Activity 3: Write from Loop (New Activity) --- */
        #write-from-loop .sim-editor { width: 100%; min-height: 120px; background-color: var(--background-dark); color: var(--text-light); border: 1px solid var(--secondary-color); border-radius: var(--border-radius); padding: 1rem; font-family: var(--code-font); font-size: 1rem; line-height: 1.5; resize: vertical; }
        #write-from-loop .sim-output-area { margin-top: 1rem; min-height: 80px; background-color: #1a1a1a; border: 1px solid #444; border-radius: var(--border-radius); padding: 1rem; color: var(--text-light); font-family: var(--font-body); font-size: 1rem; white-space: pre-wrap; word-wrap: break-word; }
        #write-from-loop .sim-output-area .placeholder { color: var(--secondary-color); font-style: italic; font-size: 0.9rem; }
        #write-from-loop .sim-output-area .filename-header { font-weight: bold; color: var(--file-color); margin-bottom: 5px; display: block; font-family: var(--code-font); font-size: 0.9rem;}
        #write-from-loop .sim-output-area .output-line { display: block; border-bottom: 1px dotted #555; padding-bottom: 3px; margin-bottom: 3px; }
        #write-from-loop .sim-output-area .output-line:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }


        /* --- Activity 4: Advanced Mini Missions (Adapted) --- */
        #adv-mini-missions .mission { padding: 1.5rem; border: 1px solid #d6d8db; border-radius: var(--border-radius); margin-bottom: 1.5rem; background-color: var(--background-light); position: relative; }
        .mission-status { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; transition: transform 0.3s ease; }
        .mission-status .fa-check-circle { color: var(--success-color); transform-origin: center; animation: iconAppearCorrect 0.6s ease-out; }
        .mission-status .fa-times-circle { color: var(--error-color); }
        .mission-status .fa-question-circle { color: var(--secondary-color); }
        #adv-mini-missions .mission-editor { width: 100%; min-height: 100px; background-color: var(--background-dark); color: var(--text-light); border: 1px solid var(--secondary-color); border-radius: var(--border-radius); padding: 1rem; font-family: var(--code-font); font-size: 1rem; line-height: 1.5; resize: vertical; margin-top: 1rem; }
        #adv-mini-missions .mission-output { margin-top: 1rem; min-height: 40px; background-color: #1a1a1a; border: 1px solid #444; border-radius: var(--border-radius); padding: 0.8rem; color: var(--text-light); font-family: var(--font-body); font-size: 1rem; white-space: pre-wrap; word-wrap: break-word; }
         #adv-mini-missions .mission-output .filename-header { font-weight: bold; color: var(--file-color); margin-bottom: 5px; display: block; font-family: var(--code-font); font-size: 0.9rem;}
         #adv-mini-missions .mission-output .output-line { display: block; }

        /* --- Final Section (Adapted Links/Icon) --- */
        .completion-section { padding: 4rem 0; text-align: center; }
        .completion-section .icon { font-size: 4rem; color: var(--success-color); margin-bottom: 1rem; display: inline-block; opacity: 0; animation: iconAppearCorrect 1s ease-out 0.5s forwards; }
        .completion-section h2 { font-family: var(--font-title); font-size: 2.2rem; color: var(--primary-color); }
        .completion-section p { font-size: 1.1rem; margin-top: 1rem; color: var(--secondary-color); }

        /* --- Responsive Design (Identical) --- */
        @media (max-width: 768px) { html { font-size: 15px; } .practice-header h1 { font-size: 2.2rem; } .practice-section h2 { font-size: 1.6rem; } .interactive-area { padding: 1.5rem; } .piece { padding: 6px 10px; font-size: 0.95rem; } #build-multi-write #build-drop-zone { min-height: 70px; padding: 10px; } .button-group { flex-direction: column; align-items: center; } .minimal-nav { min-width: 180px; } .minimal-nav ul li a { padding: 0.6rem 0.8rem; } #languageSelect { font-size: 0.85rem; padding: 5px 25px 5px 10px;} }
        @media (max-width: 480px) { html { font-size: 14px; } .practice-header h1 { font-size: 1.8rem; } .practice-header p { font-size: 1rem; } .practice-section h2 { font-size: 1.4rem; } .interactive-area { padding: 1rem; } .action-button { font-size: 0.9rem; padding: 0.7rem 1.2rem; width: 90%; max-width: 300px;} .sim-editor, .sim-output-area { font-size: 0.9rem; } #build-multi-write #build-drop-zone { min-height: 60px; } .mission-editor { min-height: 90px; font-size: 0.95rem;} .mission-output { font-size: 0.95rem;} .button-group a.action-button { width: 90%; max-width: 300px; margin-bottom: 0.5rem; } .minimal-nav-button { top: 10px; right: 10px; padding: 6px 10px; font-size: 1rem; } .minimal-nav { top: 48px; right: 10px; min-width: 160px; } .minimal-nav ul li a { padding: 0.5rem 0.7rem; font-size: 0.9rem;} .minimal-nav ul li a i.fas { margin-right: 8px; } #languageSelect { font-size: 0.8rem; padding: 4px 20px 4px 8px;} }
    </style>
</head>
<body>

    <!-- ========= Minimal Nav Handle (Identical) ========= -->
    <button id="minimal-nav-toggle" class="minimal-nav-button" aria-label="Toggle Navigation Menu">
        <i class="fas fa-bars"></i>
    </button>

    <!-- ========= Minimal Nav Panel (Adapted Links) ========= -->
    <nav id="minimal-nav-panel" class="minimal-nav">
        <ul>
            <!-- *** MODIFIED Links for Advanced Page *** -->
            <li><a href="ctp-practice-24.html"><i class="fas fa-pencil-alt fa-fw"></i> <span data-translate="nav_basic_practice">View Basic Practice</span></a></li>
            <li><a href="ctp-video-24.html"><i class="fas fa-video fa-fw"></i> <span data-translate="nav_video">Watch Video Lesson</span></a></li>
            <li><a href="ctp-dashboard.html"><i class="fas fa-list fa-fw"></i> <span data-translate="nav_menu">Course Menu</span></a></li>
            <hr style="border: none; border-top: 1px solid var(--secondary-color); margin: 8px 0;">
            <!-- In-page links adapted for new activities -->
            <li><a href="#build-multi-write"><i class="fas fa-puzzle-piece fa-fw"></i> <span data-translate="nav_build">Build</span></a></li>
            <li><a href="#data-type-challenge"><i class="fas fa-exchange-alt fa-fw"></i> <span data-translate="nav_data_types">Data Types</span></a></li>
            <li><a href="#write-from-loop"><i class="fas fa-sync-alt fa-fw"></i> <span data-translate="nav_loop">Loop Write</span></a></li>
            <li><a href="#adv-mini-missions"><i class="fas fa-rocket fa-fw"></i> <span data-translate="nav_missions">Missions</span></a></li>
            <!-- Language Switcher Item (Identical) -->
            <li class="language-switcher-item">
                 <select id="languageSelect" aria-label="Select Language">
                     <option value="en" data-translate="lang_en">🇬🇧 English</option>
                     <option value="pt" data-translate="lang_pt">🇧🇷 Português</option>
                     <option value="zh" data-translate="lang_zh">🇨🇳 中文</option>
                 </select>
            </li>
        </ul>
    </nav>

    <!-- ========= Header (Adapted for Advanced) ========= -->
    <header class="practice-header">
        <!-- *** MODIFIED Icons *** -->
        <i class="fas fa-file-signature header-icon icon1"></i>
        <i class="fas fa-cogs header-icon icon2"></i>
        <div class="container">
            <!-- *** MODIFIED Text *** -->
            <h1 data-translate="header_title">Module 24: Advanced Practice</h1>
            <p data-translate="header_subtitle">Challenge yourself further with file writing techniques.</p>
        </div>
    </header>

    <!-- ========= Main Content ========= -->
    <main>
        <!-- ========= Activity 1: Build-a-Multi-Write Statement (Adapted) ========= -->
        <section id="build-multi-write" class="practice-section">
             <div class="container">
                 <h2 class="fade-in"><i class="fas fa-puzzle-piece"></i> <span data-translate="build_title">Build: Multiple Lines</span></h2>
                 <p class="section-description fade-in delay-1" data-translate="build_desc">
                     Construct the code using `with open`. Write **two separate lines** to `report.txt` in append mode (`'a'`):<br>
                     Line 1: `Status: OK\n`<br>
                     Line 2: `Data logged.\n`
                 </p>
                 <div class="interactive-area fade-in delay-2">
                     <div id="draggable-pieces" class="draggable-pieces">
                         <!-- Pieces populated by JS: Needs pieces for with, open, 'report.txt', 'a', as, f (or similar var), :, f.write, "Status: OK\n", "Data logged.\n", parentheses -->
                     </div>
                     <div id="build-drop-zone" class="code-font">
                         <span id="build-drop-zone-placeholder" data-translate="build_drop_placeholder">Drop pieces for the full 'with' block...</span>
                         <!-- Use visual line break cue if needed: <span class="line-break-visual"></span> -->
                     </div>
                     <div class="text-center">
                         <button id="check-build-btn" class="action-button" data-translate="button_check_build">Check My Code</button>
                         <button id="reset-build-btn" class="action-button secondary" data-translate="button_reset_build">Reset</button>
                     </div>
                     <div id="build-feedback" class="feedback-message"></div>
                 </div>
             </div>
        </section>

        <!-- ========= Activity 2: Data Type Challenge (New Activity) ========= -->
        <section id="data-type-challenge" class="practice-section">
             <div class="container">
                 <h2 class="fade-in"><i class="fas fa-exchange-alt"></i> <span data-translate="data_type_title">Challenge: Writing Numbers</span></h2>
                 <p class="section-description fade-in delay-1" data-translate="data_type_desc">
                     The `.write()` method only accepts strings! Type code to write a score (e.g., `score = 100`) to `scores.txt` in write mode (`'w'`). Remember to convert the number to a string first using `str()`. Include a newline `\n`.
                 </p>
                 <div class="interactive-area fade-in delay-2">
                     <label for="sim-editor-input-dt" style="font-weight: bold; display:block; margin-bottom: 8px;" data-translate="simulator_editor_label">Code Editor:</label>
                     <textarea id="sim-editor-input-dt" class="sim-editor" rows="5" data-translate-placeholder="data_type_placeholder" placeholder='score = 100\nwith open("scores.txt", "w") as f:\n    f.write( # Convert score to string here! )'></textarea>
                     <div class="text-center">
                          <button id="run-sim-btn-dt" class="action-button" data-translate="button_run_sim">Run Simulation</button>
                     </div>
                     <label for="sim-output-dt" style="font-weight: bold; display:block; margin-top: 1.5rem; margin-bottom: 8px;" data-translate="simulator_output_label">Simulated File Content:</label>
                     <div id="sim-output-dt" class="sim-output-area">
                         <span class="placeholder" data-translate="simulator_output_placeholder">File content will appear here...</span>
                     </div>
                     <div id="sim-feedback-dt" class="feedback-message"></div>
                 </div>
             </div>
        </section>

         <!-- ========= Activity 3: Write from Loop (New Activity) ========= -->
        <section id="write-from-loop" class="practice-section">
             <div class="container">
                 <h2 class="fade-in"><i class="fas fa-sync-alt"></i> <span data-translate="loop_title">Write Using a Loop</span></h2>
                 <p class="section-description fade-in delay-1" data-translate="loop_desc">
                     Imagine you have a list: `items = ["CPU", "GPU", "RAM"]`. Write code using a `for` loop inside a `with open` block to write each item to `hardware.log` (append mode `'a'`), adding a newline `\n` after each item.
                 </p>
                 <div class="interactive-area fade-in delay-2">
                     <label for="sim-editor-input-loop" style="font-weight: bold; display:block; margin-bottom: 8px;" data-translate="simulator_editor_label">Code Editor:</label>
                     <textarea id="sim-editor-input-loop" class="sim-editor" rows="7" data-translate-placeholder="loop_placeholder" placeholder='items = ["CPU", "GPU", "RAM"]\nwith open("hardware.log", "a") as hw_log:\n    for item in items:\n        # Write item + newline here'></textarea>
                     <div class="text-center">
                          <button id="run-sim-btn-loop" class="action-button" data-translate="button_run_sim">Run Simulation</button>
                          <button id="clear-sim-file-btn-loop" class="action-button secondary" data-translate="button_clear_sim_file">Clear hardware.log</button>
                     </div>
                     <label for="sim-output-loop" style="font-weight: bold; display:block; margin-top: 1.5rem; margin-bottom: 8px;" data-translate="simulator_output_label">Simulated File Content:</label>
                     <div id="sim-output-loop" class="sim-output-area">
                         <span class="placeholder" data-translate="simulator_output_placeholder">File content will appear here...</span>
                     </div>
                     <div id="sim-feedback-loop" class="feedback-message"></div>
                 </div>
             </div>
        </section>

         <!-- ========= Activity 4: Advanced Mini Missions (Adapted) ========= -->
        <section id="adv-mini-missions" class="practice-section">
             <div class="container">
                  <h2 class="fade-in"><i class="fas fa-rocket"></i> <span data-translate="missions_title">Advanced Mini Missions</span></h2>
                 <p class="section-description fade-in delay-1" data-translate="missions_desc">
                     Apply your skills to these challenges. Pay attention to filenames, modes, and required content format!
                 </p>
                 <div class="interactive-area fade-in delay-2">
                     <!-- Mission 1 -->
                     <div class="mission" id="mission-1" data-completed="false">
                         <span class="mission-status"><i class="fas fa-question-circle"></i></span>
                         <h4 data-translate="mission1_title">Adv. Mission 1: Single Write, Multiple Lines</h4>
                         <p data-translate="mission1_desc">Using only **one** `.write()` call, create/overwrite `greeting.txt` (mode `'w'`) with the exact content:<br>`Hello\nWorld\n`</p>
                         <textarea class="sim-editor mission-editor" rows="4" data-translate-placeholder="mission1_placeholder" placeholder='with open("greeting.txt", "w") as greet_file:\n    greet_file.write("...") # Include newline characters!'></textarea>
                         <div class="text-center"> <button class="action-button mission-run-btn" data-mission-id="1" data-translate="button_test_mission">Test Mission</button> </div>
                         <div class="sim-output-area mission-output"></div>
                         <div id="mission-feedback-1" class="feedback-message mission-feedback"></div>
                     </div>
                     <!-- Mission 2 -->
                     <div class="mission" id="mission-2" data-completed="false">
                          <span class="mission-status"><i class="fas fa-question-circle"></i></span>
                         <h4 data-translate="mission2_title">Adv. Mission 2: Append Formatted Data</h4>
                         <p data-translate="mission2_desc">You have `user_id = 5` and `action = "updated"`. Append a line to `activity.log` (mode `'a'`) in the format: `ID: 5 - Action: updated\n`. Remember to convert `user_id` to a string!</p>
                         <textarea class="sim-editor mission-editor" rows="5" data-translate-placeholder="mission2_placeholder" placeholder='user_id = 5\naction = "updated"\nwith open("activity.log", "a") as act_log:\n    # Construct the string and write it'></textarea>
                          <div class="text-center"> <button class="action-button mission-run-btn" data-mission-id="2" data-translate="button_test_mission">Test Mission</button> </div>
                         <div class="sim-output-area mission-output"></div>
                         <div id="mission-feedback-2" class="feedback-message mission-feedback"></div>
                     </div>
                     <!-- Mission 3 -->
                     <div class="mission" id="mission-3" data-completed="false">
                          <span class="mission-status"><i class="fas fa-question-circle"></i></span>
                         <h4 data-translate="mission3_title">Adv. Mission 3: Overwrite with Key-Value</h4>
                         <p data-translate="mission3_desc">Overwrite (`'w'`) the file `settings.ini` with the following key-value pairs, each on its own line (ending with `\n`):<br>`theme=dark`<br>`autosave=true`</p>
                         <textarea class="sim-editor mission-editor" rows="5" data-translate-placeholder="mission3_placeholder" placeholder='with open("settings.ini", "w") as settings_file:\n    settings_file.write("key1=value1\\n")\n    settings_file.write("key2=value2\\n")'></textarea>
                          <div class="text-center"> <button class="action-button mission-run-btn" data-mission-id="3" data-translate="button_test_mission">Test Mission</button> </div>
                         <div class="sim-output-area mission-output"></div>
                         <div id="mission-feedback-3" class="feedback-message mission-feedback"></div>
                     </div>
                     <div id="missions-summary-feedback" class="feedback-message" style="margin-top: 2rem;"></div>
                 </div>
             </div>
        </section>

         <!-- ========= Completion Section (Adapted Links) ========= -->
        <section class="completion-section">
            <div class="container">
                <!-- *** MODIFIED Icon *** -->
                <div class="icon fade-in" style="animation: iconAppearCorrect 1s ease-out 0.5s forwards;">
                     <i class="fas fa-star"></i><i class="fas fa-file-code"></i><i class="fas fa-star"></i>
                </div>
                <h2 class="fade-in delay-1" data-translate="completion_title">Module 24 Advanced Practice Complete!</h2>
                <p class="fade-in delay-2" data-translate="completion_desc">
                    Excellent job tackling these advanced file writing exercises! You're building solid persistence skills.<br>
                    Review the basic practice or watch the video lesson if needed, or head back to the course menu.
                </p>
                <div class="button-group">
                     <!-- *** MODIFIED Links for Advanced Page *** -->
                    <a href="ctp-practice-24.html" class="action-button secondary fade-in delay-3"><i class="fas fa-pencil-alt"></i> <span data-translate="button_view_basic_practice">View Basic Practice</span></a>
                    <a href="ctp-video-24.html" class="action-button info fade-in delay-3"><i class="fas fa-video"></i> <span data-translate="button_watch_video">Watch Video Lesson</span></a>
                    <a href="ctp-dashboard.html" class="action-button secondary fade-in delay-4"><i class="fas fa-list"></i> <span data-translate="button_back_menu">Back to Course Menu</span></a>
                </div>
            </div>
        </section>
    </main>

    <!-- ========= Script ========= -->
    <script>
    // --- Translations Object (Module 24 - Advanced) ---
    const translations = {
        en: {
            "page_title": "Module 24: Advanced Python Practice - Files",
            "nav_basic_practice": "View Basic Practice", "nav_video": "Watch Video Lesson", "nav_menu": "Course Menu",
            "nav_build": "Build", "nav_data_types": "Data Types", "nav_loop": "Loop Write", "nav_missions": "Missions", // In-page nav
            "lang_en": "🇬🇧 English", "lang_pt": "🇧🇷 Português", "lang_zh": "🇨🇳 中文",
            "header_title": "Module 24: Advanced Practice", "header_subtitle": "Challenge yourself further with file writing techniques.",
            "build_title": "Build: Multiple Lines", "build_desc": "Construct the code using `with open`. Write **two separate lines** to `report.txt` in append mode (`'a'`):<br>Line 1: `Status: OK\\n`<br>Line 2: `Data logged.\\n`",
            "build_drop_placeholder": "Drop pieces for the full 'with' block...",
            "build_piece_with": "with", "build_piece_open": "open", "build_piece_paren_open": "(", "build_piece_paren_close": ")",
            "build_piece_filename_report": "'report.txt'", "build_piece_filename_scores": "'scores.txt'", // More filenames
            "build_piece_mode_w": "'w'", "build_piece_mode_a": "'a'", "build_piece_comma": ",", "build_piece_as": "as",
            "build_piece_variable_f": "f", "build_piece_variable_rep": "report_file", "build_piece_colon": ":", // More variables
            "build_piece_write_call_f": "f.write", "build_piece_write_call_rep": "report_file.write",
            "build_piece_data_status": "\"Status: OK\\n\"", "build_piece_data_logged": "\"Data logged.\\n\"", "build_piece_data_header": "\"HEADER\\n\"", // More data
            "button_check_build": "Check My Code", "button_reset_build": "Reset",
            "feedback_build_correct": "Excellent! Structure for multiple writes is correct.",
            "feedback_build_almost": "Close! Check the mode ('a'), filename, or the content/order of the two `.write()` calls.",
            "feedback_build_incorrect": "Hmm, review the `with open(...)` syntax and how to make multiple `.write()` calls.",
            "data_type_title": "Challenge: Writing Numbers", "data_type_desc": "The `.write()` method only accepts strings! Type code to write a score (e.g., `score = 100`) to `scores.txt` in write mode (`'w'`). Remember to convert the number to a string first using `str()`. Include a newline `\\n`.",
            "data_type_placeholder": "score = 100\nwith open(\"scores.txt\", \"w\") as f:\n    f.write( # Convert score to string here! )",
            "simulator_editor_label": "Code Editor:", "simulator_output_label": "Simulated File Content:",
            "simulator_filename_header": "File: {filename}", "simulator_output_placeholder": "File content will appear here...",
            "button_run_sim": "Run Simulation", "button_clear_sim_file": "Clear {filename}", // Dynamic clear button text
            "feedback_sim_success": "Simulation ran. Check simulated file content.", "feedback_sim_empty": "Editor is empty.",
            "feedback_sim_syntax": "Check syntax: `with open(...) as ...:`, indentation, `.write(...)`.",
            "feedback_sim_no_str": "Type Error likely: Did you forget `str()` to convert the number before writing?",
            "feedback_sim_no_conversion": "Incorrect output. Ensure the number was converted to a string with `str()`.",
            "feedback_sim_missing_newline": "Output correct, but missing the final newline `\\n`?",
            "feedback_sim_cleared": "Simulated file {filename} cleared.",
            "loop_title": "Write Using a Loop", "loop_desc": "Imagine you have a list: `items = [\"CPU\", \"GPU\", \"RAM\"]`. Write code using a `for` loop inside a `with open` block to write each item to `hardware.log` (append mode `'a'`), adding a newline `\\n` after each item.",
            "loop_placeholder": "items = [\"CPU\", \"GPU\", \"RAM\"]\nwith open(\"hardware.log\", \"a\") as hw_log:\n    for item in items:\n        # Write item + newline here",
            "feedback_loop_no_loop": "Missing `for` loop structure inside the `with` block.",
            "feedback_loop_no_write": "Missing `.write()` call inside the loop.",
            "feedback_loop_wrong_content": "Loop seems okay, but check what's being written inside. Should be `item + '\\n'`.",
            "feedback_loop_indentation": "Check indentation of the `for` loop and the `.write()` call inside it.",
            "missions_title": "Advanced Mini Missions", "missions_desc": "Apply your skills to these challenges. Pay attention to filenames, modes, and required content format!",
            "greeting_filename": "greeting.txt", "activity_filename": "activity.log", "settings_filename": "settings.ini",
            "mission1_title": "Adv. Mission 1: Single Write, Multiple Lines", "mission1_desc": "Using only **one** `.write()` call, create/overwrite `greeting.txt` (mode `'w'`) with the exact content:<br>`Hello\\nWorld\\n`", "mission1_placeholder": "with open(\"greeting.txt\", \"w\") as greet_file:\n    greet_file.write(\"...\") # Include newline characters!",
            "mission2_title": "Adv. Mission 2: Append Formatted Data", "mission2_desc": "You have `user_id = 5` and `action = \"updated\"`. Append a line to `activity.log` (mode `'a'`) in the format: `ID: 5 - Action: updated\\n`. Remember to convert `user_id` to a string!", "mission2_placeholder": "user_id = 5\naction = \"updated\"\nwith open(\"activity.log\", \"a\") as act_log:\n    # Construct the string and write it",
            "mission3_title": "Adv. Mission 3: Overwrite with Key-Value", "mission3_desc": "Overwrite (`'w'`) the file `settings.ini` with the following key-value pairs, each on its own line (ending with `\\n`):<br>`theme=dark`<br>`autosave=true`", "mission3_placeholder": "with open(\"settings.ini\", \"w\") as settings_file:\n    settings_file.write(\"key1=value1\\n\")\n    settings_file.write(\"key2=value2\\n\")",
            "button_test_mission": "Test Mission",
            "feedback_mission_success": "Mission Accomplished! Excellent.", "feedback_mission_syntax_error": "Syntax/logic error.",
            "feedback_mission_generic_hint": "Check `with open(...)`, mode, filename, `.write(...)` content/format, `str()` conversions, and `\\n`.",
            "feedback_mission1_hint": "Use mode 'w', file 'greeting.txt'. One `.write()` call with \"Hello\\nWorld\\n\".",
            "feedback_mission2_hint": "Use mode 'a', file 'activity.log'. Construct the string like \"ID: \" + str(user_id) + \" - Action: \" + action + \"\\n\".",
            "feedback_mission3_hint": "Use mode 'w', file 'settings.ini'. Two `.write()` calls: first \"theme=dark\\n\", second \"autosave=true\\n\".",
            "feedback_missions_summary_all_done": "All {totalMissions} advanced missions complete! File expert!", "feedback_missions_summary_progress": "Completed {completedCount} of {totalMissions} advanced missions. Keep challenging yourself!",
            "completion_title": "Module 24 Advanced Practice Complete!", "completion_desc": "Excellent job tackling these advanced file writing exercises! You're building solid persistence skills.<br> Review the basic practice or watch the video lesson if needed, or head back to the course menu.",
            "button_view_basic_practice": "View Basic Practice", "button_watch_video": "Watch Video Lesson", "button_back_menu": "Back to Course Menu"
        },
        pt: {
            "page_title": "Módulo 24: Prática Avançada Python - Arquivos",
            "nav_basic_practice": "Ver Prática Básica", "nav_video": "Ver Videoaula", "nav_menu": "Menu do Curso",
            "nav_build": "Construir", "nav_data_types": "Tipos de Dados", "nav_loop": "Escrever em Loop", "nav_missions": "Missões",
            "lang_en": "🇬🇧 English", "lang_pt": "🇧🇷 Português", "lang_zh": "🇨🇳 中文",
            "header_title": "Módulo 24: Prática Avançada", "header_subtitle": "Desafie-se ainda mais com técnicas de escrita em arquivos.",
            "build_title": "Construir: Múltiplas Linhas", "build_desc": "Construa o código usando `with open`. Escreva **duas linhas separadas** em `report.txt` no modo de anexar (`'a'`):<br>Linha 1: `Status: OK\\n`<br>Linha 2: `Data logged.\\n`",
            "build_drop_placeholder": "Solte as peças para o bloco 'with' completo...",
            "build_piece_with": "with", "build_piece_open": "open", "build_piece_paren_open": "(", "build_piece_paren_close": ")",
            "build_piece_filename_report": "'report.txt'", "build_piece_filename_scores": "'scores.txt'",
            "build_piece_mode_w": "'w'", "build_piece_mode_a": "'a'", "build_piece_comma": ",", "build_piece_as": "as",
            "build_piece_variable_f": "f", "build_piece_variable_rep": "arq_relatorio", "build_piece_colon": ":", // pt var
            "build_piece_write_call_f": "f.write", "build_piece_write_call_rep": "arq_relatorio.write",
            "build_piece_data_status": "\"Status: OK\\n\"", "build_piece_data_logged": "\"Dados registrados.\\n\"", "build_piece_data_header": "\"CABECALHO\\n\"", // pt data
            "button_check_build": "Verificar Meu Código", "button_reset_build": "Reiniciar",
            "feedback_build_correct": "Excelente! Estrutura para múltiplas escritas está correta.",
            "feedback_build_almost": "Perto! Verifique o modo ('a'), nome do arquivo ou o conteúdo/ordem das duas chamadas `.write()`.",
            "feedback_build_incorrect": "Hmm, revise a sintaxe `with open(...)` e como fazer múltiplas chamadas `.write()`.",
            "data_type_title": "Desafio: Escrevendo Números", "data_type_desc": "O método `.write()` só aceita strings! Digite o código para escrever uma pontuação (ex: `score = 100`) em `scores.txt` no modo de escrita (`'w'`). Lembre-se de converter o número para string primeiro usando `str()`. Inclua uma nova linha `\\n`.",
            "data_type_placeholder": "pontuacao = 100\nwith open(\"scores.txt\", \"w\") as f:\n    f.write( # Converta pontuacao para string aqui! )", // pt var
            "simulator_editor_label": "Editor de Código:", "simulator_output_label": "Conteúdo do Arquivo Simulado:",
            "simulator_filename_header": "Arquivo: {filename}", "simulator_output_placeholder": "O conteúdo do arquivo aparecerá aqui...",
            "button_run_sim": "Executar Simulação", "button_clear_sim_file": "Limpar {filename}",
            "feedback_sim_success": "Simulação executada. Verifique o conteúdo do arquivo simulado.", "feedback_sim_empty": "O editor está vazio.",
            "feedback_sim_syntax": "Verifique a sintaxe: `with open(...) as ...:`, indentação, `.write(...)`.",
            "feedback_sim_no_str": "Provável TypeError: Esqueceu `str()` para converter o número antes de escrever?",
            "feedback_sim_no_conversion": "Saída incorreta. Garanta que o número foi convertido para string com `str()`.",
            "feedback_sim_missing_newline": "Saída correta, mas faltou a nova linha final `\\n`?",
            "feedback_sim_cleared": "Arquivo simulado {filename} limpo.",
            "loop_title": "Escrever Usando Loop", "loop_desc": "Imagine que você tem uma lista: `itens = [\"CPU\", \"GPU\", \"RAM\"]`. Escreva código usando um loop `for` dentro de um bloco `with open` para escrever cada item em `hardware.log` (modo anexar `'a'`), adicionando uma nova linha `\\n` após cada item.",
            "loop_placeholder": "itens = [\"CPU\", \"GPU\", \"RAM\"]\nwith open(\"hardware.log\", \"a\") as log_hw:\n    for item in itens:\n        # Escreva item + nova linha aqui",
            "feedback_loop_no_loop": "Faltando estrutura de loop `for` dentro do bloco `with`.",
            "feedback_loop_no_write": "Faltando chamada `.write()` dentro do loop.",
            "feedback_loop_wrong_content": "Loop parece ok, mas verifique o que está sendo escrito. Deveria ser `item + '\\n'`.",
            "feedback_loop_indentation": "Verifique a indentação do loop `for` e da chamada `.write()` dentro dele.",
            "missions_title": "Mini Missões Avançadas", "missions_desc": "Aplique suas habilidades nestes desafios. Preste atenção aos nomes dos arquivos, modos e formato de conteúdo exigido!",
            "greeting_filename": "saudacao.txt", "activity_filename": "atividade.log", "settings_filename": "config.ini", // pt filenames
            "mission1_title": "Missão Adv. 1: Escrita Única, Múltiplas Linhas", "mission1_desc": "Usando apenas **uma** chamada `.write()`, crie/sobrescreva `saudacao.txt` (modo `'w'`) com o conteúdo exato:<br>`Ola\\nMundo\\n`", "mission1_placeholder": "with open(\"saudacao.txt\", \"w\") as arq_saud:\n    arq_saud.write(\"...\") # Inclua caracteres de nova linha!",
            "mission2_title": "Missão Adv. 2: Anexar Dados Formatados", "mission2_desc": "Você tem `id_usuario = 5` e `acao = \"atualizado\"`. Anexe uma linha a `atividade.log` (modo `'a'`) no formato: `ID: 5 - Acao: atualizado\\n`. Lembre-se de converter `id_usuario` para string!", "mission2_placeholder": "id_usuario = 5\nacao = \"atualizado\"\nwith open(\"atividade.log\", \"a\") as log_ativ:\n    # Construa a string e escreva",
            "mission3_title": "Missão Adv. 3: Sobrescrever com Chave-Valor", "mission3_desc": "Sobrescreva (`'w'`) o arquivo `config.ini` com os seguintes pares chave-valor, cada um em sua própria linha (terminando com `\\n`):<br>`tema=dark`<br>`salvar_auto=true`", "mission3_placeholder": "with open(\"config.ini\", \"w\") as arq_conf:\n    arq_conf.write(\"chave1=valor1\\n\")\n    arq_conf.write(\"chave2=valor2\\n\")",
            "button_test_mission": "Testar Missão",
            "feedback_mission_success": "Missão Cumprida! Excelente.", "feedback_mission_syntax_error": "Erro de sintaxe/lógica.",
            "feedback_mission_generic_hint": "Verifique `with open(...)`, modo, nome do arquivo, conteúdo/formato de `.write(...)`, conversões `str()` e `\\n`.",
            "feedback_mission1_hint": "Use modo 'w', arquivo 'saudacao.txt'. Uma chamada `.write()` com \"Ola\\nMundo\\n\".",
            "feedback_mission2_hint": "Use modo 'a', arquivo 'atividade.log'. Construa a string como \"ID: \" + str(id_usuario) + \" - Acao: \" + acao + \"\\n\".",
            "feedback_mission3_hint": "Use modo 'w', arquivo 'config.ini'. Duas chamadas `.write()`: primeira \"tema=dark\\n\", segunda \"salvar_auto=true\\n\".",
            "feedback_missions_summary_all_done": "Todas as {totalMissions} missões avançadas completas! Expert em arquivos!", "feedback_missions_summary_progress": "Completou {completedCount} de {totalMissions} missões avançadas. Continue se desafiando!",
            "completion_title": "Prática Avançada do Módulo 24 Completa!", "completion_desc": "Excelente trabalho enfrentando estes exercícios avançados de escrita em arquivos! Você está construindo sólidas habilidades de persistência.<br> Revise a prática básica ou assista à videoaula se necessário, ou volte ao menu do curso.",
            "button_view_basic_practice": "Ver Prática Básica", "button_watch_video": "Ver Videoaula", "button_back_menu": "Voltar ao Menu do Curso"
        },
        zh: {
            "page_title": "模块 24：高级 Python 练习 - 文件",
            "nav_basic_practice": "查看基础练习", "nav_video": "观看视频课程", "nav_menu": "课程菜单",
            "nav_build": "构建", "nav_data_types": "数据类型", "nav_loop": "循环写入", "nav_missions": "任务",
            "lang_en": "🇬🇧 English", "lang_pt": "🇧🇷 Português", "lang_zh": "🇨🇳 中文",
            "header_title": "模块 24：高级练习", "header_subtitle": "通过文件写入技巧进一步挑战自己。",
            "build_title": "构建：多行写入", "build_desc": "使用 `with open` 构建代码。在追加模式 (`'a'`)下将**两个独立的行**写入 `report.txt`：<br>第 1 行：`Status: OK\\n`<br>第 2 行：`Data logged.\\n`",
            "build_drop_placeholder": "将碎片拖放到完整的 'with' 代码块...",
            "build_piece_with": "with", "build_piece_open": "open", "build_piece_paren_open": "(", "build_piece_paren_close": ")",
            "build_piece_filename_report": "'report.txt'", "build_piece_filename_scores": "'scores.txt'",
            "build_piece_mode_w": "'w'", "build_piece_mode_a": "'a'", "build_piece_comma": ",", "build_piece_as": "as",
            "build_piece_variable_f": "f", "build_piece_variable_rep": "report_file", "build_piece_colon": ":",
            "build_piece_write_call_f": "f.write", "build_piece_write_call_rep": "report_file.write",
            "build_piece_data_status": "\"Status: OK\\n\"", "build_piece_data_logged": "\"数据已记录。\\n\"", "build_piece_data_header": "\"页眉\\n\"", // zh data
            "button_check_build": "检查我的代码", "button_reset_build": "重置",
            "feedback_build_correct": "太棒了！多次写入的结构是正确的。",
            "feedback_build_almost": "接近了！检查模式 ('a')、文件名或两个 `.write()` 调用的内容/顺序。",
            "feedback_build_incorrect": "嗯，请复习 `with open(...)` 语法以及如何进行多次 `.write()` 调用。",
            "data_type_title": "挑战：写入数字", "data_type_desc": "`.write()` 方法只接受字符串！编写代码将分数（例如 `score = 100`）以写入模式 (`'w'`) 写入 `scores.txt`。记住首先使用 `str()` 将数字转换为字符串。包含换行符 `\\n`。",
            "data_type_placeholder": "score = 100\nwith open(\"scores.txt\", \"w\") as f:\n    f.write( # 在这里将 score 转换为字符串！ )",
            "simulator_editor_label": "代码编辑器：", "simulator_output_label": "模拟文件内容：",
            "simulator_filename_header": "文件：{filename}", "simulator_output_placeholder": "文件内容将显示在此处...",
            "button_run_sim": "运行模拟", "button_clear_sim_file": "清除 {filename}",
            "feedback_sim_success": "模拟已运行。检查模拟文件内容。", "feedback_sim_empty": "编辑器是空的。",
            "feedback_sim_syntax": "检查语法：`with open(...) as ...:`、缩进、`.write(...)`。",
            "feedback_sim_no_str": "可能出现 TypeError：写入前是否忘记使用 `str()` 转换数字？",
            "feedback_sim_no_conversion": "输出不正确。确保使用 `str()` 将数字转换为字符串。",
            "feedback_sim_missing_newline": "输出正确，但是否缺少最后的换行符 `\\n`？",
            "feedback_sim_cleared": "模拟文件 {filename} 已清除。",
            "loop_title": "使用循环写入", "loop_desc": "假设你有一个列表：`items = [\"CPU\", \"GPU\", \"RAM\"]`。在 `with open` 代码块内使用 `for` 循环编写代码，将每个项目写入 `hardware.log`（追加模式 `'a'`），并在每个项目后添加换行符 `\\n`。",
            "loop_placeholder": "items = [\"CPU\", \"GPU\", \"RAM\"]\nwith open(\"hardware.log\", \"a\") as hw_log:\n    for item in items:\n        # 在此处写入 item + 换行符",
            "feedback_loop_no_loop": "`with` 代码块内缺少 `for` 循环结构。",
            "feedback_loop_no_write": "循环内缺少 `.write()` 调用。",
            "feedback_loop_wrong_content": "循环看起来没问题，但请检查写入的内容。应该是 `item + '\\n'`。",
            "feedback_loop_indentation": "检查 `for` 循环及其内部 `.write()` 调用的缩进。",
            "missions_title": "高级迷你任务", "missions_desc": "运用你的技能应对这些挑战。注意文件名、模式和所需的内容格式！",
            "greeting_filename": "greeting.txt", "activity_filename": "activity.log", "settings_filename": "settings.ini",
            "mission1_title": "高级任务 1：单次写入，多行", "mission1_desc": "仅使用 **一次** `.write()` 调用，创建/覆盖 `greeting.txt`（模式 `'w'`），内容完全如下：<br>`Hello\\nWorld\\n`", "mission1_placeholder": "with open(\"greeting.txt\", \"w\") as greet_file:\n    greet_file.write(\"...\") # 包含换行符！",
            "mission2_title": "高级任务 2：追加格式化数据", "mission2_desc": "你有 `user_id = 5` 和 `action = \"updated\"`。将一行以 `ID: 5 - Action: updated\\n` 格式追加到 `activity.log`（模式 `'a'`）。记住将 `user_id` 转换为字符串！", "mission2_placeholder": "user_id = 5\naction = \"updated\"\nwith open(\"activity.log\", \"a\") as act_log:\n    # 构建字符串并写入",
            "mission3_title": "高级任务 3：用键值对覆盖", "mission3_desc": "覆盖 (`'w'`) 文件 `settings.ini`，包含以下键值对，每对占一行（以 `\\n` 结尾）：<br>`theme=dark`<br>`autosave=true`", "mission3_placeholder": "with open(\"settings.ini\", \"w\") as settings_file:\n    settings_file.write(\"key1=value1\\n\")\n    settings_file.write(\"key2=value2\\n\")",
            "button_test_mission": "测试任务",
            "feedback_mission_success": "任务完成！非常棒。", "feedback_mission_syntax_error": "语法/逻辑错误。",
            "feedback_mission_generic_hint": "检查 `with open(...)`、模式、文件名、`.write(...)` 的内容/格式、`str()` 转换和 `\\n`。",
            "feedback_mission1_hint": "使用模式 'w'，文件 'greeting.txt'。一次 `.write()` 调用，内容为 \"Hello\\nWorld\\n\"。",
            "feedback_mission2_hint": "使用模式 'a'，文件 'activity.log'。构建字符串，例如 \"ID: \" + str(user_id) + \" - Action: \" + action + \"\\n\"。",
            "feedback_mission3_hint": "使用模式 'w'，文件 'settings.ini'。两次 `.write()` 调用：第一次是 \"theme=dark\\n\"，第二次是 \"autosave=true\\n\"。",
            "feedback_missions_summary_all_done": "所有 {totalMissions} 个高级任务已完成！文件专家！", "feedback_missions_summary_progress": "已完成 {completedCount} / {totalMissions} 个高级任务。继续挑战自我！",
            "completion_title": "模块 24 高级练习完成！", "completion_desc": "出色地完成了这些高级文件写入练习！你正在建立扎实的数据持久化技能。<br> 如果需要，可以复习基础练习或观看视频课程，或返回课程菜单。",
            "button_view_basic_practice": "查看基础练习", "button_watch_video": "观看视频课程", "button_back_menu": "返回课程菜单"
        }
    };


    document.addEventListener('DOMContentLoaded', () => {

        // --- Language Management Functions (Mostly Unchanged) ---
        function getStoredLanguage() { /* ... unchanged ... */
            const storedLang = localStorage.getItem('userLanguage');
            if (storedLang && translations[storedLang]) return storedLang;
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith('pt')) return 'pt';
            if (browserLang.startsWith('zh')) return 'zh';
            return 'en';
        }

        function setLanguage(lang) { /* ... */
            if (!translations[lang]) lang = 'en';
            localStorage.setItem('userLanguage', lang);
            document.documentElement.lang = lang;
            translatePage(lang);

            const langSelect = document.getElementById('languageSelect');
            if (langSelect) langSelect.value = lang;

            // Re-initialize or update language-dependent interactive content
            if (buildSection) setupBuildListeners();
            if (dataTypeSection) updateDataTypePlaceholders();
            if (loopSection) updateLoopPlaceholders(); // Update loop simulator placeholders
            if (missionsSection) updateMissionSummary(); // Update mission text/summary
        }

        function getTranslation(key, lang, replacements = {}) { /* ... unchanged ... */
             let text = translations[lang]?.[key] ?? translations['en']?.[key] ?? `[${key}]`;
            for (const placeholder in replacements) {
                const regex = new RegExp(`\\{${placeholder}\\}`, 'g');
                text = text.replace(regex, replacements[placeholder]);
            }
            return text;
        }

        function translatePage(lang) { /* ... */
            if (!translations[lang]) lang = 'en';
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                const translation = getTranslation(key, lang);
                 if (el.tagName === 'TITLE') document.title = translation;
                 else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {} // Placeholders handled below
                 else if (el.tagName === 'OPTION') el.textContent = translation;
                 else {
                    if (translation.includes('<') && translation.includes('>')) el.innerHTML = translation;
                    else el.textContent = translation;
                 }
            });
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                const translation = getTranslation(key, lang);
                el.setAttribute('placeholder', translation);
            });
            // Dynamic button text update (e.g., Clear button)
            document.querySelectorAll('[data-translate-dynamic-filename]').forEach(el => {
                const key = el.getAttribute('data-translate-dynamic-filename');
                const filename = el.dataset.filename || 'file'; // Fallback filename
                const translation = getTranslation(key, lang, { filename: filename });
                 if (el.tagName === 'BUTTON') {
                    // Find the span inside if exists, otherwise set button text
                    const span = el.querySelector('span');
                    if(span) span.textContent = translation;
                    else el.textContent = translation;
                 }
             });
        }

        const initialLang = getStoredLanguage();

        // --- Minimal Nav Logic (Unchanged) ---
        const navToggleButton = document.getElementById('minimal-nav-toggle'); /* ... */
        const navPanel = document.getElementById('minimal-nav-panel'); /* ... */
        const body = document.body; /* ... */
        if (navToggleButton && navPanel) { /* ... nav toggling logic ... */
             navToggleButton.addEventListener('click', (event) => { event.stopPropagation(); body.classList.toggle('nav-active'); navToggleButton.setAttribute('aria-expanded', body.classList.contains('nav-active')); });
            document.addEventListener('click', (event) => { if (body.classList.contains('nav-active') && !navPanel.contains(event.target) && event.target !== navToggleButton && !navToggleButton.contains(event.target) ) { body.classList.remove('nav-active'); navToggleButton.setAttribute('aria-expanded', 'false'); } });
            navPanel.querySelectorAll('a').forEach(link => { link.addEventListener('click', () => { body.classList.remove('nav-active'); navToggleButton.setAttribute('aria-expanded', 'false'); }); });
            document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && body.classList.contains('nav-active')) { body.classList.remove('nav-active'); navToggleButton.setAttribute('aria-expanded', 'false'); } });
            navToggleButton.setAttribute('aria-expanded', 'false');
        }

        // --- Language Switcher Setup (Unchanged) ---
        const langSelect = document.getElementById('languageSelect'); /* ... */
        if (langSelect) { langSelect.addEventListener('change', (e) => setLanguage(e.target.value)); }

        // --- Helper Function for Feedback (Unchanged) ---
        function showFeedback(elementId, messageKey, type = 'info', replacements = {}) { /* ... */
             const feedbackEl = document.getElementById(elementId);
            if (!feedbackEl) { console.error(`Feedback element not found: ${elementId}`); return; }
            const currentLang = getStoredLanguage();
            const translatedMessage = getTranslation(messageKey, currentLang, replacements);
             if (translatedMessage.includes('<') && translatedMessage.includes('>')) feedbackEl.innerHTML = translatedMessage;
             else feedbackEl.textContent = translatedMessage;
            feedbackEl.className = 'feedback-message';
            feedbackEl.classList.add('visible', type);
            const interactiveArea = feedbackEl.closest('.interactive-area');
            if (!interactiveArea) return;
            interactiveArea.classList.remove('success-glow-anim', 'shake-anim');
            void interactiveArea.offsetWidth;
            if (type === 'correct') interactiveArea.classList.add('success-glow-anim');
            else if (type === 'incorrect') interactiveArea.classList.add('shake-anim');
        }

        // --- Generic File Simulation Logic ---
        // Stores content keyed by a unique identifier (e.g., 'sim-loop-hardware.log', 'mission-1-greeting.txt')
        let simulatedFileStore = {};

        function updateSimulatedFile(fileKey, mode, contentToAdd) {
            if (mode === 'w') {
                simulatedFileStore[fileKey] = contentToAdd;
            } else if (mode === 'a') {
                simulatedFileStore[fileKey] = (simulatedFileStore[fileKey] || '') + contentToAdd;
            }
        }

        function clearSimulatedFile(fileKey) {
            simulatedFileStore[fileKey] = '';
        }

        function getSimulatedFileContent(fileKey) {
            return simulatedFileStore[fileKey] || '';
        }

        function displaySimulatedContent(outputAreaId, fileKey, filename, placeholderKey) {
            const outputArea = document.getElementById(outputAreaId);
            if (!outputArea) return;
            outputArea.innerHTML = ''; // Clear previous output

            const currentLang = getStoredLanguage();
            const header = document.createElement('span');
            header.classList.add('filename-header');
            header.textContent = getTranslation('simulator_filename_header', currentLang, { filename: filename });
            outputArea.appendChild(header);

            const content = getSimulatedFileContent(fileKey);
            if (content) {
                content.split('\n').forEach((lineText, index, arr) => {
                    if (index === arr.length - 1 && lineText === '') return; // Don't show trailing empty line
                    const line = document.createElement('span');
                    line.classList.add('output-line');
                    line.textContent = lineText;
                    outputArea.appendChild(line);
                });
            } else {
                const placeholder = document.createElement('span');
                placeholder.className = 'placeholder';
                placeholder.dataset.translate = placeholderKey; // Use specific key if provided
                placeholder.textContent = getTranslation(placeholderKey || 'simulator_output_placeholder', currentLang);
                outputArea.appendChild(placeholder);
            }
        }


        // --- Activity 1: Build-a-Multi-Write (Adapted) ---
        const buildSection = document.getElementById('build-multi-write');
        let buildDropZone;
        if (buildSection) {
            const piecesContainer = document.getElementById('draggable-pieces');
            buildDropZone = document.getElementById('build-drop-zone');
            const checkBtn = document.getElementById('check-build-btn');
            const resetBtn = document.getElementById('reset-build-btn');
            const feedbackDiv = document.getElementById('build-feedback');

             const initialPiecesData = [ // Pieces for writing two lines to report.txt in append mode
                 { key: 'build_piece_with', canonicalValue: 'with', type: 'keyword' },
                 { key: 'build_piece_open', canonicalValue: 'open', type: 'function' },
                 { key: 'build_piece_paren_open', canonicalValue: '(', type: 'paren-open' },
                 { key: 'build_piece_filename_report', canonicalValue: "'report.txt'", type: 'filename' }, // Correct filename
                 { key: 'build_piece_comma', canonicalValue: ',', type: 'separator' },
                 { key: 'build_piece_mode_a', canonicalValue: "'a'", type: 'mode' }, // Correct mode 'a'
                 { key: 'build_piece_paren_close', canonicalValue: ')', type: 'paren-close' },
                 { key: 'build_piece_as', canonicalValue: 'as', type: 'keyword' },
                 { key: 'build_piece_variable_f', canonicalValue: 'f', type: 'variable' }, // Example variable
                 { key: 'build_piece_colon', canonicalValue: ':', type: 'separator' },
                 // Need two write calls or equivalent structure
                 { key: 'build_piece_write_call_f', canonicalValue: 'f.write', type: 'method' },
                 { key: 'build_piece_paren_open', canonicalValue: '(', type: 'paren-open' }, // For 1st write
                 { key: 'build_piece_data_status', canonicalValue: '"Status: OK\\n"', type: 'string' }, // 1st data
                 { key: 'build_piece_paren_close', canonicalValue: ')', type: 'paren-close' }, // For 1st write
                 // Need pieces for the second write call
                 { key: 'build_piece_write_call_f', canonicalValue: 'f.write', type: 'method' }, // 2nd write method
                 { key: 'build_piece_paren_open', canonicalValue: '(', type: 'paren-open' }, // For 2nd write
                 { key: 'build_piece_data_logged', canonicalValue: '"Data logged.\\n"', type: 'string' }, // 2nd data
                 { key: 'build_piece_paren_close', canonicalValue: ')', type: 'paren-close' }, // For 2nd write
                 // Distractors
                 { key: 'build_piece_mode_w', canonicalValue: "'w'", type: 'mode' },
                 { key: 'build_piece_data_header', canonicalValue: '"HEADER\\n"', type: 'string' }
             ];

            // createPieceElement, populatePieces, setupBuildListeners (similar to basic, using new pieces data)
             function createPieceElement(pieceData, currentLang) { /* ... identical logic ... */
                 const piece = document.createElement('span');
                piece.classList.add('piece', 'code-font');
                piece.draggable = true;
                const displayText = getTranslation(pieceData.key, currentLang);
                piece.textContent = displayText;
                piece.dataset.value = pieceData.canonicalValue;
                piece.dataset.type = pieceData.type;
                if(pieceData.key) piece.dataset.transKey = pieceData.key;
                piece.classList.add(`piece-type-${pieceData.type}`); // Add type class for CSS styling if needed

                addDragListeners(piece);
                addTouchListeners(piece);
                return piece;
             }
             function populatePieces() { /* ... identical logic ... */
                 const currentLang = getStoredLanguage();
                 piecesContainer.innerHTML = '';
                 const shuffledPieces = [...initialPiecesData].sort(() => Math.random() - 0.5);
                 shuffledPieces.forEach(pData => {
                     piecesContainer.appendChild(createPieceElement(pData, currentLang));
                 });
             }
             function setupBuildListeners() { /* ... mostly identical logic ... */
                 populatePieces();
                 buildDropZone.innerHTML = '';
                 const placeholder = document.createElement('span');
                 placeholder.id = 'build-drop-zone-placeholder';
                 placeholder.dataset.translate = 'build_drop_placeholder';
                 placeholder.textContent = getTranslation('build_drop_placeholder', getStoredLanguage());
                 buildDropZone.appendChild(placeholder);
                 feedbackDiv.classList.remove('visible', 'correct', 'incorrect', 'info');
                 checkBtn.classList.remove('success');
                 checkBtn.disabled = false;
                 buildDropZone.classList.remove('over');
             }
             // Drag and Touch Logic (identical to basic practice, ensure correct dropzone ID is used)
             function addDragListeners(element){/* ... */ element.addEventListener('dragstart', (e) => { if (e.target.closest('#build-drop-zone')) { e.preventDefault(); return; } /*...*/ }); /* ... */}
             function handleTouchStart(e){/* ... */ if (touchDragElement || e.target.closest('#build-drop-zone')) return; /*...*/ }
             function handleTouchMove(e){/* ... */ const isOverDropZone = elemBelow === buildDropZone || buildDropZone.contains(elemBelow); buildDropZone.classList.toggle('over', isOverDropZone); /*...*/ }
             function handleTouchEnd(e){/* ... */ const droppedInZone = elemBelow === buildDropZone || buildDropZone.contains(elemBelow); /*...*/ }
             function addTouchListeners(element){/* ... */}
             buildDropZone.addEventListener('dragover', (e) => { e.preventDefault(); buildDropZone.classList.add('over'); }); /* ... */
             buildDropZone.addEventListener('dragleave', () => { buildDropZone.classList.remove('over'); }); /* ... */
             buildDropZone.addEventListener('drop', (e) => { /* ... */ buildDropZone.querySelector('#build-drop-zone-placeholder')?.remove(); /* ... */ });

            checkBtn.addEventListener('click', () => {
                 const droppedPieces = Array.from(buildDropZone.querySelectorAll('.piece'));
                 // Target: with open ( 'report.txt' , 'a' ) as f : f.write ( "Status: OK\n" ) f.write ( "Data logged.\n" )
                 // Note: Indentation is visual, check sequence. Also allow other variable names.
                 const canonicalSequence = droppedPieces.map(p => p.dataset.value).join(' ');
                 // Allow flexibility in variable name, check core parts
                 const withPart = "with open ( 'report.txt' , 'a' ) as ";
                 const firstWritePart = ".write ( \"Status: OK\\n\" )";
                 const secondWritePart = ".write ( \"Data logged.\\n\" )";

                 let isValid = false;
                 if (canonicalSequence.startsWith(withPart)) {
                    // Extract variable name (simple split, assumes single space)
                    const partsAfterAs = canonicalSequence.substring(withPart.length).split(' ');
                    if (partsAfterAs.length >= 4 && partsAfterAs[1] === ':') { // Check for variable and colon
                        const variableName = partsAfterAs[0];
                        const expectedSequenceEnd = `${variableName}${firstWritePart} ${variableName}${secondWritePart}`;
                        // Check if the sequence ends correctly after the colon part
                        if(canonicalSequence.endsWith(expectedSequenceEnd)) {
                           isValid = true;
                        }
                    }
                 }


                 if (isValid) {
                     showFeedback('build-feedback', 'feedback_build_correct', 'correct');
                     checkBtn.classList.add('success'); checkBtn.disabled = true;
                 } else if (canonicalSequence.includes('with open') && canonicalSequence.includes("'a'") && canonicalSequence.includes('.write')) {
                     showFeedback('build-feedback', 'feedback_build_almost', 'incorrect');
                     checkBtn.classList.remove('success');
                 } else {
                     showFeedback('build-feedback', 'feedback_build_incorrect', 'incorrect');
                     checkBtn.classList.remove('success');
                 }
            });
            resetBtn.addEventListener('click', setupBuildListeners);
        }

        // --- Activity 2: Data Type Challenge (New Logic) ---
        const dataTypeSection = document.getElementById('data-type-challenge');
        const dataTypeFileKey = 'sim-dt-scores.txt';
        const dataTypeFilename = 'scores.txt';

        function updateDataTypePlaceholders() {
             if (!dataTypeSection) return;
             const currentLang = getStoredLanguage();
             const editor = document.getElementById('sim-editor-input-dt');
             const outputArea = document.getElementById('sim-output-dt');
             const placeholder = outputArea.querySelector('.placeholder');
             if (editor) editor.placeholder = getTranslation('data_type_placeholder', currentLang);
             if (placeholder) placeholder.textContent = getTranslation('simulator_output_placeholder', currentLang);
        }

        if (dataTypeSection) {
            const editor = document.getElementById('sim-editor-input-dt');
            const runBtn = document.getElementById('run-sim-btn-dt');
            const feedbackDiv = document.getElementById('sim-feedback-dt');

            runBtn.addEventListener('click', () => {
                 const code = editor.value;
                 feedbackDiv.classList.remove('visible');
                 let simSuccess = false;
                 let feedbackKey = 'feedback_sim_syntax'; // Default
                 let writtenContent = null; // Track what was actually written

                 // Regex to find with block and the write call, specifically looking for str()
                 const withRegex = /with\s+open\s*\(\s*(["'])scores\.txt\1\s*,\s*(["'])w\2\s*\)\s+as\s+(\w+)\s*:/;
                 // This regex looks for .write(str(variable)) or .write(str(number))
                 const writeRegex = /(\w+)\.write\s*\(\s*str\s*\(\s*(\w+|\d+)\s*\)\s*(\s*\+\s*["']\\n["']\s*)?\)/; // Optional newline concatenation check


                 const withMatch = code.match(withRegex);
                 if (code.trim() === '') {
                     feedbackKey = 'feedback_sim_empty';
                 } else if (withMatch) {
                     const fileVar = withMatch[3];
                     const blockContent = code.substring(withMatch.index + withMatch[0].length);
                     const writeMatch = blockContent.match(writeRegex);

                     // Simple simulation: Does it look like they wrote str(score) or str(100)?
                     if (writeMatch && writeMatch[1] === fileVar && /^\s+/.test(blockContent.substring(0, writeMatch.index))) {
                         const valueInsideStr = writeMatch[2];
                         const includesNewline = writeMatch[3] !== undefined; // Check if newline was concatenated

                         // Simulate assignment check (very basic)
                         let scoreValue = '100'; // Default assumption
                         const assignmentMatch = code.match(/score\s*=\s*(\d+)/);
                         if (assignmentMatch) {
                            scoreValue = assignmentMatch[1];
                         }

                         if (valueInsideStr === 'score' || valueInsideStr === scoreValue) {
                             simSuccess = true;
                             feedbackKey = 'feedback_sim_success';
                             writtenContent = scoreValue + (includesNewline ? '\n' : ''); // Store simulated write
                             // Check if newline is present
                              if (!includesNewline && writeMatch[0].includes('\n')) { // Check if \n was inside str() or missing
                                // Allow if \n was inside str() for simplicity here
                                writtenContent = scoreValue + '\n';
                             } else if (!includesNewline) {
                                 // Feedback if newline seems missing altogether
                                 simSuccess = false; // Mark as not fully correct
                                 feedbackKey = 'feedback_sim_missing_newline';
                             }
                         } else {
                            feedbackKey = 'feedback_sim_no_conversion'; // Wrong variable or number inside str()
                         }
                     } else if (blockContent.includes('.write') && !blockContent.includes('str(')) {
                         // Detected .write but no str()
                         feedbackKey = 'feedback_sim_no_str';
                     } // else: keep default syntax error
                 } // else: keep default syntax error

                 updateSimulatedFile(dataTypeFileKey, 'w', writtenContent); // Update store (writes null on error)
                 displaySimulatedContent('sim-output-dt', dataTypeFileKey, dataTypeFilename, 'simulator_output_placeholder');
                 showFeedback('sim-feedback-dt', feedbackKey, simSuccess ? 'correct' : 'incorrect');
            });

            // Initial display
             displaySimulatedContent('sim-output-dt', dataTypeFileKey, dataTypeFilename, 'simulator_output_placeholder');
             updateDataTypePlaceholders();
        }

        // --- Activity 3: Write from Loop (New Logic) ---
        const loopSection = document.getElementById('write-from-loop');
        const loopFileKey = 'sim-loop-hardware.log';
        const loopFilename = 'hardware.log';

        function updateLoopPlaceholders() {
            if (!loopSection) return;
            const currentLang = getStoredLanguage();
            const editor = document.getElementById('sim-editor-input-loop');
            const outputArea = document.getElementById('sim-output-loop');
            const clearBtn = document.getElementById('clear-sim-file-btn-loop');
            const placeholder = outputArea.querySelector('.placeholder');
            if (editor) editor.placeholder = getTranslation('loop_placeholder', currentLang);
            if (placeholder) placeholder.textContent = getTranslation('simulator_output_placeholder', currentLang);
             if (clearBtn) {
                clearBtn.dataset.filename = loopFilename; // Set filename for dynamic text
                const span = clearBtn.querySelector('span');
                if (span) span.textContent = getTranslation('button_clear_sim_file', currentLang, { filename: loopFilename });
                else clearBtn.textContent = getTranslation('button_clear_sim_file', currentLang, { filename: loopFilename });
             }
        }

        if (loopSection) {
            const editor = document.getElementById('sim-editor-input-loop');
            const runBtn = document.getElementById('run-sim-btn-loop');
            const clearBtn = document.getElementById('clear-sim-file-btn-loop');
            const feedbackDiv = document.getElementById('sim-feedback-loop');

             // Set filename on button for dynamic translation
             clearBtn.dataset.filename = loopFilename;
             clearBtn.setAttribute('data-translate-dynamic-filename', 'button_clear_sim_file'); // Mark for dynamic translation

            runBtn.addEventListener('click', () => {
                const code = editor.value;
                feedbackDiv.classList.remove('visible');
                let simSuccess = false;
                let feedbackKey = 'feedback_sim_syntax';
                let simulatedOutput = ''; // Collect output from the loop

                // Regex for with block, for loop, and write call inside
                const withRegex = /with\s+open\s*\(\s*(["'])hardware\.log\1\s*,\s*(["'])a\2\s*\)\s+as\s+(\w+)\s*:/;
                const forLoopRegex = /for\s+(\w+)\s+in\s+items\s*:/; // Assumes list name 'items'
                const writeRegex = /(\w+)\.write\s*\(\s*(\w+)\s*\+\s*["']\\n["']\s*\)/; // Expects item + '\n'

                const withMatch = code.match(withRegex);
                if (code.trim() === '') {
                    feedbackKey = 'feedback_sim_empty';
                } else if (withMatch) {
                    const fileVar = withMatch[3];
                    const blockContent = code.substring(withMatch.index + withMatch[0].length);
                    const forMatch = blockContent.match(forLoopRegex);

                    if (forMatch) {
                         const loopVar = forMatch[1];
                         // Find content inside the loop (very basic check)
                         const loopBlockMatch = blockContent.substring(forMatch.index + forMatch[0].length).match(/^\s+([\s\S]*)/);
                         if (loopBlockMatch) {
                             const loopBlockContent = loopBlockMatch[1];
                             const writeMatch = loopBlockContent.match(writeRegex);

                            // Check if write call uses correct variables and format
                             if (writeMatch && writeMatch[1] === fileVar && writeMatch[2] === loopVar && /^\s+/.test(loopBlockContent.substring(0, writeMatch.index))) {
                                 // Simulate the loop execution
                                 const items = ["CPU", "GPU", "RAM"]; // As defined in the problem
                                 items.forEach(item => {
                                     simulatedOutput += item + '\n';
                                 });
                                 simSuccess = true;
                                 feedbackKey = 'feedback_sim_success';
                             } else if (!loopBlockContent.includes('.write')) {
                                 feedbackKey = 'feedback_loop_no_write';
                             } else {
                                feedbackKey = 'feedback_loop_wrong_content'; // Check write content
                             }
                         } else {
                             feedbackKey = 'feedback_loop_indentation'; // Indentation issue after for loop
                         }
                    } else {
                        feedbackKey = 'feedback_loop_no_loop'; // Missing 'for' loop
                    }
                } // else: Basic syntax error

                 // Append to the existing content in the store for 'a' mode
                 updateSimulatedFile(loopFileKey, 'a', simulatedOutput);
                 displaySimulatedContent('sim-output-loop', loopFileKey, loopFilename, 'simulator_output_placeholder');
                 showFeedback('sim-feedback-loop', feedbackKey, simSuccess ? 'correct' : 'incorrect');
            });

            clearBtn.addEventListener('click', () => {
                clearSimulatedFile(loopFileKey);
                displaySimulatedContent('sim-output-loop', loopFileKey, loopFilename, 'simulator_output_placeholder');
                feedbackDiv.classList.remove('visible');
                const currentLang = getStoredLanguage();
                showFeedback('sim-feedback-loop', 'feedback_sim_cleared', 'info', { filename: loopFilename });
            });

             // Initial display
             displaySimulatedContent('sim-output-loop', loopFileKey, loopFilename, 'simulator_output_placeholder');
             updateLoopPlaceholders();
        }


        // --- Activity 4: Advanced Mini Missions (Adapted Logic) ---
        const missionsSection = document.getElementById('adv-mini-missions');
        let updateMissionSummary; // Reuse function scope

        if (missionsSection) {
            const missionRunButtons = missionsSection.querySelectorAll('.mission-run-btn');
            const summaryFeedback = document.getElementById('missions-summary-feedback');
            const totalMissions = missionsSection.querySelectorAll('.mission').length;
            let completedMissionsCount = 0;

            updateMissionSummary = function() { /* ... identical logic ... */
                completedMissionsCount = missionsSection.querySelectorAll('.mission[data-completed="true"]').length;
                 const currentLang = getStoredLanguage();
                 if (completedMissionsCount === totalMissions) {
                     showFeedback('missions-summary-feedback', 'feedback_missions_summary_all_done', 'correct', { totalMissions: totalMissions });
                 } else if (completedMissionsCount > 0) {
                     showFeedback('missions-summary-feedback', 'feedback_missions_summary_progress', 'info', { completedCount: completedMissionsCount, totalMissions: totalMissions });
                 } else {
                     summaryFeedback.classList.remove('visible', 'correct', 'incorrect', 'info');
                 }
             }

            missionRunButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const missionId = button.dataset.missionId;
                    const missionDiv = document.getElementById(`mission-${missionId}`);
                    if (!missionDiv) return;
                    const editor = missionDiv.querySelector('.mission-editor');
                    const feedbackDivId = `mission-feedback-${missionId}`;
                    const feedbackDiv = document.getElementById(feedbackDivId);
                    if (!feedbackDiv) return;
                    const statusIcon = missionDiv.querySelector('.mission-status i');
                    const code = editor.value;
                    let success = false;
                    let feedbackMessageKey = 'feedback_mission_syntax_error';
                    let feedbackType = 'incorrect';
                    let specificHintKey = 'feedback_mission_generic_hint';
                    let targetFilename = '';
                    let fileKey = ''; // Key for simulatedFileStore
                    let mode = '';
                    let expectedOutput = '';
                    let checkWriteCount = null; // Optional: check number of write calls

                    // --- Advanced Mission Validation Logic ---
                    try {
                         const withRegex = /with\s+open\s*\(\s*(["'])(.*?)\1\s*,\s*(["'])(w|a)\3\s*\)\s+as\s+(\w+)\s*:/;
                         const writeRegex = /(\w+)\.write\s*\(([\s\S]*?)\)/g; // More flexible write content capture
                         const withMatch = code.match(withRegex);
                         let actualWrittenContent = ''; // Collect content simulated from THIS run
                         let writeCallCount = 0;


                        if (withMatch) {
                            targetFilename = withMatch[2];
                            mode = withMatch[4];
                            const fileVar = withMatch[5];
                            const blockContent = code.substring(withMatch.index + withMatch[0].length);
                            let writeMatch;

                            while ((writeMatch = writeRegex.exec(blockContent)) !== null) {
                                 if (writeMatch[1] === fileVar && /^\s+/.test(blockContent.substring(0, writeMatch.index))) {
                                     // VERY basic simulation of the write content - doesn't execute Python expressions
                                     // For missions, we often check against exact strings or simple concats
                                      const contentArg = writeMatch[2].trim();
                                      writeCallCount++;
                                     // Simulate known mission patterns
                                     if (missionId === '1' && contentArg === '"Hello\\nWorld\\n"') {
                                         actualWrittenContent += "Hello\nWorld\n";
                                     } else if (missionId === '2') {
                                         // Look for the specific pattern, allowing for str()
                                         if (contentArg.includes('str(user_id') || contentArg.includes('str(5')) {
                                              actualWrittenContent += 'ID: 5 - Action: updated\n'; // Assume correct construction if str() is used
                                         }
                                     } else if (missionId === '3') {
                                          if (contentArg === '"theme=dark\\n"') actualWrittenContent += "theme=dark\n";
                                          else if (contentArg === '"autosave=true\\n"') actualWrittenContent += "autosave=true\n";
                                     } else {
                                         // Fallback: just take literal string content if possible
                                         const stringLiteralMatch = contentArg.match(/^["']([\s\S]*)["']$/);
                                         if (stringLiteralMatch) {
                                            actualWrittenContent += stringLiteralMatch[1].replace(/\\n/g, '\n');
                                         }
                                     }
                                 }
                            }

                             fileKey = `adv-mission-${missionId}-${targetFilename}`;

                            // Define expectations per mission
                             if (missionId === '1') {
                                 expectedOutput = "Hello\nWorld\n";
                                 if (targetFilename === 'greeting.txt' && mode === 'w' && actualWrittenContent === expectedOutput && writeCallCount === 1) {
                                     success = true;
                                 } else specificHintKey = 'feedback_mission1_hint';
                             } else if (missionId === '2') {
                                 expectedOutput = "ID: 5 - Action: updated\n";
                                 if (targetFilename === 'activity.log' && mode === 'a' && actualWrittenContent === expectedOutput) { // Check appended content for this run
                                     success = true;
                                 } else specificHintKey = 'feedback_mission2_hint';
                             } else if (missionId === '3') {
                                 expectedOutput = "theme=dark\nautosave=true\n";
                                 if (targetFilename === 'settings.ini' && mode === 'w' && actualWrittenContent === expectedOutput && writeCallCount >= 2) {
                                     success = true;
                                 } else specificHintKey = 'feedback_mission3_hint';
                             }
                        } // else: syntax error handled below
                    } catch (error) { console.error("Adv Mission validation error:", error); }
                    // --- End Validation Logic ---

                    if (success) {
                        feedbackMessageKey = 'feedback_mission_success';
                        feedbackType = 'correct';
                        statusIcon.className = 'fas fa-check-circle';
                        missionDiv.dataset.completed = 'true';
                        updateSimulatedFile(fileKey, mode, actualWrittenContent); // Update store on success
                    } else {
                        feedbackMessageKey = specificHintKey || feedbackMessageKey;
                        feedbackType = 'incorrect';
                        statusIcon.className = 'fas fa-times-circle';
                        missionDiv.dataset.completed = 'false';
                        // Don't update file store on failure
                    }

                    showFeedback(feedbackDivId, feedbackMessageKey, feedbackType);
                    if(targetFilename && fileKey) { // Display the simulated file state
                         // Determine filename key for display translation
                         let displayFilenameKey = '';
                         if (targetFilename === 'greeting.txt') displayFilenameKey = 'greeting_filename';
                         else if (targetFilename === 'activity.log') displayFilenameKey = 'activity_filename';
                         else if (targetFilename === 'settings.ini') displayFilenameKey = 'settings_filename';
                         const displayFilename = getTranslation(displayFilenameKey, getStoredLanguage()) || targetFilename;

                        displaySimulatedContent(missionDiv.querySelector('.mission-output').id, fileKey, displayFilename, 'simulator_output_placeholder');
                    }
                    updateMissionSummary();
                });
            });

             // Initialize mission outputs and summary
            missionsSection.querySelectorAll('.mission').forEach(m => {
                 const id = m.id.split('-')[1];
                 let filename = '';
                 let fileKey = '';
                 let displayFilenameKey = '';
                 if (id === '1') { filename = 'greeting.txt'; displayFilenameKey = 'greeting_filename'; }
                 else if (id === '2') { filename = 'activity.log'; displayFilenameKey = 'activity_filename'; }
                 else if (id === '3') { filename = 'settings.ini'; displayFilenameKey = 'settings_filename'; }

                 if (filename) {
                     fileKey = `adv-mission-${id}-${filename}`;
                     const displayFilename = getTranslation(displayFilenameKey, getStoredLanguage()) || filename;
                     // Assign unique ID to output area if it doesn't have one
                     const outputArea = m.querySelector('.mission-output');
                     if (!outputArea.id) outputArea.id = `mission-output-${id}`;
                     displaySimulatedContent(outputArea.id, fileKey, displayFilename, 'simulator_output_placeholder');
                 }
            });
            updateMissionSummary(); // Initial call
        }


        // --- Fade-in animations on scroll (Unchanged) ---
        const fadeElements = document.querySelectorAll('.fade-in'); /* ... */
        const animateOnScroll = () => { /* ... */ }; /* ... */
        const scrollHandler = () => window.requestAnimationFrame(animateOnScroll); /* ... */
        window.addEventListener('scroll', scrollHandler); /* ... */


        // --- Initial Language Application and Activity Setups ---
        setLanguage(initialLang); // Apply language FIRST
        animateOnScroll(); // Trigger initial animation check

        // Initial setup for activities called within setLanguage or their respective blocks
        // setupBuildListeners(); // Called by setLanguage
        // updateDataTypePlaceholders(); // Called by setLanguage
        // updateLoopPlaceholders(); // Called by setLanguage
        // Missions setup done inside its block & updated by setLanguage

    }); // End DOMContentLoaded
    </script>

</body>
</html>