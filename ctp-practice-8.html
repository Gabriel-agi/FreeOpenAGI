<!DOCTYPE html>
<!-- Language set by JS -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title set by JS -->
    <title data-translate="page_title">Module 8: Python Practice Zone!</title>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --primary-color: #007bff; /* Blue */
            --secondary-color: #6c757d; /* Grey */
            --background-light: #f8f9fa;
            --background-medium: #e9ecef;
            --background-dark: #343a40; /* Dark Grey for code */
            --text-light: #f8f9fa;
            --text-dark: #212529;
            --accent-color: #ffc107; /* Yellow */
            --success-color: #28a745; /* Green */
            --error-color: #dc3545;   /* Red */
            --info-color: #17a2b8;    /* Teal */
            --condition-color: #fd7e14; /* Orange for conditions */
            --keyword-color: #6f42c1; /* Purple for keywords */
            --border-radius: 8px;
            --transition-speed: 0.3s;
            --font-body: 'Roboto', sans-serif;
            --font-title: 'Orbitron', sans-serif;
            --font-code: 'Courier New', Courier, monospace;
            --selection-highlight-bg: rgba(0, 123, 255, 0.1);
            --selection-highlight-border: rgba(0, 123, 255, 0.4);
            --execution-highlight-bg: rgba(255, 193, 7, 0.15); /* Light yellow for execution path */
            --execution-highlight-border: rgba(255, 193, 7, 0.5);
            /* Colors matching potential theme */
            --nav-primary: #6e48aa;
            --nav-success: #4cc9f0;
            --nav-dark: #1a1a2e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-body); line-height: 1.7;
            background-color: var(--background-light); color: var(--text-dark);
            overflow-x: hidden;
        }

        /* --- Utility Classes --- */
        .container { max-width: 960px; margin: 0 auto; padding: 0 15px; }
        .text-center { text-align: center; }
        .highlight { color: var(--primary-color); font-weight: bold; }
        .code-font { font-family: var(--font-code); }
        .hidden { display: none !important; }
        .button-group { margin-top: 2rem; display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; }

        /* --- Advanced Animations (Copied from Module 0) --- */
        .fade-in { opacity: 0; transform: translateY(20px); animation: fadeInAnimation 0.8s ease-out forwards; }
        .fade-in.delay-1 { animation-delay: 0.2s; }
        .fade-in.delay-2 { animation-delay: 0.4s; }
        .fade-in.delay-3 { animation-delay: 0.6s; }
        .fade-in.delay-4 { animation-delay: 0.8s; }
        @keyframes fadeInAnimation { to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseHeaderIcon { 0% { transform: scale(1); opacity: 0.1; filter: brightness(1); } 50% { transform: scale(1.05); opacity: 0.25; filter: brightness(1.2); } 100% { transform: scale(1); opacity: 0.1; filter: brightness(1); } }
        @keyframes successGlow { 0% { box-shadow: 0 0 3px rgba(40, 167, 69, 0.3); transform: scale(1); } 50% { box-shadow: 0 0 12px 5px rgba(40, 167, 69, 0.5); transform: scale(1.01); } 100% { box-shadow: 0 0 3px rgba(40, 167, 69, 0.3); transform: scale(1); } }
        .success-glow-anim { animation: successGlow 0.9s ease-out; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(3px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-5px, 0, 0); } 40%, 60% { transform: translate3d(5px, 0, 0); } }
        .shake-anim { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes iconAppearCorrect { 0% { transform: scale(0.5) rotate(-15deg); opacity: 0; } 60% { transform: scale(1.2) rotate(5deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes iconAppearIncorrect { 0% { transform: scale(0.5) rotate(-15deg); opacity: 0; } 50% { transform: scale(1.2) rotate(10deg); opacity: 1; } 70% { transform: scale(0.9) rotate(-5deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes iconAppearMissed { 0% { transform: scale(0.8) rotateY(90deg); opacity: 0; } 100% { transform: scale(1) rotateY(0deg); opacity: 0.8; } }
        .action-button:active:not(:disabled) { transform: translateY(1px) scale(0.98); filter: brightness(0.95); }

        /* --- Minimal Retractable Nav (Copied from Module 0) --- */
        .minimal-nav-button { position: fixed; top: 15px; right: 15px; z-index: 1001; background-color: rgba(52, 58, 64, 0.75); color: var(--text-light); border: none; border-radius: var(--border-radius); padding: 8px 12px; cursor: pointer; transition: background-color var(--transition-speed), opacity var(--transition-speed), transform var(--transition-speed); font-size: 1.1rem; opacity: 0.6; box-shadow: 0 2px 5px rgba(0,0,0,0.2); line-height: 1; }
        .minimal-nav-button:hover { background-color: rgba(52, 58, 64, 0.95); opacity: 1; transform: scale(1.05); }
        .minimal-nav { position: fixed; top: 60px; right: 15px; z-index: 1000; background-color: var(--background-dark); border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3); padding: 0.8rem; opacity: 0; transform: translateY(-15px) scale(0.95); transform-origin: top right; pointer-events: none; transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease; min-width: 200px; }
        body.nav-active .minimal-nav { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .minimal-nav ul { list-style: none; margin: 0; padding: 0; }
        .minimal-nav ul li { margin-bottom: 5px; }
        .minimal-nav ul li:last-child { margin-bottom: 0; }
        .minimal-nav ul li a { display: flex; align-items: center; color: var(--text-light); text-decoration: none; padding: 0.6rem 1rem; border-radius: 4px; transition: background-color var(--transition-speed), color var(--transition-speed); white-space: nowrap; font-weight: 400; font-size: 0.95rem; }
        .minimal-nav ul li a i.fas { margin-right: 10px; width: 1.2em; text-align: center; opacity: 0.8; transition: opacity var(--transition-speed); }
        .minimal-nav ul li a:hover { background-color: var(--primary-color); color: var(--text-light); }
        .minimal-nav ul li a:hover i.fas { opacity: 1; }
        .minimal-nav .language-switcher-item { padding: 0.5rem 1rem; border-top: 1px solid var(--secondary-color); margin-top: 8px; padding-top: 13px; }
        #languageSelect { width: 100%; background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--nav-success); border-radius: 5px; padding: 6px 30px 6px 12px; cursor: pointer; font-size: 0.9rem; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234CC9F0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px center; background-size: 10px auto; transition: background-color 0.3s ease; }
        #languageSelect:hover { background-color: rgba(255,255,255,0.15); }
        #languageSelect option { background: var(--nav-dark); color: var(--text-light); }
        /* --- End Minimal Retractable Nav --- */

        /* --- Practice Header (Adapted) --- */
        .practice-header { background: linear-gradient(135deg, var(--keyword-color), #4a2a8a); color: var(--text-light); padding: 3rem 0 4rem; text-align: center; position: relative; overflow: hidden; border-bottom: 5px solid var(--accent-color); }
        .practice-header h1 { font-family: var(--font-title); font-size: 2.8rem; margin-bottom: 0.5rem; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); animation: fadeInAnimation 1s ease-out; }
        .practice-header p { font-size: 1.1rem; font-weight: 300; opacity: 0.9; animation: fadeInAnimation 1s ease-out 0.3s forwards; opacity: 0; }
        .header-icon { position: absolute; font-size: 4rem; color: var(--text-light); animation: pulseHeaderIcon 6s infinite ease-in-out alternate; }
        .icon1 { top: 20%; left: 15%; animation-duration: 7s; } /* Branch icon */
        .icon2 { bottom: 15%; right: 20%; animation-duration: 5s; } /* Question icon */

        /* --- Practice Section Styling (Copied) --- */
        .practice-section { padding: 3rem 0; background-color: var(--background-medium); border-bottom: 1px solid #d6d8db; }
        .practice-section:nth-child(odd) { background-color: var(--background-light); }
        .practice-section:last-of-type { border-bottom: none; }
        .practice-section h2 { font-family: var(--font-title); font-size: 1.8rem; color: var(--keyword-color); margin-bottom: 1rem; text-align: center; }
        .practice-section .section-description { text-align: center; margin-bottom: 2.5rem; color: var(--secondary-color); font-size: 1.05rem; max-width: 700px; margin-left: auto; margin-right: auto; }

        /* --- General Interactive Elements (Copied) --- */
        .interactive-area { background-color: #fff; padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-top: 1.5rem; position: relative; transition: box-shadow 0.5s ease-out; }
        .feedback-message { padding: 0.8rem 1rem; margin-top: 1rem; border-radius: var(--border-radius); font-weight: bold; text-align: center; opacity: 0; max-height: 0; overflow: hidden; transition: opacity var(--transition-speed) ease, max-height var(--transition-speed) ease, margin-top var(--transition-speed) ease; }
        .feedback-message.visible { opacity: 1; max-height: 100px; margin-top: 1.5rem; }
        .feedback-message.correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .feedback-message.incorrect { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .feedback-message.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .feedback-message .fas { margin: 0 3px; }
        .action-button { display: inline-block; padding: 0.8rem 1.5rem; font-size: 1rem; font-weight: bold; color: var(--text-light); background-color: var(--primary-color); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color var(--transition-speed), transform var(--transition-speed), filter var(--transition-speed), box-shadow var(--transition-speed); margin-top: 1rem; vertical-align: middle; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-decoration: none; }
        .action-button:hover:not(:disabled) { background-color: #0056b3; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .action-button:disabled { background-color: var(--secondary-color); cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        .action-button.success { background-color: var(--success-color); }
        .action-button.success:hover:not(:disabled) { background-color: #218838; }
        .action-button.secondary { background-color: var(--secondary-color); }
        .action-button.secondary:hover:not(:disabled) { background-color: #5a6268; }

        /* Code styling (Adapted) */
        .code-block { background-color: var(--background-dark); color: var(--text-light); padding: 1.5rem; border-radius: var(--border-radius); font-family: var(--font-code); font-size: 1rem; position: relative; overflow-x: auto; margin: 1rem 0; line-height: 1.6; }
        .code-keyword { color: var(--keyword-color); font-weight: bold; } /* Purple */
        .code-condition { color: var(--condition-color); } /* Orange */
        .code-operator { color: #569cd6; } /* Blue (like Module 0 keyword) */
        .code-variable { color: #9cdcfe; } /* Light blue */
        .code-string { color: #ce9178; } /* Brown */
        .code-number { color: #b5cea8; } /* Light green */
        .code-comment { color: #6a9955; } /* Green */
        .code-indent { display: inline-block; width: 2em; } /* For visual indent */
        .code-colon { color: var(--accent-color); font-weight: bold; } /* Yellow */

        /* --- Activity 1: Elif Anatomy --- */
        #elif-anatomy .code-part { cursor: pointer; border-bottom: 2px dashed rgba(255, 255, 255, 0.3); transition: background-color var(--transition-speed), border-bottom-color var(--transition-speed); padding: 0 2px; display: inline-block; }
        #elif-anatomy .code-part:hover { background-color: rgba(255, 255, 255, 0.15); border-bottom-color: var(--accent-color); }
        #elif-anatomy .code-part.identified { background-color: rgba(40, 167, 69, 0.3); border-bottom: 2px solid var(--success-color); cursor: default; }
        .part-explanation { font-size: 0.95rem; color: var(--info-color); border-left: 3px solid var(--info-color); padding: 5px 10px; margin-top: 0.5rem; background-color: rgba(23, 162, 184, 0.05); }
        #anatomy-status { margin-top: 1rem; font-style: italic; color: var(--secondary-color); }

        /* --- Activity 2: Conditional Logic Builder --- */
        #condition-builder .draggable-pieces { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; padding: 1rem; background-color: var(--background-light); border: 1px dashed var(--secondary-color); border-radius: var(--border-radius); justify-content: center; user-select: none; -webkit-user-select: none; -ms-user-select: none; }
        .piece { display: inline-block; padding: 8px 12px; color: var(--text-light); border-radius: 4px; cursor: grab; font-family: var(--font-code); font-size: 1rem; transition: background-color var(--transition-speed), transform var(--transition-speed), opacity 0.1s ease, box-shadow var(--transition-speed); border: 1px solid rgba(0,0,0,0.3); touch-action: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .piece:active { cursor: grabbing; }
        .piece.dragging { opacity: 0.6 !important; transform: scale(1.05) rotate(3deg); position: fixed !important; pointer-events: none !important; z-index: 1000 !important; cursor: grabbing !important; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .piece.ghosting { opacity: 0.3; }
        /* Specific piece colors */
        .piece[data-type="keyword"] { background-color: var(--keyword-color); border-color: #5835a0;}
        .piece[data-type="variable"] { background-color: #778da9; border-color: #65798f;}
        .piece[data-type="operator"] { background-color: #3a86ff; border-color: #2e6ac6;}
        .piece[data-type="value-num"] { background-color: #8cb369; border-color: #749557;}
        .piece[data-type="value-str"] { background-color: #b17a62; border-color: #9d6c56;}
        .piece[data-type="colon"] { background-color: var(--accent-color); color: var(--text-dark); border-color: #cc9a06;}
        .piece[data-type="print"] { background-color: var(--success-color); border-color: #208438;}
        .piece[data-type="indent"] { background-color: var(--secondary-color); border-color: #575e64; font-style: italic; opacity: 0.8;}

        #builder-drop-zone { min-height: 180px; /* Taller for multiple lines */ background-color: var(--background-dark); border: 3px dashed var(--secondary-color); border-radius: var(--border-radius); padding: 15px; display: flex; flex-direction: column; /* Stack lines */ align-items: flex-start; /* Align left */ gap: 5px; transition: border-color var(--transition-speed), background-color var(--transition-speed), box-shadow var(--transition-speed); }
        #builder-drop-zone.over { border-color: var(--accent-color); background-color: #495057; box-shadow: inset 0 0 10px rgba(255,193,7,0.2); }
        #builder-drop-zone .build-line { display: flex; align-items: center; gap: 5px; width: 100%; min-height: 2.5em; /* Ensure line height */ }
        #builder-drop-zone .piece { cursor: default; margin: 0; touch-action: auto; box-shadow: none; }
        #builder-drop-zone-placeholder { color: var(--secondary-color); font-style: italic; width: 100%; text-align: center; margin-top: 30px;} /* Centered placeholder */

        /* --- Activity 3: Scenario Simulator --- */
        #scenario-simulator .sim-scenario { background-color: var(--background-medium); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border-left: 5px solid var(--info-color); }
        #scenario-simulator .sim-editor { width: 100%; min-height: 120px; /* Taller for if/elif/else */ background-color: var(--background-dark); color: var(--text-light); border: 1px solid var(--secondary-color); border-radius: var(--border-radius); padding: 1rem; font-family: var(--font-code); font-size: 1rem; line-height: 1.6; resize: vertical; }
        #scenario-simulator .sim-output-area { margin-top: 1rem; min-height: 50px; background-color: #1a1a1a; border: 1px solid #444; border-radius: var(--border-radius); padding: 1rem; color: var(--accent-color); font-family: var(--font-code); font-size: 1.05rem; white-space: pre-wrap; word-wrap: break-word; }
        #scenario-simulator .sim-output-area .placeholder { color: var(--secondary-color); font-style: italic; font-size: 0.9rem; }
        #scenario-simulator .sim-output-area .output-line { display: block; }

        /* --- Activity 4: Trace the Execution --- */
         #trace-execution .input-value-display { margin-bottom: 1.5rem; text-align: center; font-size: 1.1rem; background-color: var(--background-medium); padding: 0.5rem; border-radius: var(--border-radius); }
         #trace-execution .input-value-display strong { color: var(--primary-color); font-family: var(--font-code); }
         .trace-line-container { display: flex; align-items: center; margin-bottom: 4px; position: relative; }
         .trace-feedback-icon { width: 30px; height: 24px; margin-right: 10px; display: inline-flex; align-items: center; justify-content: center; transition: opacity var(--transition-speed); opacity: 0; font-size: 1.2rem; }
         .trace-feedback-icon.visible { opacity: 1; }
         #trace-execution .code-line-trace { flex-grow: 1; background-color: var(--background-dark); color: var(--text-light); padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: background-color var(--transition-speed), transform var(--transition-speed), border-left-color var(--transition-speed); font-family: var(--font-code); border-left: 4px solid transparent; user-select: none; -webkit-user-select: none; line-height: 1.6; white-space: pre; } /* Use pre for spacing */
         #trace-execution .code-line-trace:hover { background-color: #495057; transform: translateX(3px); }
         #trace-execution .code-line-trace.selected-execution { background-color: var(--execution-highlight-bg); border-left-color: var(--execution-highlight-border); color: var(--text-dark); }
         #trace-execution .code-line-trace.checked-state { cursor: default; } /* Prevent hover/active effects when checked */
         .trace-feedback-icon .fa-check { color: var(--success-color); animation: iconAppearCorrect 0.5s ease-out forwards; }
         .trace-feedback-icon .fa-times { color: var(--error-color); animation: iconAppearIncorrect 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
         .trace-feedback-icon .fa-eye { color: var(--accent-color); animation: iconAppearMissed 0.4s ease-in forwards; opacity: 0; }
         #reset-trace-btn { margin-left: 10px; }

        /* --- Activity 5: Mini Missions (Adapted) --- */
        #mini-missions .mission { padding: 1.5rem; border: 1px solid #d6d8db; border-radius: var(--border-radius); margin-bottom: 1.5rem; background-color: var(--background-light); position: relative; }
        .mission-status { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; transition: transform 0.3s ease; }
        .mission-status .fa-check-circle { color: var(--success-color); transform-origin: center; }
        .mission-status .fa-times-circle { color: var(--error-color); }
        .mission-status .fa-question-circle { color: var(--secondary-color); }
        .mission[data-completed="true"] .mission-status .fa-check-circle { animation: iconAppearCorrect 0.6s ease-out; }
        #mini-missions .mission-editor { width: 100%; min-height: 130px; /* Taller */ background-color: var(--background-dark); color: var(--text-light); border: 1px solid var(--secondary-color); border-radius: var(--border-radius); padding: 1rem; font-family: var(--font-code); font-size: 1rem; line-height: 1.6; resize: vertical; margin-top: 1rem; }
        #mini-missions .mission-output { margin-top: 1rem; min-height: 30px; background-color: #1a1a1a; border: 1px solid #444; border-radius: var(--border-radius); padding: 0.8rem; color: var(--accent-color); font-family: var(--font-code); font-size: 1rem; white-space: pre-wrap; word-wrap: break-word; }

        /* --- Final Section (Copied) --- */
        .completion-section { padding: 4rem 0; text-align: center; }
        .completion-section .icon { font-size: 4rem; color: var(--success-color); margin-bottom: 1rem; display: inline-block; opacity: 0; animation: iconAppearCorrect 1s ease-out 0.5s forwards; }
        .completion-section h2 { font-family: var(--font-title); font-size: 2.2rem; color: var(--primary-color); }
        .completion-section p { font-size: 1.1rem; margin-top: 1rem; color: var(--secondary-color); }

        /* --- Responsive Design (Copied & potentially adapted) --- */
        @media (max-width: 768px) {
            html { font-size: 15px; }
            .practice-header h1 { font-size: 2.2rem; }
            .practice-section h2 { font-size: 1.6rem; }
            .interactive-area { padding: 1.5rem; }
            .piece { padding: 6px 10px; font-size: 0.95rem; }
            #builder-drop-zone { min-height: 150px; padding: 10px; }
            .trace-feedback-icon { width: 25px; margin-right: 8px; font-size: 1.1rem;}
            .button-group { flex-direction: column; align-items: center; }
            .minimal-nav { min-width: 180px; }
            .minimal-nav ul li a { padding: 0.6rem 0.8rem; }
            #languageSelect { font-size: 0.85rem; padding: 5px 25px 5px 10px;}
        }
        @media (max-width: 480px) {
            html { font-size: 14px; }
            .practice-header h1 { font-size: 1.8rem; }
            .practice-header p { font-size: 1rem; }
            .practice-section h2 { font-size: 1.4rem; }
            .interactive-area { padding: 1rem; }
            .action-button { font-size: 0.9rem; padding: 0.7rem 1.2rem; width: 90%; max-width: 300px;}
            #scenario-simulator .sim-editor, #scenario-simulator .sim-output-area { font-size: 0.9rem; }
            #trace-execution .code-line-trace { padding: 6px 12px; font-size: 0.9rem;}
            #mini-missions .mission-editor, #mini-missions .mission-output { font-size: 0.95rem;}
            .trace-feedback-icon { width: 20px; margin-right: 5px; font-size: 1rem;}
            .button-group a.action-button { width: 90%; max-width: 300px; margin-bottom: 0.5rem; }
            .minimal-nav-button { top: 10px; right: 10px; padding: 6px 10px; font-size: 1rem; }
            .minimal-nav { top: 48px; right: 10px; min-width: 160px; }
            .minimal-nav ul li a { padding: 0.5rem 0.7rem; font-size: 0.9rem;}
            .minimal-nav ul li a i.fas { margin-right: 8px; }
            #languageSelect { font-size: 0.8rem; padding: 4px 20px 4px 8px;}
        }
    </style>
</head>
<body>

    <!-- ========= Minimal Nav Handle ========= -->
    <button id="minimal-nav-toggle" class="minimal-nav-button" aria-label="Toggle Navigation Menu">
        <i class="fas fa-bars"></i>
    </button>

    <!-- ========= Minimal Nav Panel (with Language Switcher & Module 8 Links) ========= -->
    <nav id="minimal-nav-panel" class="minimal-nav">
        <ul>
            <li><a href="ctp-theory-8.html"><i class="fas fa-book-open fa-fw"></i> <span data-translate="nav_theory">View Theory</span></a></li>
            <li><a href="ctp-advanced-8.html"><i class="fas fa-flask fa-fw"></i> <span data-translate="nav_advanced">Advanced Practice</span></a></li>
            <li><a href="ctp-dashboard.html"><i class="fas fa-list fa-fw"></i> <span data-translate="nav_menu">Course Menu</span></a></li>
            <hr style="border: none; border-top: 1px solid var(--secondary-color); margin: 8px 0;">
            <li><a href="#elif-anatomy"><i class="fas fa-microscope fa-fw"></i> <span data-translate="nav_anatomy">Anatomy</span></a></li>
            <li><a href="#condition-builder"><i class="fas fa-puzzle-piece fa-fw"></i> <span data-translate="nav_builder">Builder</span></a></li>
            <li><a href="#scenario-simulator"><i class="fas fa-keyboard fa-fw"></i> <span data-translate="nav_simulator">Simulator</span></a></li>
            <li><a href="#trace-execution"><i class="fas fa-shoe-prints fa-fw"></i> <span data-translate="nav_tracer">Trace</span></a></li>
            <li><a href="#mini-missions"><i class="fas fa-rocket fa-fw"></i> <span data-translate="nav_missions">Missions</span></a></li>
            <!-- Language Switcher Item -->
            <li class="language-switcher-item">
                 <select id="languageSelect" aria-label="Select Language">
                     <option value="en" data-translate="lang_en">🇬🇧 English</option>
                     <option value="pt" data-translate="lang_pt">🇧🇷 Português</option>
                     <option value="zh" data-translate="lang_zh">🇨🇳 中文</option>
                 </select>
            </li>
        </ul>
    </nav>

    <!-- ========= Header (Module 8) ========= -->
    <header class="practice-header">
        <i class="fas fa-code-branch header-icon icon1"></i>
        <i class="fas fa-question-circle header-icon icon2"></i>
        <div class="container">
            <h1 data-translate="header_title">Module 8: Practice Zone</h1>
            <p data-translate="header_subtitle">Mastering multiple conditions with `elif`!</p>
        </div>
    </header>

    <!-- ========= Main Content ========= -->
    <main>
        <!-- ========= Activity 1: Anatomy of if/elif/else ========= -->
        <section id="elif-anatomy" class="practice-section">
             <div class="container">
                 <h2 class="fade-in"><i class="fas fa-microscope"></i> <span data-translate="anatomy_title">Anatomy of Conditionals</span></h2>
                 <p class="section-description fade-in delay-1" data-translate="anatomy_desc">
                     Conditional statements let code make decisions. Click each highlighted part of this `if`/`elif`/`else` block to learn its role.
                 </p>
                 <div class="interactive-area fade-in delay-2">
                     <div class="code-block">
<pre><code><span class="code-variable" data-translate="anatomy_code_var">score</span> = <span class="code-number">75</span>

<span class="code-part" data-part="keyword-if" data-translate-title="tooltip_click_identify" title="Click"><span class="code-keyword">if</span></span> <span class="code-part" data-part="condition-if" data-translate-title="tooltip_click_identify" title="Click"><span class="code-variable">score</span> <span class="code-operator">&gt;=</span> <span class="code-number">90</span></span><span class="code-part" data-part="colon-if" data-translate-title="tooltip_click_identify" title="Click"><span class="code-colon">:</span></span>
<span class="code-part" data-part="indent-if" data-translate-title="tooltip_click_identify" title="Click"><span class="code-indent">    </span></span><span class="code-part" data-part="block-if" data-translate-title="tooltip_click_identify" title="Click">print(<span class="code-string" data-translate="anatomy_code_string_a">"Grade: A"</span>)</span>
<span class="code-part" data-part="keyword-elif" data-translate-title="tooltip_click_identify" title="Click"><span class="code-keyword">elif</span></span> <span class="code-part" data-part="condition-elif" data-translate-title="tooltip_click_identify" title="Click"><span class="code-variable">score</span> <span class="code-operator">&gt;=</span> <span class="code-number">80</span></span><span class="code-part" data-part="colon-elif" data-translate-title="tooltip_click_identify" title="Click"><span class="code-colon">:</span></span>
<span class="code-part" data-part="indent-elif" data-translate-title="tooltip_click_identify" title="Click"><span class="code-indent">    </span></span><span class="code-part" data-part="block-elif" data-translate-title="tooltip_click_identify" title="Click">print(<span class="code-string" data-translate="anatomy_code_string_b">"Grade: B"</span>)</span>
<span class="code-part" data-part="keyword-else" data-translate-title="tooltip_click_identify" title="Click"><span class="code-keyword">else</span></span><span class="code-part" data-part="colon-else" data-translate-title="tooltip_click_identify" title="Click"><span class="code-colon">:</span></span>
<span class="code-part" data-part="indent-else" data-translate-title="tooltip_click_identify" title="Click"><span class="code-indent">    </span></span><span class="code-part" data-part="block-else" data-translate-title="tooltip_click_identify" title="Click">print(<span class="code-string" data-translate="anatomy_code_string_c">"Grade: C or lower"</span>)</span></code></pre>
                     </div>
                     <div id="anatomy-explanations"></div>
                     <p id="anatomy-status" data-translate="anatomy_status_initial">Identify all parts!</p>
                     <div id="anatomy-feedback" class="feedback-message"></div>
                     <!-- Hidden explanation texts -->
                     <div id="explanation-texts" style="display: none;">
                        <span data-key="keyword-if" data-translate="anatomy_exp_if">`if`: Starts the conditional block. Checks the first condition.</span>
                        <span data-key="condition-if" data-translate="anatomy_exp_cond_if">Condition 1: An expression that evaluates to `True` or `False`.</span>
                        <span data-key="colon-if" data-translate="anatomy_exp_colon_if">Colon `:`: Marks the end of the `if` condition line.</span>
                        <span data-key="indent-if" data-translate="anatomy_exp_indent_if">Indentation: Spaces indicate the code block belonging to the `if`. Crucial!</span>
                        <span data-key="block-if" data-translate="anatomy_exp_block_if">Code Block 1: Runs only if Condition 1 is `True`.</span>
                        <span data-key="keyword-elif" data-translate="anatomy_exp_elif">`elif`: "Else if". Checks another condition *only if* the preceding `if`/`elif` was `False`.</span>
                        <span data-key="condition-elif" data-translate="anatomy_exp_cond_elif">Condition 2: Checked only if Condition 1 was `False`.</span>
                        <span data-key="colon-elif" data-translate="anatomy_exp_colon_elif">Colon `:`: Marks the end of the `elif` condition line.</span>
                        <span data-key="indent-elif" data-translate="anatomy_exp_indent_elif">Indentation: Code block belonging to the `elif`.</span>
                        <span data-key="block-elif" data-translate="anatomy_exp_block_elif">Code Block 2: Runs only if Condition 1 was `False` AND Condition 2 is `True`.</span>
                        <span data-key="keyword-else" data-translate="anatomy_exp_else">`else`: Catches everything else. Runs only if *all* preceding `if`/`elif` conditions were `False`.</span>
                        <span data-key="colon-else" data-translate="anatomy_exp_colon_else">Colon `:`: Marks the end of the `else` line.</span>
                        <span data-key="indent-else" data-translate="anatomy_exp_indent_else">Indentation: Code block belonging to the `else`.</span>
                        <span data-key="block-else" data-translate="anatomy_exp_block_else">Code Block 3: Runs only if all preceding conditions (`if`, `elif`) were `False`.</span>
                     </div>
                 </div>
             </div>
        </section>

        <!-- ========= Activity 2: Conditional Logic Builder ========= -->
        <section id="condition-builder" class="practice-section">
             <div class="container">
                 <h2 class="fade-in"><i class="fas fa-puzzle-piece"></i> <span data-translate="builder_title">Conditional Logic Builder</span></h2>
                 <p class="section-description fade-in delay-1" data-translate="builder_desc">
                     Drag pieces into the dark area to build an `if`/`elif`/`else` structure that assigns grades: A (>= 90), B (>= 80), C (< 80). Use the `score` variable.
                 </p>
                 <div class="interactive-area fade-in delay-2">
                     <div id="draggable-pieces" class="draggable-pieces">
                         <!-- Pieces populated by JS -->
                     </div>
                     <div id="builder-drop-zone" class="code-font">
                         <span id="builder-drop-zone-placeholder" data-translate="builder_drop_placeholder">Drop pieces here to build the logic...</span>
                         <!-- Lines will be added dynamically -->
                     </div>
                     <div class="text-center">
                         <button id="check-builder-btn" class="action-button" data-translate="button_check_builder">Check Logic</button>
                         <button id="reset-builder-btn" class="action-button secondary" data-translate="button_reset_builder">Reset</button>
                     </div>
                     <div id="builder-feedback" class="feedback-message"></div>
                 </div>
             </div>
        </section>

         <!-- ========= Activity 3: Scenario Simulator ========= -->
        <section id="scenario-simulator" class="practice-section">
             <div class="container">
                 <h2 class="fade-in"><i class="fas fa-keyboard"></i> <span data-translate="simulator_title">Scenario Simulator</span></h2>
                 <p class="section-description fade-in delay-1" data-translate="simulator_desc">
                     Write Python code using `if`, `elif`, and `else` to give clothing advice based on temperature.
                 </p>
                 <div class="interactive-area fade-in delay-2">
                    <div class="sim-scenario">
                        <strong data-translate="simulator_scenario_title">Scenario:</strong> <span data-translate="simulator_scenario_text">Given a variable `temp`, print: "Wear a heavy coat." if temp < 10, "Wear a jacket." if temp < 20, "Wear a t-shirt." otherwise.</span><br>
                        <span data-translate="simulator_scenario_assume">Assume `temp` is already defined (we'll test with different values).</span>
                    </div>
                     <label for="sim-editor-input" style="font-weight: bold; display:block; margin-bottom: 8px;" data-translate="simulator_editor_label">Code Editor:</label>
                     <textarea id="sim-editor-input" class="sim-editor" rows="6" data-translate-placeholder="simulator_editor_placeholder" placeholder='temp = 15 # Example value (will be changed for testing)&#10;if temp < 10:&#10;    print("...")&#10;elif ... :&#10;    print("...")&#10;else:&#10;    print("...")'></textarea>
                     <div class="text-center">
                          <button id="run-sim-btn" class="action-button" data-translate="button_run_sim">Run Simulation</button>
                     </div>
                     <label for="sim-output" style="font-weight: bold; display:block; margin-top: 1.5rem; margin-bottom: 8px;" data-translate="simulator_output_label">Simulated Output (Test Case: temp = 18):</label>
                     <div id="sim-output" class="sim-output-area">
                         <span class="placeholder" data-translate="simulator_output_placeholder">Output will appear here...</span>
                     </div>
                     <div id="sim-feedback" class="feedback-message"></div>
                 </div>
             </div>
        </section>

         <!-- ========= Activity 4: Trace the Execution ========= -->
        <section id="trace-execution" class="practice-section">
            <div class="container">
                <h2 class="fade-in"><i class="fas fa-shoe-prints"></i> <span data-translate="trace_title">Trace the Execution</span></h2>
                <p class="section-description fade-in delay-1" data-translate="trace_desc">
                    Given the input value, click ONLY the line(s) of code below that will actually <span class="highlight">execute</span>. Click again to deselect. Then check your trace.
                </p>
                <div class="interactive-area fade-in delay-2">
                    <div id="trace-input-value" class="input-value-display">
                        <span data-translate="trace_input_label">Input Value:</span> <strong id="current-input-value"></strong>
                    </div>
                    <div id="trace-lines">
                        <!-- Code lines will be generated by JS -->
                    </div>
                     <div class="text-center">
                         <button id="check-trace-btn" class="action-button" data-translate="button_check_trace">Check Trace</button>
                         <button id="reset-trace-btn" class="action-button secondary hidden" data-translate="button_try_again">Try Again</button>
                         <button id="new-trace-value-btn" class="action-button secondary" data-translate="button_new_value">New Value</button>
                     </div>
                     <div id="trace-feedback" class="feedback-message"></div>
                     <!-- Hidden data for trace lines -->
                     <div id="trace-code-data" style="display: none;">
                         <!-- Line data structure: { "id": 1, "text_key": "trace_line_1", "indent": 0, "is_executable": true/false depending on input, "is_condition": true/false } -->
                         <!-- This will be populated by JS -->
                     </div>
                </div>
            </div>
        </section>

         <!-- ========= Activity 5: Mini Missions ========= -->
        <section id="mini-missions" class="practice-section">
             <div class="container">
                  <h2 class="fade-in"><i class="fas fa-rocket"></i> <span data-translate="missions_title">Mini Missions!</span></h2>
                 <p class="section-description fade-in delay-1" data-translate="missions_desc">
                     Apply your `if`/`elif`/`else` skills! Complete these coding tasks. Assume input variables (`age`, `num`) are provided.
                 </p>
                 <div class="interactive-area fade-in delay-2">
                     <!-- Mission 1 -->
                     <div class="mission" id="mission-1" data-completed="false">
                         <span class="mission-status"><i class="fas fa-question-circle"></i></span>
                         <h4 data-translate="mission1_title">Mission 1: Ticket Pricing</h4>
                         <p data-translate="mission1_desc">Given `age`, print the ticket price: "Child: $5" (age < 13), "Senior: $7" (age >= 65), "Adult: $10" (otherwise).</p>
                         <textarea class="sim-editor mission-editor" rows="6" data-translate-placeholder="mission1_placeholder" placeholder='age = 30 # Example value&#10;if age < 13:&#10;    print("...")&#10;# Add elif and else here&#10;'></textarea>
                         <div class="text-center"> <button class="action-button mission-run-btn" data-mission-id="1" data-translate="button_test_mission_1">Test Mission 1</button> </div>
                         <div class="sim-output-area mission-output"></div>
                         <div id="mission-feedback-1" class="feedback-message mission-feedback"></div>
                     </div>
                     <!-- Mission 2 -->
                     <div class="mission" id="mission-2" data-completed="false">
                          <span class="mission-status"><i class="fas fa-question-circle"></i></span>
                         <h4 data-translate="mission2_title">Mission 2: Number Check</h4>
                         <p data-translate="mission2_desc">Given `num`, print: "Positive" (num > 0), "Negative" (num < 0), "Zero" (num == 0).</p>
                         <textarea class="sim-editor mission-editor" rows="6" data-translate-placeholder="mission2_placeholder" placeholder='num = -5 # Example value&#10;if num > 0:&#10;    print("...")&#10;# Add elif and else here&#10;'></textarea>
                          <div class="text-center"> <button class="action-button mission-run-btn" data-mission-id="2" data-translate="button_test_mission_2">Test Mission 2</button> </div>
                         <div class="sim-output-area mission-output"></div>
                         <div id="mission-feedback-2" class="feedback-message mission-feedback"></div>
                     </div>
                     <!-- Mission 3 -->
                     <div class="mission" id="mission-3" data-completed="false">
                          <span class="mission-status"><i class="fas fa-question-circle"></i></span>
                         <h4 data-translate="mission3_title">Mission 3: Simple Login Check</h4>
                         <p data-translate="mission3_desc">Given `username`, print: "Admin Access" (if username is "admin"), "Guest Access" (if username is "guest"), "Unknown User" (otherwise).</p>
                         <textarea class="sim-editor mission-editor" rows="6" data-translate-placeholder="mission3_placeholder" placeholder='username = "guest" # Example value&#10;if username == "admin":&#10;    print("...")&#10;# Add elif and else here&#10;'></textarea>
                          <div class="text-center"> <button class="action-button mission-run-btn" data-mission-id="3" data-translate="button_test_mission_3">Test Mission 3</button> </div>
                         <div class="sim-output-area mission-output"></div>
                         <div id="mission-feedback-3" class="feedback-message mission-feedback"></div>
                     </div>
                     <div id="missions-summary-feedback" class="feedback-message" style="margin-top: 2rem;"></div>
                 </div>
             </div>
        </section>

         <!-- ========= Completion Section (Module 8) ========= -->
        <section class="completion-section">
            <div class="container">
                <div class="icon fade-in"> <!-- Animation applied via JS/CSS -->
                    <i class="fas fa-check-double"></i> <i class="fas fa-brain"></i> <i class="fas fa-check-double"></i>
                </div>
                <h2 class="fade-in delay-1" data-translate="completion_title">Module 8 Practice Complete!</h2>
                <p class="fade-in delay-2" data-translate="completion_desc">
                    Excellent work navigating multiple conditions with `elif`! You're building complex logic. <br>
                    Ready for more challenges? Try the <strong>Advanced Practice</strong> for Module 8!
                </p>
                <div class="button-group">
                    <a href="ctp-theory-8.html" class="action-button secondary fade-in delay-3"><i class="fas fa-book-open"></i> <span data-translate="button_view_theory">View Theory Again</span></a>
                    <a href="ctp-advanced-8.html" class="action-button success fade-in delay-3"><i class="fas fa-arrow-right"></i> <span data-translate="button_start_advanced">Start Advanced Practice</span></a>
                    <a href="ctp-dashboard.html" class="action-button secondary fade-in delay-4"><i class="fas fa-list"></i> <span data-translate="button_back_menu">Back to Course Menu</span></a>
                </div>
            </div>
        </section>
    </main>

    <!-- ========= Script (Module 8 specific logic needed) ========= -->
    <script>
    // --- Translations Object (Module 8) ---
    const translations = {
        en: {
            "page_title": "Module 8: Python Practice Zone!",
            "tooltip_click_identify": "Click to identify this part",
            "nav_theory": "View Theory", "nav_advanced": "Advanced Practice", "nav_menu": "Course Menu",
            "nav_anatomy": "Anatomy", "nav_builder": "Builder", "nav_simulator": "Simulator", "nav_tracer": "Trace", "nav_missions": "Missions",
            "lang_en": "🇬🇧 English", "lang_pt": "🇧🇷 Português", "lang_zh": "🇨🇳 中文",
            "header_title": "Module 8: Practice Zone", "header_subtitle": "Mastering multiple conditions with `elif`!",
            // Anatomy
            "anatomy_title": "Anatomy of Conditionals", "anatomy_desc": "Conditional statements let code make decisions. Click each highlighted part of this `if`/`elif`/`else` block to learn its role.",
            "anatomy_code_var": "score", "anatomy_code_string_a": "\"Grade: A\"", "anatomy_code_string_b": "\"Grade: B\"", "anatomy_code_string_c": "\"Grade: C or lower\"",
            "anatomy_status_initial": "Identify all 14 parts!", "anatomy_status_progress": "Identified {count} of {total} parts.", "anatomy_status_done": "All parts identified!",
            "anatomy_exp_if": "`if`: Starts the conditional block. Checks the first condition.",
            "anatomy_exp_cond_if": "Condition 1: An expression that evaluates to `True` or `False` (e.g., `score >= 90`).",
            "anatomy_exp_colon_if": "Colon `:`: Marks the end of the `if` condition line. Required!",
            "anatomy_exp_indent_if": "Indentation: Spaces indicate the code block belonging to the `if`. Crucial!",
            "anatomy_exp_block_if": "Code Block 1: Runs only if Condition 1 is `True`.",
            "anatomy_exp_elif": "`elif`: \"Else if\". Checks another condition *only if* the preceding `if`/`elif` was `False`.",
            "anatomy_exp_cond_elif": "Condition 2: Checked only if Condition 1 was `False`.",
            "anatomy_exp_colon_elif": "Colon `:`: Marks the end of the `elif` condition line.",
            "anatomy_exp_indent_elif": "Indentation: Code block belonging to the `elif`.",
            "anatomy_exp_block_elif": "Code Block 2: Runs only if Condition 1 was `False` AND Condition 2 is `True`.",
            "anatomy_exp_else": "`else`: Catches everything else. Runs only if *all* preceding `if`/`elif` conditions were `False`. No condition needed.",
            "anatomy_exp_colon_else": "Colon `:`: Marks the end of the `else` line.",
            "anatomy_exp_indent_else": "Indentation: Code block belonging to the `else`.",
            "anatomy_exp_block_else": "Code Block 3: Runs only if all preceding conditions (`if`, `elif`) were `False`.",
            "feedback_anatomy_correct": "Excellent! You've dissected the conditional structure!",
            // Builder
            "builder_title": "Conditional Logic Builder", "builder_desc": "Drag pieces into the dark area to build an `if`/`elif`/`else` structure that assigns grades: A (>= 90), B (>= 80), C (< 80). Use the `score` variable.",
            "builder_drop_placeholder": "Drop pieces here to build the logic...",
            "builder_piece_if": "if", "builder_piece_elif": "elif", "builder_piece_else": "else",
            "builder_piece_score": "score", "builder_piece_ge": ">=", "builder_piece_lt": "<", "builder_piece_eq": "==",
            "builder_piece_90": "90", "builder_piece_80": "80",
            "builder_piece_colon": ":", "builder_piece_indent": "    (indent)",
            "builder_piece_printA": "print(\"A\")", "builder_piece_printB": "print(\"B\")", "builder_piece_printC": "print(\"C\")",
            "button_check_builder": "Check Logic", "button_reset_builder": "Reset",
            "feedback_builder_correct": "Perfect structure!", "feedback_builder_incomplete": "Missing some pieces. Keep building!", "feedback_builder_order": "Check the order of `if`/`elif`/`else` or conditions.", "feedback_builder_indent": "Indentation matters! Ensure print statements are indented.", "feedback_builder_syntax": "Syntax error. Check colons or condition structure.", "feedback_builder_incorrect": "Logic seems incorrect. Review the grade requirements.",
             // Simulator
            "simulator_title": "Scenario Simulator", "simulator_desc": "Write Python code using `if`, `elif`, and `else` to give clothing advice based on temperature.",
            "simulator_scenario_title": "Scenario:", "simulator_scenario_text": "Given a variable `temp`, print: \"Wear a heavy coat.\" if temp < 10, \"Wear a jacket.\" if temp < 20, \"Wear a t-shirt.\" otherwise.",
            "simulator_scenario_assume": "Assume `temp` is already defined (we'll test with different values).",
            "simulator_editor_label": "Code Editor:", "simulator_editor_placeholder": 'temp = 15 # Example value (will be changed for testing)\nif temp < 10:\n    print("...")\nelif ... :\n    print("...")\nelse:\n    print("...")',
            "button_run_sim": "Run Simulation", "simulator_output_label": "Simulated Output (Test Case: temp = {test_temp}):", "simulator_output_placeholder": "Output will appear here...",
            "feedback_sim_success": "Simulation successful for temp={test_temp}!", "feedback_sim_correct_output": "Correct output!",
            "feedback_sim_wrong_output": "Output is incorrect for temp={test_temp}. Expected: '{expected}', Got: '{actual}'",
            "feedback_sim_no_output": "No output produced for temp={test_temp}.",
            "feedback_sim_empty": "Editor is empty.", "feedback_sim_syntax_error": "Syntax Error: Check colons, indentation, or conditions.", "feedback_sim_runtime_error": "Runtime Error: Could not run the code.", "feedback_sim_missing_branch": "Seems like a condition branch (`if`, `elif`, or `else`) is missing or incorrect.",
            // Tracer
            "trace_title": "Trace the Execution", "trace_desc": "Given the input value, click ONLY the line(s) of code below that will actually <span class=\"highlight\">execute</span>. Click again to deselect. Then check your trace.",
            "trace_input_label": "Input Value:", "trace_code_label": "Code:",
            "button_check_trace": "Check Trace", "button_try_again": "Try Again", "button_new_value": "New Value",
            "trace_line_1": "color = \"blue\"", "trace_line_2": "if color == \"red\":", "trace_line_3": "    print(\"Stop\")", "trace_line_4": "elif color == \"yellow\":", "trace_line_5": "    print(\"Caution\")", "trace_line_6": "elif color == \"blue\":", "trace_line_7": "    print(\"Go\")", "trace_line_8": "else:", "trace_line_9": "    print(\"Unknown\")", "trace_line_10": "print(\"Done\")",
            "feedback_trace_correct": "Perfect trace! You followed the logic correctly. <i class=\"fas fa-thumbs-up\"></i>",
            "feedback_trace_incorrect": "Not quite right. {hints}. Review how `if/elif/else` skips branches.",
            "feedback_trace_hint_incorrect": "{count} incorrect selection(s) marked with <i class=\"fas fa-times\"></i>",
            "feedback_trace_hint_missed": "{count} missed line(s) marked with <i class=\"fas fa-eye\"></i>",
            "feedback_trace_hints_joiner": ", and ",
             // Missions
            "missions_title": "Mini Missions!", "missions_desc": "Apply your `if`/`elif`/`else` skills! Complete these coding tasks. Assume input variables (`age`, `num`, `username`) are provided.",
            "mission1_title": "Mission 1: Ticket Pricing", "mission1_desc": "Given `age`, print the ticket price: \"Child: $5\" (age < 13), \"Senior: $7\" (age >= 65), \"Adult: $10\" (otherwise).", "mission1_placeholder": 'age = 30 # Example value\nif age < 13:\n    print("...")\n# Add elif and else here\n',
            "button_test_mission_1": "Test Mission 1",
            "mission2_title": "Mission 2: Number Check", "mission2_desc": "Given `num`, print: \"Positive\" (num > 0), \"Negative\" (num < 0), \"Zero\" (num == 0).", "mission2_placeholder": 'num = -5 # Example value\nif num > 0:\n    print("...")\n# Add elif and else here\n',
            "button_test_mission_2": "Test Mission 2",
            "mission3_title": "Mission 3: Simple Login Check", "mission3_desc": "Given `username`, print: \"Admin Access\" (if username is \"admin\"), \"Guest Access\" (if username is \"guest\"), \"Unknown User\" (otherwise).", "mission3_placeholder": 'username = "guest" # Example value\nif username == "admin":\n    print("...")\n# Add elif and else here\n',
            "button_test_mission_3": "Test Mission 3",
            "feedback_mission_success": "Mission Accomplished!", "feedback_mission_syntax_error": "Syntax/logic error. Check conditions, colons, indentation.",
            "feedback_mission_wrong_output": "Incorrect output for test case. Review the requirements.",
            "feedback_mission1_hint": "Use `if age < 13`, `elif age >= 65`, and `else` with correct prints.", "feedback_mission2_hint": "Use `if num > 0`, `elif num < 0`, and `else` (for zero).", "feedback_mission3_hint": "Use `if username == \"admin\"`, `elif username == \"guest\"`, and `else`. Remember strings need quotes.",
            "feedback_missions_summary_all_done": "All {totalMissions} missions complete! Conditional logic mastered!", "feedback_missions_summary_progress": "Completed {completedCount} of {totalMissions} missions. Keep branching!",
            // Completion
            "completion_title": "Module 8 Practice Complete!", "completion_desc": "Excellent work navigating multiple conditions with `elif`! You're building complex logic. <br> Ready for more challenges? Try the <strong>Advanced Practice</strong> for Module 8!",
            "button_view_theory": "View Theory Again", "button_start_advanced": "Start Advanced Practice", "button_back_menu": "Back to Course Menu"
        },
        pt: {
            "page_title": "Módulo 8: Zona de Prática Python!",
            "tooltip_click_identify": "Clique para identificar esta parte",
            "nav_theory": "Ver Teoria", "nav_advanced": "Prática Avançada", "nav_menu": "Menu do Curso",
            "nav_anatomy": "Anatomia", "nav_builder": "Construtor", "nav_simulator": "Simulador", "nav_tracer": "Rastrear", "nav_missions": "Missões",
            "lang_en": "🇬🇧 English", "lang_pt": "🇧🇷 Português", "lang_zh": "🇨🇳 中文",
            "header_title": "Módulo 8: Zona de Prática", "header_subtitle": "Dominando múltiplas condições com `elif`!",
            // Anatomy
            "anatomy_title": "Anatomia de Condicionais", "anatomy_desc": "Declarações condicionais permitem que o código tome decisões. Clique em cada parte destacada deste bloco `if`/`elif`/`else` para aprender seu papel.",
            "anatomy_code_var": "pontos", "anatomy_code_string_a": "\"Nota: A\"", "anatomy_code_string_b": "\"Nota: B\"", "anatomy_code_string_c": "\"Nota: C ou inferior\"",
            "anatomy_status_initial": "Identifique todas as 14 partes!", "anatomy_status_progress": "Identificadas {count} de {total} partes.", "anatomy_status_done": "Todas as partes identificadas!",
            "anatomy_exp_if": "`if`: Inicia o bloco condicional. Verifica a primeira condição.",
            "anatomy_exp_cond_if": "Condição 1: Uma expressão que avalia para `True` ou `False` (ex: `pontos >= 90`).",
            "anatomy_exp_colon_if": "Dois pontos `:`: Marca o fim da linha da condição `if`. Obrigatório!",
            "anatomy_exp_indent_if": "Indentação: Espaços indicam o bloco de código pertencente ao `if`. Crucial!",
            "anatomy_exp_block_if": "Bloco de Código 1: Executa apenas se a Condição 1 for `True`.",
            "anatomy_exp_elif": "`elif`: \"Senão se\". Verifica outra condição *apenas se* o `if`/`elif` anterior foi `False`.",
            "anatomy_exp_cond_elif": "Condição 2: Verificada apenas se a Condição 1 foi `False`.",
            "anatomy_exp_colon_elif": "Dois pontos `:`: Marca o fim da linha da condição `elif`.",
            "anatomy_exp_indent_elif": "Indentação: Bloco de código pertencente ao `elif`.",
            "anatomy_exp_block_elif": "Bloco de Código 2: Executa apenas se a Condição 1 foi `False` E a Condição 2 for `True`.",
            "anatomy_exp_else": "`else`: Pega todo o resto. Executa apenas se *todas* as condições `if`/`elif` anteriores foram `False`. Não precisa de condição.",
            "anatomy_exp_colon_else": "Dois pontos `:`: Marca o fim da linha `else`.",
            "anatomy_exp_indent_else": "Indentação: Bloco de código pertencente ao `else`.",
            "anatomy_exp_block_else": "Bloco de Código 3: Executa apenas se todas as condições anteriores (`if`, `elif`) foram `False`.",
            "feedback_anatomy_correct": "Excelente! Você dissecou a estrutura condicional!",
            // Builder
            "builder_title": "Construtor de Lógica Condicional", "builder_desc": "Arraste as peças para a área escura para construir uma estrutura `if`/`elif`/`else` que atribui notas: A (>= 90), B (>= 80), C (< 80). Use a variável `pontos`.",
            "builder_drop_placeholder": "Solte as peças aqui para construir a lógica...",
            "builder_piece_if": "if", "builder_piece_elif": "elif", "builder_piece_else": "else",
            "builder_piece_score": "pontos", "builder_piece_ge": ">=", "builder_piece_lt": "<", "builder_piece_eq": "==",
            "builder_piece_90": "90", "builder_piece_80": "80",
            "builder_piece_colon": ":", "builder_piece_indent": "    (indentar)",
            "builder_piece_printA": "print(\"A\")", "builder_piece_printB": "print(\"B\")", "builder_piece_printC": "print(\"C\")",
            "button_check_builder": "Verificar Lógica", "button_reset_builder": "Reiniciar",
            "feedback_builder_correct": "Estrutura perfeita!", "feedback_builder_incomplete": "Faltam algumas peças. Continue construindo!", "feedback_builder_order": "Verifique a ordem de `if`/`elif`/`else` ou das condições.", "feedback_builder_indent": "Indentação importa! Garanta que os prints estejam indentados.", "feedback_builder_syntax": "Erro de sintaxe. Verifique os dois pontos ou a estrutura da condição.", "feedback_builder_incorrect": "A lógica parece incorreta. Revise os requisitos das notas.",
             // Simulator
            "simulator_title": "Simulador de Cenário", "simulator_desc": "Escreva código Python usando `if`, `elif` e `else` para dar conselhos de vestuário com base na temperatura.",
            "simulator_scenario_title": "Cenário:", "simulator_scenario_text": "Dada uma variável `temp`, imprima: \"Use um casaco pesado.\" se temp < 10, \"Use uma jaqueta.\" se temp < 20, \"Use uma camiseta.\" caso contrário.",
            "simulator_scenario_assume": "Assuma que `temp` já está definida (testaremos com valores diferentes).",
            "simulator_editor_label": "Editor de Código:", "simulator_editor_placeholder": 'temp = 15 # Valor exemplo (será alterado para teste)\nif temp < 10:\n    print("...")\nelif ... :\n    print("...")\nelse:\n    print("...")',
            "button_run_sim": "Executar Simulação", "simulator_output_label": "Saída Simulada (Teste: temp = {test_temp}):", "simulator_output_placeholder": "A saída aparecerá aqui...",
            "feedback_sim_success": "Simulação bem-sucedida para temp={test_temp}!", "feedback_sim_correct_output": "Saída correta!",
            "feedback_sim_wrong_output": "Saída incorreta para temp={test_temp}. Esperado: '{expected}', Recebido: '{actual}'",
            "feedback_sim_no_output": "Nenhuma saída produzida para temp={test_temp}.",
            "feedback_sim_empty": "O editor está vazio.", "feedback_sim_syntax_error": "Erro de Sintaxe: Verifique dois pontos, indentação ou condições.", "feedback_sim_runtime_error": "Erro de Execução: Não foi possível executar o código.", "feedback_sim_missing_branch": "Parece que um ramo da condição (`if`, `elif` ou `else`) está faltando ou incorreto.",
             // Tracer
            "trace_title": "Rastrear a Execução", "trace_desc": "Dado o valor de entrada, clique APENAS na(s) linha(s) de código abaixo que serão realmente <span class=\"highlight\">executadas</span>. Clique novamente para desmarcar. Depois verifique seu rastreamento.",
            "trace_input_label": "Valor de Entrada:", "trace_code_label": "Código:",
            "button_check_trace": "Verificar Rastro", "button_try_again": "Tentar Novamente", "button_new_value": "Novo Valor",
            "trace_line_1": "cor = \"azul\"", "trace_line_2": "if cor == \"vermelho\":", "trace_line_3": "    print(\"Pare\")", "trace_line_4": "elif cor == \"amarelo\":", "trace_line_5": "    print(\"Atenção\")", "trace_line_6": "elif cor == \"azul\":", "trace_line_7": "    print(\"Siga\")", "trace_line_8": "else:", "trace_line_9": "    print(\"Desconhecido\")", "trace_line_10": "print(\"Fim\")",
            "feedback_trace_correct": "Rastro perfeito! Você seguiu a lógica corretamente. <i class=\"fas fa-thumbs-up\"></i>",
            "feedback_trace_incorrect": "Não está certo. {hints}. Reveja como `if/elif/else` pula ramos.",
            "feedback_trace_hint_incorrect": "{count} seleção(ões) incorreta(s) marcada(s) com <i class=\"fas fa-times\"></i>",
            "feedback_trace_hint_missed": "{count} linha(s) não selecionada(s) marcada(s) com <i class=\"fas fa-eye\"></i>",
            "feedback_trace_hints_joiner": ", e ",
             // Missions
            "missions_title": "Mini Missões!", "missions_desc": "Aplique suas habilidades de `if`/`elif`/`else`! Complete estas tarefas de codificação. Assuma que as variáveis de entrada (`idade`, `num`, `usuario`) são fornecidas.",
            "mission1_title": "Missão 1: Preço do Ingresso", "mission1_desc": "Dada `idade`, imprima o preço do ingresso: \"Criança: R$5\" (idade < 13), \"Idoso: R$7\" (idade >= 65), \"Adulto: R$10\" (caso contrário).", "mission1_placeholder": 'idade = 30 # Valor exemplo\nif idade < 13:\n    print("...")\n# Adicione elif e else aqui\n',
            "button_test_mission_1": "Testar Missão 1",
            "mission2_title": "Missão 2: Verificação de Número", "mission2_desc": "Dado `num`, imprima: \"Positivo\" (num > 0), \"Negativo\" (num < 0), \"Zero\" (num == 0).", "mission2_placeholder": 'num = -5 # Valor exemplo\nif num > 0:\n    print("...")\n# Adicione elif e else aqui\n',
            "button_test_mission_2": "Testar Missão 2",
            "mission3_title": "Missão 3: Verificação Simples de Login", "mission3_desc": "Dado `usuario`, imprima: \"Acesso Admin\" (se usuario for \"admin\"), \"Acesso Convidado\" (se usuario for \"guest\"), \"Usuário Desconhecido\" (caso contrário).", "mission3_placeholder": 'usuario = "guest" # Valor exemplo\nif usuario == "admin":\n    print("...")\n# Adicione elif e else aqui\n',
            "button_test_mission_3": "Testar Missão 3",
            "feedback_mission_success": "Missão Cumprida!", "feedback_mission_syntax_error": "Erro de sintaxe/lógica. Verifique condições, dois pontos, indentação.",
            "feedback_mission_wrong_output": "Saída incorreta para o caso de teste. Reveja os requisitos.",
            "feedback_mission1_hint": "Use `if idade < 13`, `elif idade >= 65` e `else` com os prints corretos.", "feedback_mission2_hint": "Use `if num > 0`, `elif num < 0` e `else` (para zero).", "feedback_mission3_hint": "Use `if usuario == \"admin\"`, `elif usuario == \"guest\"` e `else`. Lembre-se que strings precisam de aspas.",
            "feedback_missions_summary_all_done": "Todas as {totalMissions} missões completas! Lógica condicional dominada!", "feedback_missions_summary_progress": "Completou {completedCount} de {totalMissions} missões. Continue ramificando!",
             // Completion
            "completion_title": "Prática do Módulo 8 Completa!", "completion_desc": "Excelente trabalho navegando por múltiplas condições com `elif`! Você está construindo lógicas complexas. <br> Pronto para mais desafios? Tente a <strong>Prática Avançada</strong> do Módulo 8!",
            "button_view_theory": "Ver Teoria Novamente", "button_start_advanced": "Iniciar Prática Avançada", "button_back_menu": "Voltar ao Menu do Curso"
        },
        zh: {
            "page_title": "模块 8：Python 练习区！",
            "tooltip_click_identify": "点击识别此部分",
            "nav_theory": "查看理论", "nav_advanced": "高级练习", "nav_menu": "课程菜单",
            "nav_anatomy": "剖析", "nav_builder": "构建器", "nav_simulator": "模拟器", "nav_tracer": "追踪", "nav_missions": "任务",
            "lang_en": "🇬🇧 English", "lang_pt": "🇧🇷 Português", "lang_zh": "🇨🇳 中文",
            "header_title": "模块 8：练习区", "header_subtitle": "使用 `elif` 掌握多重条件！",
            // Anatomy
            "anatomy_title": "条件语句剖析", "anatomy_desc": "条件语句让代码能够做出决策。点击这个 `if`/`elif`/`else` 代码块的每个高亮部分，了解它的作用。",
            "anatomy_code_var": "分数", "anatomy_code_string_a": "\"等级：A\"", "anatomy_code_string_b": "\"等级：B\"", "anatomy_code_string_c": "\"等级：C 或更低\"",
            "anatomy_status_initial": "识别所有 14 个部分！", "anatomy_status_progress": "已识别 {count} / {total} 个部分。", "anatomy_status_done": "所有部分已识别！",
            "anatomy_exp_if": "`if`：开始条件块。检查第一个条件。",
            "anatomy_exp_cond_if": "条件 1：一个计算结果为 `True` 或 `False` 的表达式（例如：`分数 >= 90`）。",
            "anatomy_exp_colon_if": "冒号 `:`：标记 `if` 条件行的结束。必需！",
            "anatomy_exp_indent_if": "缩进：空格表示属于 `if` 的代码块。至关重要！",
            "anatomy_exp_block_if": "代码块 1：仅在条件 1 为 `True` 时运行。",
            "anatomy_exp_elif": "`elif`：“否则如果”。仅在前述 `if`/`elif` 为 `False` 时检查另一个条件。",
            "anatomy_exp_cond_elif": "条件 2：仅在条件 1 为 `False` 时检查。",
            "anatomy_exp_colon_elif": "冒号 `:`：标记 `elif` 条件行的结束。",
            "anatomy_exp_indent_elif": "缩进：属于 `elif` 的代码块。",
            "anatomy_exp_block_elif": "代码块 2：仅在条件 1 为 `False` 且条件 2 为 `True` 时运行。",
            "anatomy_exp_else": "`else`：捕获所有其他情况。仅在所有前述 `if`/`elif` 条件都为 `False` 时运行。不需要条件。",
            "anatomy_exp_colon_else": "冒号 `:`：标记 `else` 行的结束。",
            "anatomy_exp_indent_else": "缩进：属于 `else` 的代码块。",
            "anatomy_exp_block_else": "代码块 3：仅在所有前述条件 (`if`, `elif`) 都为 `False` 时运行。",
            "feedback_anatomy_correct": "太棒了！你成功剖析了条件结构！",
            // Builder
            "builder_title": "条件逻辑构建器", "builder_desc": "将碎片拖到深色区域，构建一个 `if`/`elif`/`else` 结构来分配等级：A (>= 90)，B (>= 80)，C (< 80)。使用 `分数` 变量。",
            "builder_drop_placeholder": "将碎片拖放到此处构建逻辑...",
            "builder_piece_if": "if", "builder_piece_elif": "elif", "builder_piece_else": "else",
            "builder_piece_score": "分数", "builder_piece_ge": ">=", "builder_piece_lt": "<", "builder_piece_eq": "==",
            "builder_piece_90": "90", "builder_piece_80": "80",
            "builder_piece_colon": ":", "builder_piece_indent": "    (缩进)",
            "builder_piece_printA": "print(\"A\")", "builder_piece_printB": "print(\"B\")", "builder_piece_printC": "print(\"C\")",
            "button_check_builder": "检查逻辑", "button_reset_builder": "重置",
            "feedback_builder_correct": "结构完美！", "feedback_builder_incomplete": "缺少一些碎片。继续构建！", "feedback_builder_order": "检查 `if`/`elif`/`else` 或条件的顺序。", "feedback_builder_indent": "缩进很重要！确保 print 语句已缩进。", "feedback_builder_syntax": "语法错误。检查冒号或条件结构。", "feedback_builder_incorrect": "逻辑似乎不正确。请检查等级要求。",
            // Simulator
           "simulator_title": "场景模拟器", "simulator_desc": "编写 Python 代码，使用 `if`、`elif` 和 `else` 根据温度提供穿衣建议。",
           "simulator_scenario_title": "场景：", "simulator_scenario_text": "给定变量 `temp`，打印：“穿厚外套。”（如果 temp < 10），“穿夹克。”（如果 temp < 20），否则打印“穿 T 恤。”。",
           "simulator_scenario_assume": "假设 `temp` 已定义（我们将使用不同的值进行测试）。",
           "simulator_editor_label": "代码编辑器：", "simulator_editor_placeholder": 'temp = 15 # 示例值（测试时会更改）\nif temp < 10:\n    print("...")\nelif ... :\n    print("...")\nelse:\n    print("...")',
           "button_run_sim": "运行模拟", "simulator_output_label": "模拟输出（测试用例：temp = {test_temp}）：", "simulator_output_placeholder": "输出将显示在此处...",
           "feedback_sim_success": "temp={test_temp} 的模拟成功！", "feedback_sim_correct_output": "输出正确！",
           "feedback_sim_wrong_output": "temp={test_temp} 的输出不正确。预期：'{expected}'，得到：'{actual}'",
           "feedback_sim_no_output": "temp={test_temp} 没有产生输出。",
           "feedback_sim_empty": "编辑器是空的。", "feedback_sim_syntax_error": "语法错误：检查冒号、缩进或条件。", "feedback_sim_runtime_error": "运行时错误：无法运行代码。", "feedback_sim_missing_branch": "似乎缺少或不正确的条件分支（`if`、`elif` 或 `else`）。",
           // Tracer
            "trace_title": "追踪执行", "trace_desc": "根据给定的输入值，仅点击下面实际会<span class=\"highlight\">执行</span>的代码行。再次点击取消选择。然后检查您的追踪。",
            "trace_input_label": "输入值：", "trace_code_label": "代码：",
            "button_check_trace": "检查追踪", "button_try_again": "再试一次", "button_new_value": "新数值",
            "trace_line_1": "颜色 = \"蓝色\"", "trace_line_2": "if 颜色 == \"红色\":", "trace_line_3": "    print(\"停止\")", "trace_line_4": "elif 颜色 == \"黄色\":", "trace_line_5": "    print(\"小心\")", "trace_line_6": "elif 颜色 == \"蓝色\":", "trace_line_7": "    print(\"前进\")", "trace_line_8": "else:", "trace_line_9": "    print(\"未知\")", "trace_line_10": "print(\"完成\")",
            "feedback_trace_correct": "追踪完美！您正确地遵循了逻辑。 <i class=\"fas fa-thumbs-up\"></i>",
            "feedback_trace_incorrect": "不太对。{hints}。请检查 `if/elif/else` 如何跳过分支。",
            "feedback_trace_hint_incorrect": "{count} 个错误选择，已用 <i class=\"fas fa-times\"></i> 标记",
            "feedback_trace_hint_missed": "{count} 个遗漏行，已用 <i class=\"fas fa-eye\"></i> 标记",
            "feedback_trace_hints_joiner": "，并且 ",
            // Missions
            "missions_title": "迷你任务！", "missions_desc": "运用你的 `if`/`elif`/`else` 技能！完成这些编码任务。假设输入变量（`age`、`num`、`username`）已提供。",
            "mission1_title": "任务 1：票价计算", "mission1_desc": "给定 `age`，打印票价：“儿童：$5”（age < 13），“老人：$7”（age >= 65），“成人：$10”（其他情况）。", "mission1_placeholder": 'age = 30 # 示例值\nif age < 13:\n    print("...")\n# 在此处添加 elif 和 else\n',
            "button_test_mission_1": "测试任务 1",
            "mission2_title": "任务 2：数字检查", "mission2_desc": "给定 `num`，打印：“正数”（num > 0），“负数”（num < 0），“零”（num == 0）。", "mission2_placeholder": 'num = -5 # 示例值\nif num > 0:\n    print("...")\n# 在此处添加 elif 和 else\n',
            "button_test_mission_2": "测试任务 2",
            "mission3_title": "任务 3：简单登录检查", "mission3_desc": "给定 `username`，打印：“管理员访问权限”（如果 username 是 "admin"），“访客访问权限”（如果 username 是 "guest"），“未知用户”（其他情况）。", "mission3_placeholder": 'username = "guest" # 示例值\nif username == "admin":\n    print("...")\n# 在此处添加 elif 和 else\n',
            "button_test_mission_3": "测试任务 3",
            "feedback_mission_success": "任务完成！", "feedback_mission_syntax_error": "语法/逻辑错误。检查条件、冒号、缩进。",
            "feedback_mission_wrong_output": "测试用例的输出不正确。请检查要求。",
            "feedback_mission1_hint": "使用 `if age < 13`、`elif age >= 65` 和 `else` 以及正确的打印语句。", "feedback_mission2_hint": "使用 `if num > 0`、`elif num < 0` 和 `else`（用于零）。", "feedback_mission3_hint": "使用 `if username == \"admin\"`、`elif username == \"guest\"` 和 `else`。记住字符串需要引号。",
            "feedback_missions_summary_all_done": "所有 {totalMissions} 个任务已完成！条件逻辑已掌握！", "feedback_missions_summary_progress": "已完成 {completedCount} / {totalMissions} 个任务。继续分支！",
            // Completion
            "completion_title": "模块 8 练习完成！", "completion_desc": "出色地使用 `elif` 处理了多重条件！您正在构建复杂的逻辑。<br> 准备好迎接更多挑战了吗？试试模块 8 的<strong>高级练习</strong>！",
            "button_view_theory": "再次查看理论", "button_start_advanced": "开始高级练习", "button_back_menu": "返回课程菜单"
        }
    };

    document.addEventListener('DOMContentLoaded', () => {

        // --- Language Management Functions (Copied from Module 0) ---
        function getStoredLanguage() {
            const storedLang = localStorage.getItem('userLanguage');
            if (storedLang && translations[storedLang]) return storedLang;
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith('pt')) return 'pt';
            if (browserLang.startsWith('zh')) return 'zh';
            return 'en';
        }

        function setLanguage(lang) {
            if (!translations[lang]) lang = 'en';
            localStorage.setItem('userLanguage', lang);
            document.documentElement.lang = lang;
            translatePage(lang);

            const langSelect = document.getElementById('languageSelect');
            if (langSelect) langSelect.value = lang;

            // --- Re-initialize language-dependent activities ---
            if (document.getElementById('elif-anatomy')) setupAnatomyActivity();
            if (document.getElementById('condition-builder')) setupBuilderActivity();
            if (document.getElementById('scenario-simulator')) setupSimulatorActivity(); // Re-apply placeholders/labels
            if (document.getElementById('trace-execution')) setupTraceActivity(true); // Rebuild lines with new lang
            if (document.getElementById('mini-missions')) { // Re-apply placeholders/labels if needed
                 document.querySelectorAll('#mini-missions .mission-editor').forEach(editor => {
                     const key = editor.getAttribute('data-translate-placeholder');
                     if(key) editor.setAttribute('placeholder', getTranslation(key, lang));
                 });
                 if (typeof updateMissionSummary === 'function') updateMissionSummary(); // Update summary text
            }

        }

        function getTranslation(key, lang, replacements = {}) {
            let text = translations[lang]?.[key] ?? translations['en']?.[key] ?? `[${key}]`;
            for (const placeholder in replacements) {
                const regex = new RegExp(`\\{${placeholder}\\}`, 'g');
                text = text.replace(regex, replacements[placeholder]);
            }
            return text;
        }

        function translatePage(lang) {
             if (!translations[lang]) lang = 'en';
             document.querySelectorAll('[data-translate]').forEach(el => {
                 const key = el.getAttribute('data-translate');
                 const translation = getTranslation(key, lang);
                 if (el.tagName === 'TITLE') { document.title = translation; }
                 else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') { /* Skip */ }
                 else if (el.tagName === 'OPTION') { el.textContent = translation; }
                 else {
                      if (translation.includes('<') && translation.includes('>')) { el.innerHTML = translation; }
                      else { el.textContent = translation; }
                 }
             });
             document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                 const key = el.getAttribute('data-translate-placeholder');
                 el.setAttribute('placeholder', getTranslation(key, lang));
             });
              document.querySelectorAll('[data-translate-title]').forEach(el => {
                  const key = el.getAttribute('data-translate-title');
                  el.setAttribute('title', getTranslation(key, lang));
              });
              // Special case for simulator output label needing replacement
              const simOutLabel = document.querySelector('[data-translate="simulator_output_label"]');
              if(simOutLabel && typeof currentSimTestTemp !== 'undefined') {
                   simOutLabel.textContent = getTranslation('simulator_output_label', lang, {test_temp: currentSimTestTemp});
              }
        }

        const initialLang = getStoredLanguage();

        // --- Minimal Nav Logic (Copied from Module 0) ---
        const navToggleButton = document.getElementById('minimal-nav-toggle');
        const navPanel = document.getElementById('minimal-nav-panel');
        const body = document.body;
        if (navToggleButton && navPanel) {
            navToggleButton.addEventListener('click', (event) => { event.stopPropagation(); body.classList.toggle('nav-active'); navToggleButton.setAttribute('aria-expanded', body.classList.contains('nav-active')); });
            document.addEventListener('click', (event) => { if (body.classList.contains('nav-active') && !navPanel.contains(event.target) && event.target !== navToggleButton && !navToggleButton.contains(event.target)) { body.classList.remove('nav-active'); navToggleButton.setAttribute('aria-expanded', 'false'); } });
            navPanel.querySelectorAll('a').forEach(link => { link.addEventListener('click', () => { body.classList.remove('nav-active'); navToggleButton.setAttribute('aria-expanded', 'false'); }); });
            document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && body.classList.contains('nav-active')) { body.classList.remove('nav-active'); navToggleButton.setAttribute('aria-expanded', 'false'); } });
            navToggleButton.setAttribute('aria-expanded', 'false');
        }

        // --- Language Switcher Setup (Copied) ---
        const langSelect = document.getElementById('languageSelect');
        if (langSelect) { langSelect.addEventListener('change', (e) => setLanguage(e.target.value)); }

        // --- Helper Function for Feedback (Copied) ---
        function showFeedback(elementId, messageKey, type = 'info', replacements = {}) {
            const feedbackEl = document.getElementById(elementId);
            if (!feedbackEl) { console.error(`Feedback element not found: ${elementId}`); return; }
            const currentLang = getStoredLanguage();
            const translatedMessage = getTranslation(messageKey, currentLang, replacements);
            if (translatedMessage.includes('<') && translatedMessage.includes('>')) { feedbackEl.innerHTML = translatedMessage; }
            else { feedbackEl.textContent = translatedMessage; }
            feedbackEl.className = 'feedback-message'; // Reset classes first
            feedbackEl.classList.add('visible', type);
            const interactiveArea = feedbackEl.closest('.interactive-area');
            if (!interactiveArea) return;
            interactiveArea.classList.remove('success-glow-anim', 'shake-anim');
            void interactiveArea.offsetWidth; // Trigger reflow
            if (type === 'correct') { interactiveArea.classList.add('success-glow-anim'); }
            else if (type === 'incorrect') { interactiveArea.classList.add('shake-anim'); }
        }

        // --- Activity 1: Elif Anatomy ---
        const anatomySection = document.getElementById('elif-anatomy');
        let currentAnatomyListeners = [];
        const totalAnatomyParts = 14; // Updated count

        function setupAnatomyActivity() {
            if (!anatomySection) return;
            const currentLang = getStoredLanguage();
            const parts = anatomySection.querySelectorAll('.code-part');
            const explanationsDiv = document.getElementById('anatomy-explanations');
            const statusP = document.getElementById('anatomy-status');
            const feedbackDiv = document.getElementById('anatomy-feedback');
            let identifiedCount = 0;
            let partExplanations = {};

            // Fetch explanations for the current language
            document.querySelectorAll('#explanation-texts span[data-key]').forEach(span => {
                const key = span.getAttribute('data-key');
                partExplanations[key] = getTranslation(`anatomy_exp_${key}`, currentLang);
            });

            // Remove old listeners
            currentAnatomyListeners.forEach(({element, listener}) => element.removeEventListener('click', listener));
            currentAnatomyListeners = [];

            // Reset visual state
            parts.forEach(p => p.classList.remove('identified'));
            explanationsDiv.innerHTML = '';
            statusP.textContent = getTranslation('anatomy_status_initial', currentLang);
            feedbackDiv.classList.remove('visible');

            parts.forEach(part => {
                // Ensure tooltip text is updated on language change
                 const titleKey = part.getAttribute('data-translate-title');
                 if (titleKey) part.setAttribute('title', getTranslation(titleKey, currentLang));

                const clickListener = () => {
                    const partType = part.dataset.part;
                    if (!part.classList.contains('identified') && partType && partExplanations[partType]) {
                        part.classList.add('identified');
                        identifiedCount++;

                        const p = document.createElement('p');
                        p.classList.add('part-explanation');
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-check-circle'; icon.style.color = 'var(--success-color)'; icon.style.marginRight = '5px';
                        p.appendChild(icon);
                        p.appendChild(document.createTextNode(partExplanations[partType])); // Use fetched explanation
                        explanationsDiv.appendChild(p);

                        statusP.textContent = getTranslation('anatomy_status_progress', currentLang, { count: identifiedCount, total: totalAnatomyParts });

                        if (identifiedCount === totalAnatomyParts) {
                            statusP.textContent = getTranslation('anatomy_status_done', currentLang);
                            showFeedback('anatomy-feedback', 'feedback_anatomy_correct', 'correct');
                        }
                    } else if (!partExplanations[partType]) {
                        console.warn(`Explanation missing or part type invalid/already identified: ${partType}`);
                    }
                };
                part.addEventListener('click', clickListener);
                currentAnatomyListeners.push({ element: part, listener: clickListener });
            });
        }


        // --- Activity 2: Conditional Logic Builder ---
        const builderSection = document.getElementById('condition-builder');
        let builderDropZone;

        if (builderSection) {
            const piecesContainer = document.getElementById('draggable-pieces');
            builderDropZone = document.getElementById('builder-drop-zone');
            const checkBtn = document.getElementById('check-builder-btn');
            const resetBtn = document.getElementById('reset-builder-btn');
            const feedbackDiv = document.getElementById('builder-feedback');

            const initialPiecesData = [
                { key: 'builder_piece_if', type: 'keyword' },
                { key: 'builder_piece_elif', type: 'keyword' },
                { key: 'builder_piece_else', type: 'keyword' },
                { key: 'builder_piece_score', type: 'variable' },
                { key: 'builder_piece_ge', type: 'operator' }, { key: 'builder_piece_ge', type: 'operator' }, // Need two >=
                { key: 'builder_piece_90', type: 'value-num' }, { key: 'builder_piece_80', type: 'value-num' },
                { key: 'builder_piece_colon', type: 'colon' }, { key: 'builder_piece_colon', type: 'colon' }, { key: 'builder_piece_colon', type: 'colon' }, // Need three colons
                { key: 'builder_piece_indent', type: 'indent' }, { key: 'builder_piece_indent', type: 'indent' }, { key: 'builder_piece_indent', type: 'indent' }, // Need three indents
                { key: 'builder_piece_printA', type: 'print' }, { key: 'builder_piece_printB', type: 'print' }, { key: 'builder_piece_printC', type: 'print' }
            ];

            let draggedElement = null; let touchDragElement = null; let originalPiece = null; let startX, startY, offsetX, offsetY;

            function createPieceElement(pieceData, currentLang) {
                const piece = document.createElement('span');
                piece.classList.add('piece', 'code-font');
                piece.draggable = true;
                const displayText = getTranslation(pieceData.key, currentLang);
                piece.textContent = displayText;
                piece.dataset.value = pieceData.key; // Use key as value identifier
                piece.dataset.type = pieceData.type;
                addDragListeners(piece);
                addTouchListeners(piece);
                return piece;
            }

            function populatePieces() {
                 const currentLang = getStoredLanguage();
                 piecesContainer.innerHTML = '';
                 const shuffledPieces = [...initialPiecesData].sort(() => Math.random() - 0.5);
                 shuffledPieces.forEach(pData => {
                     piecesContainer.appendChild(createPieceElement(pData, currentLang));
                 });
             }

             function createDropLine() {
                 const line = document.createElement('div');
                 line.classList.add('build-line');
                 return line;
             }

            function setupBuilderActivity() {
                 populatePieces();
                 builderDropZone.innerHTML = ''; // Clear previous lines/placeholder
                 const placeholder = document.createElement('span');
                 placeholder.id = 'builder-drop-zone-placeholder';
                 placeholder.dataset.translate = 'builder_drop_placeholder';
                 placeholder.textContent = getTranslation('builder_drop_placeholder', getStoredLanguage());
                 builderDropZone.appendChild(placeholder);
                 // Add initial empty lines (visual guides) - Maybe not needed if dropped pieces create lines
                 feedbackDiv.classList.remove('visible');
                 checkBtn.classList.remove('success');
                 checkBtn.disabled = false;
                 builderDropZone.classList.remove('over');
            }

             // Drag/Touch listeners (Adapted from Module 0, simpler drop logic might be needed)
             function addDragListeners(element) {
                element.addEventListener('dragstart', (e) => {
                    if (e.target.closest('#builder-drop-zone')) { e.preventDefault(); return; }
                    draggedElement = element; element.classList.add('ghosting');
                    e.dataTransfer.effectAllowed = 'move';
                    try { e.dataTransfer.setData('text/plain', element.dataset.value); } catch (err) {}
                 });
                element.addEventListener('dragend', () => { if (draggedElement) draggedElement.classList.remove('ghosting'); draggedElement = null; builderDropZone.classList.remove('over'); });
             }
             function handleTouchStart(e) { /* Simplified: Desktop drag assumed primary for complexity */ }
             function handleTouchMove(e) { /* Simplified */ }
             function handleTouchEnd(e) { /* Simplified */ }
             function addTouchListeners(element) { /* Simplified */ }

            builderDropZone.addEventListener('dragover', (e) => { e.preventDefault(); builderDropZone.classList.add('over'); });
            builderDropZone.addEventListener('dragleave', () => { builderDropZone.classList.remove('over'); });
            builderDropZone.addEventListener('drop', (e) => {
                 e.preventDefault(); builderDropZone.classList.remove('over');
                 if (draggedElement && piecesContainer.contains(draggedElement)) {
                     builderDropZone.querySelector('#builder-drop-zone-placeholder')?.remove();

                     // Simple Append Logic: Find last line or create new one
                     let lastLine = builderDropZone.querySelector('.build-line:last-child');
                     if (!lastLine) {
                         lastLine = createDropLine();
                         builderDropZone.appendChild(lastLine);
                     }

                     const droppedPiece = draggedElement.cloneNode(true); // Clone to allow reuse from top
                     droppedPiece.classList.remove('ghosting');
                     droppedPiece.draggable = false;
                     droppedPiece.style.cursor = 'default';
                     lastLine.appendChild(droppedPiece);

                     // Crude way to start new line after colon or print
                     if (droppedPiece.dataset.type === 'colon' || droppedPiece.dataset.type === 'print') {
                          builderDropZone.appendChild(createDropLine());
                     }

                     // Make original draggable again (or remove if finite pieces)
                     // draggedElement.classList.remove('ghosting'); // Keep original visible
                      draggedElement = null; // Clear reference
                 }
             });

            // --- Builder Check Logic (NEEDS SIGNIFICANT WORK) ---
            checkBtn.addEventListener('click', () => {
                const lines = builderDropZone.querySelectorAll('.build-line');
                let structureOk = false;
                let feedbackKey = 'feedback_builder_incorrect'; // Default

                // Basic Check (Example - Needs proper parsing and validation)
                 if (lines.length >= 5) { // Expecting at least if, print, elif, print, else, print lines (or similar)
                    const line1Pieces = lines[0].querySelectorAll('.piece');
                    const line2Pieces = lines[1].querySelectorAll('.piece');
                    // ... and so on for other lines

                    // Check line 1: 'if', 'score', '>=', '90', ':'
                    const line1Correct = line1Pieces.length === 5 &&
                                         line1Pieces[0].dataset.value === 'builder_piece_if' &&
                                         line1Pieces[1].dataset.value === 'builder_piece_score' &&
                                         line1Pieces[2].dataset.value === 'builder_piece_ge' &&
                                         line1Pieces[3].dataset.value === 'builder_piece_90' &&
                                         line1Pieces[4].dataset.value === 'builder_piece_colon';

                    // Check line 2: 'indent', 'printA'
                    const line2Correct = line2Pieces.length === 2 &&
                                         line2Pieces[0].dataset.value === 'builder_piece_indent' &&
                                         line2Pieces[1].dataset.value === 'builder_piece_printA';

                    // Check line 3: 'elif', 'score', '>=', '80', ':'
                     const line3Correct = lines[2]?.querySelectorAll('.piece').length === 5 &&
                                         lines[2].querySelectorAll('.piece')[0].dataset.value === 'builder_piece_elif'; // Simplified check

                    // ... Add more checks for elif block, else block ...

                    if (line1Correct && line2Correct && line3Correct /* && other lines correct */) {
                        structureOk = true;
                        feedbackKey = 'feedback_builder_correct';
                    } else if (!line1Correct) {
                        feedbackKey = 'feedback_builder_syntax'; // Or order
                    } else if (!line2Correct) {
                         feedbackKey = 'feedback_builder_indent';
                    } else {
                        feedbackKey = 'feedback_builder_order'; // General fallback
                    }

                 } else {
                     feedbackKey = 'feedback_builder_incomplete';
                 }


                if (structureOk) {
                    showFeedback('builder-feedback', feedbackKey, 'correct');
                    checkBtn.classList.add('success'); checkBtn.disabled = true;
                } else {
                    showFeedback('builder-feedback', feedbackKey, 'incorrect');
                    checkBtn.classList.remove('success');
                }
            });

            resetBtn.addEventListener('click', setupBuilderActivity);
        }

        // --- Activity 3: Scenario Simulator ---
        const simSection = document.getElementById('scenario-simulator');
        let currentSimTestTemp; // Store current temp for feedback

        function setupSimulatorActivity() {
             if (!simSection) return;
             const currentLang = getStoredLanguage();
             // Update labels/placeholders if needed (mostly handled by translatePage)
             const editor = document.getElementById('sim-editor-input');
             const placeholderKey = editor.getAttribute('data-translate-placeholder');
             if (placeholderKey) editor.setAttribute('placeholder', getTranslation(placeholderKey, currentLang));

             const outputLabel = simSection.querySelector('[data-translate="simulator_output_label"]');
             if(outputLabel && typeof currentSimTestTemp !== 'undefined') {
                 outputLabel.textContent = getTranslation('simulator_output_label', currentLang, {test_temp: currentSimTestTemp});
             }
        }

        if(simSection) {
            const editor = document.getElementById('sim-editor-input');
            const outputArea = document.getElementById('sim-output');
            const runBtn = document.getElementById('run-sim-btn');
            const feedbackDiv = document.getElementById('sim-feedback');
            const outputLabel = simSection.querySelector('[data-translate="simulator_output_label"]');

            // Basic simulator - checks output for specific inputs
            const runSimulation = (testTemp) => {
                currentSimTestTemp = testTemp; // Store for feedback messages
                const code = editor.value; // Don't trim, indentation matters
                let output = '';
                let error = null;
                let expectedOutput = '';
                const currentLang = getStoredLanguage();

                // Determine expected output based on the test temperature
                if (testTemp < 10) expectedOutput = "Wear a heavy coat.";
                else if (testTemp < 20) expectedOutput = "Wear a jacket.";
                else expectedOutput = "Wear a t-shirt.";

                // Update output label
                outputLabel.textContent = getTranslation('simulator_output_label', currentLang, {test_temp: testTemp});

                outputArea.innerHTML = ''; // Clear previous output
                const placeholder = document.createElement('span');
                placeholder.className = 'placeholder';
                placeholder.textContent = getTranslation('simulator_output_placeholder', currentLang);
                outputArea.appendChild(placeholder); // Add placeholder initially
                feedbackDiv.classList.remove('visible'); // Hide feedback

                if (code.trim() === '') {
                     showFeedback('sim-feedback', 'feedback_sim_empty', 'info');
                     return;
                }

                // Super basic pseudo-evaluation (NOT a real Python interpreter)
                try {
                    // Very crude check for structure and keywords
                    if (!code.includes('if') || !code.includes(':') || !code.includes('<')) throw new Error("Syntax issue suspected");
                    if (code.includes('elif') && (!code.includes('elif temp < 20:') && !code.includes('elif (temp < 20):'))) throw new Error("Elif condition seems wrong");
                    if (code.includes('else') && !code.includes('else:')) throw new Error("Else syntax seems wrong");

                    // Simulate the logic flow for the given testTemp
                    let temp = testTemp; // Make temp available for eval (DANGEROUS - normally use sandboxing)
                    let printedOutput = null;

                    // This is highly fragile and insecure - just for simple demo
                    if (temp < 10) {
                        if (code.match(/if\s+temp\s*<\s*10\s*:/)) {
                            const match = code.match(/if\s+temp\s*<\s*10\s*:\s*print\s*\(\s*["'](.*?)["']\s*\)/);
                            if (match) printedOutput = match[1];
                        }
                    } else if (temp < 20) {
                         if (code.match(/elif\s+temp\s*<\s*20\s*:/)) {
                            const match = code.match(/elif\s+temp\s*<\s*20\s*:\s*print\s*\(\s*["'](.*?)["']\s*\)/);
                             if (match) printedOutput = match[1];
                         } else if (code.match(/else\s*:/) && !code.match(/elif\s+temp\s*<\s*20\s*:/) ) { // Check if else catches it wrongly
                             const match = code.match(/else\s*:\s*print\s*\(\s*["'](.*?)["']\s*\)/);
                              if (match) printedOutput = match[1]; // This would be wrong if elif existed
                         }
                    } else { // temp >= 20
                         if (code.match(/else\s*:/)) {
                            const match = code.match(/else\s*:\s*print\s*\(\s*["'](.*?)["']\s*\)/);
                             if (match) printedOutput = match[1];
                         }
                    }

                    if (printedOutput !== null) {
                        output = printedOutput;
                    } else {
                        error = new Error("No matching condition produced output or syntax issue.");
                        feedbackKey = 'feedback_sim_no_output';
                    }

                } catch (e) {
                    error = e;
                    console.error("Simulation pseudo-eval error:", e);
                    feedbackKey = 'feedback_sim_syntax_error'; // Generic syntax error
                }

                // Display result
                if (!error && output) {
                     outputArea.innerHTML = ''; // Clear placeholder
                     const outputLine = document.createElement('span');
                     outputLine.classList.add('output-line');
                     outputLine.textContent = `> ${output}`;
                     outputArea.appendChild(outputLine);
                     if (output === expectedOutput) {
                         showFeedback('sim-feedback', 'feedback_sim_correct_output', 'correct');
                     } else {
                         showFeedback('sim-feedback', 'feedback_sim_wrong_output', 'incorrect', { test_temp: testTemp, expected: expectedOutput, actual: output });
                     }
                 } else if (!error && !output) { // No output produced where expected
                     showFeedback('sim-feedback', feedbackKey || 'feedback_sim_no_output', 'incorrect', {test_temp: testTemp});
                 } else { // Error occurred
                      showFeedback('sim-feedback', feedbackKey || 'feedback_sim_runtime_error', 'incorrect');
                 }
            };

            runBtn.addEventListener('click', () => runSimulation(18)); // Default test case
        }

        // --- Activity 4: Trace the Execution ---
        const traceSection = document.getElementById('trace-execution');
        let currentTraceValue = '';
        let currentTraceListeners = [];
        let traceCodeLinesData = []; // Holds { id, text_key, indent, is_executable(value), is_condition }

        function setupTraceActivity(forceReset = false) {
            if (!traceSection) return;

            const linesContainer = document.getElementById('trace-lines');
            const checkBtn = document.getElementById('check-trace-btn');
            const resetBtn = document.getElementById('reset-trace-btn');
            const newBtn = document.getElementById('new-trace-value-btn');
            const feedbackDiv = document.getElementById('trace-feedback');
            const valueDisplay = document.getElementById('current-input-value');
            const currentLang = getStoredLanguage();

            // Only regenerate data and pick new value if forced or first time
            if (forceReset || traceCodeLinesData.length === 0) {
                // Define code structure (using keys for translation)
                traceCodeLinesData = [
                    { id: 1, text_key: "trace_line_1", indent: 0, is_condition: false }, // color = "..."
                    { id: 2, text_key: "trace_line_2", indent: 0, is_condition: true },  // if color == "red":
                    { id: 3, text_key: "trace_line_3", indent: 1, is_condition: false }, //     print("Stop")
                    { id: 4, text_key: "trace_line_4", indent: 0, is_condition: true },  // elif color == "yellow":
                    { id: 5, text_key: "trace_line_5", indent: 1, is_condition: false }, //     print("Caution")
                    { id: 6, text_key: "trace_line_6", indent: 0, is_condition: true },  // elif color == "blue":
                    { id: 7, text_key: "trace_line_7", indent: 1, is_condition: false }, //     print("Go")
                    { id: 8, text_key: "trace_line_8", indent: 0, is_condition: true },  // else: (Treat as condition for execution flow)
                    { id: 9, text_key: "trace_line_9", indent: 1, is_condition: false }, //     print("Unknown")
                    { id: 10, text_key: "trace_line_10", indent: 0, is_condition: false } // print("Done")
                ];

                // Choose a random value
                const possibleValues = ["red", "yellow", "blue", "green"];
                currentTraceValue = possibleValues[Math.floor(Math.random() * possibleValues.length)];
            }

            valueDisplay.textContent = `"${currentTraceValue}"`; // Display the chosen value

            // Determine correct executable path based on currentTraceValue
            let correctPathIds = [];
            correctPathIds.push(1); // Assignment always runs
            let conditionMet = false;

            if (currentTraceValue === "red") {
                correctPathIds.push(2); // if condition check
                correctPathIds.push(3); // if block runs
                conditionMet = true;
            } else {
                correctPathIds.push(2); // if condition check (runs, evaluates false)
                if (currentTraceValue === "yellow") {
                    correctPathIds.push(4); // elif 1 check
                    correctPathIds.push(5); // elif 1 block runs
                    conditionMet = true;
                } else {
                    correctPathIds.push(4); // elif 1 check (runs, evaluates false)
                    if (currentTraceValue === "blue") {
                        correctPathIds.push(6); // elif 2 check
                        correctPathIds.push(7); // elif 2 block runs
                        conditionMet = true;
                    } else {
                        correctPathIds.push(6); // elif 2 check (runs, evaluates false)
                        correctPathIds.push(8); // else check (implicit true)
                        correctPathIds.push(9); // else block runs
                        conditionMet = true; // else is considered meeting a condition path
                    }
                }
            }
            correctPathIds.push(10); // Final print always runs

            // --- Render Lines ---
            // Remove old listeners
            currentTraceListeners.forEach(({element, listener}) => element.removeEventListener('click', listener));
            currentTraceListeners = [];
            linesContainer.innerHTML = ''; // Clear old lines

            traceCodeLinesData.forEach(lineData => {
                const container = document.createElement('div');
                container.classList.add('trace-line-container');
                const iconPlaceholder = document.createElement('span');
                iconPlaceholder.classList.add('trace-feedback-icon');
                const codeLine = document.createElement('div');
                codeLine.classList.add('code-line-trace');
                codeLine.dataset.lineId = lineData.id;
                // Set text with correct indentation
                const indentSpaces = '&nbsp;'.repeat(lineData.indent * 4); // Use non-breaking spaces for HTML indent
                codeLine.innerHTML = indentSpaces + getTranslation(lineData.text_key, currentLang);
                 // Add syntax highlighting if needed (can be complex)
                 // Example: Highlight keywords/strings within the translated text
                 codeLine.innerHTML = codeLine.innerHTML
                     .replace(/(if|elif|else)/g, '<span class="code-keyword">$1</span>')
                     .replace(/print/g, '<span class="code-function">print</span>')
                     .replace(/"(.*?)"/g, '<span class="code-string">"$1"</span>')
                     .replace(/(==|>=|<)/g, '<span class="code-operator">$1</span>')
                     .replace(/(\bcolor\b)/g, '<span class="code-variable">$1</span>') // Highlight variable
                     .replace(/:\s*$/g, '<span class="code-colon">:</span>'); // Highlight colon


                container.appendChild(iconPlaceholder);
                container.appendChild(codeLine);
                linesContainer.appendChild(container);

                const lineClickListener = () => {
                    if (codeLine.classList.contains('checked-state')) return;
                    codeLine.classList.toggle('selected-execution');
                };
                codeLine.addEventListener('click', lineClickListener);
                currentTraceListeners.push({ element: codeLine, listener: lineClickListener });
            });

            // Reset buttons and feedback
            feedbackDiv.classList.remove('visible');
            resetBtn.classList.add('hidden');
            checkBtn.disabled = false;
            checkBtn.classList.remove('success');
            newBtn.disabled = false;
        }

        if (traceSection) {
            const checkBtn = document.getElementById('check-trace-btn');
            const resetBtn = document.getElementById('reset-trace-btn');
            const newBtn = document.getElementById('new-trace-value-btn');
            const linesContainer = document.getElementById('trace-lines');

            checkBtn.addEventListener('click', () => {
                 const selectedLines = linesContainer.querySelectorAll('.code-line-trace.selected-execution');
                 const selectedIds = Array.from(selectedLines).map(el => parseInt(el.dataset.lineId));

                 // Determine correct path again (could be stored from setup)
                 let expectedPathIds = []; let color = currentTraceValue;
                 expectedPathIds.push(1);
                 if (color === "red") { expectedPathIds.push(2, 3); }
                 else { expectedPathIds.push(2); if (color === "yellow") { expectedPathIds.push(4, 5); }
                 else { expectedPathIds.push(4); if (color === "blue") { expectedPathIds.push(6, 7); }
                 else { expectedPathIds.push(6); expectedPathIds.push(8, 9); }}}
                 expectedPathIds.push(10);

                 let incorrectSelections = 0;
                 let missedSelections = 0;
                 let isCorrectOverall = true;
                 const currentLang = getStoredLanguage();

                 linesContainer.querySelectorAll('.trace-line-container').forEach(container => {
                     const lineCheck = container.querySelector('.code-line-trace');
                     const iconPlaceholder = container.querySelector('.trace-feedback-icon');
                     const lineId = parseInt(lineCheck.dataset.lineId);
                     const isSelected = lineCheck.classList.contains('selected-execution');
                     const shouldBeSelected = expectedPathIds.includes(lineId);

                     iconPlaceholder.innerHTML = '';
                     iconPlaceholder.classList.remove('visible');
                     lineCheck.classList.add('checked-state'); // Mark as checked

                     let iconClass = '';
                     if (isSelected && shouldBeSelected) { iconClass = 'fas fa-check'; }
                     else if (isSelected && !shouldBeSelected) { iconClass = 'fas fa-times'; incorrectSelections++; isCorrectOverall = false; }
                     else if (!isSelected && shouldBeSelected) { iconClass = 'fas fa-eye'; missedSelections++; isCorrectOverall = false; }

                     if (iconClass) {
                         const icon = document.createElement('i'); icon.className = iconClass; iconPlaceholder.appendChild(icon); iconPlaceholder.classList.add('visible');
                     }
                 });


                 if (isCorrectOverall) {
                     showFeedback('trace-feedback', 'feedback_trace_correct', 'correct');
                     checkBtn.classList.add('success');
                     resetBtn.classList.add('hidden');
                     checkBtn.disabled = true;
                     newBtn.disabled = false; // Allow getting new value
                 } else {
                     let hints = [];
                     if (incorrectSelections > 0) hints.push(getTranslation('feedback_trace_hint_incorrect', currentLang, { count: incorrectSelections }));
                     if (missedSelections > 0) hints.push(getTranslation('feedback_trace_hint_missed', currentLang, { count: missedSelections }));
                     showFeedback('trace-feedback', 'feedback_trace_incorrect', 'incorrect', { hints: hints.join(getTranslation('feedback_trace_hints_joiner', currentLang)) });
                     checkBtn.classList.remove('success');
                     resetBtn.classList.remove('hidden'); // Show Try Again
                     checkBtn.disabled = true;
                     newBtn.disabled = true; // Disable new value until reset/try again
                 }
             });

            resetBtn.addEventListener('click', () => setupTraceActivity(false)); // Reset selections for the *same* value
            newBtn.addEventListener('click', () => setupTraceActivity(true)); // Get a new value and reset everything
        }


        // --- Activity 5: Mini Missions ---
        const missionsSection = document.getElementById('mini-missions');
        let updateMissionSummary;

        if (missionsSection) {
            const missionRunButtons = missionsSection.querySelectorAll('.mission-run-btn');
            const summaryFeedback = document.getElementById('missions-summary-feedback');
            const totalMissions = missionsSection.querySelectorAll('.mission').length;

            updateMissionSummary = function() { // Assign function
                 const completedMissionsCount = missionsSection.querySelectorAll('.mission[data-completed="true"]').length;
                 const currentLang = getStoredLanguage();
                 if (completedMissionsCount === totalMissions) {
                     showFeedback('missions-summary-feedback', 'feedback_missions_summary_all_done', 'correct', { totalMissions: totalMissions });
                 } else if (completedMissionsCount > 0) {
                     showFeedback('missions-summary-feedback', 'feedback_missions_summary_progress', 'info', { completedCount: completedMissionsCount, totalMissions: totalMissions });
                 } else {
                     summaryFeedback.classList.remove('visible');
                 }
            }

            // --- Mission Validation Logic ---
            const validateMission = (missionId, code) => {
                let success = false;
                let output = null;
                let hintKey = 'feedback_mission_syntax_error';
                let testValue; // Value used for testing this run

                 // Very basic simulation - NO SANDBOXING - inherently insecure
                 try {
                    let context = {}; // Simulate variable scope
                    let result = null;
                     // Capture print calls
                    const log = [];
                    const fakePrint = (...args) => log.push(args.join(' '));
                    context.print = fakePrint;

                    if (missionId === '1') {
                        const testAges = [10, 30, 70];
                        testValue = testAges[Math.floor(Math.random() * testAges.length)]; // Pick one test case
                        context.age = testValue;
                        // Use Function constructor for pseudo-sandboxing (still risky)
                        const missionFunc = new Function('age', 'print', code);
                        missionFunc(context.age, context.print);
                         result = log.join('\n');
                        let expected;
                        if (testValue < 13) expected = "Child: $5";
                        else if (testValue >= 65) expected = "Senior: $7";
                        else expected = "Adult: $10";
                         if (result === expected) { success = true; } else { hintKey = 'feedback_mission1_hint'; output = result || "[No Output]"; }
                     }
                    else if (missionId === '2') {
                        const testNums = [10, -5, 0];
                        testValue = testNums[Math.floor(Math.random() * testNums.length)];
                        context.num = testValue;
                        const missionFunc = new Function('num', 'print', code);
                        missionFunc(context.num, context.print);
                        result = log.join('\n');
                        let expected;
                        if (testValue > 0) expected = "Positive";
                        else if (testValue < 0) expected = "Negative";
                        else expected = "Zero";
                        if (result === expected) { success = true; } else { hintKey = 'feedback_mission2_hint'; output = result || "[No Output]"; }
                    }
                    else if (missionId === '3') {
                         const testUsers = ["admin", "guest", "other"];
                        testValue = testUsers[Math.floor(Math.random() * testUsers.length)];
                        context.username = testValue;
                        const missionFunc = new Function('username', 'print', code);
                        missionFunc(context.username, context.print);
                        result = log.join('\n');
                        let expected;
                        if (testValue === "admin") expected = "Admin Access";
                        else if (testValue === "guest") expected = "Guest Access";
                        else expected = "Unknown User";
                        if (result === expected) { success = true; } else { hintKey = 'feedback_mission3_hint'; output = result || "[No Output]"; }
                    }
                     if (success) output = result; // Store correct output
                 } catch (e) {
                     console.error(`Mission ${missionId} validation error:`, e);
                     hintKey = 'feedback_mission_syntax_error'; // Generic error if execution fails
                     output = `Error: ${e.message}`;
                 }

                 return { success, output, hintKey, testValue };
            };
            // --- End Mission Validation Logic ---

            missionRunButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const missionId = button.dataset.missionId;
                    const missionDiv = document.getElementById(`mission-${missionId}`);
                    if (!missionDiv) return;
                    const editor = missionDiv.querySelector('.mission-editor');
                    const outputArea = missionDiv.querySelector('.mission-output');
                    const feedbackDivId = `mission-feedback-${missionId}`;
                    const statusIcon = missionDiv.querySelector('.mission-status i');
                    const code = editor.value; // Keep indentation

                    const { success, output, hintKey, testValue } = validateMission(missionId, code);

                    outputArea.textContent = output !== null ? `(Test Value: ${typeof testValue === 'string' ? `"${testValue}"` : testValue})\n> ${output}` : '(No output)';

                    let feedbackMessageKey = hintKey;
                    let feedbackType = 'incorrect';

                    if (success) {
                        feedbackMessageKey = 'feedback_mission_success';
                        feedbackType = 'correct';
                        statusIcon.className = 'fas fa-check-circle';
                        missionDiv.dataset.completed = 'true';
                    } else {
                        feedbackType = 'incorrect';
                        statusIcon.className = 'fas fa-times-circle';
                        missionDiv.dataset.completed = 'false';
                        // Add wrong output message if applicable
                        if (output && !output.startsWith("Error:")) {
                             feedbackMessageKey = 'feedback_mission_wrong_output';
                         }
                    }
                    showFeedback(feedbackDivId, feedbackMessageKey, feedbackType);
                    updateMissionSummary();
                });
            });
            updateMissionSummary(); // Initial call
        }


        // --- Fade-in animations on scroll (Copied) ---
        const fadeElements = document.querySelectorAll('.fade-in');
        const animateOnScroll = () => {
            const windowHeight = window.innerHeight;
            fadeElements.forEach(el => {
                 if (el.style.opacity === '1') return; // Already visible
                 const rect = el.getBoundingClientRect();
                 if (rect.top < windowHeight - 80 && rect.bottom >= 50) {
                    // Check if animation hasn't started based on style presence
                    if (!el.style.animation && !el.style.opacity) {
                         el.style.animation = 'fadeInAnimation 0.8s ease-out forwards';
                         // Apply delay if class exists
                         const delayMatch = el.className.match(/delay-(\d)/);
                         if (delayMatch) {
                             el.style.animationDelay = `${parseInt(delayMatch[1]) * 0.2}s`;
                         }
                    }
                    // Fallback if animation style isn't detected reliably
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                 }
             });
        };
        const scrollHandler = () => window.requestAnimationFrame(animateOnScroll);
        window.addEventListener('scroll', scrollHandler);


        // --- Initial Setup Calls ---
        setLanguage(initialLang); // Apply language and run activity setups
        animateOnScroll(); // Initial check for elements in view


        // --- Specific Initial Calls (If not handled by setLanguage) ---
        // setupAnatomyActivity(); // Called by setLanguage
        // setupBuilderActivity(); // Called by setLanguage
        // setupSimulatorActivity(); // Called by setLanguage
        // setupTraceActivity(true); // Called by setLanguage
        // updateMissionSummary(); // Called by setLanguage


    }); // End DOMContentLoaded
    </script>

</body>
</html>