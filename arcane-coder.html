<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Tome (Vibe Coder Enhanced)</title>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Georgia&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- Arcane Tome Base Styles --- */
        :root {
            --parchment: #f5e7d0;
            --parchment-dark: #e3d5b8;
            --ink: #3a3129;
            --ink-light: #5a4e42;
            --gold: #c9a227;
            --crimson: #8b0000;
            --sapphire: #1e3a8a; /* User message background */
            --amethyst: #6b21a8; /* Spirit avatar temp background */
            --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.15);
            --code-bg: #e8e0cf;
            --code-border: #d1c3a9;
        }

        html, body { height: 100%; margin: 0; padding: 0; }
        * { box-sizing: border-box; }

        body {
            font-family: Georgia, 'Times New Roman', Times, serif;
            font-size: 1.1rem; line-height: 1.6;
            background-color: var(--parchment); color: var(--ink); /* Body has parchment background */
            width: 100vw; overflow: hidden;
        }

        .tome { /* Main container */
            width: 100%; height: 100%; display: flex; flex-direction: column; position: relative;
            background-color: var(--parchment); /* Ensure tome itself matches body */
        }

        .pages { /* Message area */
            flex: 1; min-height: 0; padding: 20px; overflow-y: auto;
            scrollbar-width: none; display: flex; flex-direction: column; gap: 15px;
            /* background-color: var(--parchment); */ /* Removed distinct background - inherits from .tome/body */
        }
        .pages::-webkit-scrollbar { display: none; }

        /* --- Message Styling --- */
        .message { display: flex; gap: 10px; max-width: 85%; animation: fadeIn 0.5s ease-in-out;}
        .message-user { align-self: flex-end; flex-direction: row-reverse; } /* User message aligned right */
        .message-spirit { align-self: flex-start; } /* Spirit message aligned left */

        .avatar {
            width: 45px; height: 45px; border-radius: 50%; flex-shrink: 0;
            border: 2px solid var(--parchment-dark); box-shadow: var(--shadow-light);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            background-color: var(--parchment-dark); cursor: pointer;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-avatar { background-color: var(--sapphire); }
        .spirit-avatar { background-color: var(--amethyst); }

        .message-content-wrapper { display: flex; flex-direction: column; max-width: 100%; }

        .message-content { /* Bubble */
            padding: 12px 18px; border-radius: 8px; line-height: 1.5;
            word-break: break-word; box-shadow: var(--shadow-light);
            max-width: fit-content; /* Allow bubble to size to content */
        }
        .message-user .message-content { /* Styles applied when .message-content is inside .message-user */
            background-color: var(--sapphire);
            color: white;
            border-top-right-radius: 0; /* Square corner pointing to user avatar */
        }
        .message-spirit .message-content { /* Styles applied when .message-content is inside .message-spirit */
            background-color: white;
            color: var(--ink);
            border: 1px solid var(--ink-light);
            border-top-left-radius: 0; /* Square corner pointing to spirit avatar */
        }
        .message-content p { margin: 0 0 0.5em 0; } .message-content p:last-child { margin-bottom: 0; }

        .typing-indicator {
            align-self: flex-start; color: var(--ink-light); font-style: italic;
            padding: 10px 15px; background-color: rgba(227, 213, 184, 0.5);
            border-radius: 8px; font-size: 1rem;
        }

        /* --- Writing Area (Footer) Styling --- */
        .writing-area {
            padding: 12px; background-color: var(--parchment-dark); border-top: 2px solid var(--ink-light);
            display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end;
            flex-shrink: 0;
        }
        .message-input {
            flex: 1 1 250px; padding: 10px; background-color: var(--parchment);
            border: 2px solid var(--ink-light); border-radius: 5px; font-family: inherit;
            font-size: 1.1rem; resize: none; outline: none; color: var(--ink);
            min-height: 48px; max-height: 150px; line-height: 1.5;
        }
        .message-input:focus { border-color: var(--gold); }

        .writing-controls { display: flex; align-items: flex-end; gap: 8px; flex-wrap: nowrap; margin-left: auto; }
        .footer-button { background-color: var(--ink-light); color: var(--parchment); border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease; padding: 8px 10px; font-size: 0.9em; flex-shrink: 0; white-space: nowrap; height: 48px; font-family: Georgia, serif; }
        .footer-button:hover { background-color: var(--ink); }
        #settings-button { background-color: var(--gold); color: var(--ink); font-size: 1.2em; padding: 0 12px; }
        #settings-button:hover { background-color: var(--crimson); color: white; }
        #clear-chat-button { background-color: var(--crimson); color: white;}
        #clear-chat-button:hover { background-color: darkred; }
        .response-count-input { width: 45px; padding: 10px; border: 2px solid var(--ink-light); border-radius: 5px; text-align: center; flex-shrink: 0; height: 48px; font-size: 1rem; background-color: var(--parchment); color: var(--ink); }
        .send-button { background-color: var(--gold); color: var(--ink); border: none; border-radius: 5px; padding: 0 18px; height: 48px; font-family: 'Cinzel Decorative', cursive; font-weight: bold; cursor: pointer; box-shadow: var(--shadow-light); display: flex; align-items: center; gap: 8px; font-size: 1.1rem; transition: background-color 0.2s ease; flex-shrink: 0; }
        .send-button:hover:not(:disabled) { background-color: var(--crimson); color: white; }
        .send-button:disabled { opacity: 0.7; cursor: not-allowed; background-color: var(--ink-light); color: var(--parchment); }

        /* --- Multi-Response Navigation --- */
        .response-navigation { display: flex; align-items: center; justify-content: flex-start; margin-top: 5px; gap: 5px; width: fit-content; }
        .response-navigation button { background-color: var(--parchment-dark); border: 1px solid var(--ink-light); color: var(--ink); border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 0.9em; line-height: 1; }
        .response-navigation button:disabled { opacity: 0.5; cursor: not-allowed; background-color: #ccc; }
        .response-navigation span { font-size: 0.8em; color: var(--ink-light); margin: 0 5px; user-select: none; }

        /* --- Modals (Themed) --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(58, 49, 41, 0.7); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--parchment); border: 3px solid var(--gold); color: var(--ink); padding: 25px; border-radius: 8px; width: 90%; max-width: 650px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); max-height: 90vh; display: flex; flex-direction: column; }
        .modal-content h3 { font-family: 'Cinzel Decorative', cursive; margin-top: 0; text-align: center; color: var(--ink); border-bottom: 1px solid var(--gold); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-content .form-group { margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
        .modal-content label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--ink-light); flex-basis: 100%; }
        .modal-content input[type="checkbox"] { cursor: pointer; margin-right: 5px; flex-shrink: 0; }
        .modal-content label[for*="checkbox"] { flex-basis: auto; margin-bottom: 0; }
        .modal-content input[type="password"], .modal-content textarea, .modal-content input[type="number"] { width: 100%; padding: 10px; border: 1px solid var(--ink-light); border-radius: 4px; outline: none; box-sizing: border-box; background-color: white; color: var(--ink); font-family: Georgia, serif; font-size: 1rem; }
        .modal-content textarea { resize: vertical; min-height: 80px; }
        .modal-content .modal-buttons { margin-top: 20px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0;}
        .modal-content button { background-color: var(--gold); color: var(--ink); border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease; font-family: 'Cinzel Decorative', cursive; font-weight: bold; }
        .modal-content button:hover { background-color: var(--crimson); color: white; }
        .modal-content button.cancel-button { background-color: var(--ink-light); color: var(--parchment); }
        .modal-content button.cancel-button:hover { background-color: var(--ink); }
        /* Code Edit Specifics */
        #edit-snippet-textarea { font-family: Consolas, Monaco, monospace; min-height: 150px; max-height: 40vh; flex-grow: 1; overflow-y: auto; margin-bottom: 5px;}
        .modal-content .line-inputs { display: flex; gap: 15px; align-items: center; margin-bottom: 10px; flex-shrink: 0; flex-wrap: wrap; }
        .modal-content .line-inputs div { flex-grow: 1; min-width: 80px; }
        .modal-content .line-inputs input[type="number"] { width: 100%; padding: 8px; }
        #edit-snippet-counter { font-size: 0.9em; color: var(--ink-light); text-align: right; margin-bottom: 15px; flex-shrink: 0; flex-basis: 100%;}
        #edit-snippet-line-count { font-weight: bold; color: var(--ink); }

        /* --- Code Formatting & Markdown --- */
        .message-content pre { border: 1px solid var(--code-border); background-color: var(--code-bg); position: relative; margin-top: 10px; margin-bottom: 5px; /* Add space for placeholder/buttons */ }
        .message-content pre code.hljs { display: block; overflow-x: auto; padding: 1em; background: transparent; color: var(--ink); border-radius: 5px; }
        .hljs-comment, .hljs-quote { color: #7a7061; font-style: italic; }
        .hljs-keyword, .hljs-selector-tag, .hljs-subst { color: var(--crimson); font-weight: bold; }
        .hljs-number, .hljs-literal, .hljs-variable, .hljs-template-variable, .hljs-tag .hljs-attr { color: var(--sapphire); }
        .hljs-string, .hljs-doctag { color: #4b8350; }
        .hljs-title, .hljs-section, .hljs-selector-id { color: var(--gold); font-weight: bold; }
        .message-content code:not(.hljs) { background-color: var(--code-bg); border: 1px solid var(--code-border); padding: 0.2em 0.4em; border-radius: 3px; font-size: 85%; font-family: Consolas, Monaco, monospace; }

        /* --- Cat Placeholder & Action Buttons --- */
        .cat-placeholder { display: none; /* Hidden by default */ font-size: 1.2em; cursor: default; user-select: none; padding: 2px 5px; background-color: var(--parchment-dark); border-radius: 3px; border: 1px solid var(--ink-light); margin-right: 5px; /* Adjust positioning as needed */ margin-bottom: 3px; /* Space below cat */ }
        .message-actions { /* Container for copy/download buttons */ margin-top: 8px; text-align: left; display: flex; gap: 5px; flex-wrap: wrap; /* Allow buttons to wrap */ }
        .action-button { background-color: var(--ink-light); color: var(--parchment); border: none; padding: 4px 8px; font-size: 0.8em; border-radius: 4px; cursor: pointer; opacity: 0.9; transition: opacity 0.2s ease, background-color 0.2s ease; font-family: Georgia, serif; }
        .action-button:hover { opacity: 1; background-color: var(--ink); }
        .copy-code-button.copied { background-color: #3a9a41; color: white; }
        .download-code-button { background-color: #17a2b8; }
        .download-code-button:hover { background-color: #138496; }

        /* --- Hide Code & Download Mode CSS --- */
        .tome.code-hidden .message pre { display: none; }
        .tome.code-hidden .message .cat-placeholder { display: inline-block; } /* Show cat when code hidden */
        .download-code-button { display: none; } /* Hide download by default */
        .tome.download-code-active .download-code-button { display: inline-block; } /* Show download in active mode */

        /* --- Animation --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            body { font-size: 1rem; }
            .pages { padding: 15px; }
            .message { max-width: 95%; } /* Allow messages to take more width */
            .message-content { padding: 10px 15px; }
            .writing-area { padding: 10px; flex-direction: column; align-items: stretch; }
            .message-input { flex-basis: 100%; margin-right: 0; }
            .writing-controls { width: 100%; justify-content: space-between; margin-left: 0; margin-top: 8px; flex-wrap: wrap; } /* Allow controls to wrap */
            .footer-button { font-size: 0.8em; padding: 6px 8px; height: 40px; margin-bottom: 5px; /* Add space when wrapping */ }
            .response-count-input { height: 40px; margin-bottom: 5px; }
            .send-button { height: 45px; padding: 0 15px; font-size: 1rem; flex-grow: 1; margin-top: 5px;}
            .avatar { width: 40px; height: 40px; }
            .modal-content { padding: 15px; }
            .modal-content .line-inputs { flex-direction: column; align-items: stretch; gap: 10px; }
            .modal-content .line-inputs input[type="number"] { width: 100%; }
            .modal-content .form-group { flex-direction: column; align-items: flex-start; } /* Stack modal form groups */
        }
        .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }
    </style>
</head>
<body>
    <!-- Arcane Tome Structure with Vibe Coder ID -->
    <div class="tome" id="chat-container">
        <div class="pages" id="pages">
            <!-- Messages will appear here -->
        </div>

        <div class="writing-area">
            <textarea class="message-input" id="message-input" placeholder="Inscribe thy query..." rows="1"></textarea>
            <div class="writing-controls">
                 <button id="settings-button" class="footer-button" title="Settings">
                    <i class="fas fa-cog"></i>
                 </button>
                 <button id="add-iterator-button" class="footer-button" title="Insert {i}">Add {i}</button>
                 <button id="clear-chat-button" class="footer-button" title="Clear Scroll">Clear</button>
                 <button id="edit-code-button" class="footer-button" title="Edit Snippet">Edit</button>
                 <input type="number" class="response-count-input" value="1" min="0" max="5" title="Responses">
                 <button class="send-button" id="send-button" title="Send Query">
                     <span>Send</span>
                     <span>✒</span>
                 </button>
            </div>
        </div>
    </div>

     <!-- Settings/System Prompt Modal -->
    <div class="modal-overlay" id="system-prompt-modal">
         <div class="modal-content">
             <h3>Tome Settings</h3>
              <div class="form-group">
                 <label for="api-key-input">Spirit Essence (API Key):</label>
                 <input type="password" id="api-key-input" placeholder="Seer's Key...">
             </div>
             <div class="form-group">
                 <label for="system-prompt-input">Spirit's Nature (System Prompt):</label>
                 <textarea id="system-prompt-input" placeholder="Define the spirit's core nature..."></textarea>
             </div>
              <div class="form-group"> <!-- Checkboxes -->
                 <div style="display: flex; align-items: center; gap: 8px; margin-right: 20px;"> <!-- Group 1 -->
                     <input type="checkbox" id="hide-code-checkbox">
                     <label for="hide-code-checkbox">Veil Glyphs</label>
                 </div>
                 <div style="display: flex; align-items: center; gap: 8px;"> <!-- Group 2 -->
                     <input type="checkbox" id="download-code-checkbox">
                     <label for="download-code-checkbox">Enable Download</label>
                 </div>
             </div>
             <div class="modal-buttons">
                <button id="cancel-settings" class="cancel-button">Cancel</button>
                <button id="save-settings-button">Seal Settings</button>
             </div>
         </div>
    </div>

    <!-- Code Edit Modal -->
    <div class="modal-overlay" id="code-edit-modal">
        <div class="modal-content">
            <h3>Transcribe & Alter Glyphs</h3>
            <p style="font-size: 0.9em; color: var(--ink-light); margin-bottom: 10px; flex-shrink: 0;">Inscribe the glyphs below. Select lines for alteration.</p>
            <textarea id="edit-snippet-textarea" placeholder="Place glyphs here..."></textarea>
            <div class="line-inputs" style="flex-shrink: 0;">
                 <div> <label for="edit-start-line">Start Line:</label> <input type="number" id="edit-start-line" min="1" value="1"> </div>
                 <div> <label for="edit-end-line">End Line:</label> <input type="number" id="edit-end-line" min="1" value="1"> </div>
                 <div id="edit-snippet-counter" style="margin-left: auto;"> Lines: <span id="edit-snippet-line-count">0</span> </div>
            </div>
            <div class="form-group" style="flex-shrink: 0;">
                <label for="edit-instructions">Instructions for Spirit (applies to selected lines):</label>
                <textarea id="edit-instructions" rows="3" placeholder="e.g., Reforge these lines, mend the flaw..."></textarea>
            </div>
            <div class="modal-buttons" style="flex-shrink: 0;">
                <button id="cancel-edit-request" class="cancel-button">Cancel</button>
                <button id="send-edit-request">Request Alteration</button>
            </div>
        </div>
    </div>

    <!-- Hidden Helpers -->
    <textarea class="visually-hidden" id="copy-helper" aria-hidden="true"></textarea>
    <input type="file" class="pfp-upload" accept="image/*" style="display:none;">

    <script>
        // --- Global State & Constants ---
        let conversationHistory = [];
        let userPfp = localStorage.getItem('userPfp') || 'https://ui-avatars.com/api/?name=U&background=1e3a8a&color=fff&font-size=0.6&bold=true';
        let botPfp = localStorage.getItem('botPfp') || 'https://ui-avatars.com/api/?name=S&background=6b21a8&color=fff&font-size=0.6&bold=true';
        let currentPfpElementToUpdate = null;
        let turnCounter = 0;
        const iterationPlaceholder = '{i}';
        const DEFAULT_SYSTEM_PROMPT = 'You are a mystical spirit from another realm, bound within this ancient tome. Speak in an ancient, poetic manner full of mystery and wonder. Keep responses concise where possible.';
        const API_URL = 'https://api.deepseek.com/v1/chat/completions';
        let apiKey = localStorage.getItem('apiKey') || '';
        let hideCodeBlocks = localStorage.getItem('hideCodeBlocks') === 'true';
        let downloadCodeMode = localStorage.getItem('downloadCodeMode') === 'true';
        let isWaitingForResponse = false;

        // --- DOM Elements (Updated Selectors) ---
        const chatContainerElement = document.getElementById('chat-container');
        const pages = document.getElementById('pages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const responseCountInput = document.querySelector('.response-count-input');
        const pfpUploadInput = document.querySelector('.pfp-upload');
        const settingsButton = document.getElementById('settings-button');
        const systemPromptModal = document.getElementById('system-prompt-modal');
        const systemPromptInput = document.getElementById('system-prompt-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveSettingsButton = document.getElementById('save-settings-button');
        const hideCodeCheckbox = document.getElementById('hide-code-checkbox');
        const downloadCodeCheckbox = document.getElementById('download-code-checkbox');
        const cancelSettingsButton = document.getElementById('cancel-settings');
        const editCodeButton = document.getElementById('edit-code-button');
        const codeEditModal = document.getElementById('code-edit-modal');
        const editSnippetTextarea = document.getElementById('edit-snippet-textarea');
        const editStartLineInput = document.getElementById('edit-start-line');
        const editEndLineInput = document.getElementById('edit-end-line');
        const editSnippetLineCount = document.getElementById('edit-snippet-line-count');
        const editInstructionsInput = document.getElementById('edit-instructions');
        const sendEditRequestButton = document.getElementById('send-edit-request');
        const cancelEditRequestButton = document.getElementById('cancel-edit-request');
        const clearChatButton = document.getElementById('clear-chat-button');
        const addIteratorButton = document.getElementById('add-iterator-button');
        const copyHelper = document.getElementById('copy-helper');

        // --- Configure Markdown & Highlighting ---
        marked.setOptions({ highlight:function(c,l){const lang=hljs.getLanguage(l)?l:'plaintext';try{return hljs.highlight(c,{language:lang,ignoreIllegals:true}).value;}catch(e){return hljs.highlight(c,{language:'plaintext',ignoreIllegals:true}).value;}},langPrefix:'hljs language-',gfm:true,breaks:true });

        // --- PFP Handling ---
        pfpUploadInput.addEventListener('change', function(event) { const f=event.target.files[0];if(!f||!currentPfpElementToUpdate)return;const r=new FileReader();r.onload=function(e){const u=e.target.result;currentPfpElementToUpdate.src=u;const t=currentPfpElementToUpdate.closest('.avatar').dataset.senderType; if(t==='user'){userPfp=u;localStorage.setItem('userPfp',u);document.querySelectorAll('.avatar.user-avatar img').forEach(i=>i.src=u);}else if(t==='spirit'){botPfp=u;localStorage.setItem('botPfp',u);document.querySelectorAll('.avatar.spirit-avatar img').forEach(i=>i.src=u);}currentPfpElementToUpdate=null;};r.readAsDataURL(f); });

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
        messageInput.addEventListener('input', autoGrowTextarea);
        editCodeButton.addEventListener('click', openEditCodeModal);
        sendEditRequestButton.addEventListener('click', handleSendEditRequest);
        cancelEditRequestButton.addEventListener('click', () => codeEditModal.style.display = 'none');
        codeEditModal.addEventListener('click', (e) => { if (e.target === codeEditModal) { codeEditModal.style.display = 'none'; } });
        settingsButton.addEventListener('click', openSystemPromptModal);
        saveSettingsButton.addEventListener('click', saveSettings);
        if (cancelSettingsButton) cancelSettingsButton.addEventListener('click', () => systemPromptModal.style.display = 'none');
        systemPromptModal.addEventListener('click', (e) => { if (e.target === systemPromptModal) { systemPromptModal.style.display = 'none'; } });
        clearChatButton.addEventListener('click', handleClearChat);
        addIteratorButton.addEventListener('click', insertIteratorPlaceholder);
        editSnippetTextarea.addEventListener('input', updateSnippetLineCount);
        hideCodeCheckbox.addEventListener('change', handleHideCodeToggle);
        downloadCodeCheckbox.addEventListener('change', handleDownloadCodeToggle);


        // --- Core Functions ---
        function isApiKeySet() { if(!apiKey){alert("Spirit Essence Key needed! Use Settings (gear icon).");return false;}return true; }
        async function handleSendMessage() { if(!isApiKeySet())return;const ui=messageInput.value.trim();const rc=parseInt(responseCountInput.value,10);if(ui===''||isWaitingForResponse)return;const sc=isNaN(rc)||rc<0?0:rc;const tid=`turn-${turnCounter++}`;const cp=ui.includes(iterationPlaceholder);isWaitingForResponse=true;sendButton.disabled=true;messageInput.value='';autoGrowTextarea();const ue={role:'user',content:ui,turnId:tid};conversationHistory.push(ue);displayMessage(ue,'user');saveHistoryToLocalStorage();if(sc>0){showTypingIndicator();const bh=prepareHistoryForApi(conversationHistory);const rs=[];let err=false;for(let i=0;i<sc;i++){const iter=i+1;let hc=[...bh];if(cp&&sc>1){const ix=hc.length-1;if(hc[ix]?.role==='user'){const sub=hc[ix].content.replace(new RegExp(iterationPlaceholder.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&'),'g'),iter.toString());hc[ix]={...hc[ix],content:sub};}}if(i>0&&rs.length>0){rs.forEach(r=>hc.push({role:'assistant',content:r}));}try{const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},body:JSON.stringify({model:'deepseek-chat',messages:hc,stream:false,temperature:0.7,top_p:0.9})});if(!res.ok){const e=await res.text();throw new Error(`API ${res.status}: ${e}`);}const d=await res.json();if(!d.choices?.[0]?.message?.content){throw new Error('Spirit bad resp.');}rs.push(d.choices[0].message.content.trim()||"[Silence]");}catch(e){console.error(`Fetch ${iter} Err:`,e);rs.push(`[Disturbance: ${e.message}]`);err=true;}}hideTypingIndicator();if(rs.length>0){const be={role:'assistant',variants:rs,selectedIndex:0,turnId:tid};conversationHistory.push(be);saveHistoryToLocalStorage();displayBotMessage(be,'spirit');}else if(!err){displayMessage({role:'system',content:'The spirit is silent.'},'spirit');}}else{console.log("Skip query.");}isWaitingForResponse=false;sendButton.disabled=false;messageInput.focus();scrollToBottom(); }
        function updateSnippetLineCount() { const t=editSnippetTextarea.value;const c=t===''?0:t.split('\n').length;editSnippetLineCount.textContent=c;editStartLineInput.max=c>0?c:1;editEndLineInput.max=c>0?c:1;if(parseInt(editEndLineInput.value,10)>c)editEndLineInput.value=c;if(parseInt(editStartLineInput.value,10)>c)editStartLineInput.value=c>0?c:1; }
        function openEditCodeModal() { editSnippetTextarea.value='';editInstructionsInput.value='';editStartLineInput.value=1;editEndLineInput.value=1;updateSnippetLineCount();codeEditModal.style.display='flex';editSnippetTextarea.focus(); }
        async function handleSendEditRequest() { if(!isApiKeySet())return;const pc=editSnippetTextarea.value;const sl=parseInt(editStartLineInput.value,10);const el=parseInt(editEndLineInput.value,10);const ins=editInstructionsInput.value.trim();if(pc.trim()===''){alert("Inscribe glyphs.");return;}if(!ins){alert("Needs instructions.");return;}const pLines=pc.split('\n');const tl=pLines.length;if(isNaN(sl)||isNaN(el)||sl<1||el<sl||el>tl){alert(`Invalid runes (${sl}-${el}). Use 1-${tl}, Start <= End.`);return;}codeEditModal.style.display='none';const tid=`turn-${turnCounter++}`;const si=sl-1;const ei=el;const sAI=pLines.slice(si,ei).join('\n');const ur=`[Glyph Alteration Request]\nInstructions (lines ${sl}-${el}): ${ins}`;const ue={role:'user',content:ur,turnId:tid};conversationHistory.push(ue);displayMessage(ue,'user');saveHistoryToLocalStorage();showTypingIndicator();const prompt=`Alter glyph snippet.\n\nSNIPPET (Lines ${sl}-${el}):\n\`\`\`\n${sAI}\n\`\`\`\n\nINSTRUCTIONS:\n${ins}\n\nReturn ONLY altered snippet for lines ${sl}-${el}.`;const hu=conversationHistory.slice(0,-1);let hAPI=prepareHistoryForApi(hu);hAPI.push({role:'user',content:prompt});let edLines=[];let err=false;try{const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},body:JSON.stringify({model:'deepseek-chat',messages:hAPI,stream:false,temperature:0.4,top_p:0.9})});if(!res.ok){const e=await res.text();throw new Error(`API Err ${res.status}: ${e}`);}const d=await res.json();if(!d.choices?.[0]?.message?.content){throw new Error('Spirit empty resp.');}let raw=d.choices[0].message.content.trim();raw=raw.replace(/^```(?:\w*\n)?/,'').replace(/\n?```$/,'').trim();edLines=raw.split('\n');}catch(e){console.error("Alter Err:",e);edLines=[`[Disturbance: ${e.message}]`];err=true;}hideTypingIndicator();let recon;try{const nf=[...pLines.slice(0,si),...edLines,...pLines.slice(ei)];recon=nf.join('\n');}catch(recErr){recon=pc+"\n\n--- ALTERATION FAILED ---";err=true;}const be={role:'assistant',variants:[recon],selectedIndex:0,turnId:tid,isCodeEdit:true};conversationHistory.push(be);saveHistoryToLocalStorage();displayBotMessage(be,'spirit');scrollToBottom(); }
        function openSystemPromptModal() { systemPromptInput.value=conversationHistory[0]?.content||DEFAULT_SYSTEM_PROMPT;apiKeyInput.value=apiKey;hideCodeCheckbox.checked=hideCodeBlocks;downloadCodeCheckbox.checked=downloadCodeMode;systemPromptModal.style.display='flex'; }
        function saveSettings() { const sp=systemPromptInput.value.trim()||DEFAULT_SYSTEM_PROMPT;if(conversationHistory.length===0||conversationHistory[0]?.role!=='system'){conversationHistory.unshift({role:'system',content:sp});}else{conversationHistory[0].content=sp;}localStorage.setItem('systemPrompt',sp);const ak=apiKeyInput.value.trim();apiKey=ak;localStorage.setItem('apiKey',ak);console.log("Settings saved.");saveHistoryToLocalStorage();systemPromptModal.style.display='none'; }
        function handleHideCodeToggle() { hideCodeBlocks=hideCodeCheckbox.checked;localStorage.setItem('hideCodeBlocks',hideCodeBlocks);chatContainerElement.classList.toggle('code-hidden',hideCodeBlocks); }
        function handleDownloadCodeToggle() { downloadCodeMode=downloadCodeCheckbox.checked;localStorage.setItem('downloadCodeMode',downloadCodeMode);chatContainerElement.classList.toggle('download-code-active',downloadCodeMode); }
        function handleClearChat() { if(confirm("Disperse echoes?")){const sp=conversationHistory[0]?.content||localStorage.getItem('systemPrompt')||DEFAULT_SYSTEM_PROMPT;conversationHistory=[{role:'system',content:sp}];turnCounter=1;saveHistoryToLocalStorage();rebuildChatFromHistory();} }
        function insertIteratorPlaceholder() { const i=messageInput;const s=i.selectionStart;const e=i.selectionEnd;const v=i.value;const nv=v.substring(0,s)+iterationPlaceholder+v.substring(e);i.value=nv;const np=s+iterationPlaceholder.length;i.selectionStart=np;i.selectionEnd=np;i.focus(); }
        function autoGrowTextarea() { const i=messageInput;const mH=i.style.maxHeight||'150px';i.style.maxHeight='none';i.style.height='auto';const sH=i.scrollHeight;i.style.height=sH+'px';i.style.maxHeight=mH;i.style.overflowY=parseFloat(i.style.height)>parseFloat(mH)?'auto':'hidden'; }

        // --- Display Logic (Adapted & CORRECTED) ---
        function createPfpElement(sender, pfpUrl) { const d=document.createElement('div');d.className=`avatar ${sender}-avatar`;d.dataset.senderType=sender;const i=document.createElement('img');i.src=pfpUrl;i.alt=`${sender} avatar`;d.addEventListener('click',()=>{currentPfpElementToUpdate=i;pfpUploadInput.click();});d.appendChild(i);return d; }
        function displayBotMessage(entry, sender='spirit') { if(entry.variants?.length>1)displayMultipleMessages(entry,sender);else if(entry.variants?.length>=1)displayMessage(entry,sender);else console.warn("Bad bot struct:",entry); }

        // --- CORRECTED displayMessage Function ---
        function displayMessage(entry, sender) {
            const c = sender === 'user' ? entry.content : (entry.variants?.[entry.selectedIndex ?? 0] || '[Silence]');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message message-${sender}`; // Assigns message-user or message-spirit here
            if (entry.turnId) msgDiv.dataset.turnId = entry.turnId;

            const p = sender === 'user' ? userPfp : botPfp;
            const avatarEl = createPfpElement(sender, p);

            const wrapper = document.createElement('div');
            wrapper.classList.add('message-content-wrapper');

            const contentDiv = document.createElement('div');
            // --- FIX: Assign ONLY message-content class ---
            contentDiv.className = 'message-content';
            // --- END FIX ---

            if (sender === 'spirit') {
                try {
                    contentDiv.innerHTML = marked.parse(c);
                } catch (e) {
                    contentDiv.textContent = c;
                }
            } else {
                contentDiv.textContent = c;
                contentDiv.style.whiteSpace = 'pre-wrap';
            }

            wrapper.appendChild(contentDiv);

            // Add action buttons for spirit messages (code blocks)
            if (sender === 'spirit') {
                const cbs = contentDiv.querySelectorAll('pre');
                if (cbs.length > 0) {
                    let acts = wrapper.querySelector('.message-actions');
                    if (!acts) {
                        acts = document.createElement('div');
                        acts.classList.add('message-actions');
                        // Append actions *after* content, but *before* nav (if exists)
                        const nav = wrapper.querySelector('.response-navigation');
                        if (nav) {
                            wrapper.insertBefore(acts, nav);
                        } else {
                             wrapper.appendChild(acts);
                        }
                    }
                    cbs.forEach((pre, idx) => {
                        const pId = `pre-${entry.turnId || 'gen'}-${idx}`;
                        pre.id = pId;

                        // Add cat placeholder
                        const cat = document.createElement('span');
                        cat.classList.add('cat-placeholder');
                        cat.textContent = '🐱';
                        cat.dataset.preId = pId; // Link placeholder to pre
                        pre.parentNode.insertBefore(cat, pre); // Insert cat before pre

                        const cd = pre.querySelector('code');
                        const ct = cd ? cd.textContent : '';
                        const lang = cd?.className.match(/language-(\w+)/)?.[1] || 'txt';
                        const fn = `scroll_${Date.now()}.${lang}`;

                        // Add Copy Button
                        const cpBtn = document.createElement('button');
                        cpBtn.textContent = 'Copy';
                        cpBtn.classList.add('copy-code-button', 'action-button');
                        cpBtn.onclick = () => copyCodeFromPre(pId, cpBtn);
                        acts.appendChild(cpBtn);

                        // Add Download Button (conditionally displayed via CSS)
                        const dlBtn = document.createElement('button');
                        dlBtn.textContent = 'Download';
                        dlBtn.classList.add('download-code-button', 'action-button');
                        dlBtn.onclick = () => downloadCode(ct, fn);
                        acts.appendChild(dlBtn);
                    });
                }
            }

            if (sender === 'user') {
                msgDiv.appendChild(wrapper); // Content first
                msgDiv.appendChild(avatarEl); // Then avatar
            } else {
                msgDiv.appendChild(avatarEl);   // Avatar first
                msgDiv.appendChild(wrapper); // Then content
            }

            pages.appendChild(msgDiv);
            return msgDiv;
        }

        // --- CORRECTED displayMultipleMessages Function ---
        function displayMultipleMessages(entry, sender = 'spirit') {
            const tid = entry.turnId;
            const vars = entry.variants;
            let idx = entry.selectedIndex;

            const msgDiv = document.createElement('div');
            msgDiv.className = `message message-${sender}`; // Assigns message-user or message-spirit here
            if (tid) msgDiv.dataset.turnId = tid;

            const p = sender === 'user' ? userPfp : botPfp;
            const avatarEl = createPfpElement(sender, p);

            const wrapper = document.createElement('div');
            wrapper.classList.add('message-content-wrapper');

            const contentDiv = document.createElement('div');
             // --- FIX: Assign ONLY message-content class ---
            contentDiv.className = 'message-content';
            // --- END FIX ---

            const nav = document.createElement('div');
            nav.classList.add('response-navigation');
            const prev = document.createElement('button'); prev.textContent = '<';
            const span = document.createElement('span');
            const next = document.createElement('button'); next.textContent = '>';
            nav.appendChild(prev); nav.appendChild(span); nav.appendChild(next);

            wrapper.appendChild(contentDiv); // Add content div first

            // Create actions container BEFORE navigation is added
            let acts = document.createElement('div');
            acts.classList.add('message-actions');
            wrapper.appendChild(acts); // Add actions container

            wrapper.appendChild(nav); // Add navigation last within the wrapper

            function update(ix) {
                try {
                    contentDiv.innerHTML = marked.parse(vars[ix]);
                } catch (e) {
                    contentDiv.textContent = vars[ix]; // Fallback
                }

                // Clear previous actions and potentially remove placeholders incorrectly added
                acts.innerHTML = '';
                contentDiv.querySelectorAll('.cat-placeholder').forEach(c => c.remove()); // Clean up old placeholders if any

                // Add action buttons for spirit messages (code blocks)
                const cbs = contentDiv.querySelectorAll('pre');
                if (cbs.length > 0) {
                     if (!wrapper.contains(acts)) { // Ensure actions div is still there
                        wrapper.insertBefore(acts, nav); // Re-insert if needed
                     }
                    cbs.forEach((pre, preIdx) => {
                        const pId = `pre-${tid || 'gen'}-${ix}-${preIdx}`; // Unique ID per variant/pre
                        pre.id = pId;

                        // Add cat placeholder
                        const cat = document.createElement('span');
                        cat.classList.add('cat-placeholder');
                        cat.textContent = '🐱';
                        cat.dataset.preId = pId;
                        pre.parentNode.insertBefore(cat, pre);

                        const cd = pre.querySelector('code');
                        const ct = cd ? cd.textContent : '';
                        const lang = cd?.className.match(/language-(\w+)/)?.[1] || 'txt';
                        const fn = `scroll_${Date.now()}_${ix + 1}.${lang}`; // Include variant index in filename

                        // Add Copy Button
                        const cpBtn = document.createElement('button');
                        cpBtn.textContent = 'Copy';
                        cpBtn.classList.add('copy-code-button', 'action-button');
                        cpBtn.onclick = () => copyCodeFromPre(pId, cpBtn);
                        acts.appendChild(cpBtn);

                        // Add Download Button
                        const dlBtn = document.createElement('button');
                        dlBtn.textContent = 'Download';
                        dlBtn.classList.add('download-code-button', 'action-button');
                        dlBtn.onclick = () => downloadCode(ct, fn);
                        acts.appendChild(dlBtn);
                    });
                } else {
                    if (wrapper.contains(acts)) {
                       // Optional: remove the empty actions div if there's no code
                       // wrapper.removeChild(acts);
                       // Or just leave it empty
                    }
                }


                span.textContent = `${ix + 1} / ${vars.length}`;
                prev.disabled = ix === 0;
                next.disabled = ix === vars.length - 1;

                // Re-apply fade-in animation
                contentDiv.style.animation = 'none'; // Reset animation
                void contentDiv.offsetWidth; // Trigger reflow
                contentDiv.style.animation = 'fadeIn 0.3s ease-in-out';
            }

            prev.addEventListener('click', () => {
                if (idx > 0) { idx--; update(idx); updateHistorySelection(tid, idx); }
            });
            next.addEventListener('click', () => {
                if (idx < vars.length - 1) { idx++; update(idx); updateHistorySelection(tid, idx); }
            });

            if (sender === 'user') {
                msgDiv.appendChild(wrapper); // Content first
                msgDiv.appendChild(avatarEl);   // Then avatar
            } else {
                msgDiv.appendChild(avatarEl);   // Avatar first
                msgDiv.appendChild(wrapper); // Then content
            }

            pages.appendChild(msgDiv);
            update(idx); // Initial display
            return msgDiv;
        }

        function copyCodeFromPre(preId, btn) { const p=document.getElementById(preId);const c=p?p.querySelector('code'):null;if(!c){if(btn)btn.textContent='Err!';return;}const t=c.textContent||'';copyHelper.value=t;copyHelper.select();copyHelper.setSelectionRange(0,99999);let ok=false;try{ok=document.execCommand('copy');}catch(e){ok=false;}window.getSelection().removeAllRanges();if(btn){if(ok){btn.textContent='Copied!';btn.classList.add('copied');setTimeout(()=>{btn.textContent='Copy';btn.classList.remove('copied');},1500);}else{btn.textContent='Failed!';setTimeout(()=>{btn.textContent='Copy';},2000);}} }
        function downloadCode(codeText, filename) { try{const b=new Blob([codeText],{type:'text/plain;charset=utf-8'});const u=URL.createObjectURL(b);const l=document.createElement('a');l.href=u;l.download=filename;document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(u);}catch(e){console.error("DL Err:",e);alert("Download failed.");} }
        function showTypingIndicator() { if(document.getElementById('typing-indicator'))return;const i=document.createElement('div');i.className='typing-indicator';i.id='typing-indicator';i.textContent='The spirit whispers...';pages.appendChild(i);scrollToBottom(); }
        function hideTypingIndicator() { const i=document.getElementById('typing-indicator');if(i)i.remove(); }
        function scrollToBottom() { setTimeout(()=>{pages.scrollTop=pages.scrollHeight;},50); }

        // --- History Management & Utilities ---
        function prepareHistoryForApi(hist) { return hist.map(m=>{if(m.role==='system')return{role:'system',content:m.content};if(m.role==='user')return{role:'user',content:m.content};if(m.role==='assistant'&&m.variants?.length>0)return{role:'assistant',content:m.variants[m.selectedIndex??0]};return null;}).filter(Boolean); }
        function updateHistorySelection(turnId, idx) { const i=conversationHistory.findIndex(m=>m.turnId===turnId&&m.role==='assistant');if(i>-1){conversationHistory[i].selectedIndex=idx;saveHistoryToLocalStorage();} }
        function saveHistoryToLocalStorage() { try{localStorage.setItem('conversationHistory',JSON.stringify(conversationHistory));}catch(e){console.error("Save Err:",e);} }
        function loadHistoryFromLocalStorage() { try{const s=localStorage.getItem('conversationHistory');if(!s)throw new Error('No hist');const p=JSON.parse(s);if(!Array.isArray(p)||p.length===0||p[0]?.role!=='system')throw new Error('Bad fmt');conversationHistory=p.map(m=>{if(m.role==='assistant'&&!Array.isArray(m.variants))return{...m,variants:[m.content||""],selectedIndex:0};if(m.role==='assistant'&&m.variants){if(m.selectedIndex<0||m.selectedIndex>=m.variants.length)m.selectedIndex=0;}return m;});console.log("Loaded history");const l=conversationHistory.filter(m=>m.turnId).pop();if(l?.turnId?.startsWith('turn-')){const n=parseInt(l.turnId.split('-')[1],10);turnCounter=isNaN(n)?1:n+1;}else{turnCounter=1;}return true;}catch(e){console.warn("Load Err:",e);}conversationHistory=[{role:'system',content:localStorage.getItem('systemPrompt')||DEFAULT_SYSTEM_PROMPT}];turnCounter=1;return false; }
        function rebuildChatFromHistory() { pages.innerHTML='';for(let i=1;i<conversationHistory.length;i++){const e=conversationHistory[i];if(e.role==='user')displayMessage(e,'user');else if(e.role==='assistant')displayBotMessage(e,'spirit');} }

        // --- Initial Load ---
        function displayInitialGreeting() { const g="The ancient tome awaits your words...";const e={role:'assistant',variants:[g],selectedIndex:0,turnId:'turn-0'};conversationHistory.push(e);displayBotMessage(e,'spirit');saveHistoryToLocalStorage();turnCounter=1; }
        function initialLoad() { loadHistoryFromLocalStorage(); apiKey=localStorage.getItem('apiKey')||''; hideCodeBlocks=localStorage.getItem('hideCodeBlocks')==='true'; downloadCodeMode=localStorage.getItem('downloadCodeMode')==='true'; chatContainerElement.classList.toggle('code-hidden',hideCodeBlocks); chatContainerElement.classList.toggle('download-code-active',downloadCodeMode); rebuildChatFromHistory(); if(conversationHistory.length<=1){displayInitialGreeting();} scrollToBottom(); }

        initialLoad(); // Start

    </script>
</body>
</html>
