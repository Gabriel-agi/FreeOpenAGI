<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Tome (Vibe Coder Enhanced)</title>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Georgia&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- Arcane Tome Base Styles --- */
        :root {
            --parchment: #f5e7d0;
            --parchment-dark: #e3d5b8;
            --ink: #3a3129;
            --ink-light: #5a4e42;
            --gold: #c9a227;
            --crimson: #8b0000;
            --sapphire: #1e3a8a; /* User message background */
            --amethyst: #6b21a8; /* Spirit avatar temp background */
            --emerald: #21a853; /* Run HTML button suggestion */
            --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.15);
            --code-bg: #e8e0cf;
            --code-border: #d1c3a9;
        }

        html, body { height: 100%; margin: 0; padding: 0; }
        * { box-sizing: border-box; }

        body {
            font-family: Georgia, 'Times New Roman', Times, serif;
            font-size: 1.1rem; line-height: 1.6;
            background-color: var(--parchment); color: var(--ink);
            width: 100vw; overflow: hidden; /* Prevent body scroll */
        }

        .tome { /* Main container */
            width: 100%; height: 100%; display: flex; flex-direction: column; position: relative;
            background-color: var(--parchment);
        }

        .pages { /* Message area */
            flex: 1; min-height: 0; padding: 20px; overflow-y: auto;
            scrollbar-width: none; display: flex; flex-direction: column; gap: 15px;
            border-bottom: 2px solid var(--ink-light);
        }
        .pages::-webkit-scrollbar { display: none; }

        /* --- Message Styling --- */
        .message { display: flex; gap: 10px; max-width: 85%; animation: fadeIn 0.5s ease-in-out;}
        .message-user { align-self: flex-end; flex-direction: row-reverse; }
        .message-spirit { align-self: flex-start; }

        .avatar {
            width: 45px; height: 45px; border-radius: 50%; flex-shrink: 0;
            border: 2px solid var(--parchment-dark); box-shadow: var(--shadow-light);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            background-color: var(--parchment-dark); cursor: pointer;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-avatar { background-color: var(--sapphire); }
        .spirit-avatar { background-color: var(--amethyst); }

        .message-content-wrapper { display: flex; flex-direction: column; max-width: 100%; }

        .message-content { /* Bubble */
            padding: 12px 18px; border-radius: 8px; line-height: 1.5;
            word-break: break-word; box-shadow: var(--shadow-light);
            max-width: fit-content; /* Allow bubble to size to content */
        }
        .message-user .message-content {
            background-color: var(--sapphire);
            color: white;
            border-top-right-radius: 0;
        }
        .message-spirit .message-content {
            background-color: white;
            color: var(--ink);
            border: 1px solid var(--ink-light);
            border-top-left-radius: 0;
        }
        .message-content p { margin: 0 0 0.5em 0; } .message-content p:last-child { margin-bottom: 0; }

        .typing-indicator {
            align-self: flex-start; color: var(--ink-light); font-style: italic;
            padding: 10px 15px; background-color: rgba(227, 213, 184, 0.5);
            border-radius: 8px; font-size: 1rem;
        }

        /* --- Writing Area (Footer) Styling --- */
        .writing-area {
            padding: 12px; background-color: var(--parchment-dark);
            display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end;
            flex-shrink: 0;
        }
        .message-input {
            flex: 1 1 250px; padding: 10px; background-color: var(--parchment);
            border: 2px solid var(--ink-light); border-radius: 5px; font-family: inherit;
            font-size: 1.1rem; resize: none; outline: none; color: var(--ink);
            min-height: 48px; max-height: 150px; line-height: 1.5;
        }
        .message-input:focus { border-color: var(--gold); }

        .writing-controls { display: flex; align-items: flex-end; gap: 8px; flex-wrap: nowrap; margin-left: auto; }
        .footer-button { background-color: var(--ink-light); color: var(--parchment); border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease; padding: 8px 10px; font-size: 0.9em; flex-shrink: 0; white-space: nowrap; height: 48px; font-family: Georgia, serif; display:flex; align-items:center; justify-content:center; }
        .footer-button:hover { background-color: var(--ink); }
        #settings-button { background-color: var(--gold); color: var(--ink); font-size: 1.2em; padding: 0 12px; }
        #settings-button:hover { background-color: var(--crimson); color: white; }
        #clear-chat-button { background-color: var(--crimson); color: white;}
        #clear-chat-button:hover { background-color: darkred; }
        #upload-file-button { font-size: 1.1em; padding: 0 12px; }
        .response-count-input { /* Shared style for number inputs */
            width: 45px; padding: 10px; border: 2px solid var(--ink-light); border-radius: 5px;
            text-align: center; flex-shrink: 0; height: 48px; font-size: 1rem;
            background-color: var(--parchment); color: var(--ink);
         }
        .send-button { background-color: var(--gold); color: var(--ink); border: none; border-radius: 5px; padding: 0 18px; height: 48px; font-family: 'Cinzel Decorative', cursive; font-weight: bold; cursor: pointer; box-shadow: var(--shadow-light); display: flex; align-items: center; gap: 8px; font-size: 1.1rem; transition: background-color 0.2s ease; flex-shrink: 0; }
        .send-button:hover:not(:disabled) { background-color: var(--crimson); color: white; }
        .send-button:disabled { opacity: 0.7; cursor: not-allowed; background-color: var(--ink-light); color: var(--parchment); }

        /* --- Multi-Response Navigation --- */
        .response-navigation { display: flex; align-items: center; justify-content: flex-start; margin-top: 5px; gap: 5px; width: fit-content; }
        .response-navigation button { background-color: var(--parchment-dark); border: 1px solid var(--ink-light); color: var(--ink); border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 0.9em; line-height: 1; }
        .response-navigation button:disabled { opacity: 0.5; cursor: not-allowed; background-color: #ccc; }
        .response-navigation span { font-size: 0.8em; color: var(--ink-light); margin: 0 5px; user-select: none; }

        /* --- Modals (Themed) --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(58, 49, 41, 0.7); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content {
             background-color: var(--parchment); border: 3px solid var(--gold); color: var(--ink);
             padding: 25px; border-radius: 8px; width: 90%; max-width: 650px;
             box-shadow: 0 5px 20px rgba(0,0,0,0.4);
             max-height: 90vh; /* Limit height */
             display: flex; flex-direction: column;
             overflow-y: auto; /* Enable scrolling for the modal content itself */
        }
        .modal-content h3 { font-family: 'Cinzel Decorative', cursive; margin-top: 0; text-align: center; color: var(--ink); border-bottom: 1px solid var(--gold); padding-bottom: 10px; margin-bottom: 20px; flex-shrink: 0; } /* Header shouldn't scroll */
        .modal-content .form-group { margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 8px 15px; flex-shrink: 0; } /* Form groups shouldn't scroll initially */
        .modal-content label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--ink-light); flex-basis: 100%; }
        .modal-content input[type="checkbox"] { cursor: pointer; margin-right: 5px; flex-shrink: 0; }
        .modal-content label[for*="checkbox"] { flex-basis: auto; margin-bottom: 0; font-weight: normal; }
        .modal-content input[type="password"], .modal-content textarea, .modal-content input[type="number"] { width: 100%; padding: 10px; border: 1px solid var(--ink-light); border-radius: 4px; outline: none; box-sizing: border-box; background-color: white; color: var(--ink); font-family: Georgia, serif; font-size: 1rem; }
        .modal-content textarea { resize: vertical; min-height: 80px; }
        .modal-content .modal-buttons { margin-top: 20px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; /* Buttons stick to bottom */ }
        .modal-content button { background-color: var(--gold); color: var(--ink); border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease; font-family: 'Cinzel Decorative', cursive; font-weight: bold; }
        .modal-content button:hover { background-color: var(--crimson); color: white; }
        .modal-content button.cancel-button { background-color: var(--ink-light); color: var(--parchment); }
        .modal-content button.cancel-button:hover { background-color: var(--ink); }

        /* --- Code Edit Modal Specifics --- */
        #edit-snippet-textarea {
            font-family: Consolas, Monaco, monospace;
            min-height: 150px; /* Suggest a minimum size */
            max-height: 40vh; /* Limit growth relative to viewport */
            flex-grow: 1; /* Allow it to take up space */
            flex-shrink: 1; /* Allow it to shrink if needed */
            overflow-y: auto; /* Scroll within textarea if content exceeds max-height */
            margin-bottom: 5px;
        }
        .modal-content .line-inputs { display: flex; gap: 15px; align-items: center; margin-bottom: 10px; flex-shrink: 0; flex-wrap: wrap; }
        .modal-content .line-inputs div { flex-grow: 1; min-width: 80px; }
        .modal-content .line-inputs input[type="number"] { width: 100%; padding: 8px; }
        #edit-snippet-counter { font-size: 0.9em; color: var(--ink-light); text-align: right; margin-bottom: 15px; flex-shrink: 0; flex-basis: 100%; }
        #edit-snippet-line-count { font-weight: bold; color: var(--ink); }
        .edit-context-note {
            font-style: italic; color: var(--ink-light); font-size: 0.85em;
            margin-bottom: 15px; flex-shrink: 0;
            border-top: 1px dashed var(--ink-light); padding-top: 10px; margin-top: 5px; /* Adjusted margin */
         }
        /* Edit Instructions Area */
        .edit-instructions-area { flex-shrink: 0; margin-bottom: 15px; }
        .edit-instructions-controls { display: flex; gap: 8px; align-items: center; margin-top: 5px; }
        #edit-instructions { /* Ensure textarea doesn't cause overflow */
            width: 100%;
            min-height: 60px;
            max-height: 25vh; /* Limit growth */
            resize: vertical;
         }
         /* Smaller button specific to modal */
        .modal-content .small-button {
             padding: 4px 8px; font-size: 0.8em; height: auto; /* Override footer button height */
             background-color: var(--ink-light); color: var(--parchment); border: none;
             border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;
             font-family: Georgia, serif; flex-shrink: 0;
         }
        .modal-content .small-button:hover { background-color: var(--ink); }
        /* Response count input specific style for modal */
        #edit-response-count {
             width: 40px; padding: 6px; font-size: 0.9rem; height: auto; /* Override default height */
             border: 1px solid var(--ink-light);
             margin-left: auto; /* Push to the right */
        }

        /* --- Code Formatting & Markdown --- */
        .message-content pre { border: 1px solid var(--code-border); background-color: var(--code-bg); position: relative; margin-top: 10px; margin-bottom: 5px; }
        .message-content pre code.hljs { display: block; overflow-x: auto; padding: 1em; background: transparent; color: var(--ink); border-radius: 5px; }
        .hljs-comment, .hljs-quote { color: #7a7061; font-style: italic; }
        .hljs-keyword, .hljs-selector-tag, .hljs-subst { color: var(--crimson); font-weight: bold; }
        .hljs-number, .hljs-literal, .hljs-variable, .hljs-template-variable, .hljs-tag .hljs-attr { color: var(--sapphire); }
        .hljs-string, .hljs-doctag { color: #4b8350; }
        .hljs-title, .hljs-section, .hljs-selector-id { color: var(--gold); font-weight: bold; }
        .message-content code:not(.hljs) { background-color: var(--code-bg); border: 1px solid var(--code-border); padding: 0.2em 0.4em; border-radius: 3px; font-size: 85%; font-family: Consolas, Monaco, monospace; }

        /* --- Cat Placeholder & Action Buttons --- */
        .cat-placeholder { display: none; font-size: 1.2em; cursor: default; user-select: none; padding: 2px 5px; background-color: var(--parchment-dark); border-radius: 3px; border: 1px solid var(--ink-light); margin-right: 5px; margin-bottom: 3px; }
        .message-actions { margin-top: 8px; text-align: left; display: flex; gap: 5px; flex-wrap: wrap; }
        .action-button { background-color: var(--ink-light); color: var(--parchment); border: none; padding: 4px 8px; font-size: 0.8em; border-radius: 4px; cursor: pointer; opacity: 0.9; transition: opacity 0.2s ease, background-color 0.2s ease; font-family: Georgia, serif; }
        .action-button:hover { opacity: 1; background-color: var(--ink); }
        .copy-code-button.copied { background-color: #3a9a41; color: white; }
        .download-code-button { background-color: #17a2b8; }
        .download-code-button:hover { background-color: #138496; }
        .run-html-button { background-color: var(--emerald); }
        .run-html-button:hover { background-color: darkgreen; }

        /* --- Mode Toggles CSS --- */
        .tome.code-hidden .message pre { display: none; }
        .tome.code-hidden .message .cat-placeholder { display: inline-block; }
        .download-code-button { display: none; }
        .tome.download-code-active .download-code-button { display: inline-block; }
        .run-html-button { display: none; }
        .tome.run-html-active .run-html-button { display: inline-block; }

        /* --- Animation --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            body { font-size: 1rem; }
            .pages { padding: 15px; }
            .message { max-width: 95%; }
            .message-content { padding: 10px 15px; }
            .writing-area { padding: 10px; flex-direction: column; align-items: stretch; }
            .message-input { flex-basis: 100%; margin-right: 0; }
            .writing-controls { width: 100%; justify-content: space-between; margin-left: 0; margin-top: 8px; flex-wrap: wrap; }
            .footer-button { font-size: 0.8em; padding: 6px 8px; height: 40px; margin-bottom: 5px; }
            .response-count-input { height: 40px; margin-bottom: 5px; }
            .send-button { height: 45px; padding: 0 15px; font-size: 1rem; flex-grow: 1; margin-top: 5px;}
            .avatar { width: 40px; height: 40px; }
            .modal-content { padding: 15px; /* Reduce padding on small screens */ }
            .modal-content .line-inputs { flex-direction: column; align-items: stretch; gap: 10px; }
            .modal-content .line-inputs input[type="number"] { width: 100%; }
            .modal-content .form-group { flex-direction: column; align-items: flex-start; }
             .modal-content .form-group > div { width: auto; margin-bottom: 5px; }
             .edit-instructions-controls { flex-wrap: wrap; } /* Allow controls to wrap */
             #edit-response-count { margin-left: 0; margin-top: 5px;} /* Adjust position on wrap */
        }
        .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }
    </style>
</head>
<body>
    <!-- Arcane Tome Structure -->
    <div class="tome" id="chat-container">
        <div class="pages" id="pages">
            <!-- Messages will appear here -->
        </div>

        <div class="writing-area">
            <textarea class="message-input" id="message-input" placeholder="Inscribe thy query..." rows="1"></textarea>
            <div class="writing-controls">
                 <button id="settings-button" class="footer-button" title="Settings"> <i class="fas fa-cog"></i> </button>
                 <button id="upload-file-button" class="footer-button" title="Attach Parchment (No logic yet)"> <i class="fas fa-paperclip"></i> </button>
                 <button id="add-iterator-button" class="footer-button" title="Insert {i}">Add {i}</button>
                 <button id="clear-chat-button" class="footer-button" title="Clear Scroll">Clear</button>
                 <button id="edit-code-button" class="footer-button" title="Edit Snippet">Edit</button>
                 <input type="number" class="response-count-input" id="main-response-count" value="1" min="1" max="5" title="Responses"> <!-- Give main one an ID -->
                 <button class="send-button" id="send-button" title="Send Query"> <span>Send</span> <span>✒</span> </button>
            </div>
        </div>
    </div>

     <!-- Settings Modal -->
    <div class="modal-overlay" id="system-prompt-modal">
         <div class="modal-content">
             <h3>Tome Settings</h3>
              <div class="form-group">
                 <label for="api-key-input">Spirit Essence (API Key):</label>
                 <input type="password" id="api-key-input" placeholder="Seer's Key...">
             </div>
             <div class="form-group">
                 <label for="system-prompt-input">Spirit's Nature (System Prompt):</label>
                 <textarea id="system-prompt-input" placeholder="Define the spirit's core nature..."></textarea>
             </div>
              <div class="form-group">
                 <div style="display: flex; align-items: center;"> <input type="checkbox" id="hide-code-checkbox"> <label for="hide-code-checkbox">Veil Glyphs</label> </div>
                 <div style="display: flex; align-items: center;"> <input type="checkbox" id="download-code-checkbox"> <label for="download-code-checkbox">Enable Download</label> </div>
                 <div style="display: flex; align-items: center;"> <input type="checkbox" id="enable-run-html-checkbox"> <label for="enable-run-html-checkbox">Enable Run HTML</label> </div>
             </div>
             <div class="modal-buttons">
                <button id="cancel-settings" class="cancel-button">Cancel</button>
                <button id="save-settings-button">Seal Settings</button>
             </div>
         </div>
    </div>

    <!-- Code Edit Modal -->
    <div class="modal-overlay" id="code-edit-modal">
        <div class="modal-content"> <!-- This container will scroll -->
            <h3>Transcribe & Alter Glyphs</h3>
            <p style="font-size: 0.9em; color: var(--ink-light); margin-bottom: 10px; flex-shrink: 0;">Inscribe the glyphs below. Select lines for alteration.</p>

            <!-- Snippet Textarea (will grow and shrink) -->
            <textarea id="edit-snippet-textarea" placeholder="Place glyphs here..."></textarea>

            <!-- Context Note -->
            <p class="edit-context-note">
                 Only the selected lines are sent. Context should be included in previous messages.
            </p>

            <!-- Line Selection -->
            <div class="line-inputs">
                 <div> <label for="edit-start-line">Start Line:</label> <input type="number" id="edit-start-line" min="1" value="1"> </div>
                 <div> <label for="edit-end-line">End Line:</label> <input type="number" id="edit-end-line" min="1" value="1"> </div>
                 <div id="edit-snippet-counter" style="margin-left: auto;"> Lines: <span id="edit-snippet-line-count">0</span> </div>
            </div>

            <!-- Instructions Area -->
            <div class="edit-instructions-area">
                <label for="edit-instructions">Instructions for Spirit (applies to selected lines):</label>
                <textarea id="edit-instructions" rows="3" placeholder="e.g., Reforge these lines, mend the flaw..."></textarea>
                <div class="edit-instructions-controls">
                    <button id="edit-add-iterator-button" class="small-button" title="Insert {i}">Add {i}</button>
                    <label for="edit-response-count" style="margin-left: auto; flex-basis: auto; margin-bottom: 0; font-weight: normal; color: var(--ink-light); font-size: 0.9em;">Variations:</label>
                    <input type="number" class="response-count-input" id="edit-response-count" value="1" min="1" max="5" title="Number of edit variations">
                </div>
            </div>

            <!-- Modal Buttons -->
            <div class="modal-buttons">
                <button id="cancel-edit-request" class="cancel-button">Cancel</button>
                <button id="send-edit-request">Request Alteration</button>
            </div>
        </div>
    </div>

    <!-- Hidden Helpers -->
    <textarea class="visually-hidden" id="copy-helper" aria-hidden="true"></textarea>
    <input type="file" id="file-upload-input" accept="*/*" style="display:none;">
    <input type="file" class="pfp-upload" accept="image/*" style="display:none;">


    <script>
        // --- Global State & Constants ---
        let conversationHistory = [];
        let userPfp = localStorage.getItem('userPfp') || 'https://ui-avatars.com/api/?name=U&background=1e3a8a&color=fff&font-size=0.6&bold=true';
        let botPfp = localStorage.getItem('botPfp') || 'https://ui-avatars.com/api/?name=S&background=6b21a8&color=fff&font-size=0.6&bold=true';
        let currentPfpElementToUpdate = null;
        let turnCounter = 0;
        const iterationPlaceholder = '{i}';
        const DEFAULT_SYSTEM_PROMPT = 'You are a mystical spirit from another realm, bound within this ancient tome. Speak in an ancient, poetic manner full of mystery and wonder. Keep responses concise where possible.';
        const API_URL = 'https://api.deepseek.com/v1/chat/completions';
        let apiKey = localStorage.getItem('apiKey') || '';
        let hideCodeBlocks = localStorage.getItem('hideCodeBlocks') === 'true';
        let downloadCodeMode = localStorage.getItem('downloadCodeMode') === 'true';
        let enableRunHtmlMode = localStorage.getItem('enableRunHtmlMode') === 'true';
        let isWaitingForResponse = false;

        // --- DOM Elements ---
        const chatContainerElement = document.getElementById('chat-container');
        const pages = document.getElementById('pages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const mainResponseCountInput = document.getElementById('main-response-count'); // Updated ID
        const pfpUploadInput = document.querySelector('.pfp-upload');
        const settingsButton = document.getElementById('settings-button');
        const systemPromptModal = document.getElementById('system-prompt-modal');
        const systemPromptInput = document.getElementById('system-prompt-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveSettingsButton = document.getElementById('save-settings-button');
        const hideCodeCheckbox = document.getElementById('hide-code-checkbox');
        const downloadCodeCheckbox = document.getElementById('download-code-checkbox');
        const enableRunHtmlCheckbox = document.getElementById('enable-run-html-checkbox');
        const cancelSettingsButton = document.getElementById('cancel-settings');
        const editCodeButton = document.getElementById('edit-code-button');
        const codeEditModal = document.getElementById('code-edit-modal');
        const editSnippetTextarea = document.getElementById('edit-snippet-textarea');
        const editStartLineInput = document.getElementById('edit-start-line');
        const editEndLineInput = document.getElementById('edit-end-line');
        const editSnippetLineCount = document.getElementById('edit-snippet-line-count');
        const editInstructionsInput = document.getElementById('edit-instructions');
        const editAddIteratorButton = document.getElementById('edit-add-iterator-button'); // New button in modal
        const editResponseCountInput = document.getElementById('edit-response-count'); // New input in modal
        const sendEditRequestButton = document.getElementById('send-edit-request');
        const cancelEditRequestButton = document.getElementById('cancel-edit-request');
        const clearChatButton = document.getElementById('clear-chat-button');
        const addIteratorButton = document.getElementById('add-iterator-button');
        const copyHelper = document.getElementById('copy-helper');
        const uploadFileButton = document.getElementById('upload-file-button');
        const fileUploadInput = document.getElementById('file-upload-input');

        // --- Configure Markdown & Highlighting ---
        marked.setOptions({ highlight:function(c,l){const lang=hljs.getLanguage(l)?l:'plaintext';try{return hljs.highlight(c,{language:lang,ignoreIllegals:true}).value;}catch(e){return hljs.highlight(c,{language:'plaintext',ignoreIllegals:true}).value;}},langPrefix:'hljs language-',gfm:true,breaks:true });

        // --- PFP Handling ---
        pfpUploadInput.addEventListener('change', function(event) { const f=event.target.files[0];if(!f||!currentPfpElementToUpdate)return;const r=new FileReader();r.onload=function(e){const u=e.target.result;currentPfpElementToUpdate.src=u;const t=currentPfpElementToUpdate.closest('.avatar').dataset.senderType; if(t==='user'){userPfp=u;localStorage.setItem('userPfp',u);document.querySelectorAll('.avatar.user-avatar img').forEach(i=>i.src=u);}else if(t==='spirit'){botPfp=u;localStorage.setItem('botPfp',u);document.querySelectorAll('.avatar.spirit-avatar img').forEach(i=>i.src=u);}currentPfpElementToUpdate=null;};r.readAsDataURL(f); });

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
        messageInput.addEventListener('input', autoGrowTextarea);
        editCodeButton.addEventListener('click', openEditCodeModal);
        sendEditRequestButton.addEventListener('click', handleSendEditRequest);
        cancelEditRequestButton.addEventListener('click', () => codeEditModal.style.display = 'none');
        codeEditModal.addEventListener('click', (e) => { if (e.target === codeEditModal) { codeEditModal.style.display = 'none'; } }); // Close on overlay click
        settingsButton.addEventListener('click', openSystemPromptModal);
        saveSettingsButton.addEventListener('click', saveSettings);
        if (cancelSettingsButton) cancelSettingsButton.addEventListener('click', () => systemPromptModal.style.display = 'none');
        systemPromptModal.addEventListener('click', (e) => { if (e.target === systemPromptModal) { systemPromptModal.style.display = 'none'; } });
        clearChatButton.addEventListener('click', handleClearChat);
        addIteratorButton.addEventListener('click', () => insertIteratorPlaceholder(messageInput)); // Pass target input
        editAddIteratorButton.addEventListener('click', () => insertIteratorPlaceholder(editInstructionsInput)); // Pass target input
        editSnippetTextarea.addEventListener('input', updateSnippetLineCount);
        hideCodeCheckbox.addEventListener('change', handleHideCodeToggle);
        downloadCodeCheckbox.addEventListener('change', handleDownloadCodeToggle);
        enableRunHtmlCheckbox.addEventListener('change', handleEnableRunHtmlToggle);
        uploadFileButton.addEventListener('click', () => fileUploadInput.click());


        // --- Core Functions ---
        function isApiKeySet() { if(!apiKey){alert("Spirit Essence Key needed! Use Settings (gear icon).");return false;}return true; }

        async function handleSendMessage() {
            if (!isApiKeySet() || isWaitingForResponse) return;
            const userInput = messageInput.value.trim();
            const responseCount = parseInt(mainResponseCountInput.value, 10); // Use main input
            if (userInput === '') return;

            const numResponses = isNaN(responseCount) || responseCount < 1 ? 1 : Math.min(responseCount, 5); // Clamp between 1 and 5
            const turnId = `turn-${turnCounter++}`;
            const containsPlaceholder = userInput.includes(iterationPlaceholder);

            isWaitingForResponse = true;
            sendButton.disabled = true;
            messageInput.value = '';
            autoGrowTextarea();

            const userEntry = { role: 'user', content: userInput, turnId: turnId };
            conversationHistory.push(userEntry);
            displayMessage(userEntry, 'user');
            saveHistoryToLocalStorage();
            scrollToBottom(); // Scroll after showing user message

            if (numResponses > 0) {
                showTypingIndicator();
                const baseHistory = prepareHistoryForApi(conversationHistory); // Prepare once before loop
                const responses = [];
                let errorOccurred = false;

                for (let i = 0; i < numResponses; i++) {
                    const iteration = i + 1;
                    let currentHistory = [...baseHistory]; // Create a copy for this iteration

                    // Substitute {i} if present and needed
                    if (containsPlaceholder && numResponses > 1) {
                        const userMessageIndex = currentHistory.length - 1;
                        if (currentHistory[userMessageIndex]?.role === 'user') {
                            const substitutedContent = currentHistory[userMessageIndex].content.replace(
                                new RegExp(iterationPlaceholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'),
                                iteration.toString()
                            );
                            currentHistory[userMessageIndex] = { ...currentHistory[userMessageIndex], content: substitutedContent };
                        }
                    }

                    // // Add previous responses to context for subsequent requests (optional, can make API calls longer)
                    // if (i > 0 && responses.length > 0) {
                    //     responses.forEach(resp => currentHistory.push({ role: 'assistant', content: resp }));
                    // }

                    try {
                        const res = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({
                                model: 'deepseek-chat', messages: currentHistory, stream: false,
                                temperature: 0.7, top_p: 0.9
                            })
                        });
                        if (!res.ok) { const e = await res.text(); throw new Error(`API ${res.status}: ${e}`); }
                        const data = await res.json();
                        if (!data.choices?.[0]?.message?.content) { throw new Error('Spirit gave empty response.'); }
                        responses.push(data.choices[0].message.content.trim() || "[Silence]");
                    } catch (e) {
                        console.error(`Fetch Error (Response ${iteration}):`, e);
                        responses.push(`[Disturbance fetching response ${iteration}: ${e.message}]`);
                        errorOccurred = true;
                        // Optionally break the loop on error: break;
                    }
                }
                hideTypingIndicator();

                if (responses.length > 0) {
                    const botEntry = { role: 'assistant', variants: responses, selectedIndex: 0, turnId: turnId };
                    conversationHistory.push(botEntry);
                    saveHistoryToLocalStorage();
                    displayBotMessage(botEntry, 'spirit');
                } else if (!errorOccurred) {
                     // Should only happen if numResponses was 0 initially
                    displayMessage({ role: 'system', content: 'The spirit remains silent.' }, 'spirit');
                }
            }

            isWaitingForResponse = false;
            sendButton.disabled = false;
            messageInput.focus();
            scrollToBottom(); // Scroll after showing bot message(s)
        }

        function updateSnippetLineCount() {
            const text = editSnippetTextarea.value;
            const lineCount = text === '' ? 0 : text.split('\n').length;
            editSnippetLineCount.textContent = lineCount;
            // Update max values for line inputs, ensure they don't exceed current count
            const maxLines = lineCount > 0 ? lineCount : 1;
            editStartLineInput.max = maxLines;
            editEndLineInput.max = maxLines;
            if (parseInt(editEndLineInput.value, 10) > lineCount) editEndLineInput.value = lineCount > 0 ? lineCount : 1;
            if (parseInt(editStartLineInput.value, 10) > lineCount) editStartLineInput.value = lineCount > 0 ? lineCount : 1;
             // Ensure start <= end
            if (parseInt(editStartLineInput.value, 10) > parseInt(editEndLineInput.value, 10)) {
                editStartLineInput.value = editEndLineInput.value;
            }
        }

        function openEditCodeModal() {
            editSnippetTextarea.value = '';
            editInstructionsInput.value = '';
            editStartLineInput.value = 1;
            editEndLineInput.value = 1;
            editResponseCountInput.value = 1; // Reset variations count
            updateSnippetLineCount(); // Initial count update
            codeEditModal.style.display = 'flex';
            editSnippetTextarea.focus();
        }

        async function handleSendEditRequest() {
             if (!isApiKeySet() || isWaitingForResponse) return;

            const pastedCode = editSnippetTextarea.value;
            const startLine = parseInt(editStartLineInput.value, 10);
            const endLine = parseInt(editEndLineInput.value, 10);
            const instructions = editInstructionsInput.value.trim();
            const numVariations = parseInt(editResponseCountInput.value, 10); // Get variation count

            if (pastedCode.trim() === '') { alert("Please inscribe the glyphs (code snippet) to alter."); return; }
            if (!instructions) { alert("Instructions for the spirit are required."); return; }

            const pastedLines = pastedCode.split('\n');
            const totalLines = pastedLines.length;

            if (isNaN(startLine) || isNaN(endLine) || startLine < 1 || endLine < startLine || endLine > totalLines) {
                alert(`Invalid line selection (${startLine}-${endLine}). Please use numbers between 1 and ${totalLines}, ensuring Start Line <= End Line.`);
                return;
            }
            const numResponses = isNaN(numVariations) || numVariations < 1 ? 1 : Math.min(numVariations, 5); // Clamp 1-5
            const containsPlaceholder = instructions.includes(iterationPlaceholder);

            codeEditModal.style.display = 'none'; // Close modal immediately
            isWaitingForResponse = true; // Block other sends

            // --- Display User's Request Placeholder ---
            const turnId = `turn-${turnCounter++}`;
            const userRequestSummary = `[Glyph Alteration Request]\nSnippet Lines: ${startLine}-${endLine}\nVariations Requested: ${numResponses}\nInstructions: ${instructions}`;
            const userEntry = { role: 'user', content: userRequestSummary, turnId: turnId };
            conversationHistory.push(userEntry);
            displayMessage(userEntry, 'user');
            saveHistoryToLocalStorage();
            scrollToBottom();
            showTypingIndicator();
            // --- End User Placeholder ---

            const startIndex = startLine - 1;
            const endIndex = endLine;
            const snippetToAlter = pastedLines.slice(startIndex, endIndex).join('\n');
            const historyUpToEdit = conversationHistory.slice(0, -1); // Exclude the request summary itself
            const baseApiHistory = prepareHistoryForApi(historyUpToEdit);

            const editResponses = [];
            let errorOccurred = false;

            // --- Loop to get variations ---
            for (let i = 0; i < numResponses; i++) {
                const iteration = i + 1;
                let currentInstructions = instructions;

                // Substitute {i} in instructions if needed
                if (containsPlaceholder && numResponses > 1) {
                    currentInstructions = instructions.replace(
                        new RegExp(iterationPlaceholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'),
                        iteration.toString()
                    );
                }

                // Construct the prompt for the API
                const prompt = `You are tasked with altering a code snippet based on user instructions.
CONTEXT: The user is working with a larger piece of code, but has provided only the following lines for alteration (Lines ${startLine} to ${endLine} of their pasted snippet). Focus your changes ONLY on these lines.
Previous conversation history may provide additional context.

SNIPPET TO ALTER (Lines ${startLine}-${endLine}):
\`\`\`
${snippetToAlter}
\`\`\`

INSTRUCTIONS FOR THIS ALTERATION:
${currentInstructions}

Return ONLY the altered code for the specified lines (${startLine}-${endLine}). Do not include explanations, backticks, or line numbers unless the instructions specifically ask for them.`;

                let apiHistoryForThisCall = [...baseApiHistory];
                apiHistoryForThisCall.push({ role: 'user', content: prompt });

                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({
                            model: 'deepseek-chat', messages: apiHistoryForThisCall, stream: false,
                            temperature: 0.5, // Slightly lower temp for more deterministic edits?
                            top_p: 0.9
                        })
                    });

                    if (!res.ok) { const e = await res.text(); throw new Error(`API Error ${res.status}: ${e}`); }
                    const data = await res.json();
                    if (!data.choices?.[0]?.message?.content) { throw new Error('Spirit returned empty edit.'); }

                    let rawResponse = data.choices[0].message.content.trim();
                    // Clean potential markdown fences
                    rawResponse = rawResponse.replace(/^```(?:\w*\n)?/, '').replace(/\n?```$/, '').trim();
                    const editedLines = rawResponse.split('\n');

                    // Reconstruct the full snippet with the edited lines
                    const reconstructedLines = [
                        ...pastedLines.slice(0, startIndex),
                        ...editedLines,
                        ...pastedLines.slice(endIndex)
                    ];
                    editResponses.push(reconstructedLines.join('\n'));

                } catch (e) {
                    console.error(`Edit Request Error (Variation ${iteration}):`, e);
                    // Provide the original code block as a fallback for this variation? Or an error message?
                     const errorMarker = `--- ERROR Altering Variation ${iteration} ---\n${e.message}\n--- ORIGINAL LINES ${startLine}-${endLine} ---`;
                     const reconstructedLines = [
                         ...pastedLines.slice(0, startIndex),
                         errorMarker,
                         ...pastedLines.slice(startIndex, endIndex), // Show original in case of error
                         ...pastedLines.slice(endIndex)
                     ];
                     editResponses.push(reconstructedLines.join('\n'));
                    errorOccurred = true;
                     // Optionally break;
                }
            }
            // --- End Loop ---

            hideTypingIndicator();

            // Create and display the bot message with potentially multiple variants
            const botEntry = {
                role: 'assistant',
                variants: editResponses,
                selectedIndex: 0,
                turnId: turnId,
                isCodeEdit: true // Mark as an edit result
            };
            conversationHistory.push(botEntry);
            saveHistoryToLocalStorage();
            displayBotMessage(botEntry, 'spirit');

            isWaitingForResponse = false; // Allow new sends
            scrollToBottom();
        }

        function openSystemPromptModal() {
            systemPromptInput.value=conversationHistory[0]?.content||DEFAULT_SYSTEM_PROMPT;
            apiKeyInput.value=apiKey;
            hideCodeCheckbox.checked=hideCodeBlocks;
            downloadCodeCheckbox.checked=downloadCodeMode;
            enableRunHtmlCheckbox.checked=enableRunHtmlMode;
            systemPromptModal.style.display='flex';
         }
        function saveSettings() { const sp=systemPromptInput.value.trim()||DEFAULT_SYSTEM_PROMPT;if(conversationHistory.length===0||conversationHistory[0]?.role!=='system'){conversationHistory.unshift({role:'system',content:sp});}else{conversationHistory[0].content=sp;}localStorage.setItem('systemPrompt',sp);const ak=apiKeyInput.value.trim();apiKey=ak;localStorage.setItem('apiKey',ak);console.log("Settings saved.");saveHistoryToLocalStorage();systemPromptModal.style.display='none'; }
        function handleHideCodeToggle() { hideCodeBlocks=hideCodeCheckbox.checked;localStorage.setItem('hideCodeBlocks',hideCodeBlocks);chatContainerElement.classList.toggle('code-hidden',hideCodeBlocks); }
        function handleDownloadCodeToggle() { downloadCodeMode=downloadCodeCheckbox.checked;localStorage.setItem('downloadCodeMode',downloadCodeMode);chatContainerElement.classList.toggle('download-code-active',downloadCodeMode); }
        function handleEnableRunHtmlToggle() { enableRunHtmlMode=enableRunHtmlCheckbox.checked; localStorage.setItem('enableRunHtmlMode',enableRunHtmlMode); chatContainerElement.classList.toggle('run-html-active',enableRunHtmlMode); }
        function handleClearChat() { if(confirm("Disperse echoes?")){const sp=conversationHistory[0]?.content||localStorage.getItem('systemPrompt')||DEFAULT_SYSTEM_PROMPT;conversationHistory=[{role:'system',content:sp}];turnCounter=1;saveHistoryToLocalStorage();rebuildChatFromHistory();} }

        // Updated to accept target textarea element
        function insertIteratorPlaceholder(targetInput) {
            if (!targetInput) return;
            const start = targetInput.selectionStart;
            const end = targetInput.selectionEnd;
            const value = targetInput.value;
            const newValue = value.substring(0, start) + iterationPlaceholder + value.substring(end);
            targetInput.value = newValue;
            const newPos = start + iterationPlaceholder.length;
            targetInput.selectionStart = newPos;
            targetInput.selectionEnd = newPos;
            targetInput.focus();
            // Trigger input event for potential auto-grow or other listeners
            targetInput.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function autoGrowTextarea() { const i=messageInput;const mH=i.style.maxHeight||'150px';i.style.maxHeight='none';i.style.height='auto';const sH=i.scrollHeight;i.style.height=sH+'px';i.style.maxHeight=mH;i.style.overflowY=parseFloat(i.style.height)>parseFloat(mH)?'auto':'hidden'; }

        // --- Display Logic ---
        function createPfpElement(sender, pfpUrl) { const d=document.createElement('div');d.className=`avatar ${sender}-avatar`;d.dataset.senderType=sender;const i=document.createElement('img');i.src=pfpUrl;i.alt=`${sender} avatar`;d.addEventListener('click',()=>{currentPfpElementToUpdate=i;pfpUploadInput.click();});d.appendChild(i);return d; }
        function displayBotMessage(entry, sender='spirit') { if(entry.variants?.length>1)displayMultipleMessages(entry,sender);else if(entry.variants?.length>=1)displayMessage(entry,sender);else console.warn("Bad bot struct:",entry); }

        function displayMessage(entry, sender) {
            const c = sender === 'user' ? entry.content : (entry.variants?.[entry.selectedIndex ?? 0] || '[Silence]');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message message-${sender}`;
            if (entry.turnId) msgDiv.dataset.turnId = entry.turnId;

            const p = sender === 'user' ? userPfp : botPfp;
            const avatarEl = createPfpElement(sender, p);

            const wrapper = document.createElement('div');
            wrapper.classList.add('message-content-wrapper');

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (sender === 'spirit') {
                try { contentDiv.innerHTML = marked.parse(c); }
                catch (e) { contentDiv.textContent = c; }
            } else {
                contentDiv.textContent = c;
                contentDiv.style.whiteSpace = 'pre-wrap'; // Ensure user text wraps
            }

            wrapper.appendChild(contentDiv);

            if (sender === 'spirit') {
                addCodeActionButtons(contentDiv, wrapper, entry.turnId, 0); // Pass index 0 for single variant
            }

            if (sender === 'user') { msgDiv.appendChild(wrapper); msgDiv.appendChild(avatarEl); }
            else { msgDiv.appendChild(avatarEl); msgDiv.appendChild(wrapper); }

            pages.appendChild(msgDiv);
            return msgDiv;
        }

        function displayMultipleMessages(entry, sender = 'spirit') {
            const tid = entry.turnId;
            const vars = entry.variants;
            let idx = entry.selectedIndex;

            const msgDiv = document.createElement('div');
            msgDiv.className = `message message-${sender}`;
            if (tid) msgDiv.dataset.turnId = tid;

            const p = sender === 'user' ? userPfp : botPfp;
            const avatarEl = createPfpElement(sender, p);

            const wrapper = document.createElement('div');
            wrapper.classList.add('message-content-wrapper');

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const nav = document.createElement('div');
            nav.classList.add('response-navigation');
            const prev = document.createElement('button'); prev.textContent = '<';
            const span = document.createElement('span');
            const next = document.createElement('button'); next.textContent = '>';
            nav.appendChild(prev); nav.appendChild(span); nav.appendChild(next);

            wrapper.appendChild(contentDiv);
            let acts = document.createElement('div'); // Create actions container
            acts.classList.add('message-actions');
            wrapper.appendChild(acts); // Add actions container before nav
            wrapper.appendChild(nav); // Add navigation last

            function update(currentIndex) {
                try { contentDiv.innerHTML = marked.parse(vars[currentIndex]); }
                catch (e) { contentDiv.textContent = vars[currentIndex]; }

                addCodeActionButtons(contentDiv, wrapper, tid, currentIndex); // Update actions for current variant

                span.textContent = `${currentIndex + 1} / ${vars.length}`;
                prev.disabled = currentIndex === 0;
                next.disabled = currentIndex === vars.length - 1;
                contentDiv.style.animation = 'none'; void contentDiv.offsetWidth; contentDiv.style.animation = 'fadeIn 0.3s ease-in-out';
            }

            prev.addEventListener('click', () => { if (idx > 0) { idx--; update(idx); updateHistorySelection(tid, idx); } });
            next.addEventListener('click', () => { if (idx < vars.length - 1) { idx++; update(idx); updateHistorySelection(tid, idx); } });

            if (sender === 'user') { msgDiv.appendChild(wrapper); msgDiv.appendChild(avatarEl); }
            else { msgDiv.appendChild(avatarEl); msgDiv.appendChild(wrapper); }

            pages.appendChild(msgDiv);
            update(idx);
            return msgDiv;
        }

        // Helper to add action buttons to code blocks
        function addCodeActionButtons(contentDiv, wrapper, turnId, variantIndex) {
            // Find or create the actions container
            let acts = wrapper.querySelector('.message-actions');
            if (!acts) {
                acts = document.createElement('div');
                acts.classList.add('message-actions');
                // Insert before navigation if nav exists, otherwise append
                const nav = wrapper.querySelector('.response-navigation');
                if (nav) { wrapper.insertBefore(acts, nav); } else { wrapper.appendChild(acts); }
            }
            acts.innerHTML = ''; // Clear previous buttons for this variant
            contentDiv.querySelectorAll('.cat-placeholder').forEach(c => c.remove()); // Clean up old placeholders

            const codeBlocks = contentDiv.querySelectorAll('pre');
            if (codeBlocks.length > 0) {
                codeBlocks.forEach((pre, preIdx) => {
                    const uniquePreId = `pre-${turnId || 'gen'}-${variantIndex}-${preIdx}`; // Unique ID
                    pre.id = uniquePreId;

                    const cat = document.createElement('span'); cat.classList.add('cat-placeholder'); cat.textContent = '🐱'; cat.dataset.preId = uniquePreId; pre.parentNode.insertBefore(cat, pre);
                    const codeElement = pre.querySelector('code');
                    const codeText = codeElement ? codeElement.textContent : '';
                    const langMatch = codeElement?.className.match(/language-(\w+)/);
                    const lang = langMatch ? langMatch[1] : 'txt';
                    const filename = `scroll_${Date.now()}_${variantIndex + 1}.${lang}`;

                    // Copy Button
                    const cpBtn = document.createElement('button'); cpBtn.textContent = 'Copy'; cpBtn.classList.add('copy-code-button', 'action-button'); cpBtn.onclick = () => copyCodeFromPre(uniquePreId, cpBtn); acts.appendChild(cpBtn);

                    // Download Button
                    const dlBtn = document.createElement('button'); dlBtn.textContent = 'Download'; dlBtn.classList.add('download-code-button', 'action-button'); dlBtn.onclick = () => downloadCode(codeText, filename); acts.appendChild(dlBtn);

                    // Run HTML Button
                    if (lang === 'html') {
                        const runBtn = document.createElement('button'); runBtn.textContent = 'Run HTML'; runBtn.classList.add('run-html-button', 'action-button'); runBtn.title = "Run this HTML snippet (logic TBD)";
                        runBtn.onclick = () => { alert(`Run HTML logic needed for code:\n\n${codeText.substring(0, 200)}${codeText.length > 200 ? '...' : ''}`); };
                        acts.appendChild(runBtn);
                    }
                });
            } else {
                 // Optional: if you want to remove the actions div completely when no code blocks exist
                 // if (wrapper.contains(acts)) { wrapper.removeChild(acts); }
            }
        }


        function copyCodeFromPre(preId, btn) { const p=document.getElementById(preId);const c=p?p.querySelector('code'):null;if(!c){if(btn)btn.textContent='Err!';return;}const t=c.textContent||'';copyHelper.value=t;copyHelper.select();copyHelper.setSelectionRange(0,99999);let ok=false;try{ok=document.execCommand('copy');}catch(e){ok=false;}window.getSelection().removeAllRanges();if(btn){if(ok){btn.textContent='Copied!';btn.classList.add('copied');setTimeout(()=>{btn.textContent='Copy';btn.classList.remove('copied');},1500);}else{btn.textContent='Failed!';setTimeout(()=>{btn.textContent='Copy';},2000);}} }
        function downloadCode(codeText, filename) { try{const b=new Blob([codeText],{type:'text/plain;charset=utf-8'});const u=URL.createObjectURL(b);const l=document.createElement('a');l.href=u;l.download=filename;document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(u);}catch(e){console.error("DL Err:",e);alert("Download failed.");} }
        function showTypingIndicator() { if(document.getElementById('typing-indicator'))return;const i=document.createElement('div');i.className='typing-indicator';i.id='typing-indicator';i.textContent='The spirit whispers...';pages.appendChild(i);scrollToBottom(); }
        function hideTypingIndicator() { const i=document.getElementById('typing-indicator');if(i)i.remove(); }
        function scrollToBottom() { setTimeout(()=>{pages.scrollTop=pages.scrollHeight;},50); }

        // --- History Management & Utilities ---
        function prepareHistoryForApi(hist) { return hist.map(m=>{if(m.role==='system')return{role:'system',content:m.content};if(m.role==='user')return{role:'user',content:m.content};if(m.role==='assistant'&&m.variants?.length>0)return{role:'assistant',content:m.variants[m.selectedIndex??0]};return null;}).filter(Boolean); }
        function updateHistorySelection(turnId, idx) { const i=conversationHistory.findIndex(m=>m.turnId===turnId&&m.role==='assistant');if(i>-1){conversationHistory[i].selectedIndex=idx;saveHistoryToLocalStorage();} }
        function saveHistoryToLocalStorage() { try{localStorage.setItem('conversationHistory',JSON.stringify(conversationHistory));}catch(e){console.error("Save Err:",e);} }
        function loadHistoryFromLocalStorage() { try{const s=localStorage.getItem('conversationHistory');if(!s)throw new Error('No hist');const p=JSON.parse(s);if(!Array.isArray(p)||p.length===0||p[0]?.role!=='system')throw new Error('Bad fmt');conversationHistory=p.map(m=>{if(m.role==='assistant'&&!Array.isArray(m.variants))return{...m,variants:[m.content||""],selectedIndex:0};if(m.role==='assistant'&&m.variants){if(!m.hasOwnProperty('selectedIndex')||m.selectedIndex<0||m.selectedIndex>=m.variants.length)m.selectedIndex=0;}return m;});console.log("Loaded history");const l=conversationHistory.filter(m=>m.turnId).pop();if(l?.turnId?.startsWith('turn-')){const n=parseInt(l.turnId.split('-')[1],10);turnCounter=isNaN(n)?1:n+1;}else{turnCounter=1;}return true;}catch(e){console.warn("Load Err:",e);}conversationHistory=[{role:'system',content:localStorage.getItem('systemPrompt')||DEFAULT_SYSTEM_PROMPT}];turnCounter=1;return false; }
        function rebuildChatFromHistory() { pages.innerHTML='';for(let i=1;i<conversationHistory.length;i++){const e=conversationHistory[i];if(e.role==='user')displayMessage(e,'user');else if(e.role==='assistant')displayBotMessage(e,'spirit');} }

        // --- Initial Load ---
        function displayInitialGreeting() { const g="The ancient tome awaits your words...";const e={role:'assistant',variants:[g],selectedIndex:0,turnId:'turn-0'};if(conversationHistory.length <= 1) { conversationHistory.push(e); displayBotMessage(e,'spirit'); saveHistoryToLocalStorage(); turnCounter = 1; } }
        function initialLoad() {
            loadHistoryFromLocalStorage();
            apiKey=localStorage.getItem('apiKey')||'';
            hideCodeBlocks=localStorage.getItem('hideCodeBlocks')==='true';
            downloadCodeMode=localStorage.getItem('downloadCodeMode')==='true';
            enableRunHtmlMode=localStorage.getItem('enableRunHtmlMode')==='true';
            chatContainerElement.classList.toggle('code-hidden',hideCodeBlocks);
            chatContainerElement.classList.toggle('download-code-active',downloadCodeMode);
            chatContainerElement.classList.toggle('run-html-active',enableRunHtmlMode);
            rebuildChatFromHistory();
            // Display greeting only if history is essentially empty (just system prompt)
            if(conversationHistory.length <= 1){ displayInitialGreeting(); }
            scrollToBottom();
        }

        initialLoad(); // Start

    </script>
</body>
</html>
