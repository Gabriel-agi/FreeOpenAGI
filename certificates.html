<!DOCTYPE html>
<!-- Language set by JS -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title set by JS -->
    <title data-translate="certificates_page_title">My Certificates - Complete Python</title>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Orbitron:wght@400;500;700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Base Styles & Variables (Combined & Refined) --- */
        :root {
            /* Dashboard/Page Vars */
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-page: #f0f2f5; /* Adjusted for certificate contrast */
            --background-card: #ffffff;
            --background-sidebar: #ffffff;
            --background-header: linear-gradient(135deg, #0d6efd, #0a58ca);
            --text-light: #f8f9fa;
            --text-dark: #343a40;
            --text-muted: #6c757d;
            --accent-color: #ffc107;
            --success-color: #198754;
            --error-color: #dc3545;
            --certificate-color-icon: #d63384; /* Pinkish for card icons */
            --border-color: #dee2e6;
            --border-radius: 8px;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 6px 18px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
            --font-body: 'Roboto', sans-serif; /* Dashboard default */
            --font-title: 'Orbitron', sans-serif; /* Dashboard default */
            --sidebar-width: 260px;

             /* Certificate Template Vars */
            --cert-gold: #D4AF37;
            --cert-dark-blue: #0F2D53;
            --cert-parchment: #F8F3E6;
            --cert-font-display: 'Playfair Display', serif;
            --cert-font-body: 'Montserrat', sans-serif;

             /* Language Switcher Vars */
             --lang-select-border: var(--certificate-color-icon);
             --lang-select-bg: rgba(255, 255, 255, 0.1);
             --lang-select-bg-hover: rgba(255, 255, 255, 0.15);
             --lang-option-bg: var(--background-card);
             --lang-option-text: var(--text-dark);
             --lang-arrow-color: var(--certificate-color-icon);

             /* Certificate Status Vars */
            --cert-locked-color: var(--secondary-color);
            --cert-inprogress-color: var(--accent-color);
            --cert-earned-color: var(--success-color);
            --cert-prepare-button-bg: var(--success-color);
            --cert-prepare-button-hover-bg: #157347;
            --cert-download-button-bg: linear-gradient(135deg, var(--cert-dark-blue), #2C5282);
            --cert-download-button-text: white;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-body); line-height: 1.6;
            background-color: var(--background-page); color: var(--text-dark);
            overflow-x: hidden;
            display: flex; /* Needed for centering certificate during print prep */
            flex-direction: column;
            align-items: center; /* Center content like certificate */
        }
        body.chat-open { overflow: hidden; }

        /* --- Animations --- */
        .card-fade-in { opacity: 0; transform: translateY(20px); animation: fadeInAnimation 0.6s ease-out forwards; }
        @keyframes fadeInAnimation { to { opacity: 1; transform: translateY(0); } }

        /* --- Debug Controls --- */
        .debug-controls {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            margin: 1rem auto;
            max-width: 1200px;
            width: calc(100% - 2rem); /* Ensure padding */
            font-size: 0.9rem;
        }
        .debug-controls h4 { margin-bottom: 0.75rem; color: #856404; font-family: var(--font-title); }
        .debug-controls label { margin-right: 1rem; cursor: pointer; display: inline-block; margin-bottom: 0.5rem; }
        .debug-controls input[type="checkbox"] { margin-right: 0.3rem; vertical-align: middle; }

        /* --- Page Header --- */
        .page-header { background: var(--background-header); color: var(--text-light); padding: 2rem 1.5rem; margin-bottom: 1rem; position: relative; width: 100%; }
        .header-content { max-width: 1200px; margin: 0 auto; position: relative; z-index: 1; text-align: center; }
        .page-header h1 { font-family: var(--font-title); font-size: 2.2rem; margin-bottom: 0; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2); }

        /* --- Page Layout Container --- */
        .page-container-wrapper {
            max-width: 1400px;
            width: 100%;
            padding: 0 1.5rem;
        }
        .page-container { display: flex; gap: 2rem; align-items: flex-start; width: 100%;}

        /* --- Sidebar --- */
        .page-sidebar { width: var(--sidebar-width); flex-shrink: 0; position: sticky; top: 20px; height: calc(100vh - 40px); overflow-y: auto; padding-right: 10px; scrollbar-width: thin; scrollbar-color: var(--secondary-color) var(--background-page); }
        .page-sidebar::-webkit-scrollbar { width: 6px; }
        .page-sidebar::-webkit-scrollbar-track { background: var(--background-page); }
        .page-sidebar::-webkit-scrollbar-thumb { background-color: var(--secondary-color); border-radius: 3px; }
        .sidebar-widget { background-color: var(--background-sidebar); border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
        .sidebar-widget h4 { font-family: var(--font-title); font-size: 1.1rem; margin-bottom: 1rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; display: flex; align-items: center; }
        .sidebar-widget h4 i { margin-right: 8px; color: var(--primary-color); opacity: 0.8; }
        .sidebar-widget ul { list-style: none; padding: 0; margin: 0; }
         /* Language Switcher Styles */
         .language-switcher { margin-top: 1rem; }
         #languageSelect { width: 100%; background: var(--background-card); color: var(--text-dark); border: 1px solid var(--lang-select-border); border-radius: 5px; padding: 8px 35px 8px 15px; cursor: pointer; font-size: 0.95rem; font-weight: 500; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${encodeURIComponent(getComputedStyle(document.documentElement).getPropertyValue('--certificate-color-icon').trim().substring(1))}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px auto; transition: border-color 0.3s ease; }
         #languageSelect:hover { border-color: #b02a6e; }
         #languageSelect:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15); }
         #languageSelect option { background: var(--lang-option-bg); color: var(--lang-option-text); padding: 5px; }
        /* Links Widget Styles */
        .sidebar-links ul li { margin-bottom: 0.75rem; }
        .sidebar-links ul li a { display: inline-flex; align-items: center; text-decoration: none; border-radius: 5px; padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 500; transition: all var(--transition-speed) ease; border: 1px solid transparent; }
        .sidebar-links ul li a i { margin-right: 6px; }
        .sidebar-links .link-dashboard { background-color: var(--primary-color); color: var(--text-light); border-color: var(--primary-color); }
        .sidebar-links .link-dashboard:hover { background-color: #0b5ed7; }
        .sidebar-links .link-main-site { background-color: var(--secondary-color); color: var(--text-light); border-color: var(--secondary-color); }
        .sidebar-links .link-main-site:hover { background-color: #5a6268; }

        /* --- Main Content Area --- */
        .page-main { flex-grow: 1; min-width: 0; }
        .certificates-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; /* Space before certificate preview */ }

        /* --- Certificate Card Styling --- */
        .certificate-card { background-color: var(--background-card); border-radius: var(--border-radius); box-shadow: var(--card-shadow); transition: all var(--transition-speed) ease-in-out; display: flex; flex-direction: column; border: 1px solid var(--border-color); border-left: 5px solid var(--cert-locked-color); overflow: hidden; position: relative; opacity: 0; transform: translateY(20px); padding: 1.5rem; }
        .certificate-card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow-hover); }
        /* Status specific styles */
        .certificate-card.status-locked { border-left-color: var(--cert-locked-color); }
        .certificate-card.status-inprogress { border-left-color: var(--cert-inprogress-color); }
        .certificate-card.status-earned { border-left-color: var(--cert-earned-color); }
        .certificate-card.status-earned .certificate-locked-info { display: none; }
        .certificate-card:not(.status-earned) .certificate-prepare-form { display: none; }

        .certificate-card h3 { font-family: var(--font-title); font-size: 1.3rem; color: var(--text-dark); margin-bottom: 0.8rem; line-height: 1.3; display: flex; align-items: center; }
        .certificate-card h3 i { margin-right: 10px; color: var(--certificate-color-icon); }
        .certificate-status { font-size: 0.95rem; font-weight: 500; margin-bottom: 1rem; padding: 0.4rem 0.8rem; border-radius: 4px; display: inline-block; border: 1px solid transparent; }
        .certificate-card.status-locked .certificate-status { color: var(--cert-locked-color); background-color: #e9ecef; border-color: var(--cert-locked-color); }
        .certificate-card.status-inprogress .certificate-status { color: #856404; background-color: #fff3cd; border-color: var(--cert-inprogress-color); }
         .certificate-card.status-earned .certificate-status { color: var(--cert-earned-color); background-color: #d1e7dd; border-color: var(--cert-earned-color); }
        .certificate-status i { margin-right: 6px; }

        .certificate-locked-info p { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .certificate-locked-info strong { color: var(--text-dark); }

        .certificate-prepare-form { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border-color); }
        .certificate-prepare-form label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .certificate-prepare-form input[type="text"] { width: 100%; padding: 0.7rem 1rem; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .certificate-prepare-form input[type="text"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); }
        .prepare-button { background-color: var(--cert-prepare-button-bg); color: var(--text-light); border: none; border-radius: 5px; padding: 0.7rem 1.5rem; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: background-color var(--transition-speed) ease; display: inline-flex; align-items: center; }
        .prepare-button:hover { background-color: var(--cert-prepare-button-hover-bg); }
        .prepare-button i { margin-right: 8px; }
        .prepare-message { font-size: 0.85rem; margin-top: 0.5rem; }
        .prepare-message.success { color: var(--success-color); }
        .prepare-message.error { color: var(--error-color); }

        /* --- Certificate Preview and Download Section --- */
        .certificate-preview-section {
            width: 100%;
            max-width: 950px; /* Slightly wider than certificate */
            margin: 2rem auto;
            text-align: center;
            display: none; /* Hidden initially */
        }
        #downloadBtn {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 0 0 1.5rem 0; /* Space below button */
            background: var(--cert-download-button-bg);
            color: var(--cert-download-button-text);
            font-family: var(--font-body);
        }
        #downloadBtn:disabled {
            background: var(--secondary-color);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- Certificate Template Styling --- */
        .certificate {
            width: 900px;
            height: 630px; /* A4 landscape aspect ratio */
            background: var(--cert-parchment);
            border: 15px solid var(--cert-gold);
            padding: 30px 50px;
            position: relative; /* For absolute positioning of elements */
            text-align: center;
            box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden; /* Prevent elements spilling */
            font-family: var(--cert-font-body); /* Use Montserrat for certificate body */
            color: #333; /* Default text color */
            margin: 0 auto; /* Center horizontally */
        }
        .certificate:before { /* Watermark */
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><path d="M20,100 Q50,40 100,20 Q150,40 180,100 Q150,160 100,180 Q50,160 20,100 Z" fill="none" stroke="%23D4AF3720" stroke-width="1"/></svg>');
            opacity: 0.1; pointer-events: none;
        }
        .certificate h1 { /* CERTIFICATE OF EXCELLENCE */
            font-family: var(--cert-font-display); color: var(--cert-dark-blue);
            font-size: 36px; margin: 15px 0 5px 0; letter-spacing: 1px;
        }
        .certificate .subtitle { /* Presented by... */
            font-size: 18px; color: #555; margin-bottom: 25px; font-weight: 600;
        }
        .certificate .recipient { /* Student's Name */
            font-family: var(--cert-font-display); font-size: 32px; font-weight: 700;
            color: var(--cert-dark-blue); margin: 30px 0; padding-bottom: 5px;
            border-bottom: 2px solid var(--cert-gold); display: inline-block;
        }
        .certificate .description { /* This certificate recognizes... */
            font-size: 16px; line-height: 1.6; margin: 25px auto; /* Center */
            position: relative; max-width: 650px; /* Control width */
        }
        /* Decorative Quotes - Removed for cleaner look, can be re-added */
        .certificate .signatures { display: flex; justify-content: center; margin: 30px 0 10px 0; }
        .certificate .signature { text-align: center; margin: 0 30px; }
        /* .certificate .signature-line REMOVED */
        .certificate .signature div { font-size: 14px; line-height: 1.4; }

        .certificate .footer { position: absolute; bottom: 30px; left: 0; right: 0; padding: 0 50px; font-size: 12px; color: #666; }
        .certificate .footer-content { display: flex; justify-content: space-between; align-items: flex-end; }
        .certificate .footer-left { text-align: left; }
        .certificate .footer-right { text-align: right; }
        .certificate #currentDate { font-style: italic; margin-bottom: 5px; }
        .certificate .footer-link { font-weight: bold; color: var(--cert-dark-blue); margin-bottom: 5px; }
        .certificate .footer-note { margin-bottom: 5px; }
        .certificate .footer-disclaimer { font-size: 10px; font-style: italic; color: #888; margin-top: 5px; line-height: 1.3; }


        .certificate .agi-seal { position: absolute; top: 30px; right: 40px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--cert-gold); border-radius: 50%; font-family: var(--cert-font-display); font-weight: bold; color: var(--cert-dark-blue); font-size: 20px; background: rgba(248, 243, 230, 0.6); /* Semi-transparent parchment */ }
        .certificate .decoration { position: absolute; bottom: 90px; left: 40px; width: 80px; opacity: 0.6; }
        .certificate .badge { position: absolute; bottom: 90px; right: 40px; width: 60px; opacity: 0.7; }

        /* --- Footer --- */
        footer { text-align: center; padding: 1.5rem; margin-top: 3rem; background-color: var(--background-card); border-top: 1px solid var(--border-color); color: var(--text-muted); font-size: 0.9rem; width: 100%; }

        /* --- Chat Panel & FAB Styles (Same as before) --- */
         #chatbot-fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: linear-gradient(45deg, var(--primary-color), #0b5ed7); color: white; border: none; border-radius: 50%; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); transition: all var(--transition-speed) ease; z-index: 1010; }
        #chatbot-fab:hover { transform: scale(1.1); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25); }
        #chatbot-fab i { transition: transform 0.3s ease; }
        body.chat-open #chatbot-fab { background: linear-gradient(45deg, var(--secondary-color), #5a6268); }
        body.chat-open #chatbot-fab i { transform: rotate(135deg); }
        #chat-panel-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.3); backdrop-filter: blur(2px); opacity: 0; visibility: hidden; transition: opacity var(--transition-speed) ease, visibility 0s var(--transition-speed); z-index: 1000; }
        body.chat-open #chat-panel-overlay { opacity: 1; visibility: visible; transition-delay: 0s; }
        #chat-panel { position: fixed; bottom: 30px; right: 100px; width: 90vw; max-width: 450px; height: 75vh; max-height: 650px; background-color: var(--background-card); border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 1005; opacity: 0; transform: translateY(20px) scale(0.98); visibility: hidden; transition: opacity var(--transition-speed) cubic-bezier(0.165, 0.84, 0.44, 1), transform var(--transition-speed) cubic-bezier(0.165, 0.84, 0.44, 1), visibility 0s var(--transition-speed); transform-origin: bottom right; }
        body.chat-open #chat-panel { opacity: 1; transform: translateY(0) scale(1); visibility: visible; transition-delay: 0s; }
        .chat-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1.2rem; border-bottom: 1px solid var(--border-color); background-color: var(--background-page); border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); }
        .chat-panel-header h5 { margin: 0; font-family: var(--font-title); font-size: 1.1rem; color: var(--primary-color); display: flex; align-items: center; }
        .chat-panel-header h5 i { margin-right: 8px; color: var(--certificate-color-icon); }
        #chat-close-button { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 0.2rem; line-height: 1; transition: color var(--transition-speed); }
        #chat-close-button:hover { color: var(--text-dark); }
        #chatbox { flex-grow: 1; overflow-y: auto; padding: 1.5rem; background-color: var(--chat-box-bg); font-family: var(--font-body); line-height: 1.6; scrollbar-width: thin; scrollbar-color: var(--secondary-color) var(--chat-box-bg); }
        #chatbox::-webkit-scrollbar { width: 6px; }
        #chatbox::-webkit-scrollbar-track { background: var(--chat-box-bg); }
        #chatbox::-webkit-scrollbar-thumb { background-color: var(--secondary-color); border-radius: 3px; }
        #chatbox .message-container { display: flex; margin-bottom: 1rem; align-items: flex-end; }
        #chatbox .message-avatar { width: 35px; height: 35px; border-radius: 50%; background-color: var(--secondary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; margin-right: 10px; }
        #chatbox .user-message-container .message-avatar { background-color: var(--primary-color); }
        #chatbox .bot-message-container .message-avatar { background-color: var(--certificate-color-icon); }
        #chatbox .message { padding: 10px 15px; border-radius: 18px; max-width: 80%; word-wrap: break-word; font-size: 0.95rem; position: relative; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        #chatbox .user-message-container { justify-content: flex-end; }
        #chatbox .user-message-container .message-avatar { margin-right: 0; margin-left: 10px; order: 2; }
        #chatbox .user-message-container .message { order: 1; }
        #chatbox .user-message { background-color: var(--chat-user-bg); color: var(--chat-user-text); border-color: var(--chat-user-bg); border-top-right-radius: 4px; }
        #chatbox .bot-message { background-color: var(--chat-bot-bg); color: var(--chat-bot-text); border-color: var(--chat-bot-bg); border-top-left-radius: 4px; }
        #chatbox .error-message { background-color: var(--chat-error-bg); color: var(--chat-error-text); border-color: #f5c6cb; margin-bottom: 1rem; }
        #chatbox .message strong { display: none; }
        #chatbox .typing-indicator { display: flex; align-items: center; color: var(--text-muted); font-style: italic; margin-bottom: 1rem; padding: 8px 15px; font-size: 0.9rem; }
        #chatbox .typing-indicator i { margin-right: 8px; color: var(--certificate-color-icon); }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .typing-dot { width: 6px; height: 6px; background-color: var(--text-muted); border-radius: 50%; display: inline-block; margin: 0 2px; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        #input-area { display: flex; padding: 0.8rem; border-top: 1px solid var(--border-color); background-color: var(--background-page); align-items: center; }
        #userInput { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 18px; padding: 0.7rem 1rem; font-size: 0.95rem; background-color: var(--background-card); color: var(--text-dark); outline: none; transition: border-color var(--transition-speed); resize: none; max-height: 80px; font-family: var(--font-body); }
        #userInput:focus { border-color: var(--primary-color); }
        #sendButton { background-color: var(--primary-color); color: var(--text-light); border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 0.7rem; padding: 0; cursor: pointer; font-size: 1.1rem; transition: background-color var(--transition-speed); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        #sendButton:hover { background-color: #0b5ed7; }
        #sendButton:disabled { background-color: var(--secondary-color); cursor: not-allowed; opacity: 0.7; }

        /* --- Responsive Design --- */
        @media (max-width: 1200px) { .page-container-wrapper { padding: 0 1rem; } .page-container { gap: 1.5rem; } :root { --sidebar-width: 240px; } #chat-panel { right: 85px; max-width: 420px;} .certificate { width: 100%; height: auto; aspect-ratio: 900 / 630; padding: 20px 30px; border-width: 10px;} .certificate h1 {font-size: 30px;} .certificate .recipient {font-size: 28px;} .certificate .description {font-size: 15px;} .certificate .footer {font-size: 11px;} .certificate .agi-seal {width: 50px; height: 50px; font-size: 16px; right: 25px;}}
        @media (max-width: 992px) { .page-container { flex-direction: column; } .page-sidebar { width: 100%; position: static; height: auto; overflow-y: visible; padding-right: 0; margin-bottom: 2rem; } .sidebar-widget { padding: 1.2rem; } .certificates-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); } #chat-panel { right: 30px; bottom: 90px; max-width: 400px; height: 70vh;} }
        @media (max-width: 768px) { html { font-size: 15px; } .page-header h1 { font-size: 1.8rem; } .certificates-grid { grid-template-columns: 1fr; gap: 1rem; } .certificate-card { padding: 1.2rem; } #chat-panel { right: 15px; bottom: 80px; left: 15px; width: auto; max-width: none; height: 65vh; } .certificate { padding: 15px 20px; border-width: 8px; } .certificate h1 { font-size: 26px; } .certificate .subtitle {font-size: 16px;} .certificate .recipient {font-size: 24px;} .certificate .description {font-size: 14px;} .certificate .signatures {margin-top: 20px;} .certificate .signature div {font-size: 12px;} .certificate .footer {font-size: 10px;} .certificate .agi-seal {width: 45px; height: 45px; font-size: 14px; right: 20px; top: 20px;} .certificate .decoration {bottom: 60px; left: 20px; width: 60px;} .certificate .badge {bottom: 60px; right: 20px; width: 45px;}}
        @media (max-width: 576px) { html { font-size: 14px; } .page-header { padding: 1.5rem 1rem; } .page-header h1 { font-size: 1.6rem; } .certificate-card h3 { font-size: 1.15rem; } .certificate-prepare-form input[type="text"] { font-size: 0.95rem; } .prepare-button { font-size: 0.9rem; padding: 0.6rem 1.2rem; } #chatbot-fab { width: 50px; height: 50px; font-size: 1.5rem; bottom: 20px; right: 20px; } #chat-panel { bottom: 75px; right: 10px; left: 10px; height: 60vh; } #chatbox { padding: 1rem; } #chatbox .message-avatar { width: 30px; height: 30px; font-size: 1rem; } #chatbox .message { font-size: 0.9rem; padding: 8px 12px;} #input-area { padding: 0.6rem; } #userInput { padding: 0.6rem 0.8rem; font-size: 0.9rem; border-radius: 15px;} #sendButton { width: 35px; height: 35px; font-size: 1rem; margin-left: 0.5rem;} .certificate h1 {font-size: 22px;} .certificate .subtitle {font-size: 14px;} .certificate .recipient {font-size: 20px;} .certificate .description {font-size: 12px;} .certificate .signature div {font-size: 11px;} .certificate .footer {font-size: 9px;} .certificate .footer-disclaimer {font-size: 8px;} }

        /* --- Print Styles --- */
        @media print {
            body { padding: 0; margin: 0; background: none; height: auto; width: auto; overflow: visible; align-items: flex-start; /* Reset body alignment for print */}
            .debug-controls, .page-header, .page-container-wrapper, footer, #chatbot-fab, #chat-panel-overlay, #chat-panel, .certificate-preview-section button { display: none !important; /* Hide everything except certificate */ }
            .certificate-preview-section { display: block !important; width: 100%; max-width: none; margin: 0; padding: 0; }
            .certificate {
                display: block !important;
                width: 100%; /* Use full printable width */
                height: 100%; /* Use full printable height */
                margin: 0;
                padding: 30px 50px; /* Keep padding consistent */
                border: 15px solid var(--cert-gold);
                box-shadow: none;
                page-break-after: always;
                page-break-inside: avoid;
                transform: scale(1);
                transform-origin: 0 0;
                position: static; /* Important for flow */
                background: var(--cert-parchment) !important; /* Ensure background prints */
                -webkit-print-color-adjust: exact !important; /* Chrome/Safari */
                color-adjust: exact !important; /* Firefox/Standard */
            }
            /* Ensure certificate variables are applied */
            .certificate h1 { color: var(--cert-dark-blue) !important; }
            .certificate .recipient { color: var(--cert-dark-blue) !important; border-bottom-color: var(--cert-gold) !important;}
            .certificate .agi-seal { border-color: var(--cert-gold) !important; color: var(--cert-dark-blue) !important; background: rgba(248, 243, 230, 0.6) !important; }
            .certificate .decoration path { stroke: var(--cert-gold) !important; }
            .certificate .badge path { fill: var(--cert-gold) !important; }
             /* .certificate .signature-line { background: var(--cert-dark-blue) !important; } REMOVED */
            .certificate .footer-link { color: var(--cert-dark-blue) !important; }
            /* Fine-tune print font sizes if needed */
            .certificate { font-size: 12pt; }
            .certificate h1 { font-size: 26pt; }
            .certificate .subtitle { font-size: 14pt; }
            .certificate .recipient { font-size: 22pt; }
            .certificate .description { font-size: 11pt; }
            .certificate .signature div { font-size: 10pt; }
            .certificate .footer { font-size: 8pt; }
            .certificate .footer-disclaimer { font-size: 7pt; }

            @page {
                size: A4 landscape; /* Standard landscape */
                margin: 0; /* No margins */
            }
        }

    </style>
</head>
<body>

    <!-- Debug Controls Removed -->

    <header class="page-header">
        <div class="header-content">
            <h1 data-translate="certificates_header_title">My Certificates</h1>
        </div>
    </header>

    <div class="page-container-wrapper">
        <div class="page-container">

            <!-- === Sidebar === -->
            <aside class="page-sidebar">
                <!-- Language Switcher -->
                <div class="sidebar-widget">
                    <h4><i class="fas fa-language"></i> <span data-translate="widget_lang_title">Language</span></h4>
                     <div class="language-switcher">
                        <select id="languageSelect" data-translate-aria-label="lang_select_aria" aria-label="Select Language">
                            <option value="en">🇬🇧 English</option>
                            <option value="pt">🇧🇷 Português</option>
                            <option value="zh">🇨🇳 中文</option>
                        </select>
                    </div>
                </div>
                 <!-- Links -->
                 <div class="sidebar-widget sidebar-links">
                     <h4><i class="fas fa-link"></i> <span data-translate="widget_links_title">Quick Links</span></h4>
                      <ul>
                        <li><a href="ctp-dashboard.html" class="link-dashboard"><i class="fas fa-tachometer-alt"></i> <span data-translate="link_dashboard">Back to Dashboard</span></a></li>
                        <li><a href="index.html" class="link-main-site"><i class="fas fa-home"></i> <span data-translate="link_main_site">Main Site</span></a></li>
                      </ul>
                 </div>
            </aside>

            <!-- === Main Content (Certificate Cards) === -->
            <main class="page-main">
                <div class="certificates-grid">

                    <!-- Certificate Card: Basics & I/O -->
                    <div class="certificate-card card-fade-in" data-certificate-id="basics" data-modules="0,1,2,3,4">
                        <h3><i class="fas fa-award"></i> <span data-translate="cert_basics_name">Basics & I/O Certificate</span></h3>
                        <div class="certificate-status"></div>
                        <div class="certificate-locked-info"><p data-translate="cert_progress_info_basics">Complete Knowledge Checks for modules 0-4.</p></div>
                        <div class="certificate-prepare-form">
                            <label for="certNameInput-basics" data-translate="cert_form_name_label">Full Name for Certificate:</label>
                            <input type="text" id="certNameInput-basics" data-translate-placeholder="cert_form_name_placeholder" placeholder="Enter your full name">
                            <button type="button" class="prepare-button" data-certificate-id="basics" data-translate-aria-label="cert_prepare_button_aria" aria-label="Prepare Basics Certificate">
                                <i class="fas fa-file-signature"></i> <span data-translate="cert_form_prepare_button">Prepare Certificate</span>
                            </button>
                            <div class="prepare-message" id="prepareMessage-basics"></div>
                        </div>
                    </div>

                     <!-- Certificate Card: Flow Control -->
                    <div class="certificate-card card-fade-in" data-certificate-id="flow" data-modules="5,6,7,8,9,12,13,14,15">
                        <h3><i class="fas fa-award"></i> <span data-translate="cert_flow_name">Flow Control Certificate</span></h3>
                        <div class="certificate-status"></div>
                        <div class="certificate-locked-info"><p data-translate="cert_progress_info_flow">Complete Knowledge Checks for modules 5-9 & 12-15.</p></div>
                        <div class="certificate-prepare-form">
                            <label for="certNameInput-flow" data-translate="cert_form_name_label">Full Name for Certificate:</label>
                            <input type="text" id="certNameInput-flow" data-translate-placeholder="cert_form_name_placeholder" placeholder="Enter your full name">
                            <button type="button" class="prepare-button" data-certificate-id="flow" data-translate-aria-label="cert_prepare_button_aria_flow" aria-label="Prepare Flow Control Certificate">
                                <i class="fas fa-file-signature"></i> <span data-translate="cert_form_prepare_button">Prepare Certificate</span>
                            </button>
                            <div class="prepare-message" id="prepareMessage-flow"></div>
                        </div>
                    </div>

                    <!-- Certificate Card: Data Structures -->
                    <div class="certificate-card card-fade-in" data-certificate-id="data" data-modules="10,11,20,21,22">
                        <h3><i class="fas fa-award"></i> <span data-translate="cert_data_name">Data Structures Certificate</span></h3>
                        <div class="certificate-status"></div>
                        <div class="certificate-locked-info"><p data-translate="cert_progress_info_data">Complete Knowledge Checks for modules 10-11 & 20-22.</p></div>
                        <div class="certificate-prepare-form">
                            <label for="certNameInput-data" data-translate="cert_form_name_label">Full Name for Certificate:</label>
                            <input type="text" id="certNameInput-data" data-translate-placeholder="cert_form_name_placeholder" placeholder="Enter your full name">
                            <button type="button" class="prepare-button" data-certificate-id="data" data-translate-aria-label="cert_prepare_button_aria_data" aria-label="Prepare Data Structures Certificate">
                               <i class="fas fa-file-signature"></i> <span data-translate="cert_form_prepare_button">Prepare Certificate</span>
                            </button>
                            <div class="prepare-message" id="prepareMessage-data"></div>
                        </div>
                    </div>

                    <!-- Certificate Card: Functions -->
                    <div class="certificate-card card-fade-in" data-certificate-id="functions" data-modules="16,17,18,19">
                        <h3><i class="fas fa-award"></i> <span data-translate="cert_functions_name">Functions Certificate</span></h3>
                        <div class="certificate-status"></div>
                        <div class="certificate-locked-info"><p data-translate="cert_progress_info_functions">Complete Knowledge Checks for modules 16-19.</p></div>
                        <div class="certificate-prepare-form">
                            <label for="certNameInput-functions" data-translate="cert_form_name_label">Full Name for Certificate:</label>
                            <input type="text" id="certNameInput-functions" data-translate-placeholder="cert_form_name_placeholder" placeholder="Enter your full name">
                            <button type="button" class="prepare-button" data-certificate-id="functions" data-translate-aria-label="cert_prepare_button_aria_functions" aria-label="Prepare Functions Certificate">
                                <i class="fas fa-file-signature"></i> <span data-translate="cert_form_prepare_button">Prepare Certificate</span>
                            </button>
                             <div class="prepare-message" id="prepareMessage-functions"></div>
                        </div>
                    </div>

                    <!-- Certificate Card: Files & Errors -->
                    <div class="certificate-card card-fade-in" data-certificate-id="files" data-modules="23,24,25">
                        <h3><i class="fas fa-award"></i> <span data-translate="cert_files_name">Files & Errors Certificate</span></h3>
                        <div class="certificate-status"></div>
                        <div class="certificate-locked-info"><p data-translate="cert_progress_info_files">Complete Knowledge Checks for modules 23-25.</p></div>
                        <div class="certificate-prepare-form">
                            <label for="certNameInput-files" data-translate="cert_form_name_label">Full Name for Certificate:</label>
                            <input type="text" id="certNameInput-files" data-translate-placeholder="cert_form_name_placeholder" placeholder="Enter your full name">
                            <button type="button" class="prepare-button" data-certificate-id="files" data-translate-aria-label="cert_prepare_button_aria_files" aria-label="Prepare Files & Errors Certificate">
                                <i class="fas fa-file-signature"></i> <span data-translate="cert_form_prepare_button">Prepare Certificate</span>
                            </button>
                             <div class="prepare-message" id="prepareMessage-files"></div>
                        </div>
                    </div>

                    <!-- Certificate Card: Advanced Topics -->
                    <div class="certificate-card card-fade-in" data-certificate-id="advanced" data-modules="26,27,28,29,30,31,32">
                        <h3><i class="fas fa-award"></i> <span data-translate="cert_advanced_name">Advanced Topics Certificate</span></h3>
                        <div class="certificate-status"></div>
                        <div class="certificate-locked-info"><p data-translate="cert_progress_info_advanced">Complete Knowledge Checks for modules 26-32.</p></div>
                        <div class="certificate-prepare-form">
                            <label for="certNameInput-advanced" data-translate="cert_form_name_label">Full Name for Certificate:</label>
                            <input type="text" id="certNameInput-advanced" data-translate-placeholder="cert_form_name_placeholder" placeholder="Enter your full name">
                            <button type="button" class="prepare-button" data-certificate-id="advanced" data-translate-aria-label="cert_prepare_button_aria_advanced" aria-label="Prepare Advanced Topics Certificate">
                                <i class="fas fa-file-signature"></i> <span data-translate="cert_form_prepare_button">Prepare Certificate</span>
                            </button>
                             <div class="prepare-message" id="prepareMessage-advanced"></div>
                        </div>
                    </div>

                    <!-- Certificate Card: Full Course -->
                    <div class="certificate-card card-fade-in" data-certificate-id="full" data-modules="0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32">
                        <h3><i class="fas fa-graduation-cap"></i> <span data-translate="cert_full_name">Full Course Completion Certificate</span></h3>
                        <div class="certificate-status"></div>
                        <div class="certificate-locked-info"><p data-translate="cert_progress_info_full">Complete <strong>ALL</strong> Knowledge Checks in the course.</p></div>
                        <div class="certificate-prepare-form">
                            <label for="certNameInput-full" data-translate="cert_form_name_label">Full Name for Certificate:</label>
                            <input type="text" id="certNameInput-full" data-translate-placeholder="cert_form_name_placeholder" placeholder="Enter your full name">
                            <button type="button" class="prepare-button" data-certificate-id="full" data-translate-aria-label="cert_prepare_button_aria_full" aria-label="Prepare Full Course Certificate">
                                 <i class="fas fa-file-signature"></i> <span data-translate="cert_form_prepare_button">Prepare Certificate</span>
                            </button>
                            <div class="prepare-message" id="prepareMessage-full"></div>
                        </div>
                    </div>

                </div><!-- /.certificates-grid -->
            </main>
        </div><!-- /.page-container -->
    </div><!-- /.page-container-wrapper -->


    <!-- Certificate Preview and Download Section -->
    <div id="certificatePreviewSection" class="certificate-preview-section">
         <button id="downloadBtn" onclick="downloadAsPDF()" data-translate-aria-label="cert_download_button_aria" aria-label="Download Certificate as PDF" disabled>
             <i class="fas fa-download"></i> <span data-translate="cert_download_button">Download PDF</span>
         </button>
         <div id="certificateTemplate" class="certificate">
            <div class="agi-seal">AGI</div>
            <svg class="decoration" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"> <path d="M20,50 Q35,20 50,50 Q65,80 80,50" fill="none" stroke="var(--cert-gold)" stroke-width="1.5"/> </svg>
            <svg class="badge" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"> <path d="M50,10 L60,40 L90,40 L65,60 L75,90 L50,75 L25,90 L35,60 L10,40 L40,40 Z" fill="var(--cert-gold)" opacity="0.8"/> </svg>

            <h1 data-translate="cert_template_title">CERTIFICATE OF COMPLETION</h1>
            <div class="subtitle" data-translate="cert_template_subtitle">Presented with Honor by Road to Free Open AGI</div>

            <div class="description">
                 <span data-translate="cert_template_desc_intro">This certificate recognizes that</span>
                 <span id="recipientName" class="recipient">[Recipient Name]</span>
                 <span id="certificateDescription"> <!-- Description filled by JS --> </span>
            </div>

            <div class="signatures">
                <div class="signature">
                    <!-- Removed signature-line -->
                    <div style="font-weight: bold; margin-top: 5px;">Gabriel M.</div>
                    <div data-translate="cert_template_signature_title">Founder & Instructor</div>
                    <div data-translate="cert_template_project_name">Road to Free Open AGI</div>
                </div>
            </div>

            <div class="footer">
                 <div class="footer-content">
                    <div class="footer-left">
                        <div id="currentDate" data-translate-prefix="cert_template_date_prefix">Awarded on [Date]</div>
                        <div class="footer-link">gabriel-agi.github.io/FreeOpenAGI/</div>
                    </div>
                    <div class="footer-right">
                        <div class="footer-note" data-translate="cert_template_note">Achievement in open learning</div>
                         <div class="footer-disclaimer" data-translate="cert_template_disclaimer">Disclaimer: This certificate is issued based on self-reported completion of knowledge checks hosted on GitHub Pages, without formal verification, proctoring, or institutional accreditation. It serves as recognition of effort within this specific open learning context.</div>
                    </div>
                 </div>
            </div>
        </div>
    </div>


    <!-- Chat Panel & FAB (Same as before) -->
    <div id="chat-panel-overlay"></div>
    <div id="chat-panel">
        <div class="chat-panel-header">
            <h5 data-translate="chat_title"><i class="fas fa-cat"></i> Cat Assistant</h5>
            <button id="chat-close-button" data-translate-aria-label="chat_close_button_aria" aria-label="Close Chat">×</button>
        </div>
        <div id="chatbox" aria-live="polite"></div>
        <div id="input-area">
            <input id="userInput" type="text" autofocus data-translate-placeholder="chat_input_placeholder" placeholder="Ask Cat Assistant...">
            <button id="sendButton" data-translate-aria-label="chat_send_button_aria" aria-label="Send Message"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    <button id="chatbot-fab" data-translate-aria-label="chat_open_button_aria" aria-label="Open Course Assistant">
        <i class="fas fa-comment-dots"></i>
    </button>

    <footer>
        <p data-translate="footer_text">Part of the Road to Free Open AGI Project</p>
    </footer>

    <script>
        // --- Translations Object (Expanded) ---
        const translations = {
             en: {
                 // Shared
                 "widget_lang_title": "Language", "lang_select_aria": "Select Language", "lang_en": "🇬🇧 English", "lang_pt": "🇧🇷 Português", "lang_zh": "🇨🇳 中文", "widget_links_title": "Quick Links", "link_main_site": "Main Site", "footer_text": "Part of the Road to Free Open AGI Project",
                 // Certificate Page Specific
                 "certificates_page_title": "My Certificates - Complete Python", "certificates_header_title": "My Certificates", "link_dashboard": "Back to Dashboard",
                 "cert_basics_name": "Basics & I/O Certificate", "cert_flow_name": "Flow Control Certificate", "cert_data_name": "Data Structures Certificate", "cert_functions_name": "Functions Certificate", "cert_files_name": "Files & Errors Certificate", "cert_advanced_name": "Advanced Topics Certificate", "cert_full_name": "Full Course Completion Certificate",
                 "cert_status_locked": "<i class='fas fa-lock'></i> Locked", "cert_status_inprogress": "<i class='fas fa-spinner fa-spin'></i> In Progress", "cert_status_earned": "<i class='fas fa-check-circle'></i> Earned!",
                 "cert_progress_info_basics": "Complete Knowledge Checks for modules 0-4.", "cert_progress_info_flow": "Complete Knowledge Checks for modules 5-9 & 12-15.", "cert_progress_info_data": "Complete Knowledge Checks for modules 10-11 & 20-22.", "cert_progress_info_functions": "Complete Knowledge Checks for modules 16-19.", "cert_progress_info_files": "Complete Knowledge Checks for modules 23-25.", "cert_progress_info_advanced": "Complete Knowledge Checks for modules 26-32.", "cert_progress_info_full": "Complete <strong>ALL</strong> Knowledge Checks in the course.",
                 "cert_form_name_label": "Full Name for Certificate:", "cert_form_name_placeholder": "Enter your full name", "cert_form_prepare_button": "Prepare Certificate",
                 "cert_prepare_button_aria": "Prepare Basics Certificate", "cert_prepare_button_aria_flow": "Prepare Flow Control Certificate", "cert_prepare_button_aria_data": "Prepare Data Structures Certificate", "cert_prepare_button_aria_functions": "Prepare Functions Certificate", "cert_prepare_button_aria_files": "Prepare Files & Errors Certificate", "cert_prepare_button_aria_advanced": "Prepare Advanced Topics Certificate", "cert_prepare_button_aria_full": "Prepare Full Course Certificate",
                 "cert_prepare_success": "Certificate ready! Scroll down to view & download.", "cert_prepare_error_name": "Please enter your full name.",
                 "cert_download_button": "Download PDF", "cert_download_button_aria": "Download Certificate as PDF", "cert_download_error_not_ready": "Please prepare a certificate first.",
                 // Certificate Template Text
                 "cert_template_title": "CERTIFICATE OF COMPLETION", "cert_template_subtitle": "Presented with Honor by Road to Free Open AGI", "cert_template_desc_intro": "This certificate recognizes that",
                 "cert_desc_basics": "has demonstrated proficiency in the foundational concepts of Python programming, including basic syntax, variables, data types, input/output operations, and computational thinking.",
                 "cert_desc_flow": "has successfully mastered Python's flow control structures, including conditional statements (if/elif/else), loops (for/while), and logical operators, applying them effectively.",
                 "cert_desc_data": "has shown competence in working with core Python data structures like lists, dictionaries, and tuples, including their creation, modification, and iteration.",
                 "cert_desc_functions": "has gained a solid understanding of defining and using functions in Python, including parameters, return values, and the basics of variable scope.",
                 "cert_desc_files": "has acquired the skills to read from and write to files using Python, and handle potential errors gracefully through exception handling.",
                 "cert_desc_advanced": "has explored advanced Python topics, including module imports, fundamental algorithms (searching/sorting), and optionally object-oriented programming and recursion concepts.",
                 "cert_desc_full": "has successfully completed all modules and knowledge checks of the Complete Python course, demonstrating comprehensive understanding of fundamental Python programming and computational thinking principles.",
                 "cert_template_signature_title": "Founder & Instructor", "cert_template_project_name": "Road to Free Open AGI", "cert_template_date_prefix": "Awarded on", "cert_template_note": "Achievement in open learning", "cert_template_disclaimer": "Disclaimer: This certificate is issued based on self-reported completion of knowledge checks hosted on GitHub Pages, without formal verification, proctoring, or institutional accreditation. It serves as recognition of effort within this specific open learning context.",
                 // Debug Removed
                 // Chat
                 "chat_title": "Cat Assistant", "chat_initial_greeting": "Meow! I'm Cat Assistant. Ask me about Python, certificates, or Computational Thinking!", "chat_typing_indicator": "Cat Assistant is pondering", "chat_input_placeholder": "Ask Cat Assistant...", "chat_error_fetch": "Meow... sorry, couldn't connect ({status}).", "chat_error_generic": "Hiss! A network error occurred.", "chat_error_invalid_response": "Purr..don me, I received a strange response.", "chat_system_prompt": "You are Cat Assistant, a friendly, cute, and helpful cat-themed AI assistant for a Python programming and Computational Thinking course. You know a lot about Python syntax, concepts like loops, functions, data structures, certificates, and Computational Thinking principles. Respond concisely and clearly, like a helpful cat guiding a student. Use cat puns sparingly and appropriately. Keep answers focused and relatively short.", "chat_close_button_aria": "Close Chat", "chat_send_button_aria": "Send Message", "chat_open_button_aria": "Open Course Assistant",
             },
             pt: {
                  // Shared
                 "widget_lang_title": "Idioma", "lang_select_aria": "Selecionar Idioma", "lang_en": "🇬🇧 English", "lang_pt": "🇧🇷 Português", "lang_zh": "🇨🇳 中文", "widget_links_title": "Links Rápidos", "link_main_site": "Site Principal", "footer_text": "Parte do Projeto Road to Free Open AGI",
                 // Certificate Page Specific
                 "certificates_page_title": "Meus Certificados - Python Completo", "certificates_header_title": "Meus Certificados", "link_dashboard": "Voltar ao Painel",
                 "cert_basics_name": "Certificado Básico & I/O", "cert_flow_name": "Certificado Controle de Fluxo", "cert_data_name": "Certificado Estruturas de Dados", "cert_functions_name": "Certificado Funções", "cert_files_name": "Certificado Arquivos & Erros", "cert_advanced_name": "Certificado Tópicos Avançados", "cert_full_name": "Certificado de Conclusão do Curso Completo",
                 "cert_status_locked": "<i class='fas fa-lock'></i> Bloqueado", "cert_status_inprogress": "<i class='fas fa-spinner fa-spin'></i> Em Progresso", "cert_status_earned": "<i class='fas fa-check-circle'></i> Obtido!",
                 "cert_progress_info_basics": "Complete as Verificações de Conhecimento dos módulos 0-4.", "cert_progress_info_flow": "Complete as Verificações de Conhecimento dos módulos 5-9 e 12-15.", "cert_progress_info_data": "Complete as Verificações de Conhecimento dos módulos 10-11 e 20-22.", "cert_progress_info_functions": "Complete as Verificações de Conhecimento dos módulos 16-19.", "cert_progress_info_files": "Complete as Verificações de Conhecimento dos módulos 23-25.", "cert_progress_info_advanced": "Complete as Verificações de Conhecimento dos módulos 26-32.", "cert_progress_info_full": "Complete <strong>TODAS</strong> as Verificações de Conhecimento do curso.",
                 "cert_form_name_label": "Nome Completo para o Certificado:", "cert_form_name_placeholder": "Digite seu nome completo", "cert_form_prepare_button": "Preparar Certificado",
                 "cert_prepare_button_aria": "Preparar Certificado Básico", "cert_prepare_button_aria_flow": "Preparar Certificado Controle de Fluxo", "cert_prepare_button_aria_data": "Preparar Certificado Estruturas de Dados", "cert_prepare_button_aria_functions": "Preparar Certificado Funções", "cert_prepare_button_aria_files": "Preparar Certificado Arquivos & Erros", "cert_prepare_button_aria_advanced": "Preparar Certificado Tópicos Avançados", "cert_prepare_button_aria_full": "Preparar Certificado Curso Completo",
                 "cert_prepare_success": "Certificado pronto! Role para baixo para ver e baixar.", "cert_prepare_error_name": "Por favor, digite seu nome completo.",
                 "cert_download_button": "Baixar PDF", "cert_download_button_aria": "Baixar Certificado como PDF", "cert_download_error_not_ready": "Por favor, prepare um certificado primeiro.",
                 // Certificate Template Text
                 "cert_template_title": "CERTIFICADO DE CONCLUSÃO", "cert_template_subtitle": "Apresentado com Honra por Road to Free Open AGI", "cert_template_desc_intro": "Este certificado reconhece que",
                 "cert_desc_basics": "demonstrou proficiência nos conceitos fundamentais da programação Python, incluindo sintaxe básica, variáveis, tipos de dados, operações de entrada/saída e pensamento computacional.",
                 "cert_desc_flow": "dominou com sucesso as estruturas de controle de fluxo do Python, incluindo declarações condicionais (if/elif/else), loops (for/while) e operadores lógicos, aplicando-os eficazmente.",
                 "cert_desc_data": "demonstrou competência no trabalho com estruturas de dados centrais do Python como listas, dicionários e tuplas, incluindo sua criação, modificação e iteração.",
                 "cert_desc_functions": "obteve um entendimento sólido da definição e uso de funções em Python, incluindo parâmetros, valores de retorno e os fundamentos do escopo de variáveis.",
                 "cert_desc_files": "adquiriu as habilidades para ler e escrever em arquivos usando Python, e lidar com possíveis erros de forma elegante através do tratamento de exceções.",
                 "cert_desc_advanced": "explorou tópicos avançados de Python, incluindo importação de módulos, algoritmos fundamentais (busca/ordenação) e, opcionalmente, conceitos de programação orientada a objetos e recursão.",
                 "cert_desc_full": "concluiu com sucesso todos os módulos e verificações de conhecimento do curso Python Completo, demonstrando compreensão abrangente dos princípios fundamentais de programação Python e pensamento computacional.",
                 "cert_template_signature_title": "Fundador & Instrutor", "cert_template_project_name": "Road to Free Open AGI", "cert_template_date_prefix": "Concedido em", "cert_template_note": "Realização em aprendizado aberto", "cert_template_disclaimer": "Aviso: Este certificado é emitido com base na autodeclaração de conclusão das verificações de conhecimento hospedadas no GitHub Pages, sem verificação formal, supervisão ou acreditação institucional. Serve como reconhecimento do esforço dentro deste contexto específico de aprendizado aberto.",
                  // Debug Removed
                 // Chat
                 "chat_title": "Gato Assistente", "chat_initial_greeting": "Miau! Sou o Gato Assistente. Pergunte-me sobre Python, certificados ou Pensamento Computacional!", "chat_typing_indicator": "Gato Assistente está pensando", "chat_input_placeholder": "Pergunte ao Gato Assistente...", "chat_error_fetch": "Miau... desculpe, não consegui conectar ({status}).", "chat_error_generic": "Grrr! Ocorreu um erro de rede.", "chat_error_invalid_response": "Ronron..desculpe, recebi uma resposta estranha.", "chat_system_prompt": "Você é o Gato Assistente, um assistente IA amigável, fofo e prestativo com tema de gato para um curso de programação Python e Pensamento Computacional. Você sabe muito sobre sintaxe Python, conceitos como loops, funções, estruturas de dados, certificados e princípios de Pensamento Computacional. Responda de forma concisa e clara, como um gato prestativo guiando um aluno. Use trocadilhos de gato com moderação e apropriadamente. Mantenha as respostas focadas e relativamente curtas.", "chat_close_button_aria": "Fechar Chat", "chat_send_button_aria": "Enviar Mensagem", "chat_open_button_aria": "Abrir Assistente do Curso",
             },
             zh: {
                  // Shared
                 "widget_lang_title": "语言", "lang_select_aria": "选择语言", "lang_en": "🇬🇧 English", "lang_pt": "🇧🇷 Português", "lang_zh": "🇨🇳 中文", "widget_links_title": "快速链接", "link_main_site": "主网站", "footer_text": "通往自由开放AGI之路项目的一部分",
                 // Certificate Page Specific
                 "certificates_page_title": "我的证书 - Python 完全指南", "certificates_header_title": "我的证书", "link_dashboard": "返回仪表板",
                 "cert_basics_name": "基础与 I/O 证书", "cert_flow_name": "流程控制证书", "cert_data_name": "数据结构证书", "cert_functions_name": "函数证书", "cert_files_name": "文件与错误证书", "cert_advanced_name": "高级主题证书", "cert_full_name": "完整课程结业证书",
                 "cert_status_locked": "<i class='fas fa-lock'></i> 未解锁", "cert_status_inprogress": "<i class='fas fa-spinner fa-spin'></i> 进行中", "cert_status_earned": "<i class='fas fa-check-circle'></i> 已获得!",
                 "cert_progress_info_basics": "完成模块 0-4 的知识测验。", "cert_progress_info_flow": "完成模块 5-9 和 12-15 的知识测验。", "cert_progress_info_data": "完成模块 10-11 和 20-22 的知识测验。", "cert_progress_info_functions": "完成模块 16-19 的知识测验。", "cert_progress_info_files": "完成模块 23-25 的知识测验。", "cert_progress_info_advanced": "完成模块 26-32 的知识测验。", "cert_progress_info_full": "完成课程中<strong>所有</strong>的知识测验。",
                 "cert_form_name_label": "证书上的全名:", "cert_form_name_placeholder": "请输入您的全名", "cert_form_prepare_button": "准备证书",
                 "cert_prepare_button_aria": "准备基础证书", "cert_prepare_button_aria_flow": "准备流程控制证书", "cert_prepare_button_aria_data": "准备数据结构证书", "cert_prepare_button_aria_functions": "准备函数证书", "cert_prepare_button_aria_files": "准备文件与错误证书", "cert_prepare_button_aria_advanced": "准备高级主题证书", "cert_prepare_button_aria_full": "准备完整课程证书",
                 "cert_prepare_success": "证书已准备好！向下滚动查看并下载。", "cert_prepare_error_name": "请输入您的全名。",
                 "cert_download_button": "下载 PDF", "cert_download_button_aria": "下载证书为 PDF", "cert_download_error_not_ready": "请先准备证书。",
                 // Certificate Template Text
                 "cert_template_title": "结业证书", "cert_template_subtitle": "由“通往自由开放AGI之路”项目荣誉颁发", "cert_template_desc_intro": "兹证明",
                 "cert_desc_basics": "已展示出对Python编程基础概念的熟练掌握，包括基本语法、变量、数据类型、输入/输出操作和计算思维。",
                 "cert_desc_flow": "已成功掌握Python的流程控制结构，包括条件语句 (if/elif/else)、循环 (for/while) 和逻辑运算符，并能有效应用。",
                 "cert_desc_data": "已表现出使用Python核心数据结构（如列表、字典和元组）的能力，包括它们的创建、修改和迭代。",
                 "cert_desc_functions": "已对在Python中定义和使用函数有扎实的理解，包括参数、返回值和变量作用域的基础知识。",
                 "cert_desc_files": "已获得使用Python读写文件的技能，并通过异常处理优雅地处理潜在错误。",
                 "cert_desc_advanced": "已探索Python高级主题，包括模块导入、基础算法（搜索/排序）以及可选的面向对象编程和递归概念。",
                 "cert_desc_full": "已成功完成“Python完全指南”课程的所有模块和知识测验，展示了对Python基础编程和计算思维原则的全面理解。",
                 "cert_template_signature_title": "创始人兼讲师", "cert_template_project_name": "通往自由开放AGI之路", "cert_template_date_prefix": "授予日期", "cert_template_note": "开放学习成就", "cert_template_disclaimer": "免责声明：本证书基于在GitHub Pages上托管的知识测验的自我报告完成情况颁发，未经正式验证、监考或机构认证。它仅作为在此特定开放学习背景下努力的认可。",
                 // Debug Removed
                 // Chat
                 "chat_title": "猫咪助手", "chat_initial_greeting": "喵！我是猫咪助手。可以问我关于 Python、证书或计算思维的问题！", "chat_typing_indicator": "猫咪助手正在思考中", "chat_input_placeholder": "询问猫咪助手...", "chat_error_fetch": "喵呜...抱歉，无法连接 ({status})。", "chat_error_generic": "嘶！发生了网络错误。", "chat_error_invalid_response": "呼噜..不好意思，我收到了奇怪的回应。", "chat_system_prompt": "你是猫咪助手，一个友好、可爱、乐于助人的猫主题 AI 助手，用于 Python 编程和计算思维课程。你非常了解 Python 语法、循环、函数、数据结构、证书等概念，以及计算思维原则。像一只乐于助人的猫指导学生一样，简明扼要地回答问题。适度且恰当地使用猫咪相关的俏皮话。保持回答重点突出且相对简短。", "chat_close_button_aria": "关闭聊天", "chat_send_button_aria": "发送消息", "chat_open_button_aria": "打开课程助手",
             }
         };

        // --- JavaScript ---
        document.addEventListener('DOMContentLoaded', () => {

            const KNOWLEDGE_CHECK_STORAGE_KEY = 'knowledgeCheckStatus_v1';
            const TOTAL_MODULES = 33; // Needs to match dashboard
            const LANGUAGE_STORAGE_KEY = 'userLanguage';

            // DOM Elements
            const certificatePreviewSection = document.getElementById('certificatePreviewSection');
            const certificateTemplateElement = document.getElementById('certificateTemplate');
            const recipientNameElement = document.getElementById('recipientName');
            const certificateDescriptionElement = document.getElementById('certificateDescription');
            const currentDateElement = document.getElementById('currentDate');
            const downloadBtn = document.getElementById('downloadBtn');
            const languageSelectElement = document.getElementById('languageSelect');
            // const debugCheckboxes = document.querySelectorAll('.debug-checkbox'); // Removed
            const prepareButtons = document.querySelectorAll('.prepare-button');

             // --- Data Loading & Saving ---
            let knowledgeCheckStatus = {}; // Initialize empty
            function loadKnowledgeCheckStatus() { try { const storedStatus = localStorage.getItem(KNOWLEDGE_CHECK_STORAGE_KEY); const parsed = storedStatus ? JSON.parse(storedStatus) : {}; knowledgeCheckStatus = typeof parsed === 'object' && parsed !== null ? parsed : {}; console.log("Loaded KC Status:", knowledgeCheckStatus); } catch (e) { console.error("Error reading KC status from localStorage:", e); knowledgeCheckStatus = {}; } }
            function saveKnowledgeCheckStatus() { try { localStorage.setItem(KNOWLEDGE_CHECK_STORAGE_KEY, JSON.stringify(knowledgeCheckStatus)); console.log("Saved KC Status:", knowledgeCheckStatus); } catch (e) { console.error("Error saving KC status to localStorage:", e); } }

            // --- Certificate Calculation ---
            function getCertificateStatus(moduleIds, statusObject) { if (!Array.isArray(moduleIds) || moduleIds.length === 0) return 'locked'; const allComplete = moduleIds.every(id => statusObject[String(id)] === true); if (allComplete) return 'earned'; const anyComplete = moduleIds.some(id => statusObject[String(id)] === true); return anyComplete ? 'inprogress' : 'locked'; }

            // --- Translation Functions ---
            function getStoredLanguage() { const storedLang = localStorage.getItem(LANGUAGE_STORAGE_KEY); if (storedLang && translations[storedLang]) return storedLang; const browserLang = navigator.language || navigator.userLanguage; if (browserLang.startsWith('pt')) return 'pt'; if (browserLang.startsWith('zh')) return 'zh'; return 'en'; }
            function setLanguage(lang) { if (!translations[lang]) lang = 'en'; localStorage.setItem(LANGUAGE_STORAGE_KEY, lang); document.documentElement.lang = lang; if (languageSelectElement) languageSelectElement.value = lang; updatePageUI(); initializeChat(); updateCertificateTemplateText(); /* Update template if visible */ }
            function getTranslation(key, lang, replacements = {}) { let text = translations[lang]?.[key] ?? translations['en']?.[key] ?? `[${key}]`; for (const placeholder in replacements) { const regex = new RegExp(`\\{${placeholder}\\}`, 'g'); text = text.replace(regex, replacements[placeholder]); } return text; }
            function translatePage(lang) { /* Translates non-template elements */ if (!translations[lang]) lang = 'en'; document.querySelectorAll('[data-translate]').forEach(el => { const key = el.getAttribute('data-translate'); const translation = getTranslation(key, lang); if (el.closest('#certificateTemplate')) return; /* Skip template elements here */ if (el.tagName === 'TITLE') { document.title = translation; } else if (el.dataset.translatePrefix) { /* Handle date prefix outside template */ el.textContent = getTranslation(el.dataset.translatePrefix, lang) + ' ' + (el.dataset.dateValue || '[Date]'); } else if (translation.includes('<') && translation.includes('>')) { el.innerHTML = translation; } else { el.textContent = translation; } }); document.querySelectorAll('[data-translate-placeholder]').forEach(el => { const key = el.getAttribute('data-translate-placeholder'); if (el.closest('#certificateTemplate')) return; el.setAttribute('placeholder', getTranslation(key, lang)); }); document.querySelectorAll('[data-translate-aria-label]').forEach(el => { const key = el.getAttribute('data-translate-aria-label'); if (el.closest('#certificateTemplate')) return; el.setAttribute('aria-label', getTranslation(key, lang)); });}

            // --- UI Update Functions ---
            function updateCertificateCards() {
                const certificateCards = document.querySelectorAll('.certificate-card[data-certificate-id]');
                const lang = getStoredLanguage();

                certificateCards.forEach(card => {
                    const certId = card.dataset.certificateId;
                    const modulesAttr = card.dataset.modules;
                    if (!modulesAttr) return;
                    const moduleIds = modulesAttr.split(',').map(Number);
                    const status = getCertificateStatus(moduleIds, knowledgeCheckStatus);
                    const statusElement = card.querySelector('.certificate-status');

                    card.classList.remove('status-locked', 'status-inprogress', 'status-earned');
                    card.classList.add(`status-${status}`);

                    if (statusElement) { statusElement.innerHTML = getTranslation(`cert_status_${status}`, lang); }

                    // Clear previous prepare messages
                    const messageElement = card.querySelector('.prepare-message');
                     if(messageElement) {
                         messageElement.textContent = '';
                         messageElement.className = 'prepare-message'; // Reset class
                     }
                });
                 // updateDebugCheckboxes(); // Removed call
            }
             // function updateDebugCheckboxes() {} // Removed function

            function updateCertificateTemplateText() {
                 // Only run if the certificate is actually visible
                if (!certificatePreviewSection || certificatePreviewSection.style.display !== 'block') {
                    return;
                }

                const lang = getStoredLanguage();
                const certId = certificateTemplateElement.dataset.currentCertId; // Get ID stored when prepared
                const template = document.getElementById('certificateTemplate');
                if (!template) return; // Safety check

                // Translate static parts of the template using corrected selectors
                template.querySelector('h1[data-translate="cert_template_title"]').textContent = getTranslation('cert_template_title', lang);
                template.querySelector('.subtitle[data-translate="cert_template_subtitle"]').textContent = getTranslation('cert_template_subtitle', lang);
                template.querySelector('.description span[data-translate="cert_template_desc_intro"]').textContent = getTranslation('cert_template_desc_intro', lang);
                // Corrected selectors for signature:
                template.querySelector('.signature div[data-translate="cert_template_signature_title"]').textContent = getTranslation('cert_template_signature_title', lang);
                template.querySelector('.signature div[data-translate="cert_template_project_name"]').textContent = getTranslation('cert_template_project_name', lang);
                template.querySelector('.footer-note[data-translate="cert_template_note"]').textContent = getTranslation('cert_template_note', lang);
                template.querySelector('.footer-disclaimer[data-translate="cert_template_disclaimer"]').textContent = getTranslation('cert_template_disclaimer', lang);

                // Update dynamic description based on the stored certId
                if (certId && certificateDescriptionElement) {
                    certificateDescriptionElement.textContent = " " + getTranslation(`cert_desc_${certId}`, lang); // Add space before
                }

                // Update date - reconstruct with new prefix using the stored raw date value
                if (currentDateElement) {
                    const datePrefix = getTranslation('cert_template_date_prefix', lang);
                    const dateValue = currentDateElement.dataset.dateValue || '[Date]'; // Get stored raw date value
                    currentDateElement.textContent = datePrefix + ' ' + dateValue;
                }
            }

             // --- Main Page Update ---
            function updatePageUI() {
                const lang = getStoredLanguage();
                translatePage(lang);
                updateCertificateCards();
                 // If certificate is showing, update its text too (handles initial load if cert was prepared before refresh)
                updateCertificateTemplateText();
            }

            // --- Certificate Preparation & Display (Corrected) ---
            function prepareCertificate(certId, userName) {
                const lang = getStoredLanguage();
                const template = document.getElementById('certificateTemplate');
                if (!template) return; // Safety check

                // 1. Populate Dynamic Content
                recipientNameElement.textContent = userName;
                certificateDescriptionElement.textContent = " " + getTranslation(`cert_desc_${certId}`, lang); // Add space before description

                // 2. Format and Set Date
                const today = new Date();
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                let formattedDate;
                try {
                    // Attempt locale-specific formatting, fallback for safety
                    formattedDate = today.toLocaleDateString(lang + '-' + lang.toUpperCase(), dateOptions); // e.g., 'en-EN', 'pt-PT', 'zh-CN'
                } catch (e) {
                    console.warn("Could not format date for locale", lang, e);
                    // Fallback using a common English format that includes weekday
                    formattedDate = today.toLocaleDateString('en-CA', dateOptions);
                }

                const datePrefix = getTranslation('cert_template_date_prefix', lang);
                currentDateElement.textContent = datePrefix + ' ' + formattedDate;
                currentDateElement.dataset.dateValue = formattedDate; // Store the formatted date value for potential re-translation

                // 3. Translate ALL Static Template Parts Directly
                template.querySelector('h1[data-translate="cert_template_title"]').textContent = getTranslation('cert_template_title', lang);
                template.querySelector('.subtitle[data-translate="cert_template_subtitle"]').textContent = getTranslation('cert_template_subtitle', lang);
                template.querySelector('.description span[data-translate="cert_template_desc_intro"]').textContent = getTranslation('cert_template_desc_intro', lang);
                template.querySelector('.signature div[data-translate="cert_template_signature_title"]').textContent = getTranslation('cert_template_signature_title', lang);
                template.querySelector('.signature div[data-translate="cert_template_project_name"]').textContent = getTranslation('cert_template_project_name', lang);
                template.querySelector('.footer-note[data-translate="cert_template_note"]').textContent = getTranslation('cert_template_note', lang);
                template.querySelector('.footer-disclaimer[data-translate="cert_template_disclaimer"]').textContent = getTranslation('cert_template_disclaimer', lang);

                // 4. Store current cert ID for potential re-translation on language change
                certificateTemplateElement.dataset.currentCertId = certId;

                // 5. Show Preview Section & Enable Download
                certificatePreviewSection.style.display = 'block';
                downloadBtn.disabled = false;

                // 6. Scroll to certificate
                certificatePreviewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // DO NOT CALL updateCertificateTemplateText() here anymore during prepare
            }


            // --- Prepare Button Listeners ---
            prepareButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const certId = button.dataset.certificateId;
                    const card = button.closest('.certificate-card');
                    const nameInput = document.getElementById(`certNameInput-${certId}`);
                    const messageElement = document.getElementById(`prepareMessage-${certId}`);
                    const userName = nameInput ? nameInput.value.trim() : '';
                    const lang = getStoredLanguage();

                    // Check if earned (redundant due to CSS hiding, but good practice)
                    if (!card.classList.contains('status-earned')) return;

                    if (!userName) {
                        if(messageElement) {
                            messageElement.textContent = getTranslation('cert_prepare_error_name', lang);
                            messageElement.className = 'prepare-message error';
                        }
                        if(nameInput) nameInput.focus();
                        return;
                    }

                    if(messageElement) {
                        messageElement.textContent = getTranslation('cert_prepare_success', lang);
                        messageElement.className = 'prepare-message success';
                    }

                    // Call the function to populate and show the template
                    prepareCertificate(certId, userName);
                });
            });


            // --- PDF Download Function ---
            window.downloadAsPDF = function() { // Make it global for onclick
                if (certificatePreviewSection.style.display !== 'block') {
                    alert(getTranslation('cert_download_error_not_ready', getStoredLanguage()));
                    return;
                }
                // Print-specific styles are in the main CSS @media print block
                // Add a class to body for potential print-specific JS overrides if needed later
                document.body.classList.add('printing-certificate');
                window.print();
                 // Remove class after print dialog is closed/cancelled
                 // Use a timeout to ensure it's removed after print finishes processing
                setTimeout(() => {
                     document.body.classList.remove('printing-certificate');
                 }, 500);
            }

             // --- Debug Checkbox Listeners Removed ---

            // --- Language Switcher Setup ---
            if (languageSelectElement) { languageSelectElement.value = getStoredLanguage(); languageSelectElement.addEventListener('change', (e) => { setLanguage(e.target.value); }); }

            // --- Staggered Card Animation ---
            const cards = document.querySelectorAll('.certificate-card');
            cards.forEach((card, index) => { const delay = index * 0.05; card.style.animationDelay = `${delay}s`; card.classList.add('card-fade-in'); });

            // --- Chat Panel Logic ---
            const chatbotFab = document.getElementById('chatbot-fab');
            const chatPanel = document.getElementById('chat-panel');
            const chatCloseButton = document.getElementById('chat-close-button');
            const chatPanelOverlay = document.getElementById('chat-panel-overlay');
            const chatboxEl = document.getElementById('chatbox');
            const userInputEl = document.getElementById('userInput');
            const sendButtonEl = document.getElementById('sendButton');
            const bodyEl = document.body;
            function openChatPanel() { bodyEl.classList.add('chat-open'); chatbotFab.setAttribute('aria-expanded', 'true'); try{ userInputEl.focus();} catch(e){} }
            function closeChatPanel() { bodyEl.classList.remove('chat-open'); chatbotFab.setAttribute('aria-expanded', 'false'); }
            if (chatbotFab && chatPanel && chatCloseButton && chatPanelOverlay && userInputEl) {
                chatbotFab.addEventListener('click', () => { bodyEl.classList.contains('chat-open') ? closeChatPanel() : openChatPanel(); });
                chatCloseButton.addEventListener('click', closeChatPanel);
                chatPanelOverlay.addEventListener('click', closeChatPanel);
                document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && bodyEl.classList.contains('chat-open')) { closeChatPanel(); } });
            }
            // --- Chatbot Messaging Logic ---
            let conversationHistory = [];
            function displayMessage(role, textKey, replacements = {}, isRawText = false) {
                const lang = getStoredLanguage();
                const text = isRawText ? textKey : getTranslation(textKey, lang, replacements);
                const messageContainer = document.createElement('div'); messageContainer.classList.add('message-container');
                const avatar = document.createElement('div'); avatar.classList.add('message-avatar');
                const messageBubble = document.createElement('div'); messageBubble.classList.add('message');

                if (role === 'user') { messageContainer.classList.add('user-message-container'); avatar.innerHTML = '<i class="fas fa-user"></i>'; messageBubble.classList.add('user-message'); }
                 else if (role === 'assistant') { messageContainer.classList.add('bot-message-container'); avatar.innerHTML = '<i class="fas fa-cat"></i>'; messageBubble.classList.add('bot-message'); }
                 else if (role === 'error') { messageBubble.classList.add('error-message'); messageBubble.innerHTML = `<strong>Error:</strong> ${text}`; chatboxEl.appendChild(messageBubble); chatboxEl.scrollTop = chatboxEl.scrollHeight; return; }
                 else if (role === 'typing') { const typingDiv = document.createElement('div'); typingDiv.classList.add('typing-indicator'); typingDiv.innerHTML = `<i class="fas fa-paw"></i> <span>${getTranslation('chat_typing_indicator', lang)}</span> <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`; chatboxEl.appendChild(typingDiv); chatboxEl.scrollTop = chatboxEl.scrollHeight; return typingDiv; }

                 messageBubble.textContent = text; // Safer default
                 messageContainer.appendChild(avatar); messageContainer.appendChild(messageBubble); chatboxEl.appendChild(messageContainer); if(chatboxEl.scrollTo) { chatboxEl.scrollTo({ top: chatboxEl.scrollHeight, behavior: 'smooth' }); } else { chatboxEl.scrollTop = chatboxEl.scrollHeight;}
            }
             async function sendMessage() {
                 const userText = userInputEl.value.trim(); if (!userText) return;
                 displayMessage('user', userText, {}, true); conversationHistory.push({ role: "user", content: userText });
                 userInputEl.value = ''; sendButtonEl.disabled = true; userInputEl.style.height = 'auto'; // Reset height
                 const typingIndicator = displayMessage('typing', '');
                 const proxyUrl = '/api/proxy'; // Replace with your actual proxy endpoint if needed
                 const lang = getStoredLanguage();
                 const systemPrompt = { role: "system", content: getTranslation('chat_system_prompt', lang) };
                 const messagesToSend = [systemPrompt, ...conversationHistory.slice(-10)]; // Limit history slightly

                 try {
                     // **** NOTE: Replace '/api/proxy' and the body structure if your backend requires something different ****
                     const response = await fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: "glm-4-flash", messages: messagesToSend, temperature: 0.6, max_tokens: 200 }) }); // Example body
                     if (typingIndicator) typingIndicator.remove();
                     if (!response.ok) { const errorText = await response.text(); console.error(`Proxy/API Error (${response.status}):`, errorText); displayMessage('error', getTranslation('chat_error_fetch', lang, { status: response.status }), {}, true); throw new Error(`HTTP error! status: ${response.status}`); }
                     const data = await response.json();
                     if (data.choices?.[0]?.message?.content) { const botText = data.choices[0].message.content.trim(); conversationHistory.push({ role: "assistant", content: botText }); displayMessage('assistant', botText, {}, true); }
                     else { console.error("Invalid API response:", data); displayMessage('error', getTranslation('chat_error_invalid_response', lang), {}, true); }
                 } catch (error) { console.error('Chat fetch error:', error); if (typingIndicator && typingIndicator.parentNode === chatboxEl) typingIndicator.remove(); if (!chatboxEl.querySelector('.error-message')) { displayMessage('error', getTranslation('chat_error_generic', lang), {}, true); }
                 } finally { sendButtonEl.disabled = false; if (bodyEl.classList.contains('chat-open')) try{userInputEl.focus();}catch(e){} }
             }
            if (sendButtonEl && userInputEl) { sendButtonEl.addEventListener('click', sendMessage); userInputEl.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } }); userInputEl.addEventListener('input', () => { userInputEl.style.height = 'auto'; userInputEl.style.height = (userInputEl.scrollHeight) + 'px'; }); }
            function initializeChat() { const lang = getStoredLanguage(); const initialGreeting = getTranslation('chat_initial_greeting', lang); conversationHistory = [{ role: "assistant", content: initialGreeting }]; if(chatboxEl){ chatboxEl.innerHTML = ''; displayMessage('assistant', initialGreeting, {}, true); } }

            // --- Final Initialization ---
            loadKnowledgeCheckStatus(); // Load status FIRST
            updatePageUI(); // Initial render of page elements + cards
            initializeChat(); // Set up chat assistant

        }); // End DOMContentLoaded
    </script>

</body>
</html>
