<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Sim - Arcane Tome UI</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Georgia&family=Uncial+Antiqua&display=swap" rel="stylesheet">


    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --parchment: #f5e7d0; --parchment-dark: #e3d5b8; --ink: #3a3129;
            --ink-light: #5a4e42; --gold: #c9a227; --crimson: #8b0000;
            --sapphire: #1e3a8a; --amethyst: #6b21a8; --shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --glow: 0 0 10px rgba(201, 162, 39, 0.7); --fade: all 0.5s ease;
            --skin-tone: #fbe5d6; --default-outline: #222; --swatch-size: 20px;
            --danger-color: var(--crimson); --danger-hover: #6b0000;
            --modal-scrollbar-track: var(--parchment-dark); --modal-scrollbar-thumb: var(--ink-light);
            --modal-scrollbar-thumb-hover: var(--ink); --chat-min-height: 150px;
            /* Font for specific buttons */
            --tibia-like-font: 'Uncial Antiqua', cursive; /* Example font, adjust if needed */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; overflow: hidden; background-color: var(--parchment); font-family: Georgia, 'Times New Roman', Times, serif; font-size: 1.1rem; line-height: 1.6; color: var(--ink); }
        #ui-container { display: flex; flex-direction: column; width: 100vw; height: 100vh; background-color: transparent; box-sizing: border-box; position: relative; }
        #ui-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('https://www.transparenttextures.com/patterns/old-map.png'); opacity: 0.15; pointer-events: none; z-index: -1; }

        /* --- Game World & Map --- */
        #game-world { flex-grow: 1; background-color: #333; position: relative; overflow: hidden; image-rendering: pixelated; image-rendering: crisp-edges; min-height: 0; }
        #map-content { position: absolute; top: 0; left: 0; width: 3000px; height: 2000px; background-color: #4a7c2d; background-image: linear-gradient(45deg, rgba(0,0,0,0.04) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.04) 75%, rgba(0,0,0,0.04)), linear-gradient(45deg, rgba(0,0,0,0.04) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.04) 75%, rgba(0,0,0,0.04)); background-size: 12px 12px; background-position: 0 0, 6px 6px; transform: translate3d(0, 0, 0); transition: transform 0.3s linear; }

        /* --- Character Styling --- */
        .character { width: 24px; height: 36px; position: absolute; cursor: pointer; z-index: 5; background-color: transparent; border: none; margin-top: 0; transition: top 0.2s linear, left 0.2s linear, opacity 0.5s ease; transform-origin: center bottom; }
        #player { z-index: 6; }
        .character .part { position: absolute; box-sizing: border-box; transition: background-color 0.1s ease, border-color 0.1s ease; display: none; background-color: transparent; image-rendering: pixelated; image-rendering: crisp-edges; }
        .character .part.head, .character .part.torso, .character .part.legs, .character .part.arm-left, .character .part.arm-right, .character .part.detail1 { border: 1px solid var(--default-outline); }
        .character .part.head { z-index: 10; background-color: var(--skin-tone); } .character .part.torso { z-index: 5; } .character .part.legs { z-index: 4; }
        .character .part.arm-left { z-index: 6; transform-origin: 2px 1px; } .character .part.arm-right { z-index: 6; transform-origin: 1px 1px; }
        .character .part.detail1 { z-index: 7; } .character .part.detail2 { z-index: 11; } .character .part.detail3 { z-index: 3; }
        .character .part.detail4 { z-index: 12; border: none; } .character .part.detail5 { z-index: 12; border: none; }
        /* ... (All other detailed character part styles unchanged - kept for brevity) ... */
        .character.gender-male .part.head { top: 1px; left: 7px; width: 10px; height: 9px; border-radius: 2px 2px 0 0; }
        .character.gender-male .part.detail2 { display: block; top: 0px; left: 5px; width: 14px; height: 6px; border-radius: 3px 3px 1px 1px; border: 1px solid var(--default-outline); }
        .character.gender-male .part.detail3 { display: block; top: 5px; left: 6px; width: 12px; height: 6px; border-radius: 0 0 2px 2px; border: 1px solid var(--default-outline); }
        .character.gender-male.outfit-citizen .part.head, .character.gender-male.outfit-citizen .part.torso, .character.gender-male.outfit-citizen .part.legs, .character.gender-male.outfit-citizen .part.detail2, .character.gender-male.outfit-citizen .part.detail3, .character.gender-male.outfit-citizen .part.arm-left, .character.gender-male.outfit-citizen .part.arm-right { display: block; }
        .character.gender-male.outfit-citizen .part.torso { top: 9px; left: 5px; width: 14px; height: 12px; border-top-width: 2px; border-bottom: none;}
        .character.gender-male.outfit-citizen .part.legs { top: 21px; left: 6px; width: 12px; height: 9px; border-bottom-width: 3px; border-top: none; }
        .character.gender-male.outfit-citizen .part.arm-left { top: 10px; left: 2px; width: 3px; height: 10px; border-radius: 1px; }
        .character.gender-male.outfit-citizen .part.arm-right { top: 10px; left: 19px; width: 3px; height: 10px; border-radius: 1px; }
        .character.gender-male.outfit-mage .part.head, .character.gender-male.outfit-mage .part.torso, .character.gender-male.outfit-mage .part.legs, .character.gender-male.outfit-mage .part.detail1, .character.gender-male.outfit-mage .part.detail4, .character.gender-male.outfit-mage .part.arm-left, .character.gender-male.outfit-mage .part.arm-right { display: block; }
        .character.gender-male.outfit-mage .part.detail2, .character.gender-male.outfit-mage .part.detail3 { display: none; }
        .character.gender-male.outfit-mage .part.detail4 { top: -4px; left: 4px; width: 16px; height: 10px; border-radius: 50% 50% 0 0 / 40% 40% 0 0; border: 1px solid var(--default-outline); border-bottom: none; clip-path: polygon(50% 0%, 100% 100%, 0% 100%); }
        .character.gender-male.outfit-mage .part.torso { top: 9px; left: 4px; width: 16px; height: 18px; }
        .character.gender-male.outfit-mage .part.legs { top: 27px; left: 6px; width: 12px; height: 6px; border-bottom-width: 3px; border-top: none; }
        .character.gender-male.outfit-mage .part.detail1 { top: 18px; left: 4px; width: 16px; height: 3px; }
        .character.gender-male.outfit-mage .part.arm-left { top: 11px; left: 1px; width: 4px; height: 10px; }
        .character.gender-male.outfit-mage .part.arm-right { top: 11px; left: 19px; width: 4px; height: 10px; }
        .character.gender-male.outfit-warrior .part.head, .character.gender-male.outfit-warrior .part.torso, .character.gender-male.outfit-warrior .part.legs, .character.gender-male.outfit-warrior .part.detail1, .character.gender-male.outfit-warrior .part.detail2, .character.gender-male.outfit-warrior .part.detail3, .character.gender-male.outfit-warrior .part.detail4, .character.gender-male.outfit-warrior .part.detail5, .character.gender-male.outfit-warrior .part.arm-left, .character.gender-male.outfit-warrior .part.arm-right { display: block; }
        .character.gender-male.outfit-warrior .part.detail4 { top: 0px; left: 1px; width: 7px; height: 10px; border-radius: 3px 0 0 0; border-width: 1px; border-style: outset; }
        .character.gender-male.outfit-warrior .part.detail5 { top: 0px; left: 16px; width: 7px; height: 10px; border-radius: 0 3px 0 0; border-width: 1px; border-style: outset; }
        .character.gender-male.outfit-warrior .part.head { border-radius: 1px; }
        .character.gender-male.outfit-warrior .part.torso { top: 9px; left: 4px; width: 16px; height: 13px; border-width: 2px; border-style: outset; }
        .character.gender-male.outfit-warrior .part.legs { top: 22px; left: 5px; width: 14px; height: 8px; border-bottom-width: 4px; border-style: outset; border-top: none;}
        .character.gender-male.outfit-warrior .part.detail1 { top: 18px; left: 4px; width: 16px; height: 4px; }
        .character.gender-male.outfit-warrior .part.arm-left { top: 11px; left: 1px; width: 4px; height: 10px; }
        .character.gender-male.outfit-warrior .part.arm-right { top: 11px; left: 19px; width: 4px; height: 10px; }
        .character.gender-male.outfit-scifi .part.head, .character.gender-male.outfit-scifi .part.torso, .character.gender-male.outfit-scifi .part.legs, .character.gender-male.outfit-scifi .part.detail1, .character.gender-male.outfit-scifi .part.detail2, .character.gender-male.outfit-scifi .part.detail3, .character.gender-male.outfit-scifi .part.arm-left, .character.gender-male.outfit-scifi .part.arm-right { display: block; }
        .character.gender-male.outfit-scifi .part.head { top: 1px; left: 7px; width: 10px; height: 9px; border-radius: 2px; }
        .character.gender-male.outfit-scifi .part.torso { top: 9px; left: 5px; width: 14px; height: 13px; border-style: solid; border-width: 1px 2px;}
        .character.gender-male.outfit-scifi .part.legs { top: 22px; left: 6px; width: 12px; height: 9px; border-bottom-width: 3px; border-style: solid; border-width: 1px 2px;}
        .character.gender-male.outfit-scifi .part.detail1 { top: 11px; left: 8px; width: 8px; height: 5px; border-radius: 1px; z-index: 7; }
        .character.gender-male.outfit-scifi .part.arm-left { top: 10px; left: 2px; width: 4px; height: 11px; border-radius: 1px;}
        .character.gender-male.outfit-scifi .part.arm-right { top: 10px; left: 18px; width: 4px; height: 11px; border-radius: 1px;}
        .character.gender-male.outfit-ranger .part.head, .character.gender-male.outfit-ranger .part.torso, .character.gender-male.outfit-ranger .part.legs, .character.gender-male.outfit-ranger .part.detail1, .character.gender-male.outfit-ranger .part.detail2, .character.gender-male.outfit-ranger .part.detail3, .character.gender-male.outfit-ranger .part.arm-left, .character.gender-male.outfit-ranger .part.arm-right { display: block; }
        .character.gender-male.outfit-ranger .part.torso { top: 9px; left: 5px; width: 14px; height: 13px; }
        .character.gender-male.outfit-ranger .part.legs { top: 22px; left: 6px; width: 12px; height: 9px; border-bottom-width: 3px; }
        .character.gender-male.outfit-ranger .part.detail1 { top: 18px; left: 5px; width: 14px; height: 4px; }
        .character.gender-male.outfit-ranger .part.arm-left { top: 10px; left: 2px; width: 4px; height: 11px; }
        .character.gender-male.outfit-ranger .part.arm-right { top: 10px; left: 18px; width: 4px; height: 11px; }
        .character.gender-male.outfit-kimono .part.head, .character.gender-male.outfit-kimono .part.torso, .character.gender-male.outfit-kimono .part.legs, .character.gender-male.outfit-kimono .part.detail1, .character.gender-male.outfit-kimono .part.detail2, .character.gender-male.outfit-kimono .part.detail3, .character.gender-male.outfit-kimono .part.arm-left, .character.gender-male.outfit-kimono .part.arm-right { display: block; }
        .character.gender-male.outfit-kimono .part.torso { top: 9px; left: 4px; width: 16px; height: 18px; border-radius: 1px; border-right-width: 2px; border-left-width: 2px;}
        .character.gender-male.outfit-kimono .part.legs { top: 27px; left: 6px; width: 12px; height: 6px; border-bottom-width: 3px; border-top: none; }
        .character.gender-male.outfit-kimono .part.detail1 { top: 16px; left: 4px; width: 16px; height: 5px; z-index: 7; }
        .character.gender-male.outfit-kimono .part.arm-left { top: 10px; left: 0px; width: 6px; height: 15px; border-radius: 0 0 2px 2px; }
        .character.gender-male.outfit-kimono .part.arm-right { top: 10px; left: 18px; width: 6px; height: 15px; border-radius: 0 0 2px 2px; }
        .character.gender-female .part.head { width: 12px; height: 11px; left: 6px; top: 1px; border-radius: 40% 40% 35% 35%; }
        .character.gender-female .part.detail3 { display: block; top: 4px; left: 4px; width: 16px; height: 20px; border-radius: 0 0 10px 10px; border: none; }
        .character.gender-female .part.detail2 { display: block; top: 1px; left: 5px; width: 14px; height: 8px; border-radius: 5px 5px 2px 2px; border: none; border-bottom: 1px solid #111;}
        .character.gender-female.outfit-citizen .part.head, .character.gender-female.outfit-citizen .part.torso, .character.gender-female.outfit-citizen .part.legs, .character.gender-female.outfit-citizen .part.detail1, .character.gender-female.outfit-citizen .part.detail2, .character.gender-female.outfit-citizen .part.detail3, .character.gender-female.outfit-citizen .part.arm-left, .character.gender-female.outfit-citizen .part.arm-right { display: block; }
        .character.gender-female.outfit-citizen .part.torso { top: 10px; left: 7px; width: 10px; height: 11px; border-radius: 2px; }
        .character.gender-female.outfit-citizen .part.detail1 { top: 18px; left: 6px; width: 12px; height: 3px; border-radius: 1px; }
        .character.gender-female.outfit-citizen .part.legs { top: 21px; left: 5px; width: 14px; height: 10px; border-bottom-width: 3px; border-top: none; border-radius: 0 0 5px 5px; }
        .character.gender-female.outfit-citizen .part.arm-left { top: 11px; left: 4px; width: 3px; height: 6px; border-radius: 1px; }
        .character.gender-female.outfit-citizen .part.arm-right { top: 11px; left: 17px; width: 3px; height: 6px; border-radius: 1px; }
        .character.gender-female.outfit-mage .part.head, .character.gender-female.outfit-mage .part.torso, .character.gender-female.outfit-mage .part.legs, .character.gender-female.outfit-mage .part.detail1, .character.gender-female.outfit-mage .part.detail2, .character.gender-female.outfit-mage .part.detail3, .character.gender-female.outfit-mage .part.arm-left, .character.gender-female.outfit-mage .part.arm-right { display: block; }
        .character.gender-female.outfit-mage .part.head { top: 2px; }
        .character.gender-female.outfit-mage .part.detail2 { top: 1px; left: 4px; width: 16px; height: 9px; border-radius: 6px 6px 3px 3px; }
        .character.gender-female.outfit-mage .part.detail3 { top: 5px; left: 4px; width: 16px; height: 22px; border-radius: 0 0 10px 10px;}
        .character.gender-female.outfit-mage .part.torso { top: 11px; left: 5px; width: 14px; height: 18px; border-radius: 2px; }
        .character.gender-female.outfit-mage .part.detail1 { top: 14px; left: 9px; width: 6px; height: 4px; border-radius: 50%; z-index: 7; }
        .character.gender-female.outfit-mage .part.legs { top: 29px; left: 6px; width: 12px; height: 5px; border-bottom-width: 2px; border-top: none; border-radius: 0 0 3px 3px;}
        .character.gender-female.outfit-mage .part.arm-left { top: 12px; left: 1px; width: 5px; height: 15px; border-radius: 0 0 3px 3px; }
        .character.gender-female.outfit-mage .part.arm-right { top: 12px; left: 18px; width: 5px; height: 15px; border-radius: 0 0 3px 3px; }
        .character.gender-female.outfit-warrior .part.head, .character.gender-female.outfit-warrior .part.torso, .character.gender-female.outfit-warrior .part.legs, .character.gender-female.outfit-warrior .part.detail1, .character.gender-female.outfit-warrior .part.detail2, .character.gender-female.outfit-warrior .part.detail3, .character.gender-female.outfit-warrior .part.arm-left, .character.gender-female.outfit-warrior .part.arm-right { display: block; }
        .character.gender-female.outfit-warrior .part.torso { top: 10px; left: 6px; width: 12px; height: 11px; border-radius: 3px 3px 1px 1px; border-style: solid; border-width: 1px; }
        .character.gender-female.outfit-warrior .part.detail1 { top: 20px; left: 4px; width: 16px; height: 7px; border-radius: 0 0 4px 4px; border-style: outset; }
        .character.gender-female.outfit-warrior .part.legs { top: 27px; left: 7px; width: 10px; height: 6px; border-bottom-width: 3px; border-top: none; }
        .character.gender-female.outfit-warrior .part.arm-left { top: 11px; left: 3px; width: 3px; height: 9px; border-radius: 1px; border-style: outset; border-width: 1px; }
        .character.gender-female.outfit-warrior .part.arm-right { top: 11px; left: 18px; width: 3px; height: 9px; border-radius: 1px; border-style: outset; border-width: 1px; }
        .character.gender-female.outfit-warrior .part.detail2 { top: 1px; height: 7px; left: 4px; width: 16px;}
        .character.gender-female.outfit-warrior .part.detail3 { height: 22px;}
        .character.gender-female.outfit-scifi .part.head, .character.gender-female.outfit-scifi .part.torso, .character.gender-female.outfit-scifi .part.legs, .character.gender-female.outfit-scifi .part.detail1, .character.gender-female.outfit-scifi .part.detail2, .character.gender-female.outfit-scifi .part.detail3, .character.gender-female.outfit-scifi .part.arm-left, .character.gender-female.outfit-scifi .part.arm-right { display: block; }
        .character.gender-female.outfit-scifi .part.torso { top: 10px; left: 6px; width: 12px; height: 12px; border-style: solid; border-width: 1px; border-radius: 2px; }
        .character.gender-female.outfit-scifi .part.legs { top: 22px; left: 7px; width: 10px; height: 9px; border-bottom-width: 3px; border-style: solid; border-width: 1px; }
        .character.gender-female.outfit-scifi .part.detail1 { top: 11px; left: 9px; width: 6px; height: 4px; border-radius: 1px; z-index: 7;}
        .character.gender-female.outfit-scifi .part.arm-left { top: 11px; left: 3px; width: 3px; height: 11px; border-radius: 1px; }
        .character.gender-female.outfit-scifi .part.arm-right { top: 11px; left: 18px; width: 3px; height: 11px; border-radius: 1px; }
        .character.gender-female.outfit-ranger .part.head, .character.gender-female.outfit-ranger .part.torso, .character.gender-female.outfit-ranger .part.legs, .character.gender-female.outfit-ranger .part.detail1, .character.gender-female.outfit-ranger .part.detail2, .character.gender-female.outfit-ranger .part.detail3, .character.gender-female.outfit-ranger .part.arm-left, .character.gender-female.outfit-ranger .part.arm-right { display: block; }
        .character.gender-female.outfit-ranger .part.torso { top: 10px; left: 6px; width: 12px; height: 13px; border-radius: 1px; }
        .character.gender-female.outfit-ranger .part.legs { top: 23px; left: 7px; width: 10px; height: 8px; border-bottom-width: 3px;}
        .character.gender-female.outfit-ranger .part.detail1 { top: 19px; left: 6px; width: 12px; height: 4px; z-index: 7;}
        .character.gender-female.outfit-ranger .part.arm-left { top: 11px; left: 3px; width: 3px; height: 11px; }
        .character.gender-female.outfit-ranger .part.arm-right { top: 11px; left: 18px; width: 3px; height: 11px; }
        .character.gender-female.outfit-kimono .part.head, .character.gender-female.outfit-kimono .part.torso, .character.gender-female.outfit-kimono .part.legs, .character.gender-female.outfit-kimono .part.detail1, .character.gender-female.outfit-kimono .part.detail2, .character.gender-female.outfit-kimono .part.detail3, .character.gender-female.outfit-kimono .part.arm-left, .character.gender-female.outfit-kimono .part.arm-right { display: block; }
        .character.gender-female.outfit-kimono .part.torso { top: 10px; left: 4px; width: 16px; height: 17px; border-radius: 1px; border-right-width: 2px; border-left-width: 2px; border-style: solid;}
        .character.gender-female.outfit-kimono .part.legs { top: 27px; left: 7px; width: 10px; height: 7px; border-bottom-width: 2px; border-top: none;}
        .character.gender-female.outfit-kimono .part.detail1 { top: 17px; left: 4px; width: 16px; height: 7px; border-radius: 1px;}
        .character.gender-female.outfit-kimono .part.arm-left { top: 11px; left: 0px; width: 6px; height: 18px; border-radius: 0 0 6px 2px; }
        .character.gender-female.outfit-kimono .part.arm-right { top: 11px; left: 18px; width: 6px; height: 18px; border-radius: 0 0 2px 6px; }
        @keyframes playerBobbing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } }
        @keyframes playerWalkArmLeft { 0%, 100% { transform: rotate(-10deg) translateX(0px); } 50% { transform: rotate(8deg) translateX(0px); } }
        @keyframes playerWalkArmRight { 0%, 100% { transform: rotate(8deg) translateX(0px); } 50% { transform: rotate(-10deg) translateX(0px); } }
        @keyframes playerWalkLegs { 0%, 100% { transform: translateX(0px); } 50% { transform: translateX(-0.5px); } }
        #player.is-walking { animation: playerBobbing 0.5s infinite ease-in-out; }
        #player.is-walking .part.arm-left { animation: playerWalkArmLeft 0.5s infinite ease-in-out; }
        #player.is-walking .part.arm-right { animation: playerWalkArmRight 0.5s infinite ease-in-out; }
        #player.is-walking .part.legs { animation: playerWalkLegs 0.5s infinite ease-in-out; }
        .character .character-name-plate { position: absolute; bottom: calc(100% + 10px); left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: bold; white-space: nowrap; text-shadow: 1px 1px 1px #000; z-index: 11; border: 1px solid rgba(255, 255, 255, 0.2); pointer-events: none; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        .character .speech { display: none; }

        /* --- Environment Zones --- */
        .environment-zone { position: absolute; border: 2px dashed rgba(58, 49, 41, 0.5); background-color: rgba(58, 49, 41, 0.08); border-radius: 8px; display: flex; justify-content: center; align-items: flex-start; padding-top: 8px; pointer-events: none; box-sizing: border-box; z-index: 1; color: var(--ink-light); font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .environment-name-plate { background-color: rgba(58, 49, 41, 0.6); color: var(--parchment); padding: 3px 8px; border-radius: 4px; white-space: nowrap; border: 1px solid rgba(245, 231, 208, 0.3); }

        /* --- Chat Area & Messages --- */
        #chat-area { flex-basis: 300px; min-height: var(--chat-min-height); display: flex; flex-direction: column; background: var(--parchment-dark); flex-shrink: 0; position: relative; border-top: 2px solid var(--ink-light); transition: flex-basis 0.3s ease-out; }
        /* --- NEW: Chat Tabs --- */
        #chat-tabs-container {
            display: flex;
            padding: 5px 15px; /* Adjust padding */
            gap: 10px; /* Spacing between buttons */
            background-color: var(--parchment-dark);
            border-bottom: 1px solid var(--ink-light);
            flex-shrink: 0; /* Prevent shrinking */
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease; /* Smooth transition */
            max-height: 100px; /* Allow space */
            overflow: hidden; /* Needed for transition */
            opacity: 1;
        }
        #chat-tabs-container.hidden {
           max-height: 0; /* Collapse */
           padding-top: 0;
           padding-bottom: 0;
           opacity: 0;
           border-bottom: none; /* Hide border when hidden */
        }
        #chat-tabs-container button {
            background-color: var(--parchment);
            border: 1px solid var(--ink-light);
            border-radius: 6px; /* Rounded corners */
            padding: 6px 18px; /* Adjust padding */
            color: var(--ink);
            font-size: 1rem; /* Adjust font size */
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            font-family: Georgia, serif; /* Default font */
        }
        #chat-tabs-container button:hover {
            background-color: var(--parchment-dark);
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        #chat-tabs-container button#general-tab {
            font-weight: bold; /* Make GENERAL bold */
            font-family: 'Cinzel Decorative', cursive; /* Use a more decorative font */
            padding: 6px 22px; /* Slightly more padding */
        }
        #chat-tabs-container button#area-tab,
        #chat-tabs-container button#city-tab,
        #chat-tabs-container button#world-tab,
        #chat-tabs-container button#message-tab {
            font-family: var(--tibia-like-font); /* Apply special font */
            text-transform: uppercase; /* Make text uppercase */
            font-size: 0.9rem; /* Slightly smaller if needed */
        }
        /* --- End Chat Tabs --- */
        .chat-messages { flex: 1; padding: 25px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--ink-light) var(--parchment-dark); display: flex; flex-direction: column; gap: 20px; background-color: var(--parchment); }
        .chat-messages::-webkit-scrollbar { width: 8px; } .chat-messages::-webkit-scrollbar-track { background: var(--parchment-dark); } .chat-messages::-webkit-scrollbar-thumb { background-color: var(--ink-light); border-radius: 4px; }
        .message { display: flex; gap: 15px; max-width: 85%; animation: appear 0.8s ease-out; }
        .message-user { align-self: flex-end; flex-direction: row-reverse; } .message-spirit { align-self: flex-start; }
        .message-system, .message-debug { align-self: flex-start; opacity: 0.8; font-size: 0.9em;}
        .message-system .message-content, .message-debug .message-content { background-color: var(--parchment-dark); border: 1px dashed var(--ink-light); }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--parchment-dark); box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; font-family: 'Cinzel Decorative', cursive; font-size: 1.5rem; transition: var(--fade); color: white; cursor: pointer; /* Make all clickable */ }
        .user-avatar { background-color: var(--sapphire); } .spirit-avatar { background-color: var(--amethyst); }
        .system-avatar, .debug-avatar { background-color: var(--ink-light); font-size: 1.2rem; } /* System avatar is now clickable too */
        .spirit-avatar:hover, .user-avatar:hover, .system-avatar:hover, .debug-avatar:hover { transform: scale(1.1); box-shadow: var(--glow); } /* Hover effect added to system/debug */
        .message-content { padding: 18px 22px; border-radius: 8px; line-height: 1.6; position: relative; word-break: break-word; box-shadow: var(--shadow); max-width: 100%; font-size: 1.1rem; }
        .message-content p { margin-bottom: 1em; } .message-content p:last-child { margin-bottom: 0; }
        .message-content strong { font-weight: bold; color: var(--ink); } .message-content em { font-style: italic; }
        .message-content ul, .message-content ol { margin-left: 1.5em; margin-bottom: 1em; } .message-content li { margin-bottom: 0.5em; }
        .message-content code { font-family: monospace; background-color: rgba(0, 0, 0, 0.1); padding: 0.2em 0.4em; border-radius: 3px; }
        .message-content pre { position: relative; background-color: rgba(0, 0, 0, 0.1); padding: 1em; border-radius: 5px; overflow-x: auto; margin-bottom: 1em; font-family: monospace; font-size: 0.95em; }
        .copy-code-btn { position: absolute; top: 5px; right: 5px; background-color: var(--gold); color: var(--ink); border: none; border-radius: 3px; padding: 3px 8px; font-size: 0.8rem; cursor: pointer; opacity: 0; transition: opacity 0.3s ease; }
        .message-content pre:hover .copy-code-btn { opacity: 1; } .copy-code-btn:hover { background-color: var(--crimson); color: white; }
        .copy-code-btn.copied { background-color: var(--sapphire); color: white; }
        .message-content blockquote { border-left: 3px solid var(--gold); padding-left: 1em; margin-left: 0; margin-bottom: 1em; color: var(--ink-light); }
        .user-message { background-color: var(--sapphire); color: white; border-top-right-radius: 0; }
        .spirit-message { background-color: white; color: var(--ink); border: 1px solid var(--ink-light); border-top-left-radius: 0; }
        .system-message, .debug-message { background-color: var(--parchment-dark); color: var(--ink-light); border: 1px dashed var(--ink-light); border-top-left-radius: 0; font-style: italic; }
        .system-message .message-name, .debug-message .message-name { font-weight: bold; margin-right: 5px; display: inline-block; }
        .typing-indicator { display: inline-flex; align-items: center; gap: 8px; padding: 15px 20px; background-color: var(--parchment-dark); border-radius: 8px; box-shadow: var(--shadow); align-self: flex-start; color: var(--ink-light); font-style: italic; border: 1px dashed var(--ink-light); position: relative; overflow: hidden; font-size: 1rem; margin-left: 65px; }
        .typing-indicator::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(201, 162, 39, 0.2), transparent); animation: shimmer 2s infinite; }
        .rune { font-family: 'Cinzel Decorative', cursive; font-size: 1.2rem; animation: float 2s infinite ease-in-out; margin-left: 5px; }

        /* --- Input Area --- */
        .input-container { padding: 18px; background-color: var(--parchment-dark); border-top: none; display: flex; gap: 12px; align-items: flex-end; flex-shrink: 0; }
        #userInput { flex: 1; padding: 18px; background-color: var(--parchment); border: 2px solid var(--ink-light); border-radius: 5px; font-family: inherit; font-size: 1.1rem; resize: none; outline: none; color: var(--ink); min-height: 60px; max-height: 200px; line-height: 1.5; overflow-y: auto; }
        #userInput:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.3); }
        #userInput::placeholder { color: var(--ink-light); font-style: italic; }
        #sendButton { background-color: var(--gold); color: var(--ink); border: none; border-radius: 5px; padding: 0 24px; height: 60px; font-family: 'Cinzel Decorative', cursive; font-weight: bold; cursor: pointer; transition: var(--fade); box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.1rem; flex-shrink: 0; align-self: flex-end; }
        #sendButton:hover:not(:disabled) { background-color: var(--crimson); color: white; }
        #sendButton:disabled { opacity: 0.7; cursor: not-allowed; background-color: var(--ink-light); color: var(--parchment); }

        /* --- Settings Modal (Paginated) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: var(--fade); }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background-color: var(--parchment); color: var(--ink); border-radius: 8px;
            width: 90%; max-width: 800px; padding: 0; /* Remove padding here */
            box-shadow: var(--shadow); transform: translateY(20px); transition: var(--fade);
            max-height: 85vh; display: flex; flex-direction: column;
            border: 1px solid var(--ink-light); overflow: hidden; /* Prevent children overflowing visually */
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 0; /* Adjusted */ border-bottom: 1px solid var(--ink-light);
            padding: 20px 28px 15px 28px; /* Added padding */ flex-shrink: 0;
        }
        .modal-title { font-family: 'Cinzel Decorative', cursive; font-size: 1.5rem; color: var(--ink); }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: var(--ink-light); font-size: 1.8rem; line-height: 1; transition: var(--fade); }
        .modal-close-btn:hover { color: var(--crimson); }
        .modal-body {
            flex-grow: 1; overflow: hidden; display: flex; flex-direction: column;
            min-height: 300px; padding: 0 28px; /* Added horizontal padding */
        }
        .settings-page { display: none; flex-grow: 1; overflow-y: auto; padding: 20px 5px 20px 0; /* Adjusted padding (added top/bottom, removed right for scrollbar)*/ scrollbar-width: thin; scrollbar-color: var(--modal-scrollbar-thumb) var(--modal-scrollbar-track); }
        .settings-page.active { display: block; }
        .settings-page::-webkit-scrollbar { width: 8px; } .settings-page::-webkit-scrollbar-track { background: var(--modal-scrollbar-track); border-radius: 4px; } .settings-page::-webkit-scrollbar-thumb { background-color: var(--modal-scrollbar-thumb); border-radius: 4px; border: 1px solid var(--modal-scrollbar-track); } .settings-page::-webkit-scrollbar-thumb:hover { background-color: var(--modal-scrollbar-thumb-hover); }
        .settings-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px dashed var(--ink-light); } .settings-section:last-child { border-bottom: none; margin-bottom: 0; }
        .settings-section-title { font-size: 1.3rem; font-weight: bold; color: var(--ink); margin-bottom: 15px; border-bottom: 1px solid var(--gold); padding-bottom: 8px; font-family: 'Cinzel Decorative', cursive; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .settings-item { background-color: var(--parchment-dark); padding: 15px; border-radius: 6px; border: 1px solid var(--ink-light); position: relative; }
        .settings-label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color: var(--ink); }
        .settings-input, .settings-textarea, .settings-select { /* Added .settings-select */
            width: 100%; padding: 10px 12px; border: 1px solid var(--ink-light); border-radius: 4px;
            font-family: inherit; font-size: 1rem; background-color: var(--parchment); color: var(--ink);
            margin-bottom: 10px; box-sizing: border-box; line-height: 1.5;
        }
        .settings-textarea { min-height: 80px; resize: vertical; }
        .settings-input:focus, .settings-textarea:focus, .settings-select:focus { /* Added .settings-select */
            border-color: var(--gold); outline: none; box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.3);
        }
        .settings-select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%233a3129'%3E%3Cpath d='M6 8L0 0h12z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px; padding-right: 30px; }
        .settings-env-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; position: relative; padding-right: 30px; }
        .settings-env-label { flex-shrink: 0; width: 80px; text-align: right; font-weight: normal; color: var(--ink); }
        .settings-env-input { flex-grow: 1; }
        .settings-delete-btn { position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; line-height: 18px; text-align: center; background-color: var(--danger-color); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; font-weight: bold; transition: background-color 0.2s ease; padding: 0; }
        .settings-delete-btn:hover { background-color: var(--danger-hover); }
        .settings-env-item .settings-delete-btn { top: 50%; right: 5px; transform: translateY(-50%); }
        .settings-city-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .settings-city-controls label { font-weight: bold; color: var(--ink); flex-shrink: 0; margin-right: 5px; }
        .settings-city-selector { /* Keep as settings-select */
             padding: 8px 10px; border-radius: 4px; border: 1px solid var(--ink-light); background-color: var(--parchment);
             color: var(--ink); font-size: 1rem; flex-grow: 1; min-width: 150px; font-family: inherit;
             appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%233a3129'%3E%3Cpath d='M6 8L0 0h12z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px; padding-right: 30px;
        }
        .settings-city-edit-btn { padding: 6px 10px; font-size: 1rem; height: 38px; /* Match select height approx */ line-height: 1; border-radius: 6px; background-color: var(--ink-light); color: var(--parchment); border: none; cursor: pointer; flex-shrink: 0; transition: var(--fade); font-family: 'Cinzel Decorative', cursive; display: inline-flex; align-items: center; justify-content: center;}
        .settings-city-edit-btn:hover { background-color: var(--ink); }
        .settings-city-delete-btn { background-color: var(--danger-color); color: white; } .settings-city-delete-btn:hover { background-color: var(--danger-hover); }
        .settings-city-add-btn { background-color: var(--gold); color: var(--ink); } .settings-city-add-btn:hover { background-color: #a1801f; }
        .settings-api-key-section { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .settings-api-key-input { flex-grow: 1; padding: 10px 12px; border: 1px solid var(--ink-light); border-radius: 4px; font-family: inherit; font-size: 1rem; background-color: var(--parchment); color: var(--ink); box-sizing: border-box; }
        .settings-api-key-input:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.3); }
        .settings-api-key-btn { padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: var(--fade); border: none; font-size: 1rem; background-color: var(--ink-light); color: var(--parchment); font-family: 'Cinzel Decorative', cursive;}
        .settings-api-key-btn:hover { background-color: var(--ink); }
        #removeAllApiKeysBtn { background-color: var(--danger-color); color: white; margin-top: 10px; } #removeAllApiKeysBtn:hover { background-color: var(--danger-hover); }
        .map-size-inputs { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .map-size-inputs input[type="number"] { width: 80px; padding: 8px 10px; font-size: 1rem; border: 1px solid var(--ink-light); background-color: var(--parchment); color: var(--ink); border-radius: 4px;}
        .map-size-inputs label { font-size: 1rem; color: var(--ink); margin-right: 5px; }
        .settings-checkbox-item { display: flex; align-items: center; gap: 8px; background-color: var(--parchment-dark); padding: 10px 15px; border-radius: 6px; border: 1px solid var(--ink-light); }
        .settings-checkbox-item label { font-size: 1rem; color: var(--ink); cursor: pointer; user-select: none; }
        .settings-checkbox-item input[type="checkbox"] { cursor: pointer; accent-color: var(--gold); }
        .settings-pagination {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 0; /* Adjusted */ padding: 15px 28px; /* Added padding */
            border-top: 1px solid var(--ink-light); flex-shrink: 0;
        }
        .pagination-btn { padding: 8px 16px; border-radius: 5px; font-family: 'Cinzel Decorative', cursive; font-weight: bold; cursor: pointer; transition: var(--fade); border: none; font-size: 1rem; background-color: var(--ink-light); color: var(--parchment); }
        .pagination-btn:hover:not(:disabled) { background-color: var(--ink); }
        .pagination-btn:disabled { background-color: var(--parchment-dark); color: var(--ink-light); cursor: not-allowed; }
        .page-indicator { font-size: 1rem; color: var(--ink-light); font-weight: bold; }
        .modal-footer {
            margin-top: 0; /* Adjusted */ padding: 15px 28px 20px 28px; /* Added padding */
            border-top: 1px solid var(--ink-light); display: flex; justify-content: flex-end;
            gap: 10px; flex-shrink: 0; background-color: var(--parchment-dark); /* Match bg */
        }
        .modal-btn { padding: 12px 24px; border-radius: 5px; font-family: 'Cinzel Decorative', cursive; font-weight: bold; cursor: pointer; transition: var(--fade); border: none; font-size: 1.1rem; }
        .modal-btn-primary { background-color: var(--gold); color: var(--ink); } .modal-btn-primary:hover { background-color: var(--crimson); color: white; }
        .modal-btn-secondary { background-color: var(--ink-light); color: var(--parchment); } .modal-btn-secondary:hover { background-color: var(--ink); color: white; }


        /* --- Appearance Editor Modal --- */
        #appearance-editor-overlay .modal-content { max-width: 900px; }
        #appearance-editor-overlay .modal-body { overflow-y: auto; padding: 20px 28px 20px 28px; /* Use same padding as settings */ flex-grow: 1; scrollbar-width: thin; scrollbar-color: var(--modal-scrollbar-thumb) var(--modal-scrollbar-track); touch-action: pan-y; -webkit-overflow-scrolling: touch; min-height: 0; }
        #appearance-editor-overlay .modal-body::-webkit-scrollbar { width: 8px; } #appearance-editor-overlay .modal-body::-webkit-scrollbar-track { background: var(--modal-scrollbar-track); border-radius: 4px; } #appearance-editor-overlay .modal-body::-webkit-scrollbar-thumb { background-color: var(--modal-scrollbar-thumb); border-radius: 4px; border: 1px solid var(--modal-scrollbar-track); } #appearance-editor-overlay .modal-body::-webkit-scrollbar-thumb:hover { background-color: var(--modal-scrollbar-thumb-hover); }
        .appearance-editor-details { padding: 15px; background-color: var(--parchment-dark); border: 1px solid var(--ink-light); border-radius: 6px; margin-bottom: 15px; display: grid; grid-template-columns: auto 1fr auto; gap: 10px 15px; align-items: center; }
        .appearance-editor-details label { font-weight: bold; font-size: 1rem; color: var(--ink); text-align: right; }
        .appearance-editor-details input, .appearance-editor-details textarea { grid-column: 2; width: 100%; padding: 10px 12px; border: 1px solid var(--ink-light); border-radius: 4px; font-family: inherit; font-size: 1rem; background-color: var(--parchment); color: var(--ink); box-sizing: border-box; }
        .appearance-editor-details textarea { min-height: 60px; resize: vertical; line-height: 1.5; }
        .appearance-editor-details input:focus, .appearance-editor-details textarea:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.3); }
        .appearance-pfp-section { grid-column: 3; display: flex; flex-direction: column; align-items: center; gap: 8px; padding-left: 15px; }
        .appearance-pfp-preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--ink-light); cursor: pointer; transition: border-color 0.3s ease; }
        .appearance-pfp-preview:hover { border-color: var(--gold); }
        .appearance-pfp-change-btn { font-size: 0.9rem; color: var(--ink-light); cursor: pointer; text-decoration: underline; background: none; border: none; padding: 0; }
        .appearance-pfp-change-btn:hover { color: var(--gold); }
        .appearance-iframe-container { border: 1px solid var(--ink-light); padding: 0; background-color: var(--parchment-dark); border-radius: 6px; overflow: hidden; flex-shrink: 0; }
        #characterCreatorFrame { width: 100%; height: 500px; border: none; display: block; background-color: var(--ink-light); }
        .pfp-upload { display: none; }

        /* --- Context Menu --- */
        .context-menu { display: none; position: absolute; background-color: var(--parchment-dark); border: 1px solid var(--ink-light); border-radius: 4px; padding: 5px 0; z-index: 1050; box-shadow: var(--shadow); min-width: 180px; font-size: 1rem; color: var(--ink); font-family: Georgia, serif; }
        .context-menu-item { padding: 8px 18px; cursor: pointer; white-space: nowrap; }
        .context-menu-item:hover { background-color: var(--ink-light); color: var(--parchment); }
        .context-menu-divider { border: none; border-top: 1px solid var(--ink-light); margin: 4px 0; }

        /* --- Settings Provider/Model Selectors --- */
        .settings-provider-model-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px; /* Add space before API key input */
        }
        .settings-provider-model-group .settings-label {
             margin-bottom: 3px; /* Tighter spacing */
        }


        /* Animations */
        @keyframes appear { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* Responsive */
        @media (max-width: 768px) {
            body { font-size: 1rem; } .chat-messages { padding: 18px; }
            .message-content { padding: 15px 18px; font-size: 1rem; } .input-container { padding: 15px; }
            #userInput { padding: 15px; min-height: 50px; font-size: 1rem; }
            #sendButton { height: 55px; padding: 0 18px; font-size: 1rem; }
            .avatar { width: 40px; height: 40px; font-size: 1.1rem; }
             .typing-indicator { margin-left: 55px; font-size: 0.9rem;} .rune { font-size: 1rem;}
             /* Modal adjustments */
             .modal-content { padding: 0; width: 95%; } /* Less padding needed on mobile */
             .modal-header { padding: 15px 20px 10px 20px; }
             .modal-body { padding: 0 20px; }
             .settings-page { padding: 15px 5px 15px 0; }
             .settings-pagination { padding: 10px 20px; flex-direction: column; gap: 10px; } .page-indicator { order: -1; }
             .modal-footer { padding: 10px 20px 15px 20px; }
             /* Appearance Editor */
             #appearance-editor-overlay .modal-body { padding: 15px 20px; }
             .appearance-editor-details { grid-template-columns: auto 1fr; }
             .appearance-pfp-section { grid-column: 1 / -1; grid-row: 3; justify-self: center; padding-left: 0; margin-top: 10px; }
            /* Adjust tab buttons for smaller screens */
            #chat-tabs-container { padding: 5px 10px; gap: 5px; }
            #chat-tabs-container button { padding: 5px 10px; font-size: 0.9rem; }
            #chat-tabs-container button#general-tab { padding: 5px 15px; }
             #chat-tabs-container button#area-tab,
             #chat-tabs-container button#city-tab,
             #chat-tabs-container button#world-tab,
             #chat-tabs-container button#message-tab { font-size: 0.8rem; }
             /* Stack Provider/Model selectors */
            .settings-provider-model-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="ui-container">
        <div id="game-world">
            <div id="map-content">
                 <div class="character" id="player" data-name="Player">
                    <div class="part detail5"></div> <div class="part detail4"></div>
                    <div class="part detail3"></div> <div class="part legs"></div>
                    <div class="part arm-left"></div> <div class="part arm-right"></div>
                    <div class="part torso"></div> <div class="part detail1"></div>
                    <div class="part detail2"></div> <div class="part head"></div>
                    <span class="character-name-plate">Player</span>
                    <span class="speech"></span>
                </div>
                 <!-- NPCs -->
            </div>
        </div>
        <div id="chat-area">
             <!-- NEW: Chat Tabs Container -->
             <div id="chat-tabs-container">
                 <button id="general-tab">GENERAL</button>
                 <button id="area-tab">AREA</button>
                 <button id="city-tab">CITY</button>
                 <button id="world-tab">WORLD</button>
                 <button id="message-tab">MESSAGE</button> <!-- Added Message button -->
             </div>
             <div class="chat-messages" id="chatMessages"></div>
             <div class="input-container">
                <textarea class="message-input" id="userInput" placeholder="Consult the spirit..." rows="1"></textarea>
                 <!-- Settings Button Removed -->
                 <button class="send-button" id="sendButton" title="Send Message"><span>Send</span><span style="font-size: 1.2em;">→</span></button>
            </div>
        </div>
    </div>

    <!-- Settings Modal (Paginated) -->
    <div class="modal-overlay" id="settings-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tome Configuration</h3>
                <button class="modal-close-btn" id="modal-close-btn">×</button>
             </div>
            <div class="modal-body" id="settings-body-container">
                <!-- Pages populated by JS -->
            </div>
             <div class="settings-pagination" id="settings-pagination-controls">
                 <button class="pagination-btn" id="settings-prev-btn">&laquo; Previous</button>
                 <span class="page-indicator" id="settings-page-indicator">Page 1 / 4</span>
                 <button class="pagination-btn" id="settings-next-btn">Next &raquo;</button>
             </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="modal-cancel-btn">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="modal-save-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Appearance Editor Modal -->
    <div class="modal-overlay" id="appearance-editor-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="appearance-editor-title">Set Appearance & Details</h3>
                <button class="modal-close-btn" id="appearance-editor-close-btn">×</button>
            </div>
            <div class="modal-body">
                <div class="appearance-editor-details">
                    <label for="appearance-editor-name">Name:</label>
                    <input type="text" id="appearance-editor-name" class="settings-input">
                    <label for="appearance-editor-persona">Persona:</label>
                    <textarea id="appearance-editor-persona" class="settings-textarea"></textarea>
                    <label>Sigil:</label>
                    <div class="appearance-pfp-section">
                        <img src="" alt="Sigil Preview" class="appearance-pfp-preview" id="appearance-pfp-preview" title="Click to change sigil">
                        <button class="appearance-pfp-change-btn" id="appearance-pfp-change-btn">Change Sigil</button>
                    </div>
                </div>
                <div class="appearance-iframe-container">
                    <iframe id="characterCreatorFrame" src="character_creator.html"></iframe>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="appearance-editor-cancel-btn">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="appearance-editor-save-btn">Save Appearance & Details</button>
            </div>
        </div>
    </div>

    <!-- Context Menus -->
    <div id="npc-context-menu" class="context-menu" style="display: none;">
        <div class="context-menu-item" data-action="talk">Talk</div> <div class="context-menu-item" data-action="follow">Follow</div>
        <div class="context-menu-item" data-action="appearance">Set Appearance, Details & Sigil</div>
        <div class="context-menu-item" data-action="switch_mode">Switch Mode</div> <hr class="context-menu-divider">
        <div class="context-menu-item" data-action="cancel">Cancel</div>
    </div>
    <div id="player-context-menu" class="context-menu" style="display: none;">
        <div class="context-menu-item" data-action="appearance">Set Appearance, Details & Sigil</div> <hr class="context-menu-divider">
        <div class="context-menu-item" data-action="add_area">Add Area Here</div> <div class="context-menu-item" data-action="add_agent">Add Agent Here</div> <hr class="context-menu-divider">
        <div class="context-menu-item" data-action="remove_closest_agent">Remove Closest Agent</div> <div class="context-menu-item" data-action="remove_closest_area">Remove Closest Area</div> <hr class="context-menu-divider">
        <div class="context-menu-item" data-action="cancel">Cancel</div>
    </div>
    <!-- NEW: PFP Context Menu -->
    <div id="pfp-context-menu" class="context-menu" style="display: none;">
        <div class="context-menu-item" data-action="toggle-tabs">Show/Hide Chat Tabs</div>
        <!-- Text updated dynamically by JS -->
        <div class="context-menu-item" data-action="toggle-fullscreen">Fullscreen Chat</div>
        <hr class="context-menu-divider">
        <div class="context-menu-item" data-action="cancel">Cancel</div>
    </div>

    <input type="file" class="pfp-upload" id="pfp-upload" accept="image/*">

    <!-- Load API Provider Definitions -->
    <script src="api_providers.js"></script>

    <script>
        // Ensure PROVIDERS and external getApiResponse are loaded before use
        if (typeof PROVIDERS === 'undefined' || typeof getApiResponse !== 'function') {
            console.error("FATAL: api_providers.js failed to load or define PROVIDERS/getApiResponse.");
            // Optional: Display an error message to the user
            document.body.innerHTML = '<p style="color: red; padding: 20px;">Error: Could not load API provider configurations. Please check api_providers.js.</p>';
        } else {
            console.log("API Providers loaded successfully:", Object.keys(PROVIDERS));
        }

        marked.setOptions({ breaks: true, gfm: true, smartypants: true });
        function darkenHexColor(h, p) { if (!h || typeof h !== 'string') return '#000'; h = h.replace(/^#/, ''); if (h.length === 3) h = h.split('').map(c => c + c).join(''); if (h.length !== 6) return '#000'; let r = parseInt(h.substring(0, 2), 16), g = parseInt(h.substring(2, 4), 16), b = parseInt(h.substring(4, 6), 16); r = Math.max(0, Math.floor(r * (1 - p))); g = Math.max(0, Math.floor(g * (1 - p))); b = Math.max(0, Math.floor(b * (1 - p))); return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`; }

        function runSimulation() {
            // Check again in case of async loading issues
             if (typeof PROVIDERS === 'undefined' || typeof getApiResponse !== 'function') {
                 console.error("Aborting runSimulation: api_providers.js definitions not found.");
                 return;
             }
             // Use the externally defined getApiResponse directly
             const callExternalApi = getApiResponse;

            // --- Element Refs ---
            const gameWorld = document.getElementById('game-world'); const mapContent = document.getElementById('map-content');
            const chatArea = document.getElementById('chat-area'); const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('userInput'); const sendButton = document.getElementById('sendButton');
            const playerElement = document.getElementById('player');
            const settingsOverlay = document.getElementById('settings-overlay'); const settingsBodyContainer = document.getElementById('settings-body-container');
            const settingsPaginationControls = document.getElementById('settings-pagination-controls'); const settingsPrevBtn = document.getElementById('settings-prev-btn');
            const settingsNextBtn = document.getElementById('settings-next-btn'); const settingsPageIndicator = document.getElementById('settings-page-indicator');
            const modalCloseBtn = document.getElementById('modal-close-btn'); const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const npcContextMenu = document.getElementById('npc-context-menu');
            const playerContextMenu = document.getElementById('player-context-menu');
            const pfpContextMenu = document.getElementById('pfp-context-menu');
            const appearanceEditorOverlay = document.getElementById('appearance-editor-overlay');
            const appearanceEditorTitle = document.getElementById('appearance-editor-title'); const appearanceEditorCloseBtn = document.getElementById('appearance-editor-close-btn');
            const appearanceEditorCancelBtn = document.getElementById('appearance-editor-cancel-btn'); const appearanceEditorSaveBtn = document.getElementById('appearance-editor-save-btn');
            const characterCreatorFrame = document.getElementById('characterCreatorFrame'); const appearanceEditorNameInput = document.getElementById('appearance-editor-name');
            const appearanceEditorPersonaInput = document.getElementById('appearance-editor-persona'); const pfpUploadInput = document.getElementById('pfp-upload');
            const appearancePfpPreview = document.getElementById('appearance-pfp-preview'); const appearancePfpChangeBtn = document.getElementById('appearance-pfp-change-btn');
            const chatTabsContainer = document.getElementById('chat-tabs-container');

            // --- Game State & Config ---
            let MAP_WIDTH = 3000; let MAP_HEIGHT = 2000; let viewportWidth, viewportHeight;
            const npcData = []; const environmentData = []; const playerData = { appearance: null, isPlayer: true, pfp: null };
            const playerStepDistance = 16; const globalSpeechDuration = 4500; let interactionMode = 'agent';
            let currentAiNpcData = null; let initialSpeakerData = null; let currentCityKey = null;
            let isPlayerMoving = false; let playerMoveTimeout = null; let contextMenuTargetNpcId = null;
            let contextMenuTargetIsPlayer = false; let appearanceEditorTarget = null; let temporaryAppearanceData = null;
            let temporaryPfpData = null; let isWaitingForApiResponse = false; let hideSystemMessages = false;
            let npcFollowInterval = null; const FOLLOW_DISTANCE = 50; const NPC_FOLLOW_SPEED = 1.5;
            let currentSettingsPage = 1; const TOTAL_SETTINGS_PAGES = 4;
            let chatHeightBeforeFullscreen = null;
            let chatTabsVisible = true;

            const defaultNpcAppearance = { outfit: 'citizen', gender: 'female', colors: { hair: '#e4b881', primary: '#a34444', secondary: '#fbe5d6', detail1: '#7a2a2a', legs: '#693434', feet: '#2a2a30' } };
            const defaultPlayerAppearance = { outfit: 'citizen', gender: 'male', colors: { hair: '#4a3021', primary: '#5d7a8a', secondary: '#d1c6b0', detail1: '#8b4513', legs: '#444450', feet: '#2a30' } };
            const DEFAULT_PLAYER_PFP = 'https://ui-avatars.com/api/?name=Player&background=1e3a8a&color=fff&size=64';
            const DEFAULT_NPC_PFP = 'https://ui-avatars.com/api/?name=Agent&background=6b21a8&color=fff&size=64';

            // --- Provider/Model/Key State ---
            let selectedProvider = null; // Globally used provider
            let selectedModel = null; // Globally used model
            let currentApiKeyIndex = 0; // Index for the *current* provider's key list during API calls
            let conversationHistory = [];
            const MAX_HISTORY_TURNS = 6; let recentEvents = []; const BASE_ACTION_RULES = `ACTIONS: <Walk X,Y>, <Follow>. Pos=(X,Y).`;
            const USER_CITY_PREFIX = "userCity_";

            // --- State for Settings Modal ---
            let modalSelectedProvider = null; // Provider selected *in the modal*
            let modalApiKeys = []; // Keys loaded for the modalSelectedProvider

            // --- MODIFIED LS_KEYS ---
            const LS_KEYS = {
                selectedCity: 'selectedCityKey', interactionMode: 'interactionMode',
                // API Keys are now provider-specific
                apiKeys: (providerKey) => `apiKeys_${providerKey}`,
                chatAreaHeight: 'chatAreaHeight', hideSystemMessages: 'hideSystemMessages',
                playerAppearance: 'global-player-appearance', playerName: 'global-player-name',
                playerPersona: 'global-player-persona', playerPfp: 'global-player-pfp',
                playerPositionX: (cityKey) => `player-${cityKey}-x`, playerPositionY: (cityKey) => `player-${cityKey}-y`,
                npcName: (cityKey, npcId) => `npc-${cityKey}-${npcId}-name`, npcPersona: (cityKey, npcId) => `npc-${cityKey}-${npcId}-persona`,
                npcAppearance: (cityKey, npcId) => `npc-${cityKey}-${npcId}-appearance`, npcPfp: (cityKey, npcId) => `npc-${cityKey}-${npcId}-pfp`,
                npcPositionX: (cityKey, npcId) => `npc-${cityKey}-${npcId}-x`, npcPositionY: (cityKey, npcId) => `npc-${cityKey}-${npcId}-y`,
                envName: (cityKey, envId) => `env-${cityKey}-${envId}-name`,
                chatTabsVisible: 'chatTabsVisible',
                selectedProvider: 'selectedApiProvider',
                selectedModel: 'selectedApiModel'
            };

            // --- CORE FUNCTIONS ---
            function updateNameplate(c){if(c&&c.nameplateElement)c.nameplateElement.textContent=c.name;}

            function addMessage(text, senderName, type, speakerData = null) { /* ... Implementation unchanged ... */
                 if (hideSystemMessages && ['debug', 'system', 'error'].includes(type)) return;
                 const messageDiv = document.createElement('div'); messageDiv.classList.add('message');
                 let senderTypeClass = '', avatarClass = '', pfpSrc = '', isMarkdown = false, displayName = senderName || 'Unknown';

                 if (type === 'user') {
                     senderTypeClass = 'message-user'; avatarClass = 'user-avatar'; pfpSrc = playerData.pfp || DEFAULT_PLAYER_PFP;
                     displayName = playerData.name || 'Player'; isMarkdown = false;
                 } else if (type === 'assistant') {
                     senderTypeClass = 'message-spirit'; avatarClass = 'spirit-avatar';
                     pfpSrc = speakerData?.pfp || DEFAULT_NPC_PFP; displayName = speakerData?.name || senderName; isMarkdown = true;
                 } else { // System, Debug, Error
                     senderTypeClass = type === 'error' ? 'message-debug' : `message-${type}`; avatarClass = type === 'error' ? 'debug-avatar' : `${type}-avatar`;
                     const systemBgColor = getComputedStyle(document.documentElement).getPropertyValue('--amethyst').trim() || '#6b21a8';
                     const defaultBgColor = getComputedStyle(document.documentElement).getPropertyValue('--ink-light').trim() || '#5a4e42';
                     const avatarBg = (type === 'system') ? systemBgColor : defaultBgColor;
                     pfpSrc = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName.substring(0,1))}&background=${avatarBg.substring(1)}&color=fff&size=64`;
                     displayName = senderName; isMarkdown = false; text = `[${type.toUpperCase()}] ${text}`;
                 }

                 messageDiv.classList.add(senderTypeClass);
                 const avatarImg = document.createElement('img');
                 avatarImg.className = `avatar ${avatarClass}`; avatarImg.src = pfpSrc; avatarImg.alt = `${displayName} avatar`; avatarImg.title = displayName;

                 if (type === 'assistant' || type === 'system' || type === 'debug' || type === 'error') {
                     avatarImg.addEventListener('click', openSettingsModal);
                 } else if (type === 'user') {
                     avatarImg.addEventListener('click', showPfpContextMenu);
                 }

                 const contentDiv = document.createElement('div'); contentDiv.className = `message-content ${senderTypeClass.replace('message-', '')}-message`;

                 if (isMarkdown) {
                     try {
                         contentDiv.innerHTML = marked.parse(text);
                         setTimeout(() => { const pre = contentDiv.querySelectorAll('pre'); pre.forEach(p => { const cC = p.querySelector('code')?.textContent || p.textContent; if (!cC || cC.trim() === '') return; const b = document.createElement('button'); b.className = 'copy-code-btn'; b.textContent = 'Copy'; b.title = 'Copy'; b.addEventListener('click', (e) => { e.stopPropagation(); const c = p.querySelector('code') || p; navigator.clipboard.writeText(c.textContent).then(() => { b.textContent = 'Copied!'; b.classList.add('copied'); setTimeout(() => { b.textContent = 'Copy'; b.classList.remove('copied'); }, 2000); }).catch(err => console.error("Copy failed: ", err)); }); p.style.position = 'relative'; p.appendChild(b); }); }, 0);
                     } catch (e) { console.error("Markdown err:", e); contentDiv.textContent = text; }
                 } else {
                     if (['system', 'debug', 'error'].includes(type)) { const nS = document.createElement('span'); nS.className = 'message-name'; nS.textContent = `${displayName}: `; contentDiv.appendChild(nS); }
                     contentDiv.appendChild(document.createTextNode(text.replace(/\[(SYSTEM|DEBUG|ERROR)\]\s*/, ''))); // Remove prefix for display
                 }
                 if (type === 'user') { messageDiv.appendChild(contentDiv); messageDiv.appendChild(avatarImg); } else { messageDiv.appendChild(avatarImg); messageDiv.appendChild(contentDiv); }
                 chatMessages.appendChild(messageDiv); chatMessages.scrollTop = chatMessages.scrollHeight;
                 if (type === 'user' || type === 'assistant') {
                     conversationHistory.push({ role: type, content: text });
                     if (conversationHistory.length > (MAX_HISTORY_TURNS * 2)) { conversationHistory = conversationHistory.slice(-(MAX_HISTORY_TURNS * 2)); }
                 } else if (type === 'system' && !text.includes("Settings saved")) { recentEvents.push(`Event: ${text.replace('[SYSTEM] ', '')}`); if(recentEvents.length > 5) recentEvents.shift(); }
            }

            // --- NEW: Chat Tab Visibility ---
            function setChatTabsVisibility(isVisible) { /* ... Implementation unchanged ... */
                chatTabsVisible = isVisible;
                chatTabsContainer.classList.toggle('hidden', !isVisible);
                try {
                    localStorage.setItem(LS_KEYS.chatTabsVisible, isVisible ? 'true' : 'false');
                } catch (e) {
                    console.error("Failed to save chat tab visibility state:", e);
                }
            }
            function toggleChatTabsVisibility() { /* ... Implementation unchanged ... */
                setChatTabsVisibility(!chatTabsVisible);
            }

            // --- MODIFIED: Context Menu Functions ---
            function handleGenericContextMenu(event, menuElement) { /* ... Implementation unchanged ... */
                event.preventDefault();
                closeAllContextMenus(); // Close others before opening new one
                const t = event.currentTarget;
                contextMenuTargetNpcId = null;
                contextMenuTargetIsPlayer = false;

                if (menuElement.id === 'player-context-menu') {
                    if (!currentCityKey || playerData.element.style.display === 'none') return;
                    contextMenuTargetIsPlayer = true;
                } else if (menuElement.id === 'npc-context-menu') {
                    if (!currentCityKey) return;
                    contextMenuTargetNpcId = parseInt(t.dataset.npcId, 10);
                    if (isNaN(contextMenuTargetNpcId)) { console.error("No NPC ID:", t); return; }
                    const n = npcData.find(n => n.id === contextMenuTargetNpcId);
                    if (!n) return;
                    updateContextMenuModeText(); // Only needed for NPC menu
                } else if (menuElement.id === 'pfp-context-menu') {
                    const toggleTabsItem = pfpContextMenu.querySelector('[data-action="toggle-tabs"]');
                    if (toggleTabsItem) {
                        toggleTabsItem.textContent = chatTabsVisible ? "Hide Tabs" : "Show Tabs";
                    }
                    const toggleFullscreenItem = pfpContextMenu.querySelector('[data-action="toggle-fullscreen"]');
                    if (toggleFullscreenItem) {
                        const isCurrentlyFullscreen = chatArea.offsetHeight >= (window.innerHeight - 10);
                        toggleFullscreenItem.textContent = isCurrentlyFullscreen ? "Minimize Chat" : "Fullscreen Chat";
                    }
                } else {
                    return; // Unknown menu type
                }

                const mW = menuElement.offsetWidth; const mH = menuElement.offsetHeight;
                let x = event.clientX; let y = event.clientY;
                if (x + mW > window.innerWidth) x -= mW;
                if (y + mH > window.innerHeight) y -= mH;
                menuElement.style.left = `${x}px`; menuElement.style.top = `${y}px`;
                menuElement.style.display = 'block';
                document.addEventListener('click', closeContextMenuOnClickOutside, { capture: true, once: true });
                document.addEventListener('contextmenu', closeContextMenuOnClickOutside, { capture: true, once: true });
            }
            function handleNpcContextMenu(event) { handleGenericContextMenu(event, npcContextMenu); }
            function handlePlayerContextMenu(event) { handleGenericContextMenu(event, playerContextMenu); }
            function showPfpContextMenu(event) { handleGenericContextMenu(event, pfpContextMenu); }
            function closeAllContextMenus() { /* ... Implementation unchanged ... */
                npcContextMenu.style.display = 'none';
                playerContextMenu.style.display = 'none';
                pfpContextMenu.style.display = 'none';
                contextMenuTargetNpcId = null;
                contextMenuTargetIsPlayer = false;
            }
            function closeContextMenuOnClickOutside(event) { /* ... Implementation unchanged ... */
                const activeMenu = [npcContextMenu, playerContextMenu, pfpContextMenu].find(menu => menu.style.display === 'block');
                if (activeMenu && !activeMenu.contains(event.target)){
                    closeAllContextMenus();
                } else if (activeMenu) {
                    document.addEventListener('click', closeContextMenuOnClickOutside, { capture: true, once: true });
                    document.addEventListener('contextmenu', closeContextMenuOnClickOutside, { capture: true, once: true });
                }
             }


            // --- Other Core Functions (unchanged unless noted) ---
            function getRandomHexColor(){ /* ... */ }
            function showSpeechBubble(c,m){ /* ... */ }
            function updateCharacterPosition(c){ /* ... */ }
            function updateEnvironmentVisuals(e){ /* ... */ }
            function updateCameraPosition(){ /* ... */ }
            function applyPlayerAppearance(styleData) { /* ... */ }
            function applyNpcAppearance(npc) { /* ... */ }
            function applyAppearanceToElement(element, styleData) { /* ... Full implementation unchanged ... */ }
            function movePlayer(dx, dy) { /* ... Full implementation unchanged ... */ }
            function updateInputPlaceholder(){/* ... */ }
            function findClosestNpc(log=true){/* ... */ }
            function getGameStateString(){/* ... */ }
            function generateSystemPrompt(npc) { /* ... */ }
            function processNpcActions(r,n){/* ... */ }
            function handleWalkAction(n,p){/* ... */ }
            function findClosestCharacter(s, includeSelf = false, onlyPlayer = false){/* ... */ }
            function handleFollowAction(n) {/* ... */ }
            function updateFollowingNpcs() {/* ... */ }
            function displayTypingIndicator() { /* ... */ }
            function removeTypingIndicator() { /* ... */ }

            // --- MODIFIED Key Management Functions ---
            function loadApiKeysForProvider(providerKey) {
                if (!providerKey) return []; // Return empty if no provider specified
                console.log(`[Keys] Loading keys for provider: ${providerKey}`);
                const storageKey = LS_KEYS.apiKeys(providerKey);
                const keysString = localStorage.getItem(storageKey);
                if (keysString) {
                    try {
                        const parsedKeys = JSON.parse(keysString);
                        if (Array.isArray(parsedKeys) && parsedKeys.every(item => typeof item === 'string')) {
                            console.log(`[Keys] Loaded ${parsedKeys.length} keys for ${providerKey}.`);
                            return parsedKeys;
                        } else {
                            console.warn(`[Keys] Invalid key format found for ${providerKey}. Clearing.`);
                            localStorage.removeItem(storageKey);
                            return [];
                        }
                    } catch (e) {
                        console.error(`[Keys] Error parsing keys for ${providerKey}:`, e);
                        localStorage.removeItem(storageKey);
                        return [];
                    }
                } else {
                    return []; // No keys stored yet
                }
            }

            function saveApiKeysForProvider(providerKey, keysArray) {
                 if (!providerKey || !Array.isArray(keysArray)) {
                     console.error("[Keys] Invalid arguments for saveApiKeysForProvider.");
                     return;
                 }
                 console.log(`[Keys] Saving ${keysArray.length} keys for provider: ${providerKey}`);
                 const storageKey = LS_KEYS.apiKeys(providerKey);
                 try {
                     localStorage.setItem(storageKey, JSON.stringify(keysArray));
                 } catch (e) {
                     console.error(`[Keys] Error saving keys for ${providerKey}:`, e);
                     addMessage(`Error saving API keys for ${providerKey}.`, "SYSTEM", "error");
                 }
             }

             // Handles adding a key *within the settings modal*
             function handleAddKeyInModal() {
                 const providerSelect = document.getElementById('providerSelector');
                 const apiKeyInput = document.getElementById('apiKeyInput');
                 if (!providerSelect || !apiKeyInput || !modalSelectedProvider) return;

                 const key = apiKeyInput.value.trim();
                 if (key) {
                     // Add to the temporary modal list
                     modalApiKeys.push(key);
                     apiKeyInput.value = ''; // Clear input
                     console.log(`[Keys] Added key temporarily for ${modalSelectedProvider}. Total in modal: ${modalApiKeys.length}`);
                     // Update UI elements in the modal
                     updateApiKeySectionUI();
                 }
             }

             // Handles removing keys *within the settings modal*
             function handleRemoveAllKeysInModal() {
                 const providerSelect = document.getElementById('providerSelector');
                 if (!providerSelect || !modalSelectedProvider) return;

                 const providerName = PROVIDERS[modalSelectedProvider]?.name || modalSelectedProvider;
                 if (!confirm(`Remove ALL stored API keys for provider "${providerName}"?`)) return;

                 // Clear the temporary modal list
                 modalApiKeys = [];
                 console.log(`[Keys] Cleared keys temporarily for ${modalSelectedProvider}.`);
                 // Update UI elements in the modal
                 updateApiKeySectionUI();
             }

             // Helper to update API key section UI elements in the modal
             function updateApiKeySectionUI() {
                 const keyCountTitle = document.querySelector('#settings-page-2 .settings-section-title[data-section="api-keys"]');
                 const removeBtn = document.getElementById('removeAllApiKeysBtn');
                 if (keyCountTitle) {
                     keyCountTitle.textContent = `API Keys (${modalApiKeys.length} loaded)`;
                 }
                 if (removeBtn) {
                     removeBtn.disabled = modalApiKeys.length === 0;
                 }
                 // Also update help text and input state
                 updateApiKeyHelpText(modalSelectedProvider);
             }


            // --- MODIFIED: getApiResponseInternal using external function & provider-specific keys ---
            async function getApiResponseInternal(userMessage, attempt = 1) {
                 if (!currentCityKey) { addMessage("No city loaded.", "SYSTEM", "system"); enableInput(); return; }

                 // Use the globally selected provider and model
                 if (!selectedProvider || !selectedModel || !PROVIDERS[selectedProvider]) {
                     addMessage("API Provider or Model not selected/invalid. Please configure in Settings.", 'SYSTEM', 'error');
                     enableInput();
                     return;
                 }
                 const providerConfig = PROVIDERS[selectedProvider];
                 const providerRequiresKey = providerConfig.apiKeyLocation !== 'none' && providerConfig.format !== 'proxy_compatible';

                 // Load keys specifically for the selected provider
                 const currentProviderKeys = loadApiKeysForProvider(selectedProvider);
                 const numKeysForProvider = currentProviderKeys.length;
                 const maxAttempts = providerRequiresKey ? (numKeysForProvider > 0 ? numKeysForProvider : 1) : 1; // Only 1 attempt if no key needed or no keys exist

                 if (providerRequiresKey && numKeysForProvider === 0) {
                     addMessage(`API key required for ${providerConfig.name}, but none found for this provider. Please add one in Settings.`, 'SYSTEM', 'error');
                     enableInput();
                     return;
                 }
                 if (providerRequiresKey && attempt > maxAttempts) {
                     addMessage(`All API keys (${numKeysForProvider}) in the list failed for ${providerConfig.name}. Please check keys in Settings.`, 'SYSTEM', 'error');
                     enableInput();
                     return;
                 }

                 if (!currentAiNpcData) { const closeNpc = findClosestNpc(true); if (closeNpc) { currentAiNpcData = closeNpc; } else if (initialSpeakerData) { currentAiNpcData = initialSpeakerData; } }
                 if (!currentAiNpcData) { addMessage(`No agent close enough to consult. Walk closer to an agent.`, 'SYSTEM', 'system'); enableInput(); return; }

                 // Determine the key to use for this attempt
                 let apiKeyToUse = null;
                 let keyIndexUsed = -1;
                 if (providerRequiresKey && numKeysForProvider > 0) {
                     keyIndexUsed = (attempt - 1) % numKeysForProvider;
                     apiKeyToUse = currentProviderKeys[keyIndexUsed];
                 }

                 if (providerRequiresKey && !apiKeyToUse && numKeysForProvider > 0) { // Should not happen if logic is correct, but safety check
                     addMessage(`Internal error: Could not find API key at index ${keyIndexUsed} for ${providerConfig.name}.`, 'SYSTEM', 'error');
                     enableInput();
                     return;
                 }

                 if (attempt === 1) { displayTypingIndicator(); }

                 const sysPrompt = generateSystemPrompt(currentAiNpcData);
                 let userContent = "";
                 if (interactionMode === 'agent') {
                     const gs=getGameStateString(); const evts=recentEvents.length>0?` RecentEvents:[${recentEvents.join('; ')}]`:'';
                     const ctx=`(You are ${currentAiNpcData.name}. Player ${playerData.name} is near you).`;
                     userContent=`${gs}${evts} ${ctx} ${playerData.name} says: ${userMessage}`.trim();
                     if (attempt === 1) recentEvents=[]; // Clear events only on first attempt
                 } else {
                     userContent = `${playerData.name} says: ${userMessage}`.trim();
                 }

                 const historyForApi = [{ role: 'system', content: sysPrompt }, ...conversationHistory];
                 historyForApi.push({ role: 'user', content: userContent }); // Add current user message

                 if (attempt === 1) {
                    addMessage(`(${interactionMode.toUpperCase()}) API Call -> ${selectedProvider} (${selectedModel}) for ${currentAiNpcData.name} | Sys: ${sysPrompt.substring(0,50)}... | User: ${userContent.substring(0, 100)}... Key Used: ${providerRequiresKey ? (apiKeyToUse ? `Yes (Index ${keyIndexUsed})` : 'No (None Found!)') : 'No (Not Required)'}`, 'DEBUG', 'debug');
                 }

                 try {
                     console.log(`[Main] Calling External API: Provider=${selectedProvider}, Model=${selectedModel}, Attempt=${attempt}/${maxAttempts}, KeyIndex=${providerRequiresKey ? keyIndexUsed : 'N/A'}`);

                     // Call the external function from api_providers.js
                     const rawReply = await callExternalApi(selectedProvider, selectedModel, historyForApi, apiKeyToUse, { /* options */ });

                     removeTypingIndicator();
                     addMessage(`(${interactionMode.toUpperCase()}) API Raw <- ${selectedProvider}/${currentAiNpcData.name}: ${rawReply.substring(0,100)}...`, 'DEBUG', 'debug');

                     let displayReply = rawReply;
                     if (interactionMode === 'agent') {
                         displayReply = processNpcActions(rawReply, currentAiNpcData);
                     }

                     if (displayReply && displayReply.trim()) {
                         addMessage(displayReply, currentAiNpcData.name, 'assistant', currentAiNpcData);
                     } else if (interactionMode === 'agent') {
                         addMessage("...", currentAiNpcData.name, 'assistant', currentAiNpcData);
                     }
                     enableInput();
                     currentApiKeyIndex = 0; // Reset index for the provider on success

                 } catch (err) {
                     removeTypingIndicator();
                     console.error(`[Main] Error during API call attempt ${attempt}:`, err);
                     let errorMsg = `Spirit Error (${selectedProvider}): ${err.message}`;
                     // Avoid adding duplicate error messages if retrying
                     if (attempt === 1 || !conversationHistory.some(msg => msg.role === 'system' && msg.content.includes(err.message))) {
                        addMessage(errorMsg, 'SYSTEM', 'error');
                     }

                     // Retry logic ONLY if a key was required/used and there are more keys/attempts left
                     if (providerRequiresKey && numKeysForProvider > 0 && attempt < maxAttempts) {
                         addMessage(`Retrying with next key for ${selectedProvider} (Attempt ${attempt + 1}/${maxAttempts})...`, 'SYSTEM', 'debug');
                         // No need to increment currentApiKeyIndex here, it's handled by the attempt number
                         setTimeout(() => getApiResponseInternal(userMessage, attempt + 1), 500);
                     } else {
                         if (providerRequiresKey && numKeysForProvider > 0) {
                             addMessage(`All API key attempts (${numKeysForProvider}) failed for ${selectedProvider}.`, 'SYSTEM', 'error');
                         } else if (providerRequiresKey && numKeysForProvider === 0){
                              // This was already handled at the start, but reiterate if error occurred anyway
                              addMessage(`No API keys configured for ${selectedProvider}. Cannot complete request.`, 'SYSTEM', 'error');
                         }
                         // If no key required, or retries exhausted, enable input
                         enableInput();
                         currentApiKeyIndex = 0; // Reset for next time
                     }
                 }
            }


            function disableInput(){ /* ... */ }
            function enableInput(){ /* ... */ }
            function handlePlayerSend() { /* ... */ }
            function toggleInteractionMode(){ /* ... */ }
            function updateContextMenuModeText() { /* ... */ }

            function openSettingsModal() {
                 // Store the currently selected provider when opening the modal
                 modalSelectedProvider = selectedProvider;
                 // Load the keys specifically for this provider into the modal's state
                 modalApiKeys = loadApiKeysForProvider(modalSelectedProvider);
                 populateSettingsModal(); // Now populate based on modal state
                 settingsOverlay.classList.add('active');
             }
            function closeSettingsModal() {
                // Reset modal-specific state if needed
                 modalSelectedProvider = null;
                 modalApiKeys = [];
                 settingsOverlay.classList.remove('active');
             }
            function openAppearanceEditorModal(target = 'player') { /* ... */ }
            function closeAppearanceEditorModal() { /* ... */ }
            function saveAppearanceFromEditor() { /* ... */ }
            function handlePfpUpload(event) { /* ... */ }
            function showSettingsPage(pageNum) { /* ... */ }
            function updatePaginationControls() { /* ... */ }

            // --- MODIFIED: populateSettingsModal ---
             function populateSettingsModal(){
                 settingsBodyContainer.innerHTML = '';
                 for (let i=1; i<=TOTAL_SETTINGS_PAGES; i++) { const p=document.createElement('div'); p.className='settings-page'; p.id=`settings-page-${i}`; settingsBodyContainer.appendChild(p); }
                 const p1 = document.getElementById('settings-page-1'); const p2 = document.getElementById('settings-page-2');
                 const p3 = document.getElementById('settings-page-3'); const p4 = document.getElementById('settings-page-4');

                 // --- PAGE 1: City, Map, UI --- (Unchanged from previous)
                 const citySec = document.createElement('div'); citySec.className = 'settings-section'; citySec.innerHTML = `<h3 class="settings-section-title">City Management</h3>`; const cityControlsDiv = document.createElement('div'); cityControlsDiv.className = 'settings-city-controls'; const cityLabel = document.createElement('label'); cityLabel.htmlFor = 'settingsCitySelector'; cityLabel.textContent = 'City:'; const citySelect = document.createElement('select'); citySelect.id = 'settingsCitySelector'; citySelect.className = 'settings-city-selector settings-select'; const addBtn = document.createElement('button'); addBtn.id = 'settingsAddCityBtn'; addBtn.className = 'settings-city-edit-btn settings-city-add-btn'; addBtn.title = 'Add New City'; addBtn.textContent = '+'; const delBtn = document.createElement('button'); delBtn.id = 'settingsDeleteCityBtn'; delBtn.className = 'settings-city-edit-btn settings-city-delete-btn'; delBtn.title = 'Delete Current City'; delBtn.textContent = '-'; cityControlsDiv.appendChild(cityLabel); cityControlsDiv.appendChild(citySelect); cityControlsDiv.appendChild(addBtn); cityControlsDiv.appendChild(delBtn); citySec.appendChild(cityControlsDiv); p1.appendChild(citySec);
                 populateCitySelectorInModal(citySelect); citySelect.addEventListener('change', (event) => { const nk=event.target.value; if (nk && nk !== currentCityKey) { localStorage.setItem(LS_KEYS.selectedCity, nk); addMessage(`Switching to ${citySelect.options[citySelect.selectedIndex].text}. Reloading...`, "SYSTEM", "system"); savePlayerPosition(); saveNpcPositions(); closeSettingsModal(); setTimeout(() => window.location.reload(), 300); } }); addBtn.addEventListener('click', addCity); delBtn.addEventListener('click', deleteCity); delBtn.disabled = !currentCityKey || !currentCityKey.startsWith(USER_CITY_PREFIX);
                 const mapSizeSec=document.createElement('div');mapSizeSec.className='settings-section';mapSizeSec.innerHTML=`<h3 class="settings-section-title">Map Dimensions</h3>`;const iDiv=document.createElement('div');iDiv.className='map-size-inputs';const wI=document.createElement('input');wI.type='number';wI.id='mapWidthInput';wI.value=MAP_WIDTH;wI.min=500;wI.step=100;const hI=document.createElement('input');hI.type='number';hI.id='mapHeightInput';hI.value=MAP_HEIGHT;hI.min=500;hI.step=100;const wL=document.createElement('label');wL.htmlFor='mapWidthInput';wL.textContent='Width:';const hL=document.createElement('label');hL.htmlFor='mapHeightInput';hL.textContent='Height:';iDiv.appendChild(wL);iDiv.appendChild(wI);iDiv.appendChild(hL);iDiv.appendChild(hI);mapSizeSec.appendChild(iDiv); p1.appendChild(mapSizeSec);
                 const uiSec = document.createElement('div'); uiSec.className = 'settings-section'; uiSec.innerHTML = `<h3 class="settings-section-title">UI Settings</h3>`; const hDiv = document.createElement('div'); hDiv.className = 'settings-checkbox-item'; const hCb = document.createElement('input'); hCb.type = 'checkbox'; hCb.id = 'hideSystemMessagesCheckbox'; hCb.checked = hideSystemMessages; const hL2 = document.createElement('label'); hL2.htmlFor = 'hideSystemMessagesCheckbox'; hL2.textContent = 'Hide System/Debug/Error Messages'; hDiv.appendChild(hCb); hDiv.appendChild(hL2); uiSec.appendChild(hDiv); p1.appendChild(uiSec);

                 // --- PAGE 2: API Provider, Model, Keys ---
                 const providerModelSec=document.createElement('div');providerModelSec.className='settings-section';
                 providerModelSec.innerHTML=`<h3 class="settings-section-title">API Provider & Model</h3>`;
                 const pmGroup = document.createElement('div'); pmGroup.className = 'settings-provider-model-group';
                 // Provider Selector
                 const providerDiv = document.createElement('div');
                 const providerLabel = document.createElement('label'); providerLabel.htmlFor = 'providerSelector'; providerLabel.className = 'settings-label'; providerLabel.textContent = 'Provider:';
                 const providerSelect = document.createElement('select'); providerSelect.id = 'providerSelector'; providerSelect.className = 'settings-select';
                 providerDiv.appendChild(providerLabel); providerDiv.appendChild(providerSelect);
                 // Model Selector
                 const modelDiv = document.createElement('div');
                 const modelLabel = document.createElement('label'); modelLabel.htmlFor = 'modelSelector'; modelLabel.className = 'settings-label'; modelLabel.textContent = 'Model:';
                 const modelSelect = document.createElement('select'); modelSelect.id = 'modelSelector'; modelSelect.className = 'settings-select';
                 modelDiv.appendChild(modelLabel); modelDiv.appendChild(modelSelect);
                 pmGroup.appendChild(providerDiv); pmGroup.appendChild(modelDiv);
                 providerModelSec.appendChild(pmGroup);
                 p2.appendChild(providerModelSec);

                 // Populate Provider Dropdown
                 for (const providerKey in PROVIDERS) {
                     const option = document.createElement('option');
                     option.value = providerKey;
                     option.textContent = PROVIDERS[providerKey].name;
                     providerSelect.appendChild(option);
                 }
                 providerSelect.value = modalSelectedProvider; // Use modal state

                 // Function to update Model Dropdown
                 function updateModelSelector(selectedProviderKey) {
                     modelSelect.innerHTML = ''; // Clear existing options
                     const modelToSelect = document.getElementById('modelSelector'); // Get fresh ref inside modal
                     if (!modelToSelect) return;

                     if (selectedProviderKey && PROVIDERS[selectedProviderKey]) {
                         const provider = PROVIDERS[selectedProviderKey];
                         provider.availableModels.forEach(modelKey => {
                             const option = document.createElement('option');
                             option.value = modelKey;
                             option.textContent = modelKey;
                             modelToSelect.appendChild(option);
                         });
                         // Select the globally saved model if it exists for this provider, else default
                         modelToSelect.value = (selectedModel && provider.availableModels.includes(selectedModel))
                             ? selectedModel
                             : provider.defaultModel;
                     }
                 }

                 // Function to handle provider change *within the modal*
                 function handleProviderChangeInModal(event) {
                     const newProviderKey = event.target.value;
                     modalSelectedProvider = newProviderKey; // Update modal state
                     modalApiKeys = loadApiKeysForProvider(newProviderKey); // Load keys for NEW provider
                     updateModelSelector(newProviderKey); // Update model dropdown
                     updateApiKeySectionUI(); // Update key count, help text, button states
                     console.log(`[Modal] Switched provider view to ${newProviderKey}. Loaded ${modalApiKeys.length} keys.`);
                 }


                 // Initial population and event listener
                 updateModelSelector(modalSelectedProvider);
                 providerSelect.addEventListener('change', handleProviderChangeInModal);
                 // Set modelSelect value after population based on global 'selectedModel' or provider default
                 const initialProviderConfig = PROVIDERS[modalSelectedProvider];
                 if (initialProviderConfig) {
                    modelSelect.value = (selectedModel && initialProviderConfig.availableModels.includes(selectedModel))
                        ? selectedModel
                        : initialProviderConfig.defaultModel;
                 }


                 // API Keys Section
                 const apiSec=document.createElement('div');apiSec.className='settings-section';
                 const apiSecTitle = document.createElement('h3'); // Create title dynamically
                 apiSecTitle.className = 'settings-section-title';
                 apiSecTitle.dataset.section = 'api-keys';
                 apiSec.appendChild(apiSecTitle); // Add title first

                 const apiKeyHelpText = document.createElement('p');
                 apiKeyHelpText.id = 'apiKeyHelpText';
                 apiKeyHelpText.style.fontSize = '0.9em';
                 apiKeyHelpText.style.color = 'var(--ink-light)';
                 apiKeyHelpText.style.marginBottom = '10px';
                 apiSec.appendChild(apiKeyHelpText); // Add help text

                 const apiIDiv=document.createElement('div');apiIDiv.className='settings-api-key-section';
                 const kIn=document.createElement('input');kIn.type="password";kIn.id='apiKeyInput';kIn.className='settings-api-key-input';kIn.placeholder='Enter API Key...';
                 const addKBtn=document.createElement('button');addKBtn.textContent='Add Key';addKBtn.id='addApiKeyBtn';addKBtn.className='settings-api-key-btn';
                 addKBtn.addEventListener('click', handleAddKeyInModal); // Use modal-specific handler
                 apiIDiv.appendChild(kIn);apiIDiv.appendChild(addKBtn);
                 apiSec.appendChild(apiIDiv);

                 const remBtn=document.createElement('button');remBtn.textContent='Remove All Keys'; remBtn.id='removeAllApiKeysBtn';remBtn.className='settings-api-key-btn';
                 remBtn.style.marginTop = '10px';
                 remBtn.addEventListener('click', handleRemoveAllKeysInModal); // Use modal-specific handler
                 apiSec.appendChild(remBtn);
                 p2.appendChild(apiSec);

                 // Helper to update API key section UI based on modalSelectedProvider
                 function updateApiKeyHelpText(providerKey) {
                    const helpEl = document.getElementById('apiKeyHelpText');
                    const keyInputEl = document.getElementById('apiKeyInput');
                    const addKeyBtnEl = document.getElementById('addApiKeyBtn');
                    const removeKeysBtnEl = document.getElementById('removeAllApiKeysBtn');
                    if (!helpEl || !keyInputEl || !addKeyBtnEl || !removeKeysBtnEl) return;

                    const provider = PROVIDERS[providerKey];
                    if (!provider) {
                        helpEl.textContent = "Select a provider.";
                        keyInputEl.disabled = true; addKeyBtnEl.disabled = true; removeKeysBtnEl.disabled = true;
                        return;
                    }
                    const needsKey = provider.apiKeyLocation !== 'none' && provider.format !== 'proxy_compatible';
                    if (needsKey) {
                        helpEl.textContent = `Enter API key(s) for ${provider.name}. Keys are stored locally. Add multiple to cycle on failure.`;
                        keyInputEl.disabled = false; addKeyBtnEl.disabled = false; removeKeysBtnEl.disabled = modalApiKeys.length === 0;
                    } else {
                        helpEl.textContent = `${provider.name} does not require a client-side API key via this configuration. Key management disabled.`;
                        keyInputEl.disabled = true; addKeyBtnEl.disabled = true; removeKeysBtnEl.disabled = true;
                    }
                }
                // Initial update for the API Key section UI based on modal state
                updateApiKeySectionUI();


                 // --- PAGE 3: Agents --- (Unchanged)
                 const npcSec=document.createElement('div');npcSec.className='settings-section';npcSec.innerHTML=`<h3 class="settings-section-title">Agents</h3>`;const npcGrid=document.createElement('div');npcGrid.className='settings-grid';npcData.forEach(n=>{const item=document.createElement('div');item.className='settings-item';item.dataset.npcId=n.id;item.innerHTML=`<button class="settings-delete-btn" data-npc-id="${n.id}" title="Delete ${n.name}">X</button> <label class="settings-label" for="npc-name-${n.id}">Name (${n.id+1}):</label><input type="text" id="npc-name-${n.id}" class="settings-input" data-field="npcName" value="${n.name}"> <label class="settings-label" for="npc-persona-${n.id}">Persona:</label><textarea id="npc-persona-${n.id}" class="settings-textarea" data-field="npcPersona">${n.personaPrompt}</textarea><p><small>Edit Appearance/Sigil/Follow via right-click.</small></p>`; npcGrid.appendChild(item);});npcSec.appendChild(npcGrid); p3.appendChild(npcSec);
                 npcGrid.querySelectorAll('.settings-delete-btn').forEach(btn => { btn.addEventListener('click', handleDeleteNpcFromSettings); });

                 // --- PAGE 4: Environments --- (Unchanged)
                 const envSec=document.createElement('div');envSec.className='settings-section';envSec.innerHTML=`<h3 class="settings-section-title">Environments</h3>`;environmentData.forEach((e, idx)=>{const item=document.createElement('div');item.className='settings-env-item';item.dataset.envId=e.id; item.innerHTML=`<label class="settings-env-label" for="env-name-${e.id}">Area ${idx + 1}:</label><input type="text" id="env-name-${e.id}" class="settings-input settings-env-input" data-field="envName" value="${e.name}"> <button class="settings-delete-btn" data-env-id="${e.id}" title="Delete ${e.name}">X</button>`; envSec.appendChild(item);}); p4.appendChild(envSec);
                 envSec.querySelectorAll('.settings-delete-btn').forEach(btn => { btn.addEventListener('click', handleDeleteEnvFromSettings); });

                 // Disable fields if no city loaded
                 if (!currentCityKey) {
                    p1.querySelectorAll('input, textarea, button:not(#settingsAddCityBtn), select').forEach(el => { if (el.id !== 'hideSystemMessagesCheckbox' && !el.closest('.settings-city-controls')) el.disabled = true; });
                    p2.querySelectorAll('input, textarea, button, select').forEach(el => el.disabled = true);
                    p3.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true); p3.querySelectorAll('.settings-delete-btn').forEach(btn => btn.style.display = 'none');
                    p4.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true); p4.querySelectorAll('.settings-delete-btn').forEach(btn => btn.style.display = 'none');
                    if(citySelect) citySelect.disabled = false;
                    if(addBtn) addBtn.disabled = false; // Allow adding a city even if none selected
                 }
                 showSettingsPage(1); // Show first page
            }

            // --- MODIFIED: saveSettings ---
            function saveSettings() {
                 console.log("Saving settings...");
                 let changed=false, requiresReload=false, cityDefinition=null;

                 // Save Provider/Model Selection from Modal state
                 const providerSelect = document.getElementById('providerSelector'); // Get from modal DOM
                 const modelSelect = document.getElementById('modelSelector');
                 if (providerSelect && modelSelect && modalSelectedProvider) {
                     const finalProvider = modalSelectedProvider; // The one selected in modal
                     const finalModel = modelSelect.value; // The one selected in modal

                     if (finalProvider !== selectedProvider) {
                         selectedProvider = finalProvider;
                         localStorage.setItem(LS_KEYS.selectedProvider, selectedProvider);
                         changed = true;
                         console.log("Saved global provider:", selectedProvider);
                     }
                     if (finalModel !== selectedModel) {
                         selectedModel = finalModel;
                         localStorage.setItem(LS_KEYS.selectedModel, selectedModel);
                         changed = true;
                         console.log("Saved global model:", selectedModel);
                     }

                     // Save the API keys *currently in the modal's state* for the *provider selected in the modal*
                     saveApiKeysForProvider(finalProvider, modalApiKeys);
                     // No 'changed' flag needed here specifically for keys, saving handles it.
                 } else {
                     console.warn("Could not find provider/model selectors or modalSelectedProvider during save.");
                 }

                // --- Rest of the saving logic (unchanged) ---
                 const hideSysMsgCb = document.getElementById('hideSystemMessagesCheckbox'); if (hideSysMsgCb) { const sh=hideSysMsgCb.checked; if (hideSystemMessages !== sh) { hideSystemMessages=sh; localStorage.setItem(LS_KEYS.hideSystemMessages, hideSystemMessages?'true':'false'); changed=true; addMessage(`System messages now ${hideSystemMessages?'hidden':'shown'}.`, 'SYSTEM', 'system'); } }

                 if (currentCityKey) {
                     const sd = localStorage.getItem(currentCityKey); if (sd) { try { cityDefinition=JSON.parse(sd); } catch (e){ console.error("Parse cityDef fail",e); addMessage("Error: Corrupt city data.","SYSTEM","error"); return; } } else { console.error("Save fail: city data missing:", currentCityKey); addMessage("Error: Cannot find city data.","SYSTEM","error"); return; }
                     const wI = document.getElementById('mapWidthInput'); const hI = document.getElementById('mapHeightInput'); if (wI && hI && cityDefinition?.map) { const nW = parseInt(wI.value,10)||MAP_WIDTH; const nH = parseInt(hI.value,10)||MAP_HEIGHT; if (cityDefinition.map.width !== nW || cityDefinition.map.height !== nH) { cityDefinition.map.width=nW; cityDefinition.map.height=nH; changed=true; requiresReload=true; addMessage(`Map size changed. Reload needed.`, 'SYSTEM', 'system'); } }
                     document.querySelectorAll('#settings-page-3 .settings-item[data-npc-id]').forEach(item => { const id=parseInt(item.dataset.npcId, 10); const npc = npcData.find(n => n.id === id); if (!npc) return; const nIn=item.querySelector('[data-field="npcName"]'); const pIn=item.querySelector('[data-field="npcPersona"]'); const nN=nIn?(nIn.value.trim()||`Agent ${id+1}`):npc.name; const nP=pIn?pIn.value.trim():npc.personaPrompt; if(npc.name!==nN){npc.name=nN; localStorage.setItem(LS_KEYS.npcName(currentCityKey,id),nN); updateNameplate(npc); changed=true;} if(npc.personaPrompt!==nP){npc.personaPrompt=nP; localStorage.setItem(LS_KEYS.npcPersona(currentCityKey,id),nP); changed=true;} });
                     document.querySelectorAll('#settings-page-4 .settings-env-item[data-env-id]').forEach(item => { const id=item.dataset.envId; const env=environmentData.find(e => e.id == id); if(!env) return; const nIn=item.querySelector('[data-field="envName"]'); if(nIn && env.name!==nIn.value.trim()){ const eIdx=environmentData.findIndex(e => e.id == id); env.name=nIn.value.trim()||`Area ${eIdx+1}`; localStorage.setItem(LS_KEYS.envName(currentCityKey,id), env.name); if(env.nameElement)env.nameElement.textContent=env.name; changed=true;} });
                     if (cityDefinition && (changed||requiresReload)) { localStorage.setItem(currentCityKey, JSON.stringify(cityDefinition)); console.log("Saved updated city def."); }
                     saveNpcPositions(); savePlayerPosition();
                 } else if (!changed) { // Check if provider/model/keys were the *only* change
                     if (localStorage.getItem(LS_KEYS.selectedProvider) !== selectedProvider || localStorage.getItem(LS_KEYS.selectedModel) !== selectedModel) {
                         // This condition might be redundant if `changed` was set correctly above, but safety first
                         changed = true;
                     } else {
                        // Check if keys actually changed compared to storage (more complex, maybe skip for now)
                        // For simplicity, assume saving keys always counts as a change if that section was interacted with.
                     }
                     if (!changed) {
                         addMessage("No changes detected.", "SYSTEM", "debug");
                         closeSettingsModal();
                         return;
                     }
                 }

                 closeSettingsModal();
                 addMessage(changed ? "Settings saved." : "No changes.", "SYSTEM", changed ? "system" : "debug");
                 if (requiresReload) { addMessage("Reloading map...", "SYSTEM", "system"); setTimeout(() => window.location.reload(), 1000); }
            }
            function saveNpcPositions(){ /* ... */ }
            function savePlayerPosition(){ /* ... */ }
            function addCity(){ /* ... */ }
            function deleteCity(){ /* ... */ }
            function modifyCurrentCityDefinition(cb){ /* ... */ }
            function addNpcAtPlayer(){ /* ... */ }
            function handleDeleteNpcFromSettings(event, npcIdToDelete = null) { /* ... */ }
            function addEnvAtPlayer(){ /* ... */ }
            function findClosestEnvironmentZone() { /* ... */ }
            function handleDeleteEnvFromSettings(event, envIdToDelete = null) { /* ... */ }

            // --- MODIFIED: initializeSimulation ---
            function initializeSimulation(cityKey) {
                console.log(`Initializing simulation for city: ${cityKey}`);
                if(npcFollowInterval) clearInterval(npcFollowInterval);

                 // Load Provider/Model State FIRST
                 const savedProvider = localStorage.getItem(LS_KEYS.selectedProvider);
                 const savedModel = localStorage.getItem(LS_KEYS.selectedModel);
                 const providerKeys = Object.keys(PROVIDERS);

                 if (savedProvider && PROVIDERS[savedProvider]) {
                     selectedProvider = savedProvider;
                     const provider = PROVIDERS[selectedProvider];
                     // Validate saved model against the loaded provider
                     if (savedModel && provider.availableModels.includes(savedModel)) {
                         selectedModel = savedModel;
                     } else {
                         console.warn(`Saved model "${savedModel}" not valid for provider "${selectedProvider}". Falling back to default.`);
                         selectedModel = provider.defaultModel; // Fallback to default if saved model invalid
                         localStorage.setItem(LS_KEYS.selectedModel, selectedModel); // Correct storage
                     }
                 } else {
                     // Default to the first provider in the list if none saved or invalid
                     selectedProvider = providerKeys[0];
                     if (!selectedProvider || !PROVIDERS[selectedProvider]) {
                         console.error("FATAL: No valid API providers found in PROVIDERS definition.");
                         addMessage("FATAL: No valid API providers configured.", "SYSTEM", "error");
                         disableInput();
                         return; // Cannot proceed
                     }
                     selectedModel = PROVIDERS[selectedProvider].defaultModel;
                     console.warn(`No valid provider saved. Defaulting to ${selectedProvider} / ${selectedModel}`);
                     localStorage.setItem(LS_KEYS.selectedProvider, selectedProvider);
                     localStorage.setItem(LS_KEYS.selectedModel, selectedModel);
                 }
                 console.log(`[Init] Using API Provider: ${selectedProvider}, Model: ${selectedModel}`);

                // --- Rest of initialization (unchanged) ---
                chatMessages.innerHTML=''; mapContent.innerHTML=''; mapContent.appendChild(playerElement);
                playerElement.style.display='block'; currentCityKey=cityKey;
                const cityDataString=localStorage.getItem(cityKey); let cityDefinition=null;
                if(cityDataString){try{cityDefinition=JSON.parse(cityDataString);}catch(e){console.error(`Failed to parse city data for "${cityKey}":`,e);}}
                if(!cityDefinition){ addMessage(`FATAL ERROR: Could not load or parse city data for key "${cityKey}". Cannot initialize simulation.`, "SYSTEM","error"); disableInput(); currentCityKey=null; return; }

                console.log(`Using city: ${cityDefinition.meta?.cityName||cityKey}`);
                MAP_WIDTH=cityDefinition.map?.width??2000; MAP_HEIGHT=cityDefinition.map?.height??1500;
                mapContent.style.width=`${MAP_WIDTH}px`; mapContent.style.height=`${MAP_HEIGHT}px`;

                // loadApiKeys(); // Removed global key loading here
                interactionMode=localStorage.getItem(LS_KEYS.interactionMode)||'agent';
                hideSystemMessages=localStorage.getItem(LS_KEYS.hideSystemMessages)==='true';
                conversationHistory=[]; recentEvents=[];

                const savedTabsVisibility = localStorage.getItem(LS_KEYS.chatTabsVisible);
                setChatTabsVisibility(savedTabsVisibility === null || savedTabsVisibility === 'true');

                const savedChatHeight=localStorage.getItem(LS_KEYS.chatAreaHeight);
                if(savedChatHeight){ chatArea.style.flexBasis=`${Math.max(parseInt(savedChatHeight,10),parseInt(getComputedStyle(document.documentElement).getPropertyValue('--chat-min-height'))||150)}px`; } else { chatArea.style.flexBasis = '300px'; }
                doChatResize();

                playerData.element=playerElement; playerData.speechElement=playerElement.querySelector('.speech'); playerData.nameplateElement=playerElement.querySelector('.character-name-plate');
                playerData.name=localStorage.getItem(LS_KEYS.playerName)||'Player'; playerData.personaPrompt=localStorage.getItem(LS_KEYS.playerPersona)||"You are the Player.";
                playerData.pfp=localStorage.getItem(LS_KEYS.playerPfp)||DEFAULT_PLAYER_PFP;
                const savedPlayerX=localStorage.getItem(LS_KEYS.playerPositionX(cityKey)); const savedPlayerY=localStorage.getItem(LS_KEYS.playerPositionY(cityKey));
                playerData.x=savedPlayerX!==null?parseFloat(savedPlayerX):(cityDefinition.player?.startX??MAP_WIDTH/2);
                playerData.y=savedPlayerY!==null?parseFloat(savedPlayerY):(cityDefinition.player?.startY??MAP_HEIGHT/2);
                playerData.width=playerElement.offsetWidth||24; playerData.height=playerElement.offsetHeight||36;
                playerData.isTalking=false; playerData.speechTimeout=null;
                const savedPlayerAppearance=localStorage.getItem(LS_KEYS.playerAppearance);
                if(savedPlayerAppearance){try{playerData.appearance=JSON.parse(savedPlayerAppearance);}catch(e){console.error("Player appearance parse error:",e);localStorage.removeItem(LS_KEYS.playerAppearance);playerData.appearance=JSON.parse(JSON.stringify(defaultPlayerAppearance));}} else {playerData.appearance=JSON.parse(JSON.stringify(defaultPlayerAppearance));}
                applyPlayerAppearance(playerData.appearance); updateNameplate(playerData); updateCharacterPosition(playerData);
                playerElement.removeEventListener('contextmenu', handlePlayerContextMenu); playerElement.addEventListener('contextmenu', handlePlayerContextMenu);

                environmentData.length=0; (cityDefinition.environments||[]).forEach((envDef,idx)=>{ const id=envDef.id||`env_${idx}_${Date.now()}`; const zoneElement=document.createElement('div'); zoneElement.className='environment-zone'; zoneElement.id=`env-${id}`; const nameElement=document.createElement('span'); nameElement.className='environment-name-plate'; const savedName=localStorage.getItem(LS_KEYS.envName(cityKey,id)); const currentName=savedName||envDef.name||`Area ${idx+1}`; nameElement.textContent=currentName; zoneElement.appendChild(nameElement); mapContent.appendChild(zoneElement); const envRuntimeData={ id:id, name: currentName, x:envDef.x, y:envDef.y, width:envDef.width, height:envDef.height, element:zoneElement, nameElement:nameElement }; environmentData.push(envRuntimeData); updateEnvironmentVisuals(envRuntimeData); if (savedName === null || savedName !== envRuntimeData.name) { localStorage.setItem(LS_KEYS.envName(cityKey,id),envRuntimeData.name); } }); console.log(`Created ${environmentData.length} environment zones.`);
                npcData.length=0; (cityDefinition.npcSpawns||[]).forEach((spawnDef,idx)=>{ const id=idx; const npcElement=document.createElement('div'); npcElement.className='character npc'; npcElement.id=`npc-${id}`; npcElement.dataset.npcId=id; npcElement.innerHTML=`<div class="part detail5"></div> <div class="part detail4"></div> <div class="part detail3"></div> <div class="part legs"></div> <div class="part arm-left"></div> <div class="part arm-right"></div> <div class="part torso"></div> <div class="part detail1"></div> <div class="part detail2"></div> <div class="part head"></div> <span class="character-name-plate"></span> <span class="speech"></span>`; mapContent.appendChild(npcElement); const namePlate=npcElement.querySelector('.character-name-plate'); const speechBubble=npcElement.querySelector('.speech'); const npcWidth=npcElement.offsetWidth||24; const npcHeight=npcElement.offsetHeight||36; const savedName=localStorage.getItem(LS_KEYS.npcName(cityKey,id)); const savedPersona=localStorage.getItem(LS_KEYS.npcPersona(cityKey,id)); const savedX=localStorage.getItem(LS_KEYS.npcPositionX(cityKey,id)); const savedY=localStorage.getItem(LS_KEYS.npcPositionY(cityKey,id)); const savedPfp=localStorage.getItem(LS_KEYS.npcPfp(cityKey,id)); const defaultName=spawnDef.defaultName||`Agent ${id+1}`; const npc={ id:id, element:npcElement, name:savedName||defaultName, speechElement:speechBubble, nameplateElement:namePlate, personaPrompt:savedPersona||spawnDef.defaultPersona||`You are ${savedName||defaultName}.`, width:npcWidth, height:npcHeight, x:savedX!==null?parseFloat(savedX):spawnDef.x, y:savedY!==null?parseFloat(savedY):spawnDef.y, isTalking:false, speechTimeout:null, appearance:null, pfp: savedPfp||DEFAULT_NPC_PFP, spawnId: spawnDef.spawnId, followingTargetId: null }; if (savedName===null&&npc.name!==defaultName) localStorage.setItem(LS_KEYS.npcName(cityKey,id),npc.name); if (savedPersona===null&&npc.personaPrompt!==(spawnDef.defaultPersona||`You are ${defaultName}.`)) localStorage.setItem(LS_KEYS.npcPersona(cityKey,id),npc.personaPrompt); const savedAppearance=localStorage.getItem(LS_KEYS.npcAppearance(cityKey,id)); if(savedAppearance){try{npc.appearance=JSON.parse(savedAppearance);}catch(e){console.error(`NPC ${id} appearance parse error:`,e);localStorage.removeItem(LS_KEYS.npcAppearance(cityKey,id));npc.appearance=JSON.parse(JSON.stringify(defaultNpcAppearance));}} else {npc.appearance=JSON.parse(JSON.stringify(defaultNpcAppearance));} npcData.push(npc); updateNameplate(npc); applyNpcAppearance(npc); updateCharacterPosition(npc); npcElement.removeEventListener('contextmenu', handleNpcContextMenu); npcElement.addEventListener('contextmenu', handleNpcContextMenu); }); console.log(`Created ${npcData.length} NPCs.`);

                viewportWidth=gameWorld.offsetWidth; viewportHeight=gameWorld.offsetHeight; updateCameraPosition(); initialSpeakerData=findClosestNpc(true);
                const welcomeMsg = `Welcome to ${cityDefinition.meta?.cityName||'the Simulation'}.`;
                const systemSpeakerName = "Tome"; // Or "System", or "Guide" etc.
                addMessage(welcomeMsg, systemSpeakerName, 'system');
                addMessage(`Using API: ${PROVIDERS[selectedProvider]?.name || 'Unknown'} (${selectedModel}). Click sigil for options.`, systemSpeakerName, "system");

                enableInput(); updateInputPlaceholder(); npcFollowInterval=setInterval(updateFollowingNpcs,200);
                console.log(`Initialization complete for: ${cityDefinition.meta?.cityName}. Mode: ${interactionMode.toUpperCase()}. Provider: ${selectedProvider}`);
            }

            function populateCitySelectorInModal(selectElement){ /* ... */ }
            function enterNoCityState() { /* ... */ }
            function doChatResize() { /* ... */ }
            function saveChatHeight() { /* ... */ }

            // --- MODIFIED: Fullscreen Toggle (called from PFP Menu) ---
             function toggleFullscreenChat() { /* ... Implementation unchanged ... */
                 const currentHeight = chatArea.offsetHeight;
                 const windowHeight = window.innerHeight;
                 const minChatHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--chat-min-height')) || 150;
                 const isFullscreen = currentHeight >= (windowHeight - 10); // Use tolerance

                 if (isFullscreen) {
                     // Exit fullscreen: Restore previous height
                     const savedHeight = chatHeightBeforeFullscreen || localStorage.getItem(LS_KEYS.chatAreaHeight);
                     let restoreHeightPx = parseInt(savedHeight, 10);
                     if (isNaN(restoreHeightPx) || restoreHeightPx < minChatHeight || restoreHeightPx >= (windowHeight - 10)) {
                         restoreHeightPx = 300; // Sensible default
                     }
                     chatArea.style.flexBasis = `${restoreHeightPx}px`;
                     console.log("Exiting fullscreen, restored height:", restoreHeightPx);
                     localStorage.setItem(LS_KEYS.chatAreaHeight, `${restoreHeightPx}`);
                     chatHeightBeforeFullscreen = null; // Clear the temporary stored height

                     // Scroll to bottom AFTER resize animation might finish
                     setTimeout(() => {
                         chatMessages.scrollTop = chatMessages.scrollHeight;
                     }, 350); // Delay slightly longer than transition

                 } else {
                     // Enter fullscreen: Store current height, then maximize
                     chatHeightBeforeFullscreen = `${currentHeight}px`; // Store current computed height in px
                     chatArea.style.flexBasis = '100vh';
                     console.log("Entering fullscreen, stored height:", chatHeightBeforeFullscreen);
                 }
                 setTimeout(doChatResize, 50);
             }

            // --- Event Listeners --- (Mostly unchanged, PFP menu listener remains)
            document.addEventListener('keydown',(e)=>{if(settingsOverlay.classList.contains('active')||appearanceEditorOverlay.classList.contains('active')||document.activeElement===userInput||!currentCityKey||isWaitingForApiResponse)return;let m=false;switch(e.key.toLowerCase()){case'arrowup':case'w':movePlayer(0,-1);m=true;break;case'arrowdown':case's':movePlayer(0,1);m=true;break;case'arrowleft':case'a':movePlayer(-1,0);m=true;break;case'arrowright':case'd':movePlayer(1,0);m=true;break;}if(m)e.preventDefault();});
            userInput.addEventListener('keypress',(e)=>{if(e.key==='Enter'&&!sendButton.disabled&&!e.shiftKey){e.preventDefault();handlePlayerSend();}});
            userInput.addEventListener('input',()=>{userInput.style.height='auto';userInput.style.height=(userInput.scrollHeight)+'px';});
            sendButton.addEventListener('click',()=>{if(!sendButton.disabled&&!isWaitingForApiResponse)handlePlayerSend();});
            modalCloseBtn.addEventListener('click',closeSettingsModal); modalCancelBtn.addEventListener('click',closeSettingsModal); modalSaveBtn.addEventListener('click',saveSettings);
            settingsOverlay.addEventListener('click',(e)=>{if(e.target===settingsOverlay)closeSettingsModal();});
            settingsPrevBtn.addEventListener('click',()=>{if(currentSettingsPage>1)showSettingsPage(currentSettingsPage-1);}); settingsNextBtn.addEventListener('click',()=>{if(currentSettingsPage<TOTAL_SETTINGS_PAGES)showSettingsPage(currentSettingsPage+1);});
            appearanceEditorCloseBtn.addEventListener('click', closeAppearanceEditorModal); appearanceEditorCancelBtn.addEventListener('click', closeAppearanceEditorModal); appearanceEditorSaveBtn.addEventListener('click', saveAppearanceFromEditor);
            appearanceEditorOverlay.addEventListener('click',(e)=>{if(e.target===appearanceEditorOverlay)closeAppearanceEditorModal();});
            appearancePfpPreview.addEventListener('click',()=>pfpUploadInput.click()); appearancePfpChangeBtn.addEventListener('click',()=>pfpUploadInput.click());
            pfpUploadInput.addEventListener('change', handlePfpUpload);
            window.addEventListener('resize',()=>{if(currentCityKey){viewportWidth=gameWorld.offsetWidth;viewportHeight=gameWorld.offsetHeight;doChatResize();updateInputPlaceholder();}});
            npcContextMenu.addEventListener('click',(e)=>{ if(e.target.classList.contains('context-menu-item')){const a=e.target.dataset.action; const tN=npcData.find(n=>n.id===contextMenuTargetNpcId); if(!tN){console.error(`NPC ${contextMenuTargetNpcId} not found for context action.`);closeAllContextMenus();return;} console.log(`Action: ${a} on ${tN.name} (ID: ${tN.id})`); switch(a){case 'talk': currentAiNpcData=tN; tN.followingTargetId=null; updateInputPlaceholder(); addMessage("Hello.",playerData.name,'user'); disableInput(); getApiResponseInternal("Hello.",1); break; case 'follow': handleFollowAction(tN); break; case 'appearance': openAppearanceEditorModal(tN.id); break; case 'switch_mode': toggleInteractionMode(); break; case 'cancel': break;} closeAllContextMenus(); }});
            playerContextMenu.addEventListener('click',(e)=>{ if(e.target.classList.contains('context-menu-item')){const a=e.target.dataset.action; console.log(`Action: ${a} on Player`); switch(a){case 'appearance': openAppearanceEditorModal('player'); break; case 'add_area': addEnvAtPlayer(); break; case 'add_agent': addNpcAtPlayer(); break; case 'remove_closest_agent': const cN=findClosestNpc(false); if(cN){handleDeleteNpcFromSettings(null,cN.id);} else {addMessage("No agent nearby to remove.","SYSTEM","system");} break; case 'remove_closest_area': const cZ=findClosestEnvironmentZone(); if(cZ){handleDeleteEnvFromSettings(null,cZ.id);} else {addMessage("No area nearby to remove.","SYSTEM","system");} break; case 'cancel': break;} closeAllContextMenus(); }});
            pfpContextMenu.addEventListener('click', (e) => { if (e.target.classList.contains('context-menu-item')) { const action = e.target.dataset.action; console.log(`PFP Menu Action: ${action}`); switch(action) { case 'toggle-tabs': toggleChatTabsVisibility(); break; case 'toggle-fullscreen': toggleFullscreenChat(); break; case 'cancel': break; } closeAllContextMenus(); } });
            window.addEventListener('beforeunload',(e)=>{if(currentCityKey){saveNpcPositions();savePlayerPosition(); saveChatHeight();} if(npcFollowInterval) clearInterval(npcFollowInterval); });
            window.addEventListener('message', receiveCreatorData);
            function receiveCreatorData(event) { /* ... */ }

            // --- Initial Execution ---
            let cityKeyToLoad=localStorage.getItem(LS_KEYS.selectedCity); if(!cityKeyToLoad||!cityKeyToLoad.startsWith(USER_CITY_PREFIX)||!localStorage.getItem(cityKeyToLoad)){ const userCityKeys=[]; Object.keys(localStorage).forEach(key => { if (key.startsWith(USER_CITY_PREFIX)) userCityKeys.push(key); }); userCityKeys.sort(); cityKeyToLoad=userCityKeys[0]||null; if(cityKeyToLoad){ localStorage.setItem(LS_KEYS.selectedCity, cityKeyToLoad); } }
            if (cityKeyToLoad) { initializeSimulation(cityKeyToLoad); } else { enterNoCityState(); }

        } // End runSimulation

        // Ensure runSimulation is called only after the DOM is ready and api_providers.js is loaded
        document.addEventListener('DOMContentLoaded', runSimulation);
    </script>

</body>
</html>
