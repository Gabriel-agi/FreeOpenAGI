<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Sim - Arcane Tome UI</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Georgia&family=Uncial+Antiqua&display=swap" rel="stylesheet">

    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --parchment: #f5e7d0; --parchment-dark: #e3d5b8; --ink: #3a3129;
            --ink-light: #5a4e42; --gold: #c9a227; --crimson: #8b0000;
            --sapphire: #1e3a8a; --amethyst: #6b21a8; --shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --glow: 0 0 10px rgba(201, 162, 39, 0.7); --fade: all 0.5s ease;
            --skin-tone: #fbe5d6; --default-outline: #222; --swatch-size: 20px;
            --danger-color: var(--crimson); --danger-hover: #6b0000;
            --modal-scrollbar-track: var(--parchment-dark); --modal-scrollbar-thumb: var(--ink-light);
            --modal-scrollbar-thumb-hover: var(--ink); --chat-min-height: 150px;
            --tibia-like-font: 'Uncial Antiqua', cursive;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; overflow: hidden; background-color: var(--parchment); font-family: Georgia, 'Times New Roman', Times, serif; font-size: 1.1rem; line-height: 1.6; color: var(--ink); }
        #ui-container { display: flex; flex-direction: column; width: 100vw; height: 100vh; background-color: transparent; box-sizing: border-box; position: relative; }
        #ui-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('https://www.transparenttextures.com/patterns/old-map.png'); opacity: 0.15; pointer-events: none; z-index: -1; }

        /* --- Game World & Map --- */
        #game-world { flex-grow: 1; background-color: #333; position: relative; overflow: hidden; image-rendering: pixelated; image-rendering: crisp-edges; min-height: 0; }
        #map-content { position: absolute; top: 0; left: 0; width: 3000px; height: 2000px; background-color: #4a7c2d; background-image: linear-gradient(45deg, rgba(0,0,0,0.04) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.04) 75%, rgba(0,0,0,0.04)), linear-gradient(45deg, rgba(0,0,0,0.04) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.04) 75%, rgba(0,0,0,0.04)); background-size: 12px 12px; background-position: 0 0, 6px 6px; transform: translate3d(0, 0, 0); transition: transform 0.3s linear; }

        /* --- Character Styling --- */
        .character { width: 24px; height: 36px; position: absolute; cursor: pointer; z-index: 5; background-color: transparent; border: none; margin-top: 0; transition: top 0.2s linear, left 0.2s linear, opacity 0.5s ease; transform-origin: center bottom; }
        #player { z-index: 6; }
        .character .part { position: absolute; box-sizing: border-box; transition: background-color 0.1s ease, border-color 0.1s ease; display: none; background-color: transparent; image-rendering: pixelated; image-rendering: crisp-edges; }
        .character .part.head, .character .part.torso, .character .part.legs, .character .part.arm-left, .character .part.arm-right, .character .part.detail1 { border: 1px solid var(--default-outline); }
        .character .part.head { z-index: 10; background-color: var(--skin-tone); } .character .part.torso { z-index: 5; } .character .part.legs { z-index: 4; }
        .character .part.arm-left { z-index: 6; transform-origin: 2px 1px; } .character .part.arm-right { z-index: 6; transform-origin: 1px 1px; }
        .character .part.detail1 { z-index: 7; } .character .part.detail2 { z-index: 11; } .character .part.detail3 { z-index: 3; }
        .character .part.detail4 { z-index: 12; border: none; } .character .part.detail5 { z-index: 12; border: none; }
        .character.gender-male .part.head { top: 1px; left: 7px; width: 10px; height: 9px; border-radius: 2px 2px 0 0; }
        .character.gender-male .part.detail2 { display: block; top: 0px; left: 5px; width: 14px; height: 6px; border-radius: 3px 3px 1px 1px; border: 1px solid var(--default-outline); }
        .character.gender-male .part.detail3 { display: block; top: 5px; left: 6px; width: 12px; height: 6px; border-radius: 0 0 2px 2px; border: 1px solid var(--default-outline); }
        .character.gender-male.outfit-citizen .part.head, .character.gender-male.outfit-citizen .part.torso, .character.gender-male.outfit-citizen .part.legs, .character.gender-male.outfit-citizen .part.detail2, .character.gender-male.outfit-citizen .part.detail3, .character.gender-male.outfit-citizen .part.arm-left, .character.gender-male.outfit-citizen .part.arm-right { display: block; }
        .character.gender-male.outfit-citizen .part.torso { top: 9px; left: 5px; width: 14px; height: 12px; border-top-width: 2px; border-bottom: none;}
        .character.gender-male.outfit-citizen .part.legs { top: 21px; left: 6px; width: 12px; height: 9px; border-bottom-width: 3px; border-top: none; }
        .character.gender-male.outfit-citizen .part.arm-left { top: 10px; left: 2px; width: 3px; height: 10px; border-radius: 1px; }
        .character.gender-male.outfit-citizen .part.arm-right { top: 10px; left: 19px; width: 3px; height: 10px; border-radius: 1px; }
        .character.gender-male.outfit-mage .part.head, .character.gender-male.outfit-mage .part.torso, .character.gender-male.outfit-mage .part.legs, .character.gender-male.outfit-mage .part.detail1, .character.gender-male.outfit-mage .part.detail4, .character.gender-male.outfit-mage .part.arm-left, .character.gender-male.outfit-mage .part.arm-right { display: block; }
        .character.gender-male.outfit-mage .part.detail2, .character.gender-male.outfit-mage .part.detail3 { display: none; }
        .character.gender-male.outfit-mage .part.detail4 { top: -4px; left: 4px; width: 16px; height: 10px; border-radius: 50% 50% 0 0 / 40% 40% 0 0; border: 1px solid var(--default-outline); border-bottom: none; clip-path: polygon(50% 0%, 100% 100%, 0% 100%); }
        .character.gender-male.outfit-mage .part.torso { top: 9px; left: 4px; width: 16px; height: 18px; }
        .character.gender-male.outfit-mage .part.legs { top: 27px; left: 6px; width: 12px; height: 6px; border-bottom-width: 3px; border-top: none; }
        .character.gender-male.outfit-mage .part.detail1 { top: 18px; left: 4px; width: 16px; height: 3px; }
        .character.gender-male.outfit-mage .part.arm-left { top: 11px; left: 1px; width: 4px; height: 10px; }
        .character.gender-male.outfit-mage .part.arm-right { top: 11px; left: 19px; width: 4px; height: 10px; }
        .character.gender-male.outfit-warrior .part.head, .character.gender-male.outfit-warrior .part.torso, .character.gender-male.outfit-warrior .part.legs, .character.gender-male.outfit-warrior .part.detail1, .character.gender-male.outfit-warrior .part.detail2, .character.gender-male.outfit-warrior .part.detail3, .character.gender-male.outfit-warrior .part.detail4, .character.gender-male.outfit-warrior .part.detail5, .character.gender-male.outfit-warrior .part.arm-left, .character.gender-male.outfit-warrior .part.arm-right { display: block; }
        .character.gender-male.outfit-warrior .part.detail4 { top: 0px; left: 1px; width: 7px; height: 10px; border-radius: 3px 0 0 0; border-width: 1px; border-style: outset; }
        .character.gender-male.outfit-warrior .part.detail5 { top: 0px; left: 16px; width: 7px; height: 10px; border-radius: 0 3px 0 0; border-width: 1px; border-style: outset; }
        .character.gender-male.outfit-warrior .part.head { border-radius: 1px; }
        .character.gender-male.outfit-warrior .part.torso { top: 9px; left: 4px; width: 16px; height: 13px; border-width: 2px; border-style: outset; }
        .character.gender-male.outfit-warrior .part.legs { top: 22px; left: 5px; width: 14px; height: 8px; border-bottom-width: 4px; border-style: outset; border-top: none;}
        .character.gender-male.outfit-warrior .part.detail1 { top: 18px; left: 4px; width: 16px; height: 4px; }
        .character.gender-male.outfit-warrior .part.arm-left { top: 11px; left: 1px; width: 4px; height: 10px; }
        .character.gender-male.outfit-warrior .part.arm-right { top: 11px; left: 19px; width: 4px; height: 10px; }
        .character.gender-male.outfit-scifi .part.head, .character.gender-male.outfit-scifi .part.torso, .character.gender-male.outfit-scifi .part.legs, .character.gender-male.outfit-scifi .part.detail1, .character.gender-male.outfit-scifi .part.detail2, .character.gender-male.outfit-scifi .part.detail3, .character.gender-male.outfit-scifi .part.arm-left, .character.gender-male.outfit-scifi .part.arm-right { display: block; }
        .character.gender-male.outfit-scifi .part.head { top: 1px; left: 7px; width: 10px; height: 9px; border-radius: 2px; }
        .character.gender-male.outfit-scifi .part.torso { top: 9px; left: 5px; width: 14px; height: 13px; border-style: solid; border-width: 1px 2px;}
        .character.gender-male.outfit-scifi .part.legs { top: 22px; left: 6px; width: 12px; height: 9px; border-bottom-width: 3px; border-style: solid; border-width: 1px 2px;}
        .character.gender-male.outfit-scifi .part.detail1 { top: 11px; left: 8px; width: 8px; height: 5px; border-radius: 1px; z-index: 7; }
        .character.gender-male.outfit-scifi .part.arm-left { top: 10px; left: 2px; width: 4px; height: 11px; border-radius: 1px;}
        .character.gender-male.outfit-scifi .part.arm-right { top: 10px; left: 18px; width: 4px; height: 11px; border-radius: 1px;}
        .character.gender-male.outfit-ranger .part.head, .character.gender-male.outfit-ranger .part.torso, .character.gender-male.outfit-ranger .part.legs, .character.gender-male.outfit-ranger .part.detail1, .character.gender-male.outfit-ranger .part.detail2, .character.gender-male.outfit-ranger .part.detail3, .character.gender-male.outfit-ranger .part.arm-left, .character.gender-male.outfit-ranger .part.arm-right { display: block; }
        .character.gender-male.outfit-ranger .part.torso { top: 9px; left: 5px; width: 14px; height: 13px; }
        .character.gender-male.outfit-ranger .part.legs { top: 22px; left: 6px; width: 12px; height: 9px; border-bottom-width: 3px; }
        .character.gender-male.outfit-ranger .part.detail1 { top: 18px; left: 5px; width: 14px; height: 4px; }
        .character.gender-male.outfit-ranger .part.arm-left { top: 10px; left: 2px; width: 4px; height: 11px; }
        .character.gender-male.outfit-ranger .part.arm-right { top: 10px; left: 18px; width: 4px; height: 11px; }
        .character.gender-male.outfit-kimono .part.head, .character.gender-male.outfit-kimono .part.torso, .character.gender-male.outfit-kimono .part.legs, .character.gender-male.outfit-kimono .part.detail1, .character.gender-male.outfit-kimono .part.detail2, .character.gender-male.outfit-kimono .part.detail3, .character.gender-male.outfit-kimono .part.arm-left, .character.gender-male.outfit-kimono .part.arm-right { display: block; }
        .character.gender-male.outfit-kimono .part.torso { top: 9px; left: 4px; width: 16px; height: 18px; border-radius: 1px; border-right-width: 2px; border-left-width: 2px;}
        .character.gender-male.outfit-kimono .part.legs { top: 27px; left: 6px; width: 12px; height: 6px; border-bottom-width: 3px; border-top: none; }
        .character.gender-male.outfit-kimono .part.detail1 { top: 16px; left: 4px; width: 16px; height: 5px; z-index: 7; }
        .character.gender-male.outfit-kimono .part.arm-left { top: 10px; left: 0px; width: 6px; height: 15px; border-radius: 0 0 2px 2px; }
        .character.gender-male.outfit-kimono .part.arm-right { top: 10px; left: 18px; width: 6px; height: 15px; border-radius: 0 0 2px 2px; }
        .character.gender-female .part.head { width: 12px; height: 11px; left: 6px; top: 1px; border-radius: 40% 40% 35% 35%; }
        .character.gender-female .part.detail3 { display: block; top: 4px; left: 4px; width: 16px; height: 20px; border-radius: 0 0 10px 10px; border: none; }
        .character.gender-female .part.detail2 { display: block; top: 1px; left: 5px; width: 14px; height: 8px; border-radius: 5px 5px 2px 2px; border: none; border-bottom: 1px solid #111;}
        .character.gender-female.outfit-citizen .part.head, .character.gender-female.outfit-citizen .part.torso, .character.gender-female.outfit-citizen .part.legs, .character.gender-female.outfit-citizen .part.detail1, .character.gender-female.outfit-citizen .part.detail2, .character.gender-female.outfit-citizen .part.detail3, .character.gender-female.outfit-citizen .part.arm-left, .character.gender-female.outfit-citizen .part.arm-right { display: block; }
        .character.gender-female.outfit-citizen .part.torso { top: 10px; left: 7px; width: 10px; height: 11px; border-radius: 2px; }
        .character.gender-female.outfit-citizen .part.detail1 { top: 18px; left: 6px; width: 12px; height: 3px; border-radius: 1px; }
        .character.gender-female.outfit-citizen .part.legs { top: 21px; left: 5px; width: 14px; height: 10px; border-bottom-width: 3px; border-top: none; border-radius: 0 0 5px 5px; }
        .character.gender-female.outfit-citizen .part.arm-left { top: 11px; left: 4px; width: 3px; height: 6px; border-radius: 1px; }
        .character.gender-female.outfit-citizen .part.arm-right { top: 11px; left: 17px; width: 3px; height: 6px; border-radius: 1px; }
        .character.gender-female.outfit-mage .part.head, .character.gender-female.outfit-mage .part.torso, .character.gender-female.outfit-mage .part.legs, .character.gender-female.outfit-mage .part.detail1, .character.gender-female.outfit-mage .part.detail2, .character.gender-female.outfit-mage .part.detail3, .character.gender-female.outfit-mage .part.arm-left, .character.gender-female.outfit-mage .part.arm-right { display: block; }
        .character.gender-female.outfit-mage .part.head { top: 2px; }
        .character.gender-female.outfit-mage .part.detail2 { top: 1px; left: 4px; width: 16px; height: 9px; border-radius: 6px 6px 3px 3px; }
        .character.gender-female.outfit-mage .part.detail3 { top: 5px; left: 4px; width: 16px; height: 22px; border-radius: 0 0 10px 10px;}
        .character.gender-female.outfit-mage .part.torso { top: 11px; left: 5px; width: 14px; height: 18px; border-radius: 2px; }
        .character.gender-female.outfit-mage .part.detail1 { top: 14px; left: 9px; width: 6px; height: 4px; border-radius: 50%; z-index: 7; }
        .character.gender-female.outfit-mage .part.legs { top: 29px; left: 6px; width: 12px; height: 5px; border-bottom-width: 2px; border-top: none; border-radius: 0 0 3px 3px;}
        .character.gender-female.outfit-mage .part.arm-left { top: 12px; left: 1px; width: 5px; height: 15px; border-radius: 0 0 3px 3px; }
        .character.gender-female.outfit-mage .part.arm-right { top: 12px; left: 18px; width: 5px; height: 15px; border-radius: 0 0 3px 3px; }
        .character.gender-female.outfit-warrior .part.head, .character.gender-female.outfit-warrior .part.torso, .character.gender-female.outfit-warrior .part.legs, .character.gender-female.outfit-warrior .part.detail1, .character.gender-female.outfit-warrior .part.detail2, .character.gender-female.outfit-warrior .part.detail3, .character.gender-female.outfit-warrior .part.arm-left, .character.gender-female.outfit-warrior .part.arm-right { display: block; }
        .character.gender-female.outfit-warrior .part.torso { top: 10px; left: 6px; width: 12px; height: 11px; border-radius: 3px 3px 1px 1px; border-style: solid; border-width: 1px; }
        .character.gender-female.outfit-warrior .part.detail1 { top: 20px; left: 4px; width: 16px; height: 7px; border-radius: 0 0 4px 4px; border-style: outset; }
        .character.gender-female.outfit-warrior .part.legs { top: 27px; left: 7px; width: 10px; height: 6px; border-bottom-width: 3px; border-top: none; }
        .character.gender-female.outfit-warrior .part.arm-left { top: 11px; left: 3px; width: 3px; height: 9px; border-radius: 1px; border-style: outset; border-width: 1px; }
        .character.gender-female.outfit-warrior .part.arm-right { top: 11px; left: 18px; width: 3px; height: 9px; border-radius: 1px; border-style: outset; border-width: 1px; }
        .character.gender-female.outfit-warrior .part.detail2 { top: 1px; height: 7px; left: 4px; width: 16px;}
        .character.gender-female.outfit-warrior .part.detail3 { height: 22px;}
        .character.gender-female.outfit-scifi .part.head, .character.gender-female.outfit-scifi .part.torso, .character.gender-female.outfit-scifi .part.legs, .character.gender-female.outfit-scifi .part.detail1, .character.gender-female.outfit-scifi .part.detail2, .character.gender-female.outfit-scifi .part.detail3, .character.gender-female.outfit-scifi .part.arm-left, .character.gender-female.outfit-scifi .part.arm-right { display: block; }
        .character.gender-female.outfit-scifi .part.torso { top: 10px; left: 6px; width: 12px; height: 12px; border-style: solid; border-width: 1px; border-radius: 2px; }
        .character.gender-female.outfit-scifi .part.legs { top: 22px; left: 7px; width: 10px; height: 9px; border-bottom-width: 3px; border-style: solid; border-width: 1px; }
        .character.gender-female.outfit-scifi .part.detail1 { top: 11px; left: 9px; width: 6px; height: 4px; border-radius: 1px; z-index: 7;}
        .character.gender-female.outfit-scifi .part.arm-left { top: 11px; left: 3px; width: 3px; height: 11px; border-radius: 1px; }
        .character.gender-female.outfit-scifi .part.arm-right { top: 11px; left: 18px; width: 3px; height: 11px; border-radius: 1px; }
        .character.gender-female.outfit-ranger .part.head, .character.gender-female.outfit-ranger .part.torso, .character.gender-female.outfit-ranger .part.legs, .character.gender-female.outfit-ranger .part.detail1, .character.gender-female.outfit-ranger .part.detail2, .character.gender-female.outfit-ranger .part.detail3, .character.gender-female.outfit-ranger .part.arm-left, .character.gender-female.outfit-ranger .part.arm-right { display: block; }
        .character.gender-female.outfit-ranger .part.torso { top: 10px; left: 6px; width: 12px; height: 13px; border-radius: 1px; }
        .character.gender-female.outfit-ranger .part.legs { top: 23px; left: 7px; width: 10px; height: 8px; border-bottom-width: 3px;}
        .character.gender-female.outfit-ranger .part.detail1 { top: 19px; left: 6px; width: 12px; height: 4px; z-index: 7;}
        .character.gender-female.outfit-ranger .part.arm-left { top: 11px; left: 3px; width: 3px; height: 11px; }
        .character.gender-female.outfit-ranger .part.arm-right { top: 11px; left: 18px; width: 3px; height: 11px; }
        .character.gender-female.outfit-kimono .part.head, .character.gender-female.outfit-kimono .part.torso, .character.gender-female.outfit-kimono .part.legs, .character.gender-female.outfit-kimono .part.detail1, .character.gender-female.outfit-kimono .part.detail2, .character.gender-female.outfit-kimono .part.detail3, .character.gender-female.outfit-kimono .part.arm-left, .character.gender-female.outfit-kimono .part.arm-right { display: block; }
        .character.gender-female.outfit-kimono .part.torso { top: 10px; left: 4px; width: 16px; height: 17px; border-radius: 1px; border-right-width: 2px; border-left-width: 2px; border-style: solid;}
        .character.gender-female.outfit-kimono .part.legs { top: 27px; left: 7px; width: 10px; height: 7px; border-bottom-width: 2px; border-top: none;}
        .character.gender-female.outfit-kimono .part.detail1 { top: 17px; left: 4px; width: 16px; height: 7px; border-radius: 1px;}
        .character.gender-female.outfit-kimono .part.arm-left { top: 11px; left: 0px; width: 6px; height: 18px; border-radius: 0 0 6px 2px; }
        .character.gender-female.outfit-kimono .part.arm-right { top: 11px; left: 18px; width: 6px; height: 18px; border-radius: 0 0 2px 6px; }
        @keyframes playerBobbing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } }
        @keyframes playerWalkArmLeft { 0%, 100% { transform: rotate(-10deg) translateX(0px); } 50% { transform: rotate(8deg) translateX(0px); } }
        @keyframes playerWalkArmRight { 0%, 100% { transform: rotate(8deg) translateX(0px); } 50% { transform: rotate(-10deg) translateX(0px); } }
        @keyframes playerWalkLegs { 0%, 100% { transform: translateX(0px); } 50% { transform: translateX(-0.5px); } }
        #player.is-walking { animation: playerBobbing 0.5s infinite ease-in-out; }
        #player.is-walking .part.arm-left { animation: playerWalkArmLeft 0.5s infinite ease-in-out; }
        #player.is-walking .part.arm-right { animation: playerWalkArmRight 0.5s infinite ease-in-out; }
        #player.is-walking .part.legs { animation: playerWalkLegs 0.5s infinite ease-in-out; }
        .character .character-name-plate { position: absolute; bottom: calc(100% + 10px); left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: bold; white-space: nowrap; text-shadow: 1px 1px 1px #000; z-index: 11; border: 1px solid rgba(255, 255, 255, 0.2); pointer-events: none; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        .character .speech { display: none; }

        /* --- Environment Zones --- */
        .environment-zone { position: absolute; border: 2px dashed rgba(58, 49, 41, 0.5); background-color: rgba(58, 49, 41, 0.08); border-radius: 8px; display: flex; justify-content: center; align-items: flex-start; padding-top: 8px; pointer-events: none; box-sizing: border-box; z-index: 1; color: var(--ink-light); font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .environment-name-plate { background-color: rgba(58, 49, 41, 0.6); color: var(--parchment); padding: 3px 8px; border-radius: 4px; white-space: nowrap; border: 1px solid rgba(245, 231, 208, 0.3); }

        /* --- Chat Area & Messages --- */
        #chat-area { flex-basis: 300px; min-height: var(--chat-min-height); display: flex; flex-direction: column; background: var(--parchment-dark); flex-shrink: 0; position: relative; border-top: 2px solid var(--ink-light); transition: flex-basis 0.3s ease-out; }
        /* --- Chat Tabs --- */
        #chat-tabs-container {
            display: flex; padding: 5px 15px; gap: 8px; background-color: var(--parchment-dark);
            border-bottom: 1px solid var(--ink-light); flex-shrink: 0;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease, border 0.3s ease;
            max-height: 100px; overflow: hidden; opacity: 1; flex-wrap: wrap;
        }
        #chat-tabs-container.hidden { max-height: 0; padding-top: 0; padding-bottom: 0; opacity: 0; border-bottom: none; pointer-events: none; }
        #chat-tabs-container button {
            background-color: var(--parchment); border: 1px solid var(--ink-light); border-radius: 6px; padding: 5px 12px;
            color: var(--ink); font-size: 0.95rem; cursor: pointer; transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            font-family: Georgia, serif; flex-shrink: 0;
        }
        #chat-tabs-container button:hover { background-color: var(--parchment-dark); box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        #chat-tabs-container button.active-tab { background-color: var(--gold); color: var(--ink); border-color: var(--gold); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        /* Apply Tibia font to renamed Chat tab and others (REMOVED #general-tab rule, changed #message-tab to #chat-tab) */
        #chat-tabs-container button#area-tab,
        #chat-tabs-container button#city-tab,
        #chat-tabs-container button#world-tab,
        #chat-tabs-container button#chat-tab, /* <-- RENAMED */
        #chat-tabs-container button#agent-tab {
            font-family: var(--tibia-like-font);
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        /* --- End Chat Tabs --- */
        .chat-messages { flex: 1; padding: 25px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--ink-light) var(--parchment-dark); display: flex; flex-direction: column; gap: 10px; background-color: var(--parchment); }
        .chat-messages::-webkit-scrollbar { width: 8px; } .chat-messages::-webkit-scrollbar-track { background: var(--parchment-dark); } .chat-messages::-webkit-scrollbar-thumb { background-color: var(--ink-light); border-radius: 4px; }
        .message { display: flex; gap: 15px; max-width: 85%; animation: appear 0.8s ease-out; margin-bottom: 10px; }
        .message-user { align-self: flex-end; flex-direction: row-reverse; } .message-spirit { align-self: flex-start; }
        .message-system, .message-debug { align-self: flex-start; opacity: 0.8; font-size: 0.9em;}
        .message-system .message-content, .message-debug .message-content { background-color: var(--parchment-dark); border: 1px dashed var(--ink-light); }
        /* Style for spatial chat messages (plain text) */
        .spatial-message { font-family: monospace; font-size: 1rem; color: var(--ink); white-space: pre-wrap; line-height: 1.4; padding: 2px 0; border-bottom: 1px dotted var(--ink-light); }
        .spatial-message:last-child { border-bottom: none; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--parchment-dark); box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; font-family: 'Cinzel Decorative', cursive; font-size: 1.5rem; transition: var(--fade); color: white; cursor: pointer; }
        .user-avatar { background-color: var(--sapphire); } .spirit-avatar { background-color: var(--amethyst); }
        .system-avatar, .debug-avatar { background-color: var(--ink-light); font-size: 1.2rem; }
        .spirit-avatar:hover, .user-avatar:hover, .system-avatar:hover, .debug-avatar:hover { transform: scale(1.1); box-shadow: var(--glow); }
        .message-content { padding: 18px 22px; border-radius: 8px; line-height: 1.6; position: relative; word-break: break-word; box-shadow: var(--shadow); max-width: 100%; font-size: 1.1rem; }
        .message-content p { margin-bottom: 1em; } .message-content p:last-child { margin-bottom: 0; }
        .message-content strong { font-weight: bold; color: var(--ink); } .message-content em { font-style: italic; }
        .message-content ul, .message-content ol { margin-left: 1.5em; margin-bottom: 1em; } .message-content li { margin-bottom: 0.5em; }
        .message-content code { font-family: monospace; background-color: rgba(0, 0, 0, 0.1); padding: 0.2em 0.4em; border-radius: 3px; }
        .message-content pre { position: relative; background-color: rgba(0, 0, 0, 0.1); padding: 1em; border-radius: 5px; overflow-x: auto; margin-bottom: 1em; font-family: monospace; font-size: 0.95em; }
        .copy-code-btn { position: absolute; top: 5px; right: 5px; background-color: var(--gold); color: var(--ink); border: none; border-radius: 3px; padding: 3px 8px; font-size: 0.8rem; cursor: pointer; opacity: 0; transition: opacity 0.3s ease; }
        .message-content pre:hover .copy-code-btn { opacity: 1; } .copy-code-btn:hover { background-color: var(--crimson); color: white; }
        .copy-code-btn.copied { background-color: var(--sapphire); color: white; }
        .message-content blockquote { border-left: 3px solid var(--gold); padding-left: 1em; margin-left: 0; margin-bottom: 1em; color: var(--ink-light); }
        .user-message { background-color: var(--sapphire); color: white; border-top-right-radius: 0; }
        .spirit-message { background-color: white; color: var(--ink); border: 1px solid var(--ink-light); border-top-left-radius: 0; }
        .system-message, .debug-message { background-color: var(--parchment-dark); color: var(--ink-light); border: 1px dashed var(--ink-light); border-top-left-radius: 0; font-style: italic; }
        .system-message .message-name, .debug-message .message-name { font-weight: bold; margin-right: 5px; display: inline-block; }
        .typing-indicator { display: inline-flex; align-items: center; gap: 8px; padding: 15px 20px; background-color: var(--parchment-dark); border-radius: 8px; box-shadow: var(--shadow); align-self: flex-start; color: var(--ink-light); font-style: italic; border: 1px dashed var(--ink-light); position: relative; overflow: hidden; font-size: 1rem; margin-left: 65px; }
        .typing-indicator::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(201, 162, 39, 0.2), transparent); animation: shimmer 2s infinite; }
        .rune { font-family: 'Cinzel Decorative', cursive; font-size: 1.2rem; animation: float 2s infinite ease-in-out; margin-left: 5px; }

        /* --- Input Area --- */
        .input-container { padding: 18px; background-color: var(--parchment-dark); border-top: none; display: flex; gap: 12px; align-items: flex-end; flex-shrink: 0; }
        #userInput { flex: 1; padding: 18px; background-color: var(--parchment); border: 2px solid var(--ink-light); border-radius: 5px; font-family: inherit; font-size: 1.1rem; resize: none; outline: none; color: var(--ink); min-height: 60px; max-height: 200px; line-height: 1.5; overflow-y: auto; }
        #userInput:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.3); }
        #userInput::placeholder { color: var(--ink-light); font-style: italic; }
        #sendButton { background-color: var(--gold); color: var(--ink); border: none; border-radius: 5px; padding: 0 24px; height: 60px; font-family: 'Cinzel Decorative', cursive; font-weight: bold; cursor: pointer; transition: var(--fade); box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.1rem; flex-shrink: 0; align-self: flex-end; }
        #sendButton:hover:not(:disabled) { background-color: var(--crimson); color: white; }
        #sendButton:disabled { opacity: 0.7; cursor: not-allowed; background-color: var(--ink-light); color: var(--parchment); }

        /* --- Settings Modal (Paginated) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: var(--fade); }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background-color: var(--parchment); color: var(--ink); border-radius: 8px;
            width: 90%; max-width: 800px; padding: 0;
            box-shadow: var(--shadow); transform: translateY(20px); transition: var(--fade);
            max-height: 85vh; display: flex; flex-direction: column;
            border: 1px solid var(--ink-light); overflow: hidden;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 0; border-bottom: 1px solid var(--ink-light);
            padding: 20px 28px 15px 28px; flex-shrink: 0;
        }
        .modal-title { font-family: 'Cinzel Decorative', cursive; font-size: 1.5rem; color: var(--ink); }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: var(--ink-light); font-size: 1.8rem; line-height: 1; transition: var(--fade); }
        .modal-close-btn:hover { color: var(--crimson); }
        .modal-body {
            flex-grow: 1; overflow: hidden; display: flex; flex-direction: column;
            min-height: 300px; padding: 0 28px;
        }
        .settings-page { display: none; flex-grow: 1; overflow-y: auto; padding: 20px 5px 20px 0; scrollbar-width: thin; scrollbar-color: var(--modal-scrollbar-thumb) var(--modal-scrollbar-track); }
        .settings-page.active { display: block; }
        .settings-page::-webkit-scrollbar { width: 8px; } .settings-page::-webkit-scrollbar-track { background: var(--modal-scrollbar-track); border-radius: 4px; } .settings-page::-webkit-scrollbar-thumb { background-color: var(--modal-scrollbar-thumb); border-radius: 4px; border: 1px solid var(--modal-scrollbar-track); } .settings-page::-webkit-scrollbar-thumb:hover { background-color: var(--modal-scrollbar-thumb-hover); }
        .settings-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px dashed var(--ink-light); } .settings-section:last-child { border-bottom: none; margin-bottom: 0; }
        .settings-section-title { font-size: 1.3rem; font-weight: bold; color: var(--ink); margin-bottom: 15px; border-bottom: 1px solid var(--gold); padding-bottom: 8px; font-family: 'Cinzel Decorative', cursive; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .settings-item { background-color: var(--parchment-dark); padding: 15px; border-radius: 6px; border: 1px solid var(--ink-light); position: relative; }
        .settings-label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color: var(--ink); }
        .settings-input, .settings-textarea, .settings-select {
            width: 100%; padding: 10px 12px; border: 1px solid var(--ink-light); border-radius: 4px;
            font-family: inherit; font-size: 1rem; background-color: var(--parchment); color: var(--ink);
            margin-bottom: 10px; box-sizing: border-box; line-height: 1.5;
        }
        .settings-textarea { min-height: 80px; resize: vertical; }
        .settings-input:focus, .settings-textarea:focus, .settings-select:focus {
             border-color: var(--gold); outline: none; box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.3);
        }
        .settings-env-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; position: relative; padding-right: 30px; }
        .settings-env-label { flex-shrink: 0; width: 80px; text-align: right; font-weight: normal; color: var(--ink); }
        .settings-env-input { flex-grow: 1; }
        .settings-delete-btn { position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; line-height: 18px; text-align: center; background-color: var(--danger-color); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; font-weight: bold; transition: background-color 0.2s ease; padding: 0; }
        .settings-delete-btn:hover { background-color: var(--danger-hover); }
        .settings-env-item .settings-delete-btn { top: 50%; right: 5px; transform: translateY(-50%); }
        .settings-city-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .settings-city-controls label { font-weight: bold; color: var(--ink); flex-shrink: 0; margin-right: 5px; }
        .settings-city-selector { padding: 8px 10px; border-radius: 4px; border: 1px solid var(--ink-light); background-color: var(--parchment); color: var(--ink); font-size: 1rem; flex-grow: 1; min-width: 150px; font-family: inherit; }
        .settings-city-edit-btn { padding: 6px 10px; font-size: 1rem; height: 38px; line-height: 1; border-radius: 6px; background-color: var(--ink-light); color: var(--parchment); border: none; cursor: pointer; flex-shrink: 0; transition: var(--fade); font-family: 'Cinzel Decorative', cursive; display: inline-flex; align-items: center; justify-content: center;}
        .settings-city-edit-btn:hover { background-color: var(--ink); }
        .settings-city-delete-btn { background-color: var(--danger-color); color: white; } .settings-city-delete-btn:hover { background-color: var(--danger-hover); }
        .settings-city-add-btn { background-color: var(--gold); color: var(--ink); } .settings-city-add-btn:hover { background-color: #a1801f; }
        /* API Key Multi-Key Styles */
        .settings-api-config { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;}
        .api-key-management { display: flex; flex-direction: column; gap: 15px; }
        .api-key-list-container { max-height: 150px; overflow-y: auto; border: 1px solid var(--ink-light); border-radius: 4px; background-color: var(--parchment-dark); padding: 8px; scrollbar-width: thin; scrollbar-color: var(--modal-scrollbar-thumb) var(--modal-scrollbar-track); }
        .api-key-list-container::-webkit-scrollbar { width: 6px; } .api-key-list-container::-webkit-scrollbar-track { background: var(--modal-scrollbar-track); border-radius: 3px; } .api-key-list-container::-webkit-scrollbar-thumb { background-color: var(--modal-scrollbar-thumb); border-radius: 3px; } .api-key-list-container::-webkit-scrollbar-thumb:hover { background-color: var(--modal-scrollbar-thumb-hover); }
        .api-key-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; border-bottom: 1px dashed var(--ink-light); font-size: 0.9rem; } .api-key-item:last-child { border-bottom: none; }
        .api-key-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70%; font-family: monospace; }
        .api-key-item-controls { display: flex; gap: 5px; flex-shrink: 0; }
        .api-key-item-controls button { padding: 3px 8px; font-size: 0.8rem; border-radius: 3px; cursor: pointer; border: none; transition: var(--fade); font-family: 'Cinzel Decorative', cursive; }
        .api-key-item-delete-btn { background-color: var(--danger-color); color: white; } .api-key-item-delete-btn:hover { background-color: var(--danger-hover); }
        .api-key-add-controls { display: flex; gap: 10px; }
        #newApiKeyInput { flex-grow: 1; padding: 10px 12px; border: 1px solid var(--ink-light); border-radius: 4px; font-family: inherit; font-size: 1rem; background-color: var(--parchment); color: var(--ink); box-sizing: border-box; }
        #addApiKeyBtn { padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: var(--fade); border: none; font-size: 1rem; background-color: var(--gold); color: var(--ink); font-family: 'Cinzel Decorative', cursive; }
        #addApiKeyBtn:hover:not(:disabled) { background-color: #a1801f; }
        #addApiKeyBtn:disabled { background-color: var(--ink-light); opacity: 0.7; cursor: not-allowed; }
        #newApiKeyInput:disabled { background-color: var(--parchment-dark); cursor: not-allowed; }
        .active-key-display { margin-top: 10px; font-size: 0.9rem; color: var(--ink-light); }
        .active-key-display strong { font-family: monospace; color: var(--amethyst); }
        .key-list-message { font-style: italic; color: var(--ink-light); text-align: center; padding: 10px 0; font-size: 0.9rem; }
        /* End API Key Multi-Key Styles */
        .map-size-inputs { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .map-size-inputs input[type="number"] { width: 80px; padding: 8px 10px; font-size: 1rem; border: 1px solid var(--ink-light); background-color: var(--parchment); color: var(--ink); border-radius: 4px;}
        .map-size-inputs label { font-size: 1rem; color: var(--ink); margin-right: 5px; }
        .settings-checkbox-item { display: flex; align-items: center; gap: 8px; background-color: var(--parchment-dark); padding: 10px 15px; border-radius: 6px; border: 1px solid var(--ink-light); }
        .settings-checkbox-item label { font-size: 1rem; color: var(--ink); cursor: pointer; user-select: none; }
        .settings-checkbox-item input[type="checkbox"] { cursor: pointer; accent-color: var(--gold); }
        .settings-pagination {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 0; padding: 15px 28px;
            border-top: 1px solid var(--ink-light); flex-shrink: 0;
        }
        .pagination-btn { padding: 8px 16px; border-radius: 5px; font-family: 'Cinzel Decorative', cursive; font-weight: bold; cursor: pointer; transition: var(--fade); border: none; font-size: 1rem; background-color: var(--ink-light); color: var(--parchment); }
        .pagination-btn:hover:not(:disabled) { background-color: var(--ink); }
        .pagination-btn:disabled { background-color: var(--parchment-dark); color: var(--ink-light); cursor: not-allowed; }
        .page-indicator { font-size: 1rem; color: var(--ink-light); font-weight: bold; }
        .modal-footer {
            margin-top: 0; padding: 15px 28px 20px 28px;
            border-top: 1px solid var(--ink-light); display: flex; justify-content: flex-end;
            gap: 10px; flex-shrink: 0; background-color: var(--parchment-dark);
        }
        .modal-btn { padding: 12px 24px; border-radius: 5px; font-family: 'Cinzel Decorative', cursive; font-weight: bold; cursor: pointer; transition: var(--fade); border: none; font-size: 1.1rem; }
        .modal-btn-primary { background-color: var(--gold); color: var(--ink); } .modal-btn-primary:hover { background-color: var(--crimson); color: white; }
        .modal-btn-secondary { background-color: var(--ink-light); color: var(--parchment); } .modal-btn-secondary:hover { background-color: var(--ink); color: white; }

        /* --- Appearance Editor Modal --- */
         #appearance-editor-overlay .modal-content { max-width: 900px; }
        #appearance-editor-overlay .modal-body { overflow-y: auto; padding: 20px 28px 20px 28px; flex-grow: 1; scrollbar-width: thin; scrollbar-color: var(--modal-scrollbar-thumb) var(--modal-scrollbar-track); touch-action: pan-y; -webkit-overflow-scrolling: touch; min-height: 0; }
        #appearance-editor-overlay .modal-body::-webkit-scrollbar { width: 8px; } #appearance-editor-overlay .modal-body::-webkit-scrollbar-track { background: var(--modal-scrollbar-track); border-radius: 4px; } #appearance-editor-overlay .modal-body::-webkit-scrollbar-thumb { background-color: var(--modal-scrollbar-thumb); border-radius: 4px; border: 1px solid var(--modal-scrollbar-track); } #appearance-editor-overlay .modal-body::-webkit-scrollbar-thumb:hover { background-color: var(--modal-scrollbar-thumb-hover); }
        .appearance-editor-details { padding: 15px; background-color: var(--parchment-dark); border: 1px solid var(--ink-light); border-radius: 6px; margin-bottom: 15px; display: grid; grid-template-columns: auto 1fr auto; gap: 10px 15px; align-items: center; }
        .appearance-editor-details label { font-weight: bold; font-size: 1rem; color: var(--ink); text-align: right; }
        .appearance-editor-details input, .appearance-editor-details textarea { grid-column: 2; width: 100%; padding: 10px 12px; border: 1px solid var(--ink-light); border-radius: 4px; font-family: inherit; font-size: 1rem; background-color: var(--parchment); color: var(--ink); box-sizing: border-box; }
        .appearance-editor-details textarea { min-height: 60px; resize: vertical; line-height: 1.5; }
        .appearance-editor-details input:focus, .appearance-editor-details textarea:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.3); }
        .appearance-pfp-section { grid-column: 3; display: flex; flex-direction: column; align-items: center; gap: 8px; padding-left: 15px; }
        .appearance-pfp-preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--ink-light); cursor: pointer; transition: border-color 0.3s ease; }
        .appearance-pfp-preview:hover { border-color: var(--gold); }
        .appearance-pfp-change-btn { font-size: 0.9rem; color: var(--ink-light); cursor: pointer; text-decoration: underline; background: none; border: none; padding: 0; }
        .appearance-pfp-change-btn:hover { color: var(--gold); }
        .appearance-iframe-container { border: 1px solid var(--ink-light); padding: 0; background-color: var(--parchment-dark); border-radius: 6px; overflow: hidden; flex-shrink: 0; }
        #characterCreatorFrame { width: 100%; height: 500px; border: none; display: block; background-color: var(--ink-light); }
        .pfp-upload { display: none; }

        /* --- Context Menu --- */
        .context-menu { display: none; position: absolute; background-color: var(--parchment-dark); border: 1px solid var(--ink-light); border-radius: 4px; padding: 5px 0; z-index: 1050; box-shadow: var(--shadow); min-width: 180px; font-size: 1rem; color: var(--ink); font-family: Georgia, serif; }
        .context-menu-item { padding: 8px 18px; cursor: pointer; white-space: nowrap; }
        .context-menu-item:hover { background-color: var(--ink-light); color: var(--parchment); }
        .context-menu-divider { border: none; border-top: 1px solid var(--ink-light); margin: 4px 0; }

        /* Animations */
        @keyframes appear { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* Responsive */
        @media (max-width: 768px) {
            body { font-size: 1rem; } .chat-messages { padding: 18px; }
            .message-content { padding: 15px 18px; font-size: 1rem; } .input-container { padding: 15px; }
            #userInput { padding: 15px; min-height: 50px; font-size: 1rem; }
            #sendButton { height: 55px; padding: 0 18px; font-size: 1rem; }
            .avatar { width: 40px; height: 40px; font-size: 1.1rem; }
             .typing-indicator { margin-left: 55px; font-size: 0.9rem;} .rune { font-size: 1rem;}
             /* Modal adjustments */
             .modal-content { padding: 0; width: 95%; }
             .modal-header { padding: 15px 20px 10px 20px; }
             .modal-body { padding: 0 20px; }
             .settings-page { padding: 15px 5px 15px 0; }
             .settings-pagination { padding: 10px 20px; flex-direction: column; gap: 10px; } .page-indicator { order: -1; }
             .modal-footer { padding: 10px 20px 15px 20px; }
             /* Appearance Editor */
             #appearance-editor-overlay .modal-body { padding: 15px 20px; }
             .appearance-editor-details { grid-template-columns: auto 1fr; }
             .appearance-pfp-section { grid-column: 1 / -1; grid-row: 3; justify-self: center; padding-left: 0; margin-top: 10px; }
            /* Adjust tab buttons for smaller screens */
            #chat-tabs-container { padding: 5px 10px; gap: 5px; }
            #chat-tabs-container button { padding: 5px 10px; font-size: 0.9rem; }
             #chat-tabs-container button#area-tab,
             #chat-tabs-container button#city-tab,
             #chat-tabs-container button#world-tab,
             #chat-tabs-container button#chat-tab, /* <-- RENAMED */
             #chat-tabs-container button#agent-tab { font-size: 0.8rem; }
             /* API Config Responsive */
             .settings-api-config { grid-template-columns: 1fr; }
             .api-key-list-container { max-height: 120px; }
             .api-key-item span { max-width: 60%; }
        }
    </style>
</head>
<body>
    <div id="ui-container">
        <div id="game-world">
            <div id="map-content">
                 <div class="character" id="player" data-name="Player">
                    <div class="part detail5"></div> <div class="part detail4"></div>
                    <div class="part detail3"></div> <div class="part legs"></div>
                    <div class="part arm-left"></div> <div class="part arm-right"></div>
                    <div class="part torso"></div> <div class="part detail1"></div>
                    <div class="part detail2"></div> <div class="part head"></div>
                    <span class="character-name-plate">Player</span>
                    <span class="speech"></span>
                </div>
                 <!-- NPCs added by JS -->
            </div>
        </div>
        <div id="chat-area">
             <!-- Chat Tabs Container (MODIFIED) -->
             <div id="chat-tabs-container">
                 <button id="chat-tab" data-mode="message">CHAT</button> <!-- MOVED & RENAMED -->
                 <button id="area-tab" data-mode="spatial" data-scope="Area">AREA</button>
                 <button id="city-tab" data-mode="spatial" data-scope="City">CITY</button>
                 <button id="world-tab" data-mode="spatial" data-scope="World">WORLD</button>
                 <!-- <button id="message-tab" data-mode="message">MESSAGE</button> ORIGINAL POSITION -->
                 <button id="agent-tab" data-mode="agent">AGENT</button>
                 <!-- REMOVED general-tab -->
             </div>
             <div class="chat-messages" id="chatMessages"></div>
             <div class="input-container">
                <textarea class="message-input" id="userInput" placeholder="Consult the spirit..." rows="1"></textarea>
                 <button class="send-button" id="sendButton" title="Send Message"><span>Send</span><span style="font-size: 1.2em;">→</span></button>
            </div>
        </div>
    </div>

    <!-- Settings Modal (Paginated) -->
    <div class="modal-overlay" id="settings-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tome Configuration</h3>
                <button class="modal-close-btn" id="modal-close-btn">×</button>
             </div>
            <div class="modal-body" id="settings-body-container">
                <!-- Pages populated by JS -->
            </div>
             <div class="settings-pagination" id="settings-pagination-controls">
                 <button class="pagination-btn" id="settings-prev-btn">« Previous</button>
                 <span class="page-indicator" id="settings-page-indicator">Page 1 / 4</span>
                 <button class="pagination-btn" id="settings-next-btn">Next »</button>
             </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="modal-cancel-btn">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="modal-save-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Appearance Editor Modal -->
     <div class="modal-overlay" id="appearance-editor-overlay">
         <div class="modal-content">
             <div class="modal-header">
                 <h3 class="modal-title" id="appearance-editor-title">Set Appearance & Details</h3>
                 <button class="modal-close-btn" id="appearance-editor-close-btn">×</button>
             </div>
             <div class="modal-body">
                 <div class="appearance-editor-details">
                     <label for="appearance-editor-name">Name:</label>
                     <input type="text" id="appearance-editor-name" class="settings-input">
                     <label for="appearance-editor-persona">Persona:</label>
                     <textarea id="appearance-editor-persona" class="settings-textarea"></textarea>
                     <label>Sigil:</label>
                     <div class="appearance-pfp-section">
                         <img src="" alt="Sigil Preview" class="appearance-pfp-preview" id="appearance-pfp-preview" title="Click to change sigil">
                         <button class="appearance-pfp-change-btn" id="appearance-pfp-change-btn">Change Sigil</button>
                     </div>
                 </div>
                 <div class="appearance-iframe-container">
                     <iframe id="characterCreatorFrame" src="character_creator.html"></iframe>
                 </div>
             </div>
             <div class="modal-footer">
                 <button class="modal-btn modal-btn-secondary" id="appearance-editor-cancel-btn">Cancel</button>
                 <button class="modal-btn modal-btn-primary" id="appearance-editor-save-btn">Save Appearance & Details</button>
             </div>
         </div>
     </div>

    <!-- Context Menus -->
    <div id="npc-context-menu" class="context-menu" style="display: none;">
        <!-- MODIFIED CONTEXT MENU -->
        <div class="context-menu-item" data-action="talk">Talk (Chat Mode)</div> <!-- RENAMED -->
        <div class="context-menu-item" data-action="command">Command (Agent Mode)</div>
        <div class="context-menu-item" data-action="toggleFollow">Toggle Follow/Unfollow</div>
        <div class="context-menu-item" data-action="appearance">Set Appearance, Details & Sigil</div>
        <hr class="context-menu-divider">
        <div class="context-menu-item" data-action="cancel">Cancel</div>
    </div>
    <div id="player-context-menu" class="context-menu" style="display: none;">
        <div class="context-menu-item" data-action="appearance">Set Appearance, Details & Sigil</div> <hr class="context-menu-divider">
        <div class="context-menu-item" data-action="add_area">Add Area Here</div> <div class="context-menu-item" data-action="add_agent">Add Agent Here</div> <hr class="context-menu-divider">
        <div class="context-menu-item" data-action="remove_closest_agent">Remove Closest Agent</div> <div class="context-menu-item" data-action="remove_closest_area">Remove Closest Area</div> <hr class="context-menu-divider">
        <div class="context-menu-item" data-action="cancel">Cancel</div>
    </div>
    <div id="pfp-context-menu" class="context-menu" style="display: none;">
        <div class="context-menu-item" data-action="toggle-tabs">Show/Hide Chat Tabs</div>
        <div class="context-menu-item" data-action="toggle-fullscreen">Toggle Fullscreen Chat</div>
        <hr class="context-menu-divider">
        <div class="context-menu-item" data-action="cancel">Cancel</div>
    </div>

    <input type="file" class="pfp-upload" id="pfp-upload" accept="image/*">

    <!-- Load API Providers Script (Make sure this file exists) -->
    <script src="api_providers.js"></script>

    <!-- Load the separated JavaScript file -->
    <!-- 'defer' ensures the script runs after the HTML is parsed -->
    <script src="script.js" defer></script>

</body>
</html>
