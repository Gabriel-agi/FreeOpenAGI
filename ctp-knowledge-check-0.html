<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Practice + Basic AI Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Using Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- Basic Setup & Variables --- */
        :root {
            --sim-primary: #007bff; /* Blue */
            --sim-secondary: #6c757d; /* Grey */
            --sim-background: #f8f9fa; /* Very Light Grey */
            --sim-panel-bg: #ffffff;
            --sim-text: #212529; /* Dark Text */
            --sim-light-text: #f8f9fa;
            --sim-code-bg: #2b2b2b;
            --sim-code-text: #a9b7c6;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-code: 'Consolas', 'Courier New', Courier, monospace;
            --border-radius: 8px;
            --success-color: #28a745;
            --error-color: #dc3545;
            --ai-message-bg: #f0f8ff; /* Light blue for AI general responses */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; }
        body {
            font-family: var(--font-main);
            background-color: var(--sim-background);
            color: var(--sim-text);
            height: 100%;
            overflow: hidden;
            display: flex;
        }

        #main-container {
            display: flex;
            width: 100%;
            height: 100%;
            background-color: var(--sim-secondary); /* Separator color */
        }

        /* --- Playground Area (Left/Top) --- */
        #playground-area {
            flex: 1;
            background-color: var(--sim-panel-bg);
            display: flex;
            flex-direction: column;
            height: 100%;
            border-right: 3px solid var(--sim-primary);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .playground-header {
            background-color: var(--sim-secondary);
            color: var(--sim-light-text);
            padding: 10px 15px;
            font-size: 1.1em;
            font-weight: bold;
            flex-shrink: 0;
            border-bottom: 2px solid var(--sim-primary);
        }
        .playground-header .fa-tasks { margin-right: 8px; color: var(--sim-primary); }

        #playground-content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            font-size: 0.95em;
            line-height: 1.6;
        }
        #playground-content h3 { color: var(--sim-primary); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        #playground-content h4 { color: #333; margin-top: 15px; margin-bottom: 8px; }
        #playground-content p { margin-bottom: 10px; }
        #playground-content pre {
            background-color: var(--sim-code-bg);
            color: var(--sim-code-text);
            padding: 15px;
            border-radius: var(--border-radius);
            font-family: var(--font-code);
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 10px;
            font-size: 0.9em;
            border: 1px solid #444;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }
        /* Basic Syntax Highlighting */
        .code-keyword { color: #cc7832; font-weight: bold; }
        .code-string { color: #6a8759; }
        .code-comment { color: #808080; font-style: italic; }
        .code-function { color: #ffc66d; }
        .code-paren { color: #bbb; }
        .playground-text-display i {
            display: block;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid var(--sim-primary);
        }

        /* --- Chatbot Area (Right/Bottom) --- */
        #chatbot-container {
            display: flex;
            flex-direction: column;
            width: 400px;
            min-width: 350px;
            height: 100%;
            border-left: 3px solid var(--sim-primary);
            background: var(--sim-panel-bg);
        }
        #message-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #fdfdfd;
        }
        #input-container {
            display: flex;
            padding: 10px 15px;
            background: #f9f9f9;
            flex-shrink: 0;
            border-top: 1px solid #eee;
        }
        #messageInput {
            flex-grow: 1;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 18px;
            resize: none;
            font-size: 1em;
            line-height: 1.4;
            height: 38px;
            overflow-y: hidden;
            transition: border-color 0.2s ease;
        }
        #messageInput:focus {
            outline: none;
            border-color: var(--sim-primary);
        }
        #messageInput:disabled { background-color: #eee; cursor: not-allowed; }

        #sendMessageBtn {
            padding: 0 15px;
            cursor: pointer;
            background: var(--sim-primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            transition: background-color 0.2s ease;
        }
         #sendMessageBtn:hover:not(:disabled) { background: #0056b3; }
         #sendMessageBtn:disabled { background: #aaa; cursor: not-allowed; opacity: 0.7;}

        #status-bar {
            padding: 6px 15px;
            background: var(--sim-secondary);
            color: white;
            font-size: 0.8em;
            flex-shrink: 0;
            height: 28px;
            display: flex;
            align-items: center;
        }
        #status-bar .icon { margin-right: 8px; }
        #status-bar .text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Message Styling */
        .message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 85%; /* Adjusted max width */
            word-wrap: break-word;
            line-height: 1.45;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            opacity: 0; /* Start hidden */
            animation: messageFadeIn 0.4s ease-out forwards;
        }
        @keyframes messageFadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-message {
            background-color: var(--sim-primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .bot-message { /* Default bot message style */
            background-color: #e9ecef;
            color: var(--sim-text);
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        /* Style for AI general responses */
        .bot-message.ai-response {
            background-color: var(--ai-message-bg); /* Light blue for AI */
            border-left: 4px solid #75aadb;
        }

        /* Specific styles for feedback messages */
        .bot-feedback.correct {
             background-color: #d4edda; /* Light green */
             color: #155724;
             border-left: 4px solid var(--success-color);
             font-weight: bold;
        }
         .bot-feedback.incorrect {
             background-color: #f8d7da; /* Light red */
             color: #721c24;
             border-left: 4px solid var(--error-color);
             font-weight: bold;
        }
         .bot-feedback strong::before { /* Icon prefix */
             margin-right: 6px;
             font-family: "Font Awesome 6 Free";
             font-weight: 900;
             font-size: 1.1em;
         }
         .bot-feedback.correct strong::before { content: "\f058"; color: var(--success-color); }
         .bot-feedback.incorrect strong::before { content: "\f057"; color: var(--error-color);}

         .error-display { /* Style for JS errors shown in chat */
            background-color: #f8d7da;
            color: #721c24;
            margin-right: auto;
            border: 1px solid #f5c6cb;
            font-weight: bold;
            border-radius: 5px;
            padding: 10px 15px; /* Ensure padding */
            margin-bottom: 12px;
         }

         /* Responsive */
         @media (max-width: 768px) {
            #main-container { flex-direction: column; }
            #playground-area { border-right: none; border-bottom: 3px solid var(--sim-primary); height: 45%; flex-basis: 45%; flex-grow: 0;}
            #chatbot-container { width: 100%; height: 55%; border-left: none; flex-basis: 55%; flex-grow: 0;}
            #messageInput { max-height: 100px; }
        }
         @media (max-width: 480px) {
            #playground-content { padding: 15px; }
            #message-list { padding: 10px; }
            .message { max-width: 90%; } /* Slightly wider on small screens */
            #messageInput { font-size: 0.95em;}
            #sendMessageBtn { width: 38px; height: 38px; font-size: 1em;}
         }
    </style>
</head>
<body>
    <div id="main-container">
        <!-- Playground Area -->
        <div id="playground-area">
            <div class="playground-header">
                <i class="fas fa-tasks"></i> Task Information
            </div>
            <div id="playground-content">
                <p>Welcome! Instructions will appear here. You can also ask general programming questions.</p>
            </div>
        </div>

        <!-- Chatbot Interface Area -->
        <div id="chatbot-container">
            <div id="message-list">
                <!-- Messages will appear here -->
            </div>
            <div id="input-container">
                <textarea id="messageInput" placeholder="Enter answer or ask a question..." rows="1"></textarea>
                <button id="sendMessageBtn" title="Submit / Send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
             <div id="status-bar">
                <span class="icon"><i class="fas fa-chalkboard-teacher"></i></span>
                <span class="text">Status: Ready</span>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("Interactive Practice + AI Script: DOM Loaded.");

        // --- Get References to Elements ---
        const messageList = document.getElementById('message-list');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const statusBarText = document.querySelector('#status-bar .text');
        const playgroundContent = document.getElementById('playground-content');

        // --- State ---
        let currentQuestionIndex = -1;
        let currentTask = null;
        let isWaitingForNext = false; // Prevent sending while transitioning tasks
        let isWaitingForAI = false; // Prevent sending while waiting for AI response
        let conversationHistory = []; // Keep track for AI context

        // --- Configuration ---
        const Config = {
            // CRITICAL: Update with YOUR working proxy URL
            proxyUrl: '/api/proxy',
            model: "glm-4-flash", // Or your preferred model
            temperature: 0.7,     // Standard temperature for helpfulness
            max_tokens: 300,
            // Standard, helpful system prompt
            standardSystemPrompt: "You are a helpful AI assistant explaining basic Python programming concepts clearly and concisely. Answer the user's questions related to Python or programming in general.",
             // Delay before showing next question after correct answer
             nextQuestionDelay: 1500, // ms
             // Typing simulation delay for AI response (can be removed if not desired)
             aiTypingDelay: 800 // ms
        };


        // --- Simple Question Bank (with hardcoded answers) ---
        const QuestionBank = [
             {
                id: 'print_hello',
                prompt: "Let's start! Write the Python code to print the exact text 'Hello, Python!' to the screen.",
                expectedAnswer: "print('Hello, Python!')", // Local check target
                visual_aid_type: 'code_editor_display',
                visual_aid_content: "# Task: Print 'Hello, Python!'\n# Type your code in the chat input below."
            },
            {
                id: 'comment_write',
                prompt: "Good! Now, write a Python comment that says exactly: # This is a comment",
                expectedAnswer: "# This is a comment",
                visual_aid_type: 'code_editor_display',
                visual_aid_content: "# Task: Write the comment '# This is a comment'\n# Enter the full comment line below."
            },
            {
                id: 'print_blank',
                prompt: "How do you write the Python code to print just a blank line?",
                expectedAnswer: "print()",
                visual_aid_type: 'code_editor_display',
                visual_aid_content: "# Task: Print a blank line using Python.\n# Enter the code below."
            },
            {
                id: 'end',
                prompt: "Great job! You've completed the basic practice. Feel free to ask any general Python questions now.",
                expectedAnswer: null, // No answer expected, marks end of sequence
                visual_aid_type: 'text_display',
                visual_aid_content: "Practice Complete! You can now ask general questions."
            }
        ];

        // --- Helper Function to Add Message to UI ---
        const addMessage = (sender, text, type = '') => {
            if (!messageList) return;

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');

            if (sender === 'bot') {
                if (type === 'correct' || type === 'incorrect') {
                    messageDiv.classList.add('bot-feedback', type);
                    messageDiv.innerHTML = `<strong></strong> ${text}`; // Strong for icon
                } else if (type === 'ai-response') {
                     messageDiv.classList.add('ai-response');
                     messageDiv.textContent = text; // Standard AI response
                } else {
                    messageDiv.textContent = text; // Default bot prompt/message
                }
            } else {
                 messageDiv.textContent = text; // User message
            }

            messageList.appendChild(messageDiv);
            messageList.scrollTop = messageList.scrollHeight;
        };

         // --- Function to Update Status Bar ---
         const updateStatus = (text, isBusy = false) => {
            if (statusBarText) {
                statusBarText.textContent = `Status: ${text}`;
            }
             // Disable/Enable Send button based on busy status
             if (sendMessageBtn) {
                 sendMessageBtn.disabled = isBusy;
             }
         };

         // --- Update Playground Function ---
         const updatePlayground = (task) => {
            if (!playgroundContent) return;
             if (!task) {
                 playgroundContent.innerHTML = "<p>Practice complete or not started. Ask a question!</p>";
                 return;
             }
             let contentHTML = `<h3>Task: ${task.id.replace(/_/g, ' ')}</h3><p>${task.prompt}</p>`;
             const visualContent = task.visual_aid_content || ''; // Ensure content exists
             const escapedVisualContent = (typeof visualContent === 'string' ? visualContent : '').replace(/</g, "<").replace(/>/g, ">");

              if (task.visual_aid_type === 'code_editor_display') {
                  contentHTML += `<h4>Instructions / Example:</h4><pre>${escapedVisualContent}</pre>`;
              } else if (task.visual_aid_type === 'text_display') {
                  contentHTML += `<div class="playground-text-display"><i>${escapedVisualContent}</i></div>`;
              }
             playgroundContent.innerHTML = contentHTML;
         };


         // --- Function to Proceed to Next Question ---
         const nextQuestion = () => {
             currentQuestionIndex++;
             isWaitingForNext = false; // Ready for input for the new task

             if (currentQuestionIndex < QuestionBank.length) {
                 currentTask = QuestionBank[currentQuestionIndex];
                 console.log(`Loading Task: ${currentTask.id}`);
                 updatePlayground(currentTask);
                 addMessage('bot', currentTask.prompt); // Ask question in chat

                 // Update status, exclude 'end' task from count if desired
                 const totalTasks = QuestionBank.length - 1;
                 const currentTaskNum = Math.min(currentQuestionIndex + 1, totalTasks); // Don't exceed count
                 const statusMsg = currentTask.id === 'end' ? "Practice Complete" : `Task ${currentTaskNum}/${totalTasks}: ${currentTask.id}`;
                 updateStatus(statusMsg, false); // Not busy anymore

                 if(messageInput) {
                     messageInput.disabled = (currentTask.id === 'end'); // Disable only if it's the end task prompt
                     messageInput.focus();
                     messageInput.placeholder = (currentTask.id === 'end') ? "Ask a general question..." : "Enter your answer...";
                 }
             } else {
                 console.log("End of practice sequence (should have been handled by 'end' task).");
                 currentTask = null; // Explicitly nullify task
                 updateStatus("Practice Complete! Ask questions.", false);
                 if(messageInput) {
                    messageInput.disabled = false; // Ensure enabled for general questions
                    messageInput.focus();
                    messageInput.placeholder = "Ask a general question...";
                 }
             }
         };

        // --- Helper for Local Answer Check ---
        const checkAnswerLocally = (userAnswer, task) => {
             if (!task || task.expectedAnswer === null) return false; // Cannot check if no task/answer

             const normalizedUserAnswer = userAnswer.replace(/;\s*$/, "").trim();
             const normalizedExpectedAnswer = task.expectedAnswer.trim();

             // Example specific check allowing quote variation
             if (task.id === 'print_hello') {
                 return normalizedUserAnswer === "print('Hello, Python!')" || normalizedUserAnswer === 'print("Hello, Python!")';
             }
             // Default strict check
             return normalizedUserAnswer === normalizedExpectedAnswer;
         };


         // --- Re-introduced API Module ---
         const API = {
             fetchChatResponse: async (messages) => {
                 console.log("API: Calling proxy...");
                 isWaitingForAI = true;
                 updateStatus("AI is thinking...", true); // Set busy status

                 const messagesToSend = [
                     { role: "system", content: Config.standardSystemPrompt },
                     ...messages.filter(m => m.role !== 'system')
                  ];

                 try {
                     const response = await fetch(Config.proxyUrl, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({
                             model: Config.model,
                             messages: messagesToSend,
                             temperature: Config.temperature,
                             max_tokens: Config.max_tokens,
                         })
                     });
                     console.log("API: Proxy response status:", response.status);

                     // Simulate typing delay
                     await new Promise(resolve => setTimeout(resolve, Config.aiTypingDelay));

                     if (!response.ok) {
                         const errorText = await response.text();
                         let detail = errorText;
                         try { detail = JSON.parse(errorText).error?.message || errorText; } catch(e) {}
                         throw new Error(`Request failed (${response.status}). ${detail}`);
                     }

                     const data = await response.json();
                     console.log("API: Received data:", !!data);

                     if (data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                         return data.choices[0].message.content.trim();
                     } else {
                         throw new Error("Invalid API response structure.");
                     }

                 } catch (error) {
                     console.error('API: Fetch failed:', error);
                     addMessage('bot', `Error communicating with AI: ${error.message}`, 'error'); // Show error in chat
                     return null; // Indicate failure
                 } finally {
                     isWaitingForAI = false;
                     // Update status only if not also waiting for next question
                     if (!isWaitingForNext) {
                          updateStatus(currentTask && currentTask.id !== 'end' ? `Task ${currentQuestionIndex + 1}/${QuestionBank.length -1}: ${currentTask.id}` : "Ready", false);
                     }
                 }
             }
         };

        // --- Main Send Message Handler ---
        const handleSendMessage = async () => {
            if (!messageInput || isWaitingForNext || isWaitingForAI) return;

            const userText = messageInput.value.trim();
            if (!userText) return; // Don't send empty messages

            console.log(`Handling send: "${userText}"`);
            addMessage('user', userText);
            conversationHistory.push({ role: "user", content: userText }); // Add user message to history immediately
            messageInput.value = '';
            messageInput.style.height = '38px'; // Reset height

            // Determine if it's an answer to the current task OR a general query
            let isTaskAnswer = currentTask && currentTask.expectedAnswer !== null;
            let isCorrect = false;

            if (isTaskAnswer) {
                console.log(`Checking answer for task: ${currentTask.id}`);
                isCorrect = checkAnswerLocally(userText, currentTask);

                if (isCorrect) {
                    console.log("Local check: Correct");
                    addMessage('bot', "Correct!", 'correct');
                    updateStatus("Correct! Loading next task...", true); // Set busy
                    isWaitingForNext = true; // Block input during transition
                    setTimeout(nextQuestion, Config.nextQuestionDelay); // Proceed after delay
                } else {
                    console.log("Local check: Incorrect");
                    addMessage('bot', "Not quite right. Try again!", 'incorrect');
                    updateStatus("Incorrect. Please try again.", false); // Not busy, allow retry
                    if (messageInput) messageInput.focus();
                     // For this version, we DON'T send incorrect answers to the API.
                     // We just give local feedback.
                }
            }

            // If it wasn't a task answer OR if the task has no expected answer (like 'end')
            // Or if you want to allow general chat even during tasks (remove isTaskAnswer check below)
            if (!isTaskAnswer) {
                 console.log("Handling as general AI query.");
                 // Send the conversation history (which includes the latest user message) to the AI
                 const botResponse = await API.fetchChatResponse(conversationHistory);

                 if (botResponse !== null) {
                     console.log("AI Response received.");
                     addMessage('bot', botResponse, 'ai-response'); // Display AI response with specific style
                     conversationHistory.push({ role: "assistant", content: botResponse }); // Add AI response to history
                 } else {
                     console.log("AI query failed.");
                     // Error message handled by API module, status updated in finally block
                 }
                  // Re-enable input if it's the end task (allow continued chat)
                  if (currentTask && currentTask.id === 'end' && messageInput) {
                     messageInput.disabled = false;
                     sendMessageBtn.disabled = false;
                 }
            }
        };


        // --- Auto-Resize Textarea ---
        const autoResizeTextarea = () => {
             if (!messageInput) return;
             messageInput.style.height = 'auto';
             const maxHeight = 150;
             messageInput.style.height = Math.min(messageInput.scrollHeight, maxHeight) + 'px';
        };


        // --- Add Event Listeners ---
        if (sendMessageBtn && messageInput && messageList && statusBarText && playgroundContent) {
             console.log("All elements found. Adding listeners.");
             sendMessageBtn.addEventListener('click', handleSendMessage);
             messageInput.addEventListener('keypress', (event) => {
                 if (event.key === 'Enter' && !event.shiftKey) {
                     event.preventDefault();
                     // Only send if not busy
                     if (!isWaitingForNext && !isWaitingForAI) {
                         handleSendMessage();
                     }
                 }
             });
             messageInput.addEventListener('input', autoResizeTextarea);

             // --- Initial Setup ---
             console.log("Initializing practice...");
             updateStatus("Loading first task...", true); // Start busy
             conversationHistory = []; // Reset history on load
             addMessage('bot', "Welcome to the Python practice area! I'll guide you through some tasks. You can also ask me general Python questions.");
             setTimeout(nextQuestion, 1000); // Load the first question after welcome message

        } else {
            console.error("Initialization failed: One or more essential elements are missing.");
            updateStatus("Initialization Error!", true);
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('error-display'); // Use defined style
             errorDiv.textContent = "Error initializing interface. Check console (F12).";
             if(messageList) messageList.appendChild(errorDiv); // Show error in chat if possible
             else document.body.prepend(errorDiv);
        }

    }); // End DOMContentLoaded
    </script>

</body>
</html>
